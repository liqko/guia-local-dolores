<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panel Admin - Anunciantes</title>
  <!-- Firebase App y Auth -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 2em; background: #fafafa;}
    .panel { max-width: 700px; margin: 2em auto; background: #fff; border-radius: 12px; box-shadow: 0 2px 12px #0002; padding: 2em;}
    h2 { text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 1em;}
    th, td { padding: 8px 5px; text-align: left; border-bottom: 1px solid #ddd;}
    th { background: #006699; color: #fff;}
    tr.aprobado { background: #e8f5e9;}
    tr.pendiente { background: #fffde7;}
    .btn { padding: 5px 14px; border-radius: 6px; border: none; cursor: pointer;}
    .btn-aprobar { background: #43a047; color: #fff;}
    .btn-rechazar { background: #e53935; color: #fff;}
    .logout { float: right; background: #888; color: #fff; border: none; border-radius: 8px; padding: 6px 14px;}
    .msg { color:#e53935; margin-top:1em;}
    .user-email { font-size: 1em; color: #006699; font-weight: bold;}
  </style>
</head>
<body>
  <div class="panel">
    <button class="logout" onclick="logout()">Salir</button>
    <h2>Panel de administración</h2>
    <div id="admin-email"></div>
    <div id="msg" class="msg"></div>
    <table id="tabla">
      <thead>
        <tr>
          <th>Email</th>
          <th>Nombre</th>
          <th>Fecha registro</th>
          <th>Aprobado</th>
          <th>Acción</th>
        </tr>
      </thead>
      <tbody id="listado"></tbody>
    </table>
  </div>
  <script>
    // Configuración Firebase (TU CONFIGURACIÓN)
    const firebaseConfig = {
      apiKey: "AIzaSyC__YRb9phBPEL563dkDHZhht-sdTXy6XE",
      authDomain: "anunciantes-guialocal.firebaseapp.com",
      projectId: "anunciantes-guialocal",
      storageBucket: "anunciantes-guialocal.firebasestorage.app",
      messagingSenderId: "1046169260713",
      appId: "1:1046169260713:web:5ae883a5f2d16619d18fb8",
      measurementId: "G-CNR1Y6VW06"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const ADMIN_EMAIL = "liqkoargentina@gmail.com";

    // Autenticación al cargar
    window.onload = function() {
      auth.onAuthStateChanged(async function(user) {
        if (user && user.email === ADMIN_EMAIL) {
          document.getElementById('admin-email').innerHTML = 'Administrador: <span class="user-email">'+user.email+'</span>';
          cargarUsuarios();
        } else {
          // Si no está logueado como admin, mostrar login rápido solo para admin
          mostrarLoginAdmin();
        }
      });
    };

    function mostrarLoginAdmin() {
      document.body.innerHTML = `
        <div class="panel">
          <h2>Acceso administrador</h2>
          <form id="form-admin-login">
            <label>Email</label>
            <input type="email" id="admin-email-input" required style="width:100%;padding:8px;">
            <label>Contraseña</label>
            <input type="password" id="admin-pass-input" required style="width:100%;padding:8px;">
            <input type="submit" value="Ingresar" class="btn btn-aprobar" style="margin-top:1em;">
          </form>
          <div id="msg" class="msg"></div>
        </div>
      `;
      document.getElementById('form-admin-login').onsubmit = async function(e) {
        e.preventDefault();
        let email = document.getElementById('admin-email-input').value;
        let pass = document.getElementById('admin-pass-input').value;
        try {
          let cred = await auth.signInWithEmailAndPassword(email, pass);
          if (cred.user.email !== ADMIN_EMAIL) {
            auth.signOut();
            document.getElementById('msg').innerText = "Solo el email administrador puede acceder.";
          } else {
            window.location.reload();
          }
        } catch (e) {
          document.getElementById('msg').innerText = "Error: " + e.message;
        }
      }
    }

    // Cargar usuarios
    async function cargarUsuarios() {
      let tbody = document.getElementById('listado');
      tbody.innerHTML = "";
      const snap = await db.collection("anunciantes").orderBy("creado", "desc").get();
      snap.forEach(doc => {
        let data = doc.data();
        let aprobado = data.aprobado === true;
        let tr = document.createElement("tr");
        tr.className = aprobado ? "aprobado" : "pendiente";
        tr.innerHTML = `
          <td>${data.email}</td>
          <td>${data.nombre || ''}</td>
          <td>${data.creado ? (new Date(data.creado.seconds*1000)).toLocaleString() : ''}</td>
          <td>${aprobado ? "Sí" : "No"}</td>
          <td>
            ${aprobado ? 
              `<button class="btn btn-rechazar" onclick="cambiarAprobado('${data.email}', false)">Rechazar</button>` :
              `<button class="btn btn-aprobar" onclick="cambiarAprobado('${data.email}', true)">Aprobar</button>`
            }
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Cambiar aprobado/rechazado
    async function cambiarAprobado(email, valor) {
      try {
        await db.collection("anunciantes").doc(email).update({aprobado: valor});
        cargarUsuarios();
      } catch (e) {
        document.getElementById('msg').innerText = "Error: " + e.message;
      }
    }

    // Logout
    function logout() {
      auth.signOut();
      window.location.reload();
    }
  </script>
</body>
</html>
