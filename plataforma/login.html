<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Panel Comercios - Login & Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f6f7fb;margin:0;padding:0}
    .container{max-width:720px;margin:20px auto;background:#fff;border-radius:12px;box-shadow:0 2px 16px #0002;padding:24px}
    label{display:block;margin:12px 0 6px;font-weight:500}
    input,button{width:100%;padding:8px;margin-bottom:10px;border-radius:5px;border:1px solid #bbb;box-sizing:border-box}
    .autocomplete-list{position:absolute;background:#fff;border:1px solid #bbb;z-index:10;max-height:220px;overflow-y:auto;width:93%}
    .autocomplete-item{padding:8px;cursor:pointer}
    .autocomplete-item:hover{background:#e7f7fd}
    .hidden{display:none}
    .success{color:#060;font-weight:bold}
    .error{color:#c00}
    button.primary{margin-top:10px;padding:12px 0;font-size:1.05em;border-radius:7px;background:#3dc879;color:#fff;border:1px solid #2a8}
    .link{color:#3498db;cursor:pointer;text-decoration:underline;display:inline-block;margin-top:8px}
    .panel{display:none}
    .panel.active{display:block}
    #debug{background:#111;color:#bff;padding:10px;border-radius:6px;max-height:160px;overflow:auto;font-size:12px;margin-top:8px;white-space:pre-wrap}
  </style>
</head>
<body>
  <div class="container">
    <div id="panel-login" class="panel active">
      <h2>Ingresar a tu comercio</h2>
      <form id="login-form" autocomplete="off">
        <label>Comercio</label>
        <div style="position:relative;">
          <input type="text" id="comercio-buscar" placeholder="Buscá tu comercio..." autocomplete="off" required>
          <div id="autocomplete-list" class="autocomplete-list hidden"></div>
        </div>
        <input type="hidden" id="comercio-id">
        <label>Clave</label>
        <input type="password" id="clave" placeholder="Clave..." required minlength="1">
        <button id="btnLogin" class="primary" disabled>Ingresar</button>
        <div id="login-msg"></div>
        <div id="report-area" style="display:none;">
          <button id="reportBtn">Contactar Soporte (WhatsApp)</button>
        </div>
      </form>
      <div style="text-align:center;">
        <span class="link" onclick="mostrarPanel('registro')">¿No tenés cuenta? Registrate / Solicitar alta</span>
      </div>
    </div>

    <div id="panel-registro" class="panel">
      <h2>Solicitar alta o pedir cuenta</h2>
      <label>Buscar comercio (si existe)</label>
      <div style="position:relative;">
        <input type="text" id="comercio-buscar2" placeholder="Buscá tu comercio..." autocomplete="off">
        <div id="autocomplete-list2" class="autocomplete-list hidden"></div>
      </div>
      <input type="hidden" id="comercio-id2">
      <div style="display:flex;gap:8px;">
        <button id="btnSolicitarAlta" class="primary" style="flex:1">Ir a formulario de alta</button>
        <button id="btnPedirCuenta" style="flex:1;background:#f39c12;color:#fff;border:none;padding:10px;border-radius:6px">Pedir cuenta / Modificar (Soporte)</button>
      </div>
      <div id="reg-msg"></div>
      <div style="text-align:center;margin-top:8px;">
        <span class="link" onclick="mostrarPanel('login')">Volver al login</span>
      </div>
    </div>

    <div id="panel-dashboard" class="panel">
      <div style="font-size:1.2em;margin-bottom:10px">¡Hola <span id="nombre-comercio"></span>!</div>
      <form id="form-datos-comercio">
        <div id="campos-datos-comercio"></div>
        <button type="submit" style="background:#3dc879;color:#fff;padding:10px;border:none;border-radius:6px">Guardar cambios</button>
        <div id="msg-datos-comercio"></div>
      </form>
      <div style="margin-top:10px">
        <a id="link-support-dashboard" href="#" target="_blank">WhatsApp Soporte</a>
      </div>
      <div style="margin-top:8px">
        <button id="logout-btn" style="background:#e74c3c;color:#fff;border:none;padding:8px;border-radius:6px">Cerrar sesión</button>
      </div>
    </div>

    <h3>Debug / Registros</h3>
    <div id="debug"></div>
  </div>

<script>
/* === CONFIG: ya configurado para tu entorno - NO toques si no querés === */
const WORKER_URL = "https://login.liqkoargentina.workers.dev/login";
const WORKER_ORIGIN = (new URL(WORKER_URL)).origin;
const SHEET_ID = "170kTZ-ViCPxPli86g-n_XMuMv1S3O0-DbGwNFGYVnjY";
const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSdZDgpGMYyb5uh1xpsJCN1MzNGoSgGZ9W9EUqQqAYFdB2EyBQ/viewform";
/* =================================================================== */

let comercios = [];
let sesion = null;
const debugEl = document.getElementById('debug');
function debugLog(...args){ console.log(...args); try { debugEl.textContent += args.map(a=>typeof a==='object'?JSON.stringify(a,null,2):String(a)).join(' ') + "\n\n"; debugEl.scrollTop = debugEl.scrollHeight; }catch(e){} }

function mostrarPanel(panel){ ['panel-login','panel-registro','panel-dashboard'].forEach(id=>document.getElementById(id).classList.remove('active')); document.getElementById('panel-'+panel)?.classList.add('active'); }

function openWhatsApp(text){ const number="5492245459957"; window.open(`https://wa.me/${number}?text=${encodeURIComponent(text)}`,'_blank'); }

function enableReportButton(payloadText){ document.getElementById('report-area').style.display='block'; document.getElementById('reportBtn').onclick = ()=> openWhatsApp(payloadText + "\n\nPor favor revisen. Gracias."); }

/* Cargar lista de comercios (autocompletado) */
function cargarComercios(callback){
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=anunciantes`;
  fetch(url, {cache:'no-store'}).then(r=>r.text()).then(text=>{
    try{
      const start=text.indexOf('{'), end=text.lastIndexOf('}');
      const jsonText=text.slice(start,end+1);
      const json=JSON.parse(jsonText);
      const cols=(json.table && json.table.cols)? json.table.cols.map(c=>(c&&c.label)?String(c.label).toLowerCase().trim():''):[];
      let idxNombre = cols.findIndex(h=>/nombre|comercio|title|titulo/.test(h)); if(idxNombre===-1) idxNombre=1;
      let idxId = cols.findIndex(h=>/id|planilla|planilla_id|codigo/.test(h)); if(idxId===-1) idxId=61;
      comercios=(json.table.rows||[]).map(row=>({ nombre:(row.c && row.c[idxNombre] && row.c[idxNombre].v)?row.c[idxNombre].v:'', id:(row.c && row.c[idxId] && row.c[idxId].v)?row.c[idxId].v:'' })).filter(c=>c.nombre);
      debugLog('Comercios cargados:', comercios.length);
      callback && callback();
    }catch(e){
      debugLog('Error parseando lista de comercios', e);
      callback && callback();
    }
  }).catch(err=>{ debugLog('Error fetch lista de comercios', err); callback && callback(); });
}

function showAutocomplete(inputEl, listEl, idEl, modoRegistro=false){
  if(!inputEl||!listEl||!idEl) return;
  inputEl.addEventListener('input', function(){
    const val=this.value.trim().toLowerCase(); listEl.innerHTML='';
    if(val.length<2){ listEl.classList.add('hidden'); idEl.value=''; document.getElementById('btnLogin')?.setAttribute('disabled','true'); if(modoRegistro) document.getElementById('btnPedirCuenta')?.setAttribute('disabled','true'); return; }
    const matches = comercios.filter(c=>c.nombre.toLowerCase().includes(val));
    if(matches.length){
      matches.slice(0,20).forEach(c=>{
        const item=document.createElement('div'); item.className='autocomplete-item'; item.textContent=c.nombre + (c.id?(' ('+c.id+')'):'');
        item.onclick=function(){ inputEl.value=c.nombre; idEl.value=c.id||''; listEl.classList.add('hidden'); document.getElementById('btnLogin')?.removeAttribute('disabled'); if(modoRegistro) document.getElementById('btnPedirCuenta')?.removeAttribute('disabled'); };
        listEl.appendChild(item);
      });
      listEl.classList.remove('hidden');
    } else {
      const item=document.createElement('div'); item.style.padding='10px'; item.style.background='#fffbe5';
      item.innerHTML = `<b>¿Tu comercio no está publicado?</b><br><button id="btnRegistrarComercio" style="margin-top:8px;width:100%;">Solicitar alta</button>`;
      listEl.appendChild(item);
      setTimeout(()=>{ const btn=document.getElementById('btnRegistrarComercio'); if(btn) btn.onclick=()=> mostrarPanel('registro'); },50);
      listEl.classList.remove('hidden');
    }
  });
  inputEl.addEventListener('blur', ()=> setTimeout(()=>listEl.classList.add('hidden'),180));
  inputEl.addEventListener('change', function(){ if(this.value===''){ idEl.value=''; document.getElementById('btnLogin')?.setAttribute('disabled','true'); if(modoRegistro) document.getElementById('btnPedirCuenta')?.setAttribute('disabled','true'); } });
}

/* Eventos y login */
document.addEventListener('DOMContentLoaded', ()=>{
  cargarComercios(()=>{
    showAutocomplete(document.getElementById('comercio-buscar'), document.getElementById('autocomplete-list'), document.getElementById('comercio-id'));
    showAutocomplete(document.getElementById('comercio-buscar2'), document.getElementById('autocomplete-list2'), document.getElementById('comercio-id2'), true);
  });

  document.getElementById('login-form').onsubmit = async function(e){
    e.preventDefault(); document.getElementById('report-area').style.display='none';
    const nombre = document.getElementById('comercio-buscar').value.trim();
    const clave = document.getElementById('clave').value.trim();
    const id = document.getElementById('comercio-id').value.trim();
    if(!id && !nombre){ document.getElementById('login-msg').innerHTML = "<span class='error'>Elegí un comercio de la lista.</span>"; return; }
    document.getElementById('login-msg').innerHTML = "<span>Ingresando...</span>";
    const payload = { accion:'login', comercio_id:id||'', nombre:nombre, password:clave };
    try{
      const r = await fetch(WORKER_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload), mode:'cors' });
      const text = await r.text();
      let res;
      try{ res = JSON.parse(text); }catch(e){ res = { success:false, message: text }; }
      debugLog('Login worker ->', r.status, res);
      if(r.status===200 && res.success){
        localStorage.setItem('comercio_id', res.id || id);
        localStorage.setItem('comercio_nombre', res.nombre || nombre);
        if(res.planilla_id) localStorage.setItem('planilla_id', res.planilla_id);
        sesion = { id: res.id || id, nombre: res.nombre || nombre, planilla_id: res.planilla_id || '' };
        document.getElementById('login-msg').innerHTML = "<span class='success'>"+(res.message||'Ingresado')+"</span>";
        setTimeout(()=> mostrarPanelDashboard(),500);
        return;
      }
      document.getElementById('login-msg').innerHTML = "<span class='error'>"+(res.message||'Login falló')+"</span>";
      enableReportButton(`Intento login\nPayload: ${JSON.stringify(payload)}\nWorker status: ${r.status}\nWorker body: ${JSON.stringify(res)}`);
    }catch(err){
      debugLog('Error fetch worker', err);
      document.getElementById('login-msg').innerHTML = "<span class='error'>Error de conexión.</span>";
      enableReportButton(`Error fetch worker: ${err}`);
    }
  };

  document.getElementById('btnSolicitarAlta').addEventListener('click', ()=> window.open(FORM_URL,'_blank'));
  document.getElementById('btnPedirCuenta').addEventListener('click', ()=>{
    const nombre = document.getElementById('comercio-buscar2').value.trim();
    const id = document.getElementById('comercio-id2').value.trim();
    if(!nombre && !id){ document.getElementById('reg-msg').innerHTML = "<span class='error'>Buscá tu comercio o completá el formulario de alta.</span>"; return; }
    openWhatsApp(`Hola, solicito creación/activación o modificación de datos.\nComercio: ${nombre}\nId: ${id}\nGracias.`);
  });

  document.getElementById('logout-btn').addEventListener('click', ()=> { localStorage.removeItem('comercio_id'); localStorage.removeItem('comercio_nombre'); localStorage.removeItem('planilla_id'); sesion=null; mostrarPanel('login'); });

  // Si ya hay sesión guardada, abrir dashboard
  if(localStorage.getItem('comercio_id') && localStorage.getItem('comercio_nombre')){ sesion = { id: localStorage.getItem('comercio_id'), nombre: localStorage.getItem('comercio_nombre'), planilla_id: localStorage.getItem('planilla_id')||'' }; mostrarPanelDashboard(); }
});

/* Dashboard: pedir datos al Worker -> Apps Script */
async function mostrarPanelDashboard(){
  if(!sesion || !sesion.id){ mostrarPanel('login'); return; }
  document.getElementById('nombre-comercio').textContent = sesion.nombre;
  debugLog('Pidiendo datos para id:', sesion.id);
  const url = `${WORKER_ORIGIN}/commerce?id=${encodeURIComponent(sesion.id)}&nombre=${encodeURIComponent(sesion.nombre)}&planilla_id=${encodeURIComponent(sesion.planilla_id||'')}`;
  try{
    const r = await fetch(url, { method:'GET', mode:'cors' });
    const datos = await r.json().catch(()=>({ error:'Respuesta inválida'}));
    debugLog('/commerce ->', datos);
    if(datos.error){ document.getElementById('campos-datos-comercio').innerHTML = `<b>Error:</b> ${datos.error}`; mostrarPanel('dashboard'); return; }
    if(datos.planilla_id && datos.planilla_id !== sesion.planilla_id){ sesion.planilla_id = datos.planilla_id; localStorage.setItem('planilla_id', datos.planilla_id); }
    const campos = ["nombre","nivel","subnivel","segmento","categoria","tags","adicionales","pie","descripcion","direccion","lat","lng","telefono","whatsapp","mail","instagram","facebook","youtube","tiktok","linkedin","logo","verificado","gold","img1","img2","img3","img4","link"];
    let html = '';
    campos.forEach(c=> html += `<div><label>${c}</label><input type="text" name="${c}" value="${datos[c]||''}" /></div>`);
    html += `<input type="hidden" name="__id" value="${sesion.id}"/>`;
    document.getElementById('campos-datos-comercio').innerHTML = html;
    document.getElementById('link-support-dashboard').href = `https://wa.me/5492245502172?text=${encodeURIComponent('Solicito modificación de datos\\nComercio: ' + sesion.nombre + '\\nId: ' + sesion.id)}`;
    mostrarPanel('dashboard');
  }catch(err){
    debugLog('Error al consultar /commerce', err);
    document.getElementById('campos-datos-comercio').innerHTML = `<b>Error conexión con Worker.</b>`;
    mostrarPanel('dashboard');
  }
}

/* Guardar cambios via Worker -> Apps Script */
document.addEventListener('submit', function(e){
  if(e.target && e.target.id === 'form-datos-comercio'){ e.preventDefault();
    if(!sesion || !sesion.id){ document.getElementById('msg-datos-comercio').textContent = 'Sesión no válida.'; return; }
    const fd = new FormData(e.target);
    const data = {};
    fd.forEach((v,k)=> data[k]=v);
    if(!data.__id) data.__id = sesion.id;
    debugLog('Guardar ->', data);
    const saveUrl = `${WORKER_ORIGIN}/commerce?id=${encodeURIComponent(sesion.id)}&planilla_id=${encodeURIComponent(sesion.planilla_id||'')}`;
    fetch(saveUrl, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data), mode:'cors' })
      .then(r=>r.json().catch(()=>({success:false, raw:'no json'})))
      .then(res=>{ debugLog('respuesta guardar ->', res); if(res && res.success) document.getElementById('msg-datos-comercio').textContent = '¡Datos guardados!'; else document.getElementById('msg-datos-comercio').textContent = 'Error al guardar.'; })
      .catch(err=>{ debugLog('Error guardando', err); document.getElementById('msg-datos-comercio').textContent = 'Error de conexión.'; });
  }
});
</script>
</body>
</html>
