<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Panel Comercios - Login & Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f6f7fb; min-height: 100vh; margin:0; padding:0;}
    .container { max-width: 420px; margin: 40px auto; background: #fff; border-radius: 12px; box-shadow: 0 2px 16px #0002; padding: 32px 32px 24px 32px;}
    label { display: block; margin: 16px 0 6px; font-weight: 500; }
    input, select { width: 100%; padding: 8px; margin-bottom: 10px; border-radius:5px; border:1px solid #bbb;}
    .autocomplete-list { position:absolute; background:#fff; border:1px solid #bbb; z-index:10; max-height:180px; overflow-y:auto; width:93%; }
    .autocomplete-item { padding:8px; cursor:pointer; }
    .autocomplete-item:hover { background:#e7f7fd; }
    .hidden { display: none; }
    .success { color: #060; font-weight:bold; }
    .error { color: #c00; }
    button { margin-top: 18px; padding: 12px 0; width: 100%; font-size: 1.1em; border-radius:7px; border:1px solid #2a8; background:#3dc879; color:#fff; font-weight:bold;}
    .link { color: #3498db; cursor:pointer; text-decoration:underline; margin-top:14px; display:inline-block;}
    .panel { display: none; }
    .panel.active { display: block; }
    h2, h3 { text-align:center; }
    .info { background: #fffbe5; padding: 15px; border-radius: 8px; margin: 10px 0; color: #555; text-align: center;}
    .saludo { font-size: 1.3em; margin-bottom:16px; text-align:center;}
    .datos { background: #f6f6f6; padding: 12px; border-radius:7px; margin-bottom:10px; }
    .panel-dashboard { margin-top:20px; }
    .logout-btn { background:#e74c3c; border:1px solid #c0392b; color:#fff; margin-top:10px;}
    .panel-dashboard h3 { margin-bottom:10px; }
    .item-dato { margin-bottom:7px; }
    .panel-dashboard a { color: #3498db; text-decoration:underline; }
  </style>
</head>
<body>
  <div class="container">
    <!-- LOGIN PANEL -->
    <div id="panel-login" class="panel active">
      <h2>Ingresar a tu comercio</h2>
      <form id="login-form" autocomplete="off">
        <label>Comercio</label>
        <div style="position:relative;">
          <input type="text" id="comercio-buscar" name="comercio" placeholder="Buscá tu comercio..." required autocomplete="off">
          <div id="autocomplete-list" class="autocomplete-list hidden"></div>
        </div>
        <input type="hidden" id="comercio-id" name="comercio_id">
        <label>Clave</label>
        <input type="password" id="clave" name="clave" placeholder="Clave de acceso..." required minlength="4">
        <button type="submit">Ingresar</button>
        <div id="login-msg"></div>
      </form>
      <div style="text-align:center;">
        <span class="link" onclick="mostrarPanel('registro')">¿No tenés cuenta? Registrate</span>
      </div>
    </div>

    <!-- REGISTRO PANEL -->
    <div id="panel-registro" class="panel">
      <h2>Registrate</h2>
      <form id="register-form" autocomplete="off">
        <label>Comercio</label>
        <div style="position:relative;">
          <input type="text" id="comercio-buscar2" name="comercio_reg" placeholder="Buscá tu comercio..." required autocomplete="off">
          <div id="autocomplete-list2" class="autocomplete-list hidden"></div>
        </div>
        <input type="hidden" id="comercio-id2" name="comercio_id_reg">
        <label>Contraseña</label>
        <input type="password" id="password_reg" name="password_reg" placeholder="Elige una contraseña..." required minlength="4" autocomplete="new-password">
        <button type="submit">Crear cuenta</button>
        <div id="reg-msg"></div>
      </form>
      <div style="text-align:center;">
        <span class="link" onclick="mostrarPanel('login')">Ya tengo cuenta</span>
      </div>
    </div>

    <!-- PANEL ALTA NUEVO COMERCIO -->
    <div id="panel-nuevo-comercio" class="panel">
      <h2>Alta de nuevo comercio</h2>
      <div class="info">
        Tu comercio aún no está publicado.<br>
        <b>Completá el formulario para pedir el alta.</b><br>
        El proceso puede tardar hasta <b>48 hs hábiles</b>.<br>
        <button id="btnFormComercio">Ir al formulario de alta</button>
      </div>
      <div style="text-align:center;">
        <span class="link" onclick="mostrarPanel('login')">Volver al login</span>
      </div>
    </div>

    <!-- PANEL DASHBOARD -->
    <div id="panel-dashboard" class="panel panel-dashboard">
      <div class="saludo">¡Hola <span id="nombre-comercio"></span>!</div>
      <div class="datos">
        <div class="item-dato"><b>ID:</b> <span id="id-comercio"></span></div>
        <div class="item-dato"><b>Nombre:</b> <span id="nombre-comercio2"></span></div>
      </div>
      <h3>Zona Comercios Panel</h3>
      <div>
        <a href="https://wa.me/5492245502172?text=Hola, quiero ayuda con mi panel" target="_blank">¿Necesitás ayuda? WhatsApp Soporte</a>
      </div>
      <button class="logout-btn" id="logout-btn">Cerrar sesión</button>
    </div>
  </div>

<script>
// CONFIGURACIÓN
const SHEET_ID = "170kTZ-ViCPxPli86g-n_XMuMv1S3O0-DbGwNFGYVnjY";
const SHEET_ANUNCIANTES = "anunciantes";
const WORKER_URL = "https://login.liqkoargentina.workers.dev/login";
const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSdZDgpGMYyb5uh1xpsJCN1MzNGoSgGZ9W9EUqQqAYFdB2EyBQ/viewform";

let comercios = [];
let sesion = null;

// Cambia de panel entre login, registro, alta nuevo comercio y dashboard
function mostrarPanel(panel) {
  document.getElementById('panel-login').classList.remove('active');
  document.getElementById('panel-registro').classList.remove('active');
  document.getElementById('panel-nuevo-comercio').classList.remove('active');
  document.getElementById('panel-dashboard').classList.remove('active');
  if (panel === 'login') document.getElementById('panel-login').classList.add('active');
  else if (panel === 'registro') document.getElementById('panel-registro').classList.add('active');
  else if (panel === 'nuevo-comercio') document.getElementById('panel-nuevo-comercio').classList.add('active');
  else if (panel === 'dashboard') document.getElementById('panel-dashboard').classList.add('active');
}

// --- AUTOCOMPLETADO ---
function cargarComercios(callback) {
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${SHEET_ANUNCIANTES}`;
  fetch(url)
    .then(res => res.text())
    .then(text => {
      try {
        const json = JSON.parse(text.substr(47).slice(0, -2));
        comercios = json.table.rows.map(row => ({
          nombre: row.c[1] ? row.c[1].v : "",
          id: row.c[61] ? row.c[61].v : ""
        }));
        if (callback) callback();
      } catch (error) {
        alert("Error cargando comercios: revisá la hoja de Google y que esté pública.");
      }
    })
    .catch(() => {
      alert("No se pudo cargar la lista de comercios. Revisá tu conexión.");
    });
}

function showAutocomplete(inputEl, listEl, idEl, modoRegistro = false) {
  inputEl.addEventListener('input', function() {
    const val = this.value.trim().toLowerCase();
    listEl.innerHTML = '';
    if (val.length < 2) { listEl.classList.add('hidden'); return; }
    const matches = comercios.filter(c => c.nombre.toLowerCase().includes(val));
    matches.slice(0, 10).forEach(c => {
      const item = document.createElement('div');
      item.className = 'autocomplete-item';
      item.textContent = c.nombre;
      item.onclick = function() {
        inputEl.value = c.nombre;
        idEl.value = c.id;
        listEl.classList.add('hidden');
        // Fix: aseguramos que el campo contraseña se habilite y reciba foco si estamos en registro
        if(modoRegistro) {
          setTimeout(() => {
            document.getElementById('password_reg').disabled = false;
            document.getElementById('password_reg').focus();
          },150);
        }
      };
      listEl.appendChild(item);
    });

    // SI NO HAY NINGUN RESULTADO, MOSTRAR OPCIÓN DE REGISTRAR NUEVO COMERCIO
    if (matches.length === 0) {
      const item = document.createElement('div');
      item.style.padding = "10px";
      item.style.background = "#fffbe5";
      item.innerHTML = `
        <b>¿Tu comercio aún no está publicado?</b><br>
        <button id="btnRegistrarComercio" style="margin-top:8px;">Solicitar alta de nuevo comercio</button>
      `;
      listEl.appendChild(item);
      setTimeout(() => {
        const btn = document.getElementById('btnRegistrarComercio');
        if(btn){
          btn.onclick = function() {
            mostrarPanel('nuevo-comercio');
          };
        }
      }, 100);
    }
    listEl.classList.toggle('hidden', !matches.length && inputEl.value.length < 2);
  });
  inputEl.addEventListener('blur', function() {
    setTimeout(() => listEl.classList.add('hidden'), 200);
  });
  inputEl.addEventListener('change', function() {
    if (this.value === "") idEl.value = "";
  });
}

// --- LOGIN y REGISTRO ---
document.addEventListener('DOMContentLoaded', () => {
  cargarComercios(() => {
    showAutocomplete(
      document.getElementById('comercio-buscar'),
      document.getElementById('autocomplete-list'),
      document.getElementById('comercio-id')
    );
    showAutocomplete(
      document.getElementById('comercio-buscar2'),
      document.getElementById('autocomplete-list2'),
      document.getElementById('comercio-id2'),
      true // modoRegistro
    );
  });

  // --- SESIÓN LOCAL ---
  if(localStorage.getItem("comercio_id") && localStorage.getItem("comercio_nombre")) {
    sesion = {
      id: localStorage.getItem("comercio_id"),
      nombre: localStorage.getItem("comercio_nombre")
    };
    mostrarPanelDashboard();
  }

  // LOGIN
  document.getElementById("login-form").onsubmit = function(e) {
    e.preventDefault();
    const nombre = document.getElementById('comercio-buscar').value.trim();
    const clave = document.getElementById('clave').value.trim();
    if (!nombre) {
      document.getElementById('login-msg').innerHTML = "<span class='error'>Elegí un comercio de la lista.</span>";
      return;
    }
    document.getElementById('login-msg').innerHTML = "<span>Ingresando...</span>";
    fetch(WORKER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        accion: "login",
        nombre: nombre,
        password: clave
      })
    })
    .then(r => r.json())
    .then(res => {
      if (res.success) {
        localStorage.setItem("comercio_id", res.id);
        localStorage.setItem("comercio_nombre", res.nombre);
        sesion = { id: res.id, nombre: res.nombre };
        document.getElementById('login-msg').innerHTML = "<span class='success'>" + res.message + "</span>";
        setTimeout(() => {
          mostrarPanelDashboard();
        }, 600);
      } else {
        document.getElementById('login-msg').innerHTML = "<span class='error'>" + (res.message || "Login incorrecto") + "</span>";
      }
    })
    .catch(() => {
      document.getElementById('login-msg').innerHTML = "<span class='error'>Error de conexión.</span>";
    });
  };

  // REGISTRO
  document.getElementById("register-form").onsubmit = function(e) {
    e.preventDefault();
    const comercio = document.getElementById('comercio-buscar2').value.trim();
    const comercio_id = document.getElementById('comercio-id2').value.trim();
    const password = document.getElementById('password_reg').value.trim();
    if (!comercio_id) {
      document.getElementById('reg-msg').innerHTML = "<span class='error'>Elegí un comercio de la lista.</span>";
      return;
    }
    document.getElementById('reg-msg').innerHTML = "<span>Registrando...</span>";
    fetch(WORKER_URL, {
      method: "POST",
      body: JSON.stringify({
        accion: "registrar",
        password: password,
        comercio_id: comercio_id,
        comercio_nombre: comercio
      }),
      headers: { "Content-Type": "application/json" }
    })
    .then(r => r.json())
    .then(res => {
      if (res.success) {
        localStorage.setItem("comercio_id", comercio_id);
        localStorage.setItem("comercio_nombre", comercio);
        sesion = { id: comercio_id, nombre: comercio };
        document.getElementById('reg-msg').innerHTML = "<span class='success'>" + res.message + "</span>";
        setTimeout(() => {
          mostrarPanelDashboard();
        }, 1200);
      } else {
        document.getElementById('reg-msg').innerHTML = "<span class='error'>" + res.message + "</span>";
      }
    })
    .catch(() => {
      document.getElementById('reg-msg').innerHTML = "<span class='error'>Error de conexión.</span>";
    });
  };

  // Botón para ir al formulario de alta de comercio nuevo
  document.getElementById('btnFormComercio')?.addEventListener('click', function() {
    window.open(FORM_URL, "_blank");
  });

  // LOGOUT
  document.getElementById('logout-btn')?.addEventListener('click', function() {
    localStorage.removeItem("comercio_id");
    localStorage.removeItem("comercio_nombre");
    sesion = null;
    mostrarPanel('login');
  });
});

// Mostrar panel dashboard con datos
function mostrarPanelDashboard() {
  if (sesion && sesion.id && sesion.nombre) {
    document.getElementById('nombre-comercio').textContent = sesion.nombre;
    document.getElementById('id-comercio').textContent = sesion.id;
    document.getElementById('nombre-comercio2').textContent = sesion.nombre;
    mostrarPanel('dashboard');
  } else {
    mostrarPanel('login');
  }
}
</script>
</body>
</html>
