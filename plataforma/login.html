<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Panel Comercios - Login & Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; background: #f6f7fb; min-height: 100vh; margin:0; padding:0;}
    .container { max-width: 720px; margin: 20px auto; background: #fff; border-radius: 12px; box-shadow: 0 2px 16px #0002; padding: 24px;}
    label { display: block; margin: 12px 0 6px; font-weight: 500; }
    input, select, button { width: 100%; padding: 8px; margin-bottom: 10px; border-radius:5px; border:1px solid #bbb; box-sizing: border-box; }
    .autocomplete-list { position:absolute; background:#fff; border:1px solid #bbb; z-index:10; max-height:220px; overflow-y:auto; width:93%; }
    .autocomplete-item { padding:8px; cursor:pointer; }
    .autocomplete-item:hover { background:#e7f7fd; }
    .hidden { display: none; }
    .success { color: #060; font-weight:bold; }
    .error { color: #c00; }
    button.primary { margin-top: 10px; padding: 12px 0; font-size: 1.05em; border-radius:7px; border:1px solid #2a8; background:#3dc879; color:#fff; font-weight:bold;}
    .link { color: #3498db; cursor:pointer; text-decoration:underline; margin-top:8px; display:inline-block;}
    .panel { display: none; }
    .panel.active { display: block; }
    h2, h3 { text-align:center; }
    .info { background: #fffbe5; padding: 12px; border-radius: 8px; margin: 10px 0; color: #555; text-align: center;}
    .saludo { font-size: 1.3em; margin-bottom:16px; text-align:center;}
    .datos { background: #f6f6f6; padding: 12px; border-radius:7px; margin-bottom:10px; }
    .panel-dashboard { margin-top:20px; }
    .logout-btn { background:#e74c3c; border:1px solid #c0392b; color:#fff; margin-top:10px; padding:8px; }
    .panel-dashboard h3 { margin-bottom:10px; }
    .item-dato { margin-bottom:7px; }
    .panel-dashboard a { color: #3498db; text-decoration:underline; }
    #debug { background:#111; color:#bff; padding:10px; border-radius:6px; max-height:160px; overflow:auto; font-size:12px; margin-top:8px; white-space:pre-wrap; }
    #reportBtn { margin-top:8px; background:#2d9bf0; color:#fff; border:none; padding:10px; border-radius:6px; cursor:pointer; }
    .row { display:flex; gap:8px; }
    .col { flex:1; }
  </style>
</head>
<body>
  <div class="container">
    <!-- LOGIN PANEL -->
    <div id="panel-login" class="panel active">
      <h2>Ingresar a tu comercio</h2>
      <form id="login-form" autocomplete="off">
        <label>Comercio</label>
        <div style="position:relative;">
          <input type="text" id="comercio-buscar" name="comercio" placeholder="Buscá tu comercio..." required autocomplete="off">
          <div id="autocomplete-list" class="autocomplete-list hidden"></div>
        </div>
        <input type="hidden" id="comercio-id" name="comercio_id">
        <label>Clave</label>
        <input type="password" id="clave" name="clave" placeholder="Clave de acceso..." required minlength="4" autocomplete="current-password">
        <button type="submit" id="btnLogin" class="primary" disabled>Ingresar</button>
        <div id="login-msg"></div>
        <div id="report-area" style="display:none;">
          <button id="reportBtn">Contactar Soporte (WhatsApp)</button>
        </div>
      </form>
      <div style="text-align:center;">
        <span class="link" onclick="mostrarPanel('registro')">¿No tenés cuenta? Registrate</span>
      </div>
      <div style="text-align:center; margin-top:8px;">
        <span class="link" onclick="contactSupport('consulta_anonima')">¿Querés anunciar? Consultar a soporte</span>
      </div>
    </div>

    <!-- REGISTRO / SOLICITUD ALTA PANEL -->
    <div id="panel-registro" class="panel">
      <h2>Solicitar alta o cuenta</h2>
      <div class="info">
        Si sos un anunciante nuevo: completá el formulario de alta. Si ya existís en la lista pero necesitás una cuenta o que modifiquemos datos, contactá soporte.
      </div>

      <label>Buscar comercio (si existe)</label>
      <div style="position:relative;">
        <input type="text" id="comercio-buscar2" placeholder="Buscá tu comercio..." autocomplete="off">
        <div id="autocomplete-list2" class="autocomplete-list hidden"></div>
      </div>
      <input type="hidden" id="comercio-id2">

      <div class="row">
        <div class="col">
          <button id="btnSolicitarAlta" class="primary">Solicitar Alta (Formulario)</button>
        </div>
        <div class="col">
          <button id="btnPedirCuenta" style="background:#f39c12; color:#fff; border:none; padding:10px; border-radius:6px;">Pedir Cuenta / Modificar (Soporte)</button>
        </div>
      </div>
      <div id="reg-msg"></div>

      <div style="text-align:center; margin-top:8px;">
        <span class="link" onclick="mostrarPanel('login')">Volver al login</span>
      </div>
    </div>

    <!-- PANEL ALTA NUEVO COMERCIO (sólo info) -->
    <div id="panel-nuevo-comercio" class="panel">
      <h2>Alta de nuevo comercio</h2>
      <div class="info">
        Tu comercio aún no está publicado.<br>
        <b>Completá el formulario para pedir el alta.</b><br>
        El proceso puede tardar hasta <b>48 hs hábiles</b>.<br>
        <button id="btnFormComercio">Ir al formulario de alta</button>
      </div>
      <div style="text-align:center;">
        <span class="link" onclick="mostrarPanel('login')">Volver al login</span>
      </div>
    </div>

    <!-- PANEL DASHBOARD con edición de datos -->
    <div id="panel-dashboard" class="panel panel-dashboard">
      <div class="saludo">¡Hola <span id="nombre-comercio"></span>!</div>
      <form id="form-datos-comercio">
        <div id="campos-datos-comercio"></div>
        <button type="submit" style="background:#3dc879; margin-top:16px;">Guardar cambios</button>
        <div id="msg-datos-comercio"></div>
      </form>
      <div style="margin-top:8px;">
        <a id="link-support-dashboard" href="#" target="_blank">¿Necesitás ayuda? WhatsApp Soporte</a>
      </div>
      <div style="margin-top:8px;">
        <button class="logout-btn" id="logout-btn">Cerrar sesión</button>
      </div>
    </div>

    <h3>Debug / Registros</h3>
    <div id="debug"></div>
  </div>

<script>
/* ====== CONFIG ====== */
const SHEET_ID = "170kTZ-ViCPxPli86g-n_XMuMv1S3O0-DbGwNFGYVnjY";
const SHEET_ANUNCIANTES = "anunciantes";
const WORKER_URL = "https://login.liqkoargentina.workers.dev/login";
const WORKER_ORIGIN = (new URL(WORKER_URL)).origin;
const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSdZDgpGMYyb5uh1xpsJCN1MzNGoSgGZ9W9EUqQqAYFdB2EyBQ/viewform";

/* ====== Estado ====== */
let comercios = [];
let sesion = null;
const debugEl = document.getElementById('debug');

function debugLog(...args) {
  console.log(...args);
  try {
    debugEl.textContent += Array.from(args).map(a => {
      if (typeof a === 'object') return JSON.stringify(a, null, 2);
      return String(a);
    }).join(' ') + "\n\n";
    debugEl.scrollTop = debugEl.scrollHeight;
  } catch(e){}
}

/* ====== UI helpers ====== */
function mostrarPanel(panel) {
  ['panel-login','panel-registro','panel-nuevo-comercio','panel-dashboard'].forEach(id => {
    document.getElementById(id).classList.remove('active');
  });
  const el = document.getElementById('panel-' + panel);
  if (el) el.classList.add('active');
}

function openWhatsApp(prefilledText) {
  const supportNumber = "5492245502172";
  const text = encodeURIComponent(prefilledText);
  window.open(`https://wa.me/${supportNumber}?text=${text}`, "_blank");
}

/* Habilita botón de contacto/soporte con payload */
function enableReportButton(payloadText) {
  const area = document.getElementById('report-area');
  area.style.display = 'block';
  const btn = document.getElementById('reportBtn');
  btn.onclick = function() { openWhatsApp(payloadText + "\n\nPor favor revisen. Gracias."); };
}

/* Lógica de autocompletado local basada en la planilla principal (nombre + id) */
function cargarComercios(callback) {
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${SHEET_ANUNCIANTES}`;
  fetch(url, {cache:'no-store'})
    .then(r => r.text())
    .then(text => {
      try {
        const start = text.indexOf('{');
        const end = text.lastIndexOf('}');
        const jsonText = text.slice(start, end+1);
        const json = JSON.parse(jsonText);
        const cols = (json.table && json.table.cols) ? json.table.cols.map(c => (c && c.label) ? String(c.label).toLowerCase().trim() : '') : [];
        let idxNombre = cols.findIndex(h => /nombre|comercio|title|titulo/.test(h));
        let idxId = cols.findIndex(h => /id|planilla|planilla_id|codigo/.test(h));
        if (idxNombre === -1) idxNombre = 1;
        if (idxId === -1) idxId = 61;
        comercios = (json.table.rows || []).map(row => ({
          nombre: (row.c && row.c[idxNombre] && row.c[idxNombre].v) ? row.c[idxNombre].v : '',
          id: (row.c && row.c[idxId] && row.c[idxId].v) ? row.c[idxId].v : ''
        })).filter(c => c.nombre);
        debugLog('Comercios cargados:', comercios.length);
        if (callback) callback();
      } catch(e) {
        debugLog('Error parseando Google Sheets:', e);
        if (callback) callback();
      }
    })
    .catch(err => { debugLog('Error fetch comercios:', err); if (callback) callback(); });
}

function showAutocomplete(inputEl, listEl, idEl, modoRegistro = false) {
  if(!inputEl || !listEl || !idEl) return;
  inputEl.addEventListener('input', function() {
    const val = this.value.trim().toLowerCase();
    listEl.innerHTML = '';
    if (val.length < 2) { listEl.classList.add('hidden'); idEl.value = ''; document.getElementById('btnLogin')?.setAttribute('disabled','true'); if(modoRegistro) document.getElementById('btnPedirCuenta')?.setAttribute('disabled','true'); return; }
    const matches = comercios.filter(c => c.nombre.toLowerCase().includes(val));
    if (matches.length) {
      matches.slice(0,20).forEach(c => {
        const item = document.createElement('div');
        item.className = 'autocomplete-item';
        item.textContent = c.nombre + (c.id ? (' ('+c.id+')') : '');
        item.onclick = function() {
          inputEl.value = c.nombre;
          idEl.value = c.id || '';
          listEl.classList.add('hidden');
          document.getElementById('btnLogin')?.removeAttribute('disabled');
          if(modoRegistro) { document.getElementById('btnPedirCuenta')?.removeAttribute('disabled'); }
        };
        listEl.appendChild(item);
      });
      listEl.classList.remove('hidden');
    } else {
      const item = document.createElement('div');
      item.style.padding = '10px';
      item.style.background = '#fffbe5';
      item.innerHTML = `<b>¿Tu comercio aún no está publicado?</b><br><button id="btnRegistrarComercio" style="margin-top:8px; width:100%;">Solicitar alta de nuevo comercio</button>`;
      listEl.appendChild(item);
      setTimeout(() => { const btn = document.getElementById('btnRegistrarComercio'); if(btn) btn.onclick = function(){ mostrarPanel('nuevo-comercio'); }; }, 50);
      listEl.classList.remove('hidden');
    }
  });
  inputEl.addEventListener('blur', function(){ setTimeout(()=>listEl.classList.add('hidden'),180); });
  inputEl.addEventListener('change', function(){ if (this.value === '') { idEl.value = ''; document.getElementById('btnLogin')?.setAttribute('disabled','true'); if(modoRegistro) document.getElementById('btnPedirCuenta')?.setAttribute('disabled','true'); } });
}

/* ====== LOGIN ====== */
document.addEventListener('DOMContentLoaded', () => {
  cargarComercios(() => {
    showAutocomplete(document.getElementById('comercio-buscar'), document.getElementById('autocomplete-list'), document.getElementById('comercio-id'));
    showAutocomplete(document.getElementById('comercio-buscar2'), document.getElementById('autocomplete-list2'), document.getElementById('comercio-id2'), true);
  });

  if(localStorage.getItem('comercio_id') && localStorage.getItem('comercio_nombre')) {
    sesion = { id: localStorage.getItem('comercio_id'), nombre: localStorage.getItem('comercio_nombre'), planilla_id: localStorage.getItem('planilla_id') || '' };
    mostrarPanelDashboard();
  }

  document.getElementById('login-form').onsubmit = async function(e) {
    e.preventDefault();
    document.getElementById('report-area').style.display = 'none';
    const nombre = document.getElementById('comercio-buscar').value.trim();
    const clave = document.getElementById('clave').value.trim();
    const id = document.getElementById('comercio-id').value.trim();
    if (!id && !nombre) { document.getElementById('login-msg').innerHTML = "<span class='error'>Elegí un comercio de la lista.</span>"; return; }
    document.getElementById('login-msg').innerHTML = "<span>Ingresando...</span>";

    const payloadWithId = { accion: 'login', comercio_id: id || '', nombre: nombre, password: clave };
    debugLog('POST -> WORKER_URL:', WORKER_URL, payloadWithId);

    try {
      let r = await fetch(WORKER_URL, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payloadWithId), mode: 'cors' });
      let text = await r.text();
      let res;
      try { res = JSON.parse(text); } catch(e) { res = { success:false, message: text }; }
      debugLog('Respuesta worker status:', r.status, 'body:', res);

      if (r.status === 200 && res.success) {
        localStorage.setItem('comercio_id', res.id || id);
        localStorage.setItem('comercio_nombre', res.nombre || nombre);
        if (res.planilla_id) localStorage.setItem('planilla_id', res.planilla_id);
        sesion = { id: res.id || id, nombre: res.nombre || nombre, planilla_id: res.planilla_id || localStorage.getItem('planilla_id') || '' };
        document.getElementById('login-msg').innerHTML = "<span class='success'>" + (res.message || 'Ingresado') + "</span>";
        setTimeout(()=>mostrarPanelDashboard(), 600);
        return;
      }

      // Si 401 o success false -> mostrar mensaje y permitir reporte/soporte
      const messageToShow = (res && res.message) ? res.message : 'Login falló. Ver debug.';
      document.getElementById('login-msg').innerHTML = "<span class='error'>" + messageToShow + "</span>";

      // payload para soporte con datos de diagnóstico
      const payloadText = `Solicitud de soporte - Login\nComercio: ${nombre}\nComercio_id: ${id}\nPayload enviado: ${JSON.stringify(payloadWithId)}\nRespuesta worker status: ${r.status}\nRespuesta worker body: ${JSON.stringify(res)}`;
      enableReportButton(payloadText);
      debugLog('Payload completo para soporte:', payloadText);
      return;
    } catch(err) {
      debugLog('Error fetch worker:', err);
      document.getElementById('login-msg').innerHTML = "<span class='error'>Error de conexión. Revisá consola (posible CORS o endpoint inaccesible).</span>";
      enableReportButton(`Error fetch worker: ${err}`);
    }
  };

  /* REGISTRO / SOLICITUD ALTA */
  document.getElementById('btnSolicitarAlta').addEventListener('click', function(e) {
    // Abrir formulario de Google (alta nuevo anunciante)
    window.open(FORM_URL, '_blank');
  });

  document.getElementById('btnPedirCuenta').addEventListener('click', function(e) {
    // Si hay comercio seleccionado -> pedir cuenta / modificar via WhatsApp
    const nombre = document.getElementById('comercio-buscar2').value.trim();
    const id = document.getElementById('comercio-id2').value.trim();
    if (!nombre && !id) {
      document.getElementById('reg-msg').innerHTML = "<span class='error'>Buscá tu comercio o completá el formulario de alta.</span>";
      return;
    }
    const txt = `Hola, solicito creación/activación de cuenta o modificación de datos.\nComercio: ${nombre}\nComercio_id: ${id}\nPor favor indicarnos pasos a seguir / datos necesarios. Gracias.`;
    openWhatsApp(txt);
  });

  document.getElementById('btnFormComercio')?.addEventListener('click', function(){ window.open(FORM_URL, '_blank'); });

  document.getElementById('logout-btn')?.addEventListener('click', function(){ localStorage.removeItem('comercio_id'); localStorage.removeItem('comercio_nombre'); localStorage.removeItem('planilla_id'); sesion = null; mostrarPanel('login'); });

});

/* ====== DASHBOARD (carga datos desde Worker -> Apps Script) ====== */
async function mostrarPanelDashboard() {
  if (!sesion || !sesion.id) { mostrarPanel('login'); return; }
  document.getElementById('nombre-comercio').textContent = sesion.nombre;
  debugLog('Consultando datos de comercio con id:', sesion.id);

  const encodedId = encodeURIComponent(sesion.id);
  const encodedNombre = encodeURIComponent(sesion.nombre || '');
  const encodedPlanilla = encodeURIComponent(sesion.planilla_id || '');
  const urlToWorker = `${WORKER_ORIGIN}/commerce?id=${encodedId}&nombre=${encodedNombre}&planilla_id=${encodedPlanilla}`;

  debugLog('URL -> Worker /commerce:', urlToWorker);

  try {
    const r = await fetch(urlToWorker, { method: 'GET', mode: 'cors' });
    const datos = await r.json().catch(()=>({ error: 'Respuesta inválida del worker' }));
    debugLog('Worker /commerce ->', datos);

    if (datos.error) {
      document.getElementById('campos-datos-comercio').innerHTML = `<b>Error cargando datos:</b> <span style='color:red'>${datos.error}</span><br><span style='color:#555'>Contactá soporte para asistencia.</span>`;
      mostrarPanel('dashboard');
      // prearmar link a soporte con detalle
      document.getElementById('link-support-dashboard').href = `https://wa.me/5492245502172?text=${encodeURIComponent('Ayuda panel - error cargando datos: ' + datos.error + '\nComercio: ' + sesion.nombre + '\nId: ' + sesion.id)}`;
      return;
    }

    if (datos.planilla_id && datos.planilla_id !== sesion.planilla_id) {
      sesion.planilla_id = datos.planilla_id;
      localStorage.setItem('planilla_id', datos.planilla_id);
    }

    // campos editables (mismo listado que tenías)
    const camposEditables = ["nombre","nivel","subnivel","segmento","categoria","subcategoria","tags","adicionales","pie","descripcion","direccion","lat","lng","maps","telefono","whatsapp","mail","instagram","facebook","youtube","tiktok","linkedin","logo","verificado","gold","img1","img2","img3","img4","img5","img6","link"];
    let html = '';
    camposEditables.forEach(campo => { 
      const val = datos[campo] || '';
      html += `<div><label>${campo}</label><input type="text" name="${campo}" value="${val}" autocomplete="off"/></div>`; 
    });
    // mantener id oculto
    html += `<input type="hidden" name="__id" value="${sesion.id}"/>`;
    document.getElementById('campos-datos-comercio').innerHTML = html;

    // soporte link en dashboard
    document.getElementById('link-support-dashboard').href = `https://wa.me/5492245502172?text=${encodeURIComponent('Solicito modificación de datos o consulta sobre anunciar\\nComercio: ' + sesion.nombre + '\\nId: ' + sesion.id)}`;
  } catch (err) {
    document.getElementById('campos-datos-comercio').innerHTML = `<b>Error de conexión con el Worker.</b><br><span style='color:#c00;'>${err}</span>`;
    debugLog('Error al consultar Worker /commerce:', err);
  }

  mostrarPanel('dashboard');
}

/* Guardar cambios (via Worker -> Apps Script) */
const formDatos = document.getElementById('form-datos-comercio');
if (formDatos) {
  formDatos.onsubmit = function(e) {
    e.preventDefault();
    if (!sesion || !sesion.id) { document.getElementById('msg-datos-comercio').textContent = 'Sesión no válida.'; return; }
    const formData = new FormData(e.target);
    const data = {};
    formData.forEach((v,k) => data[k] = v);
    // incluir id de sesión si no está
    if (!data.__id) data.__id = sesion.id;
    debugLog('POST -> Worker /commerce guardar (via Worker):', data);
    const saveUrl = `${WORKER_ORIGIN}/commerce?id=${encodeURIComponent(sesion.id)}&planilla_id=${encodeURIComponent(sesion.planilla_id || '')}`;
    fetch(saveUrl, { method:'POST', body: JSON.stringify(data), headers:{'Content-Type':'application/json'}, mode:'cors' })
      .then(r => r.json().catch(()=>({success:false, error:'respuesta no JSON'})))
      .then(res => { debugLog('Worker /commerce guardar ->', res); if(res && res.success) { document.getElementById('msg-datos-comercio').textContent = '¡Datos guardados!'; } else { document.getElementById('msg-datos-comercio').textContent = 'Error al guardar (ver Debug)'; } })
      .catch(err => { debugLog('Error guardando via Worker:', err); document.getElementById('msg-datos-comercio').textContent = 'Error de conexión.'; });
  };
}

/* Función pública de contacto rápido para UI */
function contactSupport(kind) {
  // kind: 'consulta_anonima', 'como_anunciar', ...
  const common = `Tipo: ${kind}\nPlataforma: panel de anunciantes\n`;
  const extra = sesion ? `Comercio: ${sesion.nombre}\nId: ${sesion.id}\n` : '';
  const text = common + extra + 'Hola, quisiera recibir información / asistencia. Gracias.';
  openWhatsApp(text);
}
</script>
</body>
</html>
