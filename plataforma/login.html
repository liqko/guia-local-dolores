<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body { font-family: Arial, sans-serif; background: #f7f7f7; margin:0; padding:0; }
      .container { max-width: 700px; margin: 30px auto; background: #fff; border-radius: 10px; box-shadow: 0 2px 12px #0002; padding: 28px 28px 12px 28px;}
      .tabs { display: flex; margin-bottom: 18px; }
      .tab {
        flex: 1; padding: 12px 0; text-align: center; cursor: pointer; background: #efefef;
        border: 1px solid #ccc; border-bottom: none; border-radius: 7px 7px 0 0;
        margin-right: 2px; transition: background .2s;
      }
      .tab.active { background: #fff; font-weight: bold; }
      .tab-content { background: #fff; border: 1px solid #ccc; border-radius: 0 0 7px 7px; padding: 22px; }
      label { display: block; margin: 14px 0 4px; font-weight: 500;}
      input, select, textarea { width: 100%; padding: 7px; margin-bottom: 8px; border-radius:4px; border:1px solid #bbb;}
      textarea { min-height: 48px;}
      .hidden { display: none; }
      .error { color: #c00; font-size: 0.95em; }
      .success { color: #060; font-size: 1.07em; margin-top: 15px;}
      button { margin-top: 18px; padding: 10px 0; width: 100%; font-size: 1.1em; border-radius:5px; border:1px solid #2a8; background:#3dc879; color:#fff; font-weight:bold;}
      .fieldset { border: 1px solid #eee; border-radius: 6px; margin-bottom: 13px; padding: 10px; }
      .fieldset legend { font-size: 1.1em; font-weight: 600; }
      .autocomplete-list { position:absolute; background:#fff; border:1px solid #bbb; z-index:10; max-height:180px; overflow-y:auto; width:100%; }
      .autocomplete-item { padding:7px; cursor:pointer; }
      .autocomplete-item:hover, .autocomplete-active { background:#e7f7fd; }
      .relative { position:relative; }
      .info { color:#666; font-size:0.93em; margin-bottom:8px;}
      .required-star { color: #d00; font-weight:bold;}
      .link-btn { color: #2a8; background: none; border: none; text-decoration: underline; cursor: pointer; font-size: 1em; margin-top: 10px;}
    </style>
  </head>
  <body>
    <div class="container">

      <!-- Pantalla de login inicial -->
      <div id="login-inicial">
        <h2>Ingresar</h2>
        <form id="form-login" autocomplete="off">
          <label>Email</label>
          <input type="email" name="email" required placeholder="Ej: tu@email.com" />
          <label>Contraseña</label>
          <input type="password" name="pass" id="pass-login" required minlength="8" placeholder="Mínimo 8 caracteres" />
          <span id="pass-error-login" class="error"></span>
          <button type="submit">Ingresar</button>
          <div id="resultado-login"></div>
        </form>
        <div style="margin-top:18px;">
          ¿No tenés cuenta?
          <button type="button" class="link-btn" id="btn-ir-registro">Crear cuenta nueva</button>
        </div>
      </div>

      <!-- Pantalla de registro (lo que ya tenías antes, oculto al inicio) -->
      <div id="registro" class="hidden">
        <div class="tabs">
          <div class="tab active" id="tab-existente">Comercio existente</div>
          <div class="tab" id="tab-nuevo">Nuevo comercio</div>
        </div>

        <!-- Pestaña 1: Comercio existente (orden modificado) -->
        <div class="tab-content" id="content-existente">
          <form id="form-existente" autocomplete="off">
            <label>Buscá tu comercio <span class="required-star">*</span></label>
            <div class="relative">
              <input type="text" id="comercio-busqueda" name="comercio_nombre" autocomplete="off" required placeholder="Escribí las primeras letras del nombre" />
              <input type="hidden" name="comercio_id" id="comercio-id" />
              <div id="autocomplete-list" class="autocomplete-list hidden"></div>
            </div>
            <!-- Mensaje de corrección debajo del campo de búsqueda -->
            <div class="info">
              Si tu comercio necesita correcciones, podrás actualizarlas luego desde tu panel.
            </div>
            <label>Nombre de usuario <span class="required-star">*</span></label>
            <input type="text" name="nombre" required placeholder="Ej: Juan Pérez" />
            <label>Email <span class="required-star">*</span></label>
            <input type="email" name="email" required placeholder="Ej: tu@email.com" />
            <!-- WhatsApp incorporado como campo principal -->
            <label>WhatsApp <span class="required-star">*</span></label>
            <input type="text" name="whatsapp" required placeholder="Ej: 2245500000"/>
            <label>Contraseña <span class="required-star">*</span></label>
            <input type="password" name="pass" id="pass-existente" required minlength="8" placeholder="Mínimo 8 caracteres" />
            <span id="pass-error-existente" class="error"></span>
            <button type="submit">Registrar usuario</button>
            <div id="resultado-existente"></div>
          </form>
        </div>

        <!-- Pestaña 2: Nuevo comercio -->
        <div class="tab-content hidden" id="content-nuevo">
          <form id="form-nuevo" autocomplete="off">
            <fieldset class="fieldset">
              <legend>Datos de usuario</legend>
              <label>Email <span class="required-star">*</span></label>
              <input type="email" name="email" required placeholder="Ej: tu@email.com" />
              <label>Nombre de usuario <span class="required-star">*</span></label>
              <input type="text" name="nombre" required placeholder="Ej: Juan Pérez" />
              <!-- WhatsApp obligatorio en el registro de usuario -->
              <label>WhatsApp <span class="required-star">*</span></label>
              <input type="text" name="whatsapp" required placeholder="Ej: 2245500000"/>
              <label>Contraseña <span class="required-star">*</span></label>
              <input type="password" name="pass" id="pass-nuevo" required minlength="8" placeholder="Mínimo 8 caracteres" />
              <span id="pass-error-nuevo" class="error"></span>
            </fieldset>
            <fieldset class="fieldset">
              <legend>Datos del comercio</legend>
              <label>nombre <span class="required-star">*</span></label>
              <input type="text" name="nombre_comercio" required placeholder="Nombre del comercio" />

              <!-- nivel y subnivel1 se envían vacíos/ocultos -->
              <input type="hidden" name="nivel" value="" />
              <input type="hidden" name="subnivel1" value="" />

              <label>rubro1 <span class="required-star">*</span></label>
              <input type="text" name="rubro1" required />
              <label>rubro2</label>
              <input type="text" name="rubro2" />
              <label>categoria <span class="required-star">*</span></label>
              <input type="text" name="categoria" required />
              <label>subcategoria1</label>
              <input type="text" name="subcategoria1" />
              <label>adicionales</label>
              <input type="text" name="adicionales" />
              <label>descripcion <span class="required-star">*</span></label>
              <textarea name="descripcion" required></textarea>
              <label>tags</label>
              <input type="text" name="tags" />
              <label>direccion <span class="required-star">*</span></label>
              <input type="text" name="direccion" required placeholder="Ej: Av. Siempre Viva 123" />
              <label>lat</label>
              <input type="text" name="lat" />
              <label>lng</label>
              <input type="text" name="lng" />
              <label>maps</label>
              <input type="text" name="maps" />
              <label>telefono <span class="required-star">*</span></label>
              <input type="text" name="telefono" required />

              <!-- Repito los campos multiples, podés ajustar si querés menos/más -->
              <label>direccion2</label>
              <input type="text" name="direccion2" />
              <label>lat2</label>
              <input type="text" name="lat2" />
              <label>lng2</label>
              <input type="text" name="lng2" />
              <label>maps2</label>
              <input type="text" name="maps2" />
              <label>telefono2</label>
              <input type="text" name="telefono2" />

              <label>direccion3</label>
              <input type="text" name="direccion3" />
              <label>lat3</label>
              <input type="text" name="lat3" />
              <label>lng3</label>
              <input type="text" name="lng3" />
              <label>maps3</label>
              <input type="text" name="maps3" />
              <label>telefono3</label>
              <input type="text" name="telefono3" />

              <label>direccion4</label>
              <input type="text" name="direccion4" />
              <label>lat4</label>
              <input type="text" name="lat4" />
              <label>lng4</label>
              <input type="text" name="lng4" />
              <label>maps4</label>
              <input type="text" name="maps4" />
              <label>telefono4</label>
              <input type="text" name="telefono4" />

              <label>direccion5</label>
              <input type="text" name="direccion5" />
              <label>lat5</label>
              <input type="text" name="lat5" />
              <label>lng5</label>
              <input type="text" name="lng5" />
              <label>maps5</label>
              <input type="text" name="maps5" />
              <label>telefono5</label>
              <input type="text" name="telefono5" />

              <label>direccion6</label>
              <input type="text" name="direccion6" />
              <label>lat6</label>
              <input type="text" name="lat6" />
              <label>lng6</label>
              <input type="text" name="lng6" />
              <label>maps6</label>
              <input type="text" name="maps6" />
              <label>telefono6</label>
              <input type="text" name="telefono6" />

              <label>whatsapp</label>
              <input type="text" name="whatsapp" />
              <label>whatsapp2</label>
              <input type="text" name="whatsapp2" />
              <label>whatsapp3</label>
              <input type="text" name="whatsapp3" />
              <label>mail</label>
              <input type="text" name="mail" />
              <label>instagram</label>
              <input type="text" name="instagram" />
              <label>facebook</label>
              <input type="text" name="facebook" />
              <label>youtube</label>
              <input type="text" name="youtube" />
              <label>logo</label>
              <input type="text" name="logo" />
              <label>verificado</label>
              <input type="text" name="verificado" />
              <label>gold</label>
              <input type="text" name="gold" />
              <label>img1</label>
              <input type="text" name="img1" />
              <label>img2</label>
              <input type="text" name="img2" />
              <label>img3</label>
              <input type="text" name="img3" />
              <label>img4</label>
              <input type="text" name="img4" />
              <label>img5</label>
              <input type="text" name="img5" />
              <label>img6</label>
              <input type="text" name="img6" />
              <label>link</label>
              <input type="text" name="link" />
            </fieldset>
            <button type="submit">Registrar usuario y comercio</button>
            <div id="resultado-nuevo"></div>
          </form>
        </div>
        <div style="margin-top:18px;">
          ¿Ya tenés cuenta?
          <button type="button" class="link-btn" id="btn-ir-login">Volver a ingresar</button>
        </div>
      </div>
    </div>

    <script>
      // ----- Cambio entre login y registro -----
      document.getElementById('btn-ir-registro').onclick = function() {
        document.getElementById('login-inicial').classList.add('hidden');
        document.getElementById('registro').classList.remove('hidden');
      };
      document.getElementById('btn-ir-login').onclick = function() {
        document.getElementById('registro').classList.add('hidden');
        document.getElementById('login-inicial').classList.remove('hidden');
      };

      // --- Tabs ---
      document.getElementById('tab-existente').onclick = function() {
        this.classList.add('active');
        document.getElementById('tab-nuevo').classList.remove('active');
        document.getElementById('content-existente').classList.remove('hidden');
        document.getElementById('content-nuevo').classList.add('hidden');
      };
      document.getElementById('tab-nuevo').onclick = function() {
        this.classList.add('active');
        document.getElementById('tab-existente').classList.remove('active');
        document.getElementById('content-nuevo').classList.remove('hidden');
        document.getElementById('content-existente').classList.add('hidden');
      };

      // --- Autocompletado de comercios ---
      let timer, lastValue = "";
      const inputBusqueda = document.getElementById('comercio-busqueda');
      const listaAuto = document.getElementById('autocomplete-list');
      const inputId = document.getElementById('comercio-id');

      inputBusqueda.addEventListener('input', function() {
        const val = this.value.trim();
        if (val.length < 2) { listaAuto.classList.add('hidden'); return; }
        clearTimeout(timer);
        timer = setTimeout(function() {
          if (val === lastValue) return;
          lastValue = val;
          google.script.run.withSuccessHandler(function(comercios) {
            listaAuto.innerHTML = "";
            if (!comercios.length) {
              listaAuto.classList.add('hidden');
              return;
            }
            comercios.forEach(function(c) {
              const item = document.createElement('div');
              item.className = 'autocomplete-item';
              item.textContent = c.nombre;
              item.onclick = function() {
                inputBusqueda.value = c.nombre;
                inputId.value = c.id;
                listaAuto.classList.add('hidden');
              };
              listaAuto.appendChild(item);
            });
            listaAuto.classList.remove('hidden');
          }).buscarComerciosPorNombre(val);
        }, 200);
      });

      inputBusqueda.addEventListener('blur', function() {
        setTimeout(() => listaAuto.classList.add('hidden'), 200);
      });

      // Extra: limpiar id si se borra el texto
      inputBusqueda.addEventListener('change', function() {
        if (this.value === "") inputId.value = "";
      });

      // --- Validación de contraseña ---
      function validaPass(passEl, errEl) {
        passEl.addEventListener('input', function() {
          if(this.value.length < 8) {
            errEl.textContent = "La contraseña debe tener al menos 8 caracteres.";
          } else {
            errEl.textContent = "";
          }
        });
      }
      validaPass(document.getElementById('pass-existente'), document.getElementById('pass-error-existente'));
      validaPass(document.getElementById('pass-nuevo'), document.getElementById('pass-error-nuevo'));
      validaPass(document.getElementById('pass-login'), document.getElementById('pass-error-login'));

      // --- Enviar formulario login ---
      document.getElementById('form-login').onsubmit = function(e) {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(this));
        if(data.pass.length < 8) {
          document.getElementById('pass-error-login').textContent = "La contraseña debe tener al menos 8 caracteres.";
          return;
        }
        document.getElementById('resultado-login').textContent = "Ingresando...";
        google.script.run.withSuccessHandler(function(msg) {
          document.getElementById('resultado-login').innerHTML = msg.success
            ? '<span class="success">'+msg.message+'</span>'
            : '<span class="error">'+msg.message+'</span>';
        }).loginUsuario(data);
      };

      // --- Enviar formulario comercio existente ---
      document.getElementById('form-existente').onsubmit = function(e) {
        e.preventDefault();
        if(!inputId.value) {
          alert("Debés elegir un comercio de la lista desplegable.");
          return;
        }
        var data = Object.fromEntries(new FormData(this));
        if(data.pass.length < 8) {
          document.getElementById('pass-error-existente').textContent = "La contraseña debe tener al menos 8 caracteres.";
          return;
        }
        document.getElementById('resultado-existente').textContent = "Registrando...";
        google.script.run.withSuccessHandler(function(msg) {
          document.getElementById('resultado-existente').innerHTML = '<span class="success">'+msg+'</span>';
        }).registrarUsuarioComercioExistente(data);
      };

      // --- Enviar formulario nuevo comercio ---
      document.getElementById('form-nuevo').onsubmit = function(e) {
        e.preventDefault();
        var data = Object.fromEntries(new FormData(this));
        if(data.pass.length < 8) {
          document.getElementById('pass-error-nuevo').textContent = "La contraseña debe tener al menos 8 caracteres.";
          return;
        }
        document.getElementById('resultado-nuevo').textContent = "Registrando...";
        google.script.run.withSuccessHandler(function(msg) {
          document.getElementById('resultado-nuevo').innerHTML = '<span class="success">'+msg+'</span>';
        }).registrarUsuarioNuevoComercio(data);
      };
    </script>
  </body>
</html>
