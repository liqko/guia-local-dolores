<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body { font-family: Arial, sans-serif; background: #f7f7f7; }
      .tabs { display: flex; margin-bottom: 18px; }
      .tab {
        flex: 1; padding: 12px 0; text-align: center; cursor: pointer; background: #efefef;
        border: 1px solid #ccc; border-bottom: none; border-radius: 7px 7px 0 0;
        margin-right: 2px; transition: background .2s;
      }
      .tab.active { background: #fff; font-weight: bold; }
      .tab-content { background: #fff; border: 1px solid #ccc; border-radius: 0 0 7px 7px; padding: 22px; }
      label { display: block; margin: 12px 0 4px; }
      input, select, textarea { width: 100%; padding: 7px; }
      .hidden { display: none; }
      .error { color: #c00; font-size: 0.95em; }
      .success { color: #060; font-size: 1.07em; margin-top: 15px;}
      button { margin-top: 18px; padding: 9px 0; width: 100%; font-size: 1.1em; }
      .fieldset { border: 1px solid #eee; border-radius: 6px; margin-bottom: 13px; padding: 10px; }
      .fieldset legend { font-size: 1.1em; font-weight: 600; }
    </style>
  </head>
  <body>
    <div class="tabs">
      <div class="tab active" id="tab-existente">Comercio existente</div>
      <div class="tab" id="tab-nuevo">Nuevo comercio</div>
    </div>

    <!-- Pestaña 1: Comercio existente -->
    <div class="tab-content" id="content-existente">
      <form id="form-existente">
        <label>Email:</label>
        <input type="email" name="email" required />
        <label>Nombre de usuario:</label>
        <input type="text" name="nombre" required />
        <label>Contraseña:</label>
        <input type="password" name="pass" id="pass-existente" required minlength="8" />
        <span id="pass-error-existente" class="error"></span>
        <label>Seleccioná tu comercio:</label>
        <select name="comercio_id" id="comercio-existente-select" required>
          <option value="">-- Elegir comercio --</option>
        </select>
        <div style="font-size:.93em; color:#666; margin-top:3px;">
          Si tu comercio necesita correcciones, podrás actualizarlas luego desde tu panel.
        </div>
        <button type="submit">Registrar usuario</button>
        <div id="resultado-existente"></div>
      </form>
    </div>

    <!-- Pestaña 2: Nuevo comercio -->
    <div class="tab-content hidden" id="content-nuevo">
      <form id="form-nuevo">

        <fieldset class="fieldset">
          <legend>Datos de usuario</legend>
          <label>Email:</label>
          <input type="email" name="email" required />
          <label>Nombre de usuario:</label>
          <input type="text" name="nombre" required />
          <label>Contraseña:</label>
          <input type="password" name="pass" id="pass-nuevo" required minlength="8" />
          <span id="pass-error-nuevo" class="error"></span>
        </fieldset>

        <fieldset class="fieldset">
          <legend>Datos del comercio</legend>
          <label>nombre:</label>
          <input type="text" name="nombre_comercio" required />
          <label>nivel:</label>
          <input type="text" name="nivel" />
          <label>subnivel1:</label>
          <input type="text" name="subnivel1" />
          <label>rubro1:</label>
          <input type="text" name="rubro1" />
          <label>rubro2:</label>
          <input type="text" name="rubro2" />
          <label>categoria:</label>
          <input type="text" name="categoria" />
          <label>subcategoria1:</label>
          <input type="text" name="subcategoria1" />
          <label>adicionales:</label>
          <input type="text" name="adicionales" />
          <label>descripcion:</label>
          <textarea name="descripcion"></textarea>
          <label>tags:</label>
          <input type="text" name="tags" />
          <label>direccion:</label>
          <input type="text" name="direccion" />
          <label>lat:</label>
          <input type="text" name="lat" />
          <label>lng:</label>
          <input type="text" name="lng" />
          <label>maps:</label>
          <input type="text" name="maps" />
          <label>telefono:</label>
          <input type="text" name="telefono" />

          <label>direccion2:</label>
          <input type="text" name="direccion2" />
          <label>lat2:</label>
          <input type="text" name="lat2" />
          <label>lng2:</label>
          <input type="text" name="lng2" />
          <label>maps2:</label>
          <input type="text" name="maps2" />
          <label>telefono2:</label>
          <input type="text" name="telefono2" />

          <label>direccion3:</label>
          <input type="text" name="direccion3" />
          <label>lat3:</label>
          <input type="text" name="lat3" />
          <label>lng3:</label>
          <input type="text" name="lng3" />
          <label>maps3:</label>
          <input type="text" name="maps3" />
          <label>telefono3:</label>
          <input type="text" name="telefono3" />

          <label>direccion4:</label>
          <input type="text" name="direccion4" />
          <label>lat4:</label>
          <input type="text" name="lat4" />
          <label>lng4:</label>
          <input type="text" name="lng4" />
          <label>maps4:</label>
          <input type="text" name="maps4" />
          <label>telefono4:</label>
          <input type="text" name="telefono4" />

          <label>direccion5:</label>
          <input type="text" name="direccion5" />
          <label>lat5:</label>
          <input type="text" name="lat5" />
          <label>lng5:</label>
          <input type="text" name="lng5" />
          <label>maps5:</label>
          <input type="text" name="maps5" />
          <label>telefono5:</label>
          <input type="text" name="telefono5" />

          <label>direccion6:</label>
          <input type="text" name="direccion6" />
          <label>lat6:</label>
          <input type="text" name="lat6" />
          <label>lng6:</label>
          <input type="text" name="lng6" />
          <label>maps6:</label>
          <input type="text" name="maps6" />
          <label>telefono6:</label>
          <input type="text" name="telefono6" />

          <label>whatsapp:</label>
          <input type="text" name="whatsapp" />
          <label>whatsapp2:</label>
          <input type="text" name="whatsapp2" />
          <label>whatsapp3:</label>
          <input type="text" name="whatsapp3" />
          <label>mail:</label>
          <input type="text" name="mail" />
          <label>instagram:</label>
          <input type="text" name="instagram" />
          <label>facebook:</label>
          <input type="text" name="facebook" />
          <label>youtube:</label>
          <input type="text" name="youtube" />
          <label>logo:</label>
          <input type="text" name="logo" />
          <label>verificado:</label>
          <input type="text" name="verificado" />
          <label>gold:</label>
          <input type="text" name="gold" />
          <label>img1:</label>
          <input type="text" name="img1" />
          <label>img2:</label>
          <input type="text" name="img2" />
          <label>img3:</label>
          <input type="text" name="img3" />
          <label>img4:</label>
          <input type="text" name="img4" />
          <label>img5:</label>
          <input type="text" name="img5" />
          <label>img6:</label>
          <input type="text" name="img6" />
          <label>link:</label>
          <input type="text" name="link" />
        </fieldset>
        <button type="submit">Registrar usuario y comercio</button>
        <div id="resultado-nuevo"></div>
      </form>
    </div>

    <script>
      // Pestañas:
      document.getElementById('tab-existente').onclick = function() {
        this.classList.add('active');
        document.getElementById('tab-nuevo').classList.remove('active');
        document.getElementById('content-existente').classList.remove('hidden');
        document.getElementById('content-nuevo').classList.add('hidden');
      };
      document.getElementById('tab-nuevo').onclick = function() {
        this.classList.add('active');
        document.getElementById('tab-existente').classList.remove('active');
        document.getElementById('content-nuevo').classList.remove('hidden');
        document.getElementById('content-existente').classList.add('hidden');
      };

      // Llenar selector comercio desde la hoja "1"
      window.onload = function() {
        google.script.run.withSuccessHandler(function(comercios) {
          var select = document.getElementById('comercio-existente-select');
          comercios.forEach(function(c) {
            var opt = document.createElement('option');
            opt.value = c.id; // el id REAL de la hoja 1
            opt.textContent = c.nombre;
            select.appendChild(opt);
          });
        }).getComerciosDesdeHoja1();
      };

      // Validación de contraseña (ambas pestañas)
      function validaPass(passEl, errEl) {
        passEl.addEventListener('input', function() {
          if(this.value.length < 8) {
            errEl.textContent = "La contraseña debe tener al menos 8 caracteres.";
          } else {
            errEl.textContent = "";
          }
        });
      }
      validaPass(document.getElementById('pass-existente'), document.getElementById('pass-error-existente'));
      validaPass(document.getElementById('pass-nuevo'), document.getElementById('pass-error-nuevo'));

      // Enviar formulario comercio existente
      document.getElementById('form-existente').onsubmit = function(e) {
        e.preventDefault();
        var data = Object.fromEntries(new FormData(this));
        if(data.pass.length < 8) {
          document.getElementById('pass-error-existente').textContent = "La contraseña debe tener al menos 8 caracteres.";
          return;
        }
        document.getElementById('resultado-existente').textContent = "Registrando...";
        google.script.run.withSuccessHandler(function(msg) {
          document.getElementById('resultado-existente').innerHTML = '<span class="success">'+msg+'</span>';
        }).registrarUsuarioComercioExistente(data);
      };

      // Enviar formulario nuevo comercio
      document.getElementById('form-nuevo').onsubmit = function(e) {
        e.preventDefault();
        var data = Object.fromEntries(new FormData(this));
        if(data.pass.length < 8) {
          document.getElementById('pass-error-nuevo').textContent = "La contraseña debe tener al menos 8 caracteres.";
          return;
        }
        document.getElementById('resultado-nuevo').textContent = "Registrando...";
        google.script.run.withSuccessHandler(function(msg) {
          document.getElementById('resultado-nuevo').innerHTML = '<span class="success">'+msg+'</span>';
        }).registrarUsuarioNuevoComercio(data);
      };
    </script>
  </body>
</html>
