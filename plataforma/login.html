<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Panel Comercios - Login & Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f6f7fb;margin:0;padding:0}
    .container{max-width:980px;margin:20px auto;background:#fff;border-radius:12px;box-shadow:0 2px 16px #0002;padding:24px}
    label{display:block;margin:12px 0 6px;font-weight:500}
    input,button,textarea,select{width:100%;padding:8px;margin-bottom:10px;border-radius:5px;border:1px solid #bbb;box-sizing:border-box}
    .autocomplete-list{position:absolute;background:#fff;border:1px solid #bbb;z-index:10;max-height:220px;overflow-y:auto;width:93%}
    .autocomplete-item{padding:8px;cursor:pointer}
    .autocomplete-item:hover{background:#e7f7fd}
    .hidden{display:none}
    .hidden-panel{display:none}
    .success{color:#060;font-weight:bold}
    .error{color:#c00}
    button.primary{margin-top:10px;padding:12px 0;font-size:1.05em;border-radius:7px;background:#3dc879;color:#fff;border:1px solid #2a8}
    .link{color:#3498db;cursor:pointer;text-decoration:underline;display:inline-block;margin-top:8px}
    .panel{display:none}
    .panel.active{display:block}
    #debug{background:#111;color:#bff;padding:10px;border-radius:6px;max-height:160px;overflow:auto;font-size:12px;margin-top:8px;white-space:pre-wrap}
    .blocked { background:#f4f6f4; border:1px solid #dfe8df; }
    .info-banner{background:#fffbe5;border:1px solid #f5c26b;padding:10px;border-radius:6px;margin-top:8px}
    .small-muted{font-size:0.95em;color:#555}
    .small-warning{font-size:0.9em;color:#a33;margin-top:6px}
    .muted-note{font-size:0.95em;color:#444;margin-top:6px}

    /* Promos */
    .box{border:1px solid #ddd;padding:12px;border-radius:6px;margin-bottom:12px;background:#fafafa}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:left;vertical-align:top}
    tr:hover{background:#f7f7f7}
    .actions button{padding:6px 8px;margin-right:6px}
    .msg{padding:8px;border-radius:6px;margin-bottom:12px}
    .ok{background:#e6ffed;border:1px solid #b7f0c6}
    .err{background:#ffecec;border:1px solid #fabbbb}
    .secondary{background:#666;color:#fff;border:0;padding:8px 12px;border-radius:6px;cursor:pointer}
    .spinner{display:inline-block;width:16px;height:16px;border:2px solid #ccc;border-top-color:#333;border-radius:50%;animation:spin .8s linear infinite;margin-left:8px;vertical-align:middle}
    @keyframes spin{to{transform:rotate(360deg)}}
    .promos-row-controls { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .promo-input { flex:1; min-width:160px; }
    .promo-select { width:220px; min-width:140px; }

    /* Tabs */
    .tabs { display:flex; gap:8px; margin-bottom:12px; align-items:center; flex-wrap:wrap; }
    .tab { padding:8px 14px; border-radius:8px; cursor:pointer; background:#f0f0f0; border:1px solid #e0e0e0; color:#333; font-weight:600; }
    .tab.tab-active { background:#3dc879; color:#fff; border-color:#2a8; }
    .panel-section { padding:6px 0 0 0; }

    /* Hide promo_id column */
    #promos-list table th:nth-child(5), #promos-list table td:nth-child(5) { display:none; }
    #promos-list table td:nth-child(6), #promos-list table th:nth-child(6) { white-space:normal; max-width:420px; word-wrap:break-word; }
    #promos-list table td:last-child { text-align:right; width:140px; }
    #promos-list table td:last-child button { display:block; width:90px; margin:8px auto; }
    #promos-list table td { padding-top:14px; padding-bottom:14px; }

    /* Support button */
    #btnContactSupportData {
      background: #e74c3c;
      color: #fff;
      border: none;
      padding: 12px;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      width:100%;
      text-align:center;
    }

    /* Events UI */
    .events-card{margin-top:8px;background:#fbfbff;border:1px solid #e6e8ff;padding:10px;border-radius:6px}
    .events-grid { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .events-grid .full { grid-column: 1 / -1; }
    .events-actions { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .events-actions button { width:auto; padding:10px 14px; }
    .events-small { font-size:12px; color:#444; }

    .req { color:#c00; font-weight:700; margin-left:4px; }

    /* ===== Mobile-first improvements (NO cambia lógica) ===== */
    .tabs { position: sticky; top: 0; z-index: 50; padding: 10px 0; background: #fff; }
    .tab { user-select:none; -webkit-tap-highlight-color: transparent; }

    /* Cards (mobile lists) */
    .card-list{display:flex;flex-direction:column;gap:10px}
    .card{
      border:1px solid #e9e9e9;
      background:#fff;
      border-radius:12px;
      padding:12px;
      box-shadow:0 1px 8px #0001;
    }
    .card-title{font-weight:800;margin-bottom:6px}
    .card-meta{display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:0.95em;color:#333}
    .card-meta .full{grid-column:1/-1}
    .card-actions{display:flex;flex-direction:column;gap:8px;margin-top:10px}
    .card-actions button{width:100%;padding:12px;border-radius:10px}

    @media (max-width:720px) {
      .container{margin:0 auto;border-radius:0;box-shadow:none;padding:14px}
      h2,h3{margin-top:8px}
      .tabs{gap:6px}
      .tab{flex:1;text-align:center;padding:10px 8px}
      .promos-row-controls { flex-direction:column; align-items:stretch; }
      .promo-select { width:100%; }

      /* En mobile NO usamos tabla "bloqueada": usamos cards */
      #promos-list table, #eventos-list table { display:none !important; }
      #promos-list .card-list, #eventos-list .card-list { display:flex; }

      /* Botones en acciones (tabla desktop) no afecta mobile porque tabla se oculta */
      .events-grid { grid-template-columns: 1fr; }
      .events-actions button { width:100%; }
    }

    /* Desktop: ocultar cards */
    @media (min-width:721px){
      #promos-list .card-list, #eventos-list .card-list { display:none !important; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="panel-login" class="panel active">
      <h2>Ingresar a tu comercio</h2>
      <form id="login-form" autocomplete="off">
        <label>Comercio</label>
        <div style="position:relative;">
          <input type="text" id="comercio-buscar" placeholder="Buscá tu comercio..." autocomplete="off" required>
          <div id="autocomplete-list" class="autocomplete-list hidden"></div>
        </div>
        <input type="hidden" id="comercio-id">
        <label>Clave</label>
        <input type="password" id="clave" placeholder="Clave..." required minlength="1">
        <button id="btnLogin" class="primary" disabled>Ingresar</button>

        <div id="login-msg"></div>
        <div id="level-warning" class="small-muted"></div>

        <div id="create-commerce-banner" class="info-banner">
          <strong>¿Tu anuncio no aparece en la guía?</strong>
          <div class="small-muted">Si tu comercio, servicio u organización no figura en la guía, completá el formulario para solicitar la creación del anuncio. Esto publica el anuncio y el equipo técnico asignará el nivel correspondiente.</div>
          <button id="btnCrearComercio" style="margin-top:8px;width:100%;">Solicitar creación de anuncio (formulario)</button>
          <div class="small-warning">Importante: Crear/publicar el anuncio es distinto de generar la contraseña de acceso. Las cuentas sólo pueden generarse para anunciantes con nivel permitido (1, 2 o 5 y superiores). Para otras consultas contactá a soporte.</div>
        </div>

        <div id="report-area" style="display:none;">
          <button id="reportBtn">Contactar Soporte (WhatsApp)</button>
        </div>
      </form>

      <div style="text-align:center;margin-top:8px;">
        <span class="link" onclick="mostrarPanel('registro')">¿Necesitás generar tu contraseña? Ir a Generar contraseña</span>
      </div>
    </div>

    <div id="panel-registro" class="panel">
      <h2>Generar contraseña / Registrar acceso</h2>
      <p class="muted-note">
        Este flujo sirve para generar la contraseña directamente para un anunciante que ya tiene su anuncio cargado en la guía.
        Si tu anuncio NO está en la guía, volvé al apartado "Ingresar" y solicitá la creación del anuncio mediante el formulario.
      </p>

      <label>Buscar anuncio (seleccioná el anuncio ya publicado)</label>
      <div style="position:relative;">
        <input type="text" id="comercio-buscar2" placeholder="Buscá tu comercio..." autocomplete="off">
        <div id="autocomplete-list2" class="autocomplete-list hidden"></div>
      </div>
      <input type="hidden" id="comercio-id2">

      <label>Contraseña</label>
      <input type="password" id="nueva-clave" placeholder="Ingresá la nueva contraseña (mínimo 4 caracteres)" minlength="4" disabled>
      <label>Confirmar contraseña</label>
      <input type="password" id="nueva-clave-confirm" placeholder="Repetí la contraseña" minlength="4" disabled>

      <div style="display:flex;gap:8px;">
        <button id="btnGenerarClave" class="primary" style="flex:1" disabled>Generar y registrar contraseña</button>
      </div>

      <div id="reg-msg"></div>

      <div style="text-align:center;margin-top:8px;">
        <span class="link" onclick="mostrarPanel('login')">Volver al login</span>
      </div>

      <div style="margin-top:10px" class="small-muted">
        Nota técnica: cuando generes la contraseña aquí, el sistema intentará registrarla automáticamente en la hoja "anunciantes" en la columna BG (encabezado "clave"). Si preferís que el equipo la registre manualmente o necesitás soporte, contactá a soporte por WhatsApp.
      </div>
    </div>

    <div id="panel-dashboard" class="panel">
      <div style="font-size:1.2em;margin-bottom:10px">¡Hola <span id="nombre-comercio"></span>!</div>

      <div class="tabs" role="tablist" aria-label="Secciones">
        <div id="tab-datos" class="tab tab-active" role="tab" aria-selected="true">Datos</div>
        <div id="tab-promos" class="tab" role="tab" aria-selected="false">Promos</div>
        <div id="tab-eventos" class="tab" role="tab" aria-selected="false">Eventos</div>
      </div>

      <div class="panel-section">
        <!-- Datos -->
        <div id="datos-panel">
          <h3>Datos del Anunciante</h3>
          <form id="form-datos-comercio">
            <div id="campos-datos-comercio"></div>
            <button id="btnContactSupportData" type="button">SI NECESITAS HACER CAMBIOS EN TUS DATOS, CONTACTA A SOPORTE</button>
            <div id="msg-datos-comercio"></div>
          </form>
        </div>

        <!-- Promos -->
        <div id="promos-panel" class="hidden-panel" style="margin-top:18px;border-top:1px solid #eee;padding-top:12px">
          <h3>Promos / Ofertas</h3>
          <div id="promos-status" class="small-muted">Cargando promos...</div>

          <div style="margin-top:8px;background:#fbfbff;border:1px solid #e6e8ff;padding:10px;border-radius:6px">
            <div class="promos-row-controls">
              <input id="promo-text" class="promo-input" type="text" placeholder="Texto de la promo (ej: 10% OFF)" />
              <select id="promo-categoria" class="promo-select" aria-label="Categoría de la promo">
                <option value="">Categoría de la promo</option>
              </select>
              <input id="promo-desde" type="date" style="width:140px" />
              <input id="promo-hasta" type="date" style="width:140px" />
              <input id="promo-otros" class="promo-input" type="text" placeholder="Descripción (ej: Hasta agotar stock 50 unidades)" style="max-width:300px" />

              <button id="promo-create" style="min-width:140px">Crear promo</button>
              <button id="promo-cancel" class="secondary" style="min-width:140px">Cancelar edición</button>
              <button id="promo-refresh" class="secondary" style="min-width:120px">Refrescar lista</button>
            </div>

            <div id="promos-msg" style="margin-top:8px"></div>
          </div>

          <div id="promos-list" style="margin-top:12px">Cargando promos...</div>
        </div>

        <!-- Eventos -->
        <div id="eventos-panel" class="hidden-panel" style="margin-top:18px;border-top:1px solid #eee;padding-top:12px">
          <h3>Eventos</h3>
          <div class="events-small" style="margin-top:6px">
            Cargá tu evento para que aparezca publicado en la guía.
          </div>

          <div id="eventos-status" class="small-muted" style="margin-top:8px">Cargando eventos...</div>

          <div class="events-card">
            <div class="events-grid">
              <div class="full">
                <label>Nombre del evento <span class="req">*</span></label>
                <input id="ev-nombre_evento" type="text" placeholder="Nombre del evento" />
              </div>

              <div>
                <label>Categoría <span class="req">*</span></label>
                <select id="ev-categoria"><option value="">Seleccioná una categoría</option></select>
              </div>

              <div>
                <label>Localidad <span class="req">*</span></label>
                <select id="ev-localidad"><option value="">Seleccioná la localidad</option></select>
              </div>

              <div class="full">
                <label>Lugar <span class="req">*</span></label>
                <select id="ev-lugar"><option value="">Seleccioná un lugar</option></select>
                <div class="events-small">Si elegís un lugar, se completa dirección y cómo llegar automáticamente.</div>
              </div>

              <div class="full">
                <label>Dirección (auto)</label>
                <input id="ev-direccion" type="text" placeholder="(se completa solo si elegís un lugar)" disabled />
              </div>

              <div class="full">
                <label>Cómo llegar (auto)</label>
                <input id="ev-llegar" type="text" placeholder="(se completa solo si elegís un lugar)" disabled />
              </div>

              <div class="full">
                <label>Descripción</label>
                <textarea id="ev-descripcion" rows="3" placeholder="Descripción del evento"></textarea>
              </div>

              <div>
                <label>Fecha <span class="req">*</span></label>
                <input id="ev-fecha" type="date" />
              </div>

              <div>
                <label>Hora</label>
                <input id="ev-hora" type="time" />
              </div>

              <div>
                <label>Hora 2 / detalle horario</label>
                <input id="ev-hora2" type="text" placeholder="Ej: A partir de las 14 hs, desde las 20 hs, etc." />
              </div>

              <div>
                <label>Instagram</label>
                <input id="ev-instagram" type="text" placeholder="@usuario o link (si aplica)" />
              </div>

              <div class="full">
                <label>Entradas</label>
                <input id="ev-entradas" type="text" placeholder="Link o texto sobre entradas (si corresponde)" />
              </div>

              <div class="full"><label>Imagen 1 (URL)</label><input id="ev-img1" type="text" placeholder="https://... (si tenés imagen)" /></div>
              <div class="full"><label>Imagen 2 (URL)</label><input id="ev-img2" type="text" placeholder="https://... (opcional)" /></div>
              <div class="full"><label>Imagen 3 (URL)</label><input id="ev-img3" type="text" placeholder="https://... (opcional)" /></div>

              <div><label>Partner 1</label><select id="ev-partner"><option value="">Seleccioná un partner (opcional)</option></select></div>
              <div><label>Partner 2</label><select id="ev-partner2"><option value="">Seleccioná un partner (opcional)</option></select></div>
              <div><label>Partner 3</label><select id="ev-partner3"><option value="">Seleccioná un partner (opcional)</option></select></div>
              <div><label>Partner 4</label><select id="ev-partner4"><option value="">Seleccioná un partner (opcional)</option></select></div>
              <div><label>Partner 5</label><select id="ev-partner5"><option value="">Seleccioná un partner (opcional)</option></select></div>
              <div><label>Partner 6</label><select id="ev-partner6"><option value="">Seleccioná un partner (opcional)</option></select></div>

              <div class="full events-actions">
                <button id="ev-create" class="primary" type="button">Crear evento</button>
                <button id="ev-cancel" class="secondary" type="button">Cancelar edición</button>
                <button id="ev-refresh" class="secondary" type="button">Refrescar lista</button>
              </div>

              <div class="full"><div id="eventos-msg"></div></div>
            </div>
          </div>

          <div id="eventos-list" style="margin-top:12px">Cargando eventos...</div>
        </div>
      </div>

      <div style="margin-top:10px">
        <a id="link-support_dashboard" href="#" target="_blank">WhatsApp Soporte</a>
      </div>
      <div style="margin-top:8px">
        <button id="logout-btn" style="background:#e74c3c;color:#fff;border:none;padding:8px;border-radius:6px">Cerrar sesión</button>
      </div>
    </div>

    <h3>Debug / Registros</h3>
    <div id="debug"></div>
  </div>

<script>
/* === CONFIG === */
const WORKER_URL = "https://login.liqkoargentina.workers.dev/login";
const WORKER_ORIGIN = (new URL(WORKER_URL)).origin;
const WORKER_COMMERCE_URL = WORKER_ORIGIN + '/commerce';
const WORKER_EVENTS_URL = WORKER_ORIGIN + '/events';

const SHEET_ID = "170kTZ-ViCPxPli86g-n_XMuMv1S3O0-DbGwNFGYVnjY";
const EVENTS_SHEET_ID = "1CCNDvrIFFufiLXmYkm4YcmtZVpk6rG2gJQQYXzA186o";
const PROMOS_SHEET_ID = "1ffyftdylRAiS97L2Fy6xhPT3A876qeXXCaPI3SUFI-s";
const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSdZDgpGMYyb5uh1xpsJCN1MzNGoSgGZ9W9EUqQqAYFdB2EyBQ/viewform";
/* ================= */

const SUPPORT_NUMBER = "5492245459957";

let comercios = [];
let sesion = null;
let evLists = { categorias: [], localidades: [], lugares: [], partners: [] };
let editingEventId = null;

// ✅ Promos: edición sin prompts
let editingPromoId = null;

const debugEl = document.getElementById('debug');
function debugLog(...args){ console.log(...args); try { debugEl.textContent += args.map(a=>typeof a==='object'?JSON.stringify(a,null,2):String(a)).join(' ') + "\n\n"; debugEl.scrollTop = debugEl.scrollHeight; }catch(e){} }

function mostrarPanel(panel){ ['panel-login','panel-registro','panel-dashboard'].forEach(id=>document.getElementById(id).classList.remove('active')); document.getElementById('panel-'+panel)?.classList.add('active'); }
function openWhatsApp(text){ window.open(`https://wa.me/${SUPPORT_NUMBER}?text=${encodeURIComponent(text)}`,'_blank'); }

function parseLevel(levelStr){
  if(levelStr===undefined || levelStr===null) return NaN;
  const s = String(levelStr).trim().replace(',', '.');
  const m = s.match(/^(\d+(\.\d+)?)/);
  return m ? parseFloat(m[1]) : NaN;
}
function isAllowedLevel(levelStr){
  const n = parseLevel(levelStr);
  if(isNaN(n)) return false;
  return n === 1 || n === 2 || n >= 5;
}

/* GViz helpers */
function _cellToString(cell){
  if(cell === undefined || cell === null) return '';
  if(typeof cell === 'object' && 'v' in cell) return String(cell.v).trim();
  return String(cell).trim();
}
function gvizFetch(sheetId, sheetName){
  const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
  return fetch(url, { cache:'no-store' })
    .then(r=>r.text())
    .then(text=>{
      const start=text.indexOf('{'), end=text.lastIndexOf('}');
      if(start === -1 || end === -1) throw new Error('GViz inesperado');
      const jsonText=text.slice(start,end+1);
      return JSON.parse(jsonText);
    });
}
function gvizGetHeaders(json){
  const cols = (json && json.table && Array.isArray(json.table.cols)) ? json.table.cols : [];
  return cols.map(c => (c && c.label) ? String(c.label).toLowerCase().trim() : '');
}
function gvizGetRows(json){
  return (json && json.table && Array.isArray(json.table.rows)) ? json.table.rows : [];
}

/* === FECHA/HORA === */
function isIsoZ(s){ return typeof s === 'string' && /Z$/.test(s); }

function toDateInputValue(v){
  if(v === undefined || v === null) return '';
  const s = String(v).trim();
  if(!s) return '';
  if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
  const mIso = s.match(/^(\d{4}-\d{2}-\d{2})[ T]/);
  if(mIso) return mIso[1];
  const mLat = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
  if(mLat){
    const dd = String(mLat[1]).padStart(2,'0');
    const mm = String(mLat[2]).padStart(2,'0');
    const yy = mLat[3];
    return `${yy}-${mm}-${dd}`;
  }
  const d = new Date(s);
  if(!isNaN(d.getTime())){
    const yy = isIsoZ(s) ? d.getUTCFullYear() : d.getFullYear();
    const mm = String((isIsoZ(s) ? d.getUTCMonth() : d.getMonth()) + 1).padStart(2,'0');
    const dd = String(isIsoZ(s) ? d.getUTCDate() : d.getDate()).padStart(2,'0');
    return `${yy}-${mm}-${dd}`;
  }
  return '';
}

function toTimeInputValue(v){
  if(v === undefined || v === null) return '';
  const s0 = String(v).trim();
  if(!s0) return '';

  const m = s0.match(/^\s*(\d{1,2}):(\d{2})(?::\d{2})?\s*$/);
  if(m){
    const hh = String(m[1]).padStart(2,'0');
    const mm = m[2];
    return `${hh}:${mm}`;
  }

  const d = new Date(s0);
  if(!isNaN(d.getTime())){
    const hh = String(isIsoZ(s0) ? d.getUTCHours() : d.getHours()).padStart(2,'0');
    const mm = String(isIsoZ(s0) ? d.getUTCMinutes() : d.getMinutes()).padStart(2,'0');
    return `${hh}:${mm}`;
  }

  const n = Number(s0.replace(',','.'));
  if(!isNaN(n) && isFinite(n) && n >= 0 && n < 1){
    const totalMinutes = Math.round(n * 24 * 60);
    const hh = String(Math.floor(totalMinutes / 60)).padStart(2,'0');
    const mm = String(totalMinutes % 60).padStart(2,'0');
    return `${hh}:${mm}`;
  }

  return '';
}

function formatDateForTable(v){ return toDateInputValue(v) || String(v||''); }
function formatTimeForTable(v){ return toTimeInputValue(v) || ''; }

/* ====================== Autocomplete comercios ====================== */
function cargarComercios(callback){
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=anunciantes`;
  fetch(url, {cache:'no-store'}).then(r=>r.text()).then(text=>{
    try{
      const start=text.indexOf('{'), end=text.lastIndexOf('}');
      const jsonText=text.slice(start,end+1);
      const json=JSON.parse(jsonText);
      const cols=(json.table && json.table.cols)? json.table.cols.map(c=>(c&&c.label)?String(c.label).toLowerCase().trim():''):[];
      let idxNombre = cols.findIndex(h=>/nombre|comercio|title|titulo/.test(h)); if(idxNombre===-1) idxNombre=1;
      let idxId = cols.findIndex(h=>/id|planilla|planilla_id|codigo/.test(h)); if(idxId===-1) idxId=61;
      let idxNivel = cols.findIndex(h=>/nivel|nivel_acceso|nivelacceso/.test(h));
      comercios=(json.table.rows||[]).map(row=>{
        const nombre = (row.c && row.c[idxNombre] && row.c[idxNombre].v)?row.c[idxNombre].v:'';
        const id = (row.c && row.c[idxId] && row.c[idxId].v)?row.c[idxId].v:'';
        const nivel = (idxNivel!==-1 && row.c && row.c[idxNivel] && row.c[idxNivel].v)?row.c[idxNivel].v:'';
        return { nombre, id, nivel };
      }).filter(c=>c.nombre);
      callback && callback();
    }catch(e){
      debugLog('Error parseando lista de comercios', e);
      callback && callback();
    }
  }).catch(err=>{ debugLog('Error fetch lista de comercios', err); callback && callback(); });
}

function showAutocomplete(inputEl, listEl, idEl, modoRegistro=false){
  if(!inputEl||!listEl||!idEl) return;
  inputEl.addEventListener('input', function(){
    const val=this.value.trim().toLowerCase(); listEl.innerHTML='';
    document.getElementById('level-warning').textContent = '';
    if(val.length<2){ listEl.classList.add('hidden'); idEl.value=''; document.getElementById('btnLogin')?.setAttribute('disabled','true'); if(modoRegistro) document.getElementById('btnGenerarClave')?.setAttribute('disabled','true'); return; }
    const matches = comercios.filter(c=>c.nombre.toLowerCase().includes(val));
    if(matches.length){
      matches.slice(0,20).forEach(c=>{
        const item=document.createElement('div'); item.className='autocomplete-item';
        let lvlLabel = c.nivel ? ` — nivel ${c.nivel}` : '';
        item.textContent=c.nombre + (c.id?(' ('+c.id+')'):'' ) + lvlLabel;
        item.onclick=function(){
          inputEl.value=c.nombre; idEl.value=c.id||''; inputEl.dataset.nivel = c.nivel || '';
          listEl.classList.add('hidden');
          const allowed = isAllowedLevel(c.nivel);
          const lvlWarningEl = document.getElementById('level-warning');
          if(allowed){
            document.getElementById('btnLogin')?.removeAttribute('disabled');
            if(lvlWarningEl) lvlWarningEl.innerHTML = `<span class="success">Anunciante nivel ${c.nivel} — permitido crear cuenta / iniciar sesión.</span>`;
          } else {
            document.getElementById('btnLogin')?.setAttribute('disabled','true');
            if(lvlWarningEl){
              if(c.nivel) lvlWarningEl.innerHTML = `<span class="error">Anunciante nivel ${c.nivel} — NO puede crear cuenta ni iniciar sesión desde aquí. Para otras consultas contactá soporte.</span>`;
              else lvlWarningEl.innerHTML = `<span class="error">No hay información de nivel para este anunciante — no es posible crear cuenta desde aquí.</span>`;
            }
          }
          if(modoRegistro){
            const pwdInput = document.getElementById('nueva-clave');
            const pwdConfirm = document.getElementById('nueva-clave-confirm');
            if(allowed){
              document.getElementById('btnGenerarClave')?.removeAttribute('disabled');
              pwdInput.removeAttribute('disabled');
              pwdConfirm.removeAttribute('disabled');
            } else {
              document.getElementById('btnGenerarClave')?.setAttribute('disabled','true');
              pwdInput.setAttribute('disabled','true');
              pwdConfirm.setAttribute('disabled','true');
            }
          }
        };
        listEl.appendChild(item);
      });
      listEl.classList.remove('hidden');
    } else {
      const item=document.createElement('div'); item.style.padding='10px'; item.style.background='#fffbe5';
      item.innerHTML = `<b>¿Tu comercio no está publicado?</b><br>
                        <div class="small-muted">Si no aparece en la guía, debés solicitar la creación del comercio (anuncio) mediante el formulario.</div>
                        <button id="btnRegistrarComercio" style="margin-top:8px;width:100%;">Solicitar creación de comercio</button>`;
      listEl.appendChild(item);
      setTimeout(()=>{ const btn=document.getElementById('btnRegistrarComercio'); if(btn) btn.onclick=()=> window.open(FORM_URL,'_blank'); },50);
      listEl.classList.remove('hidden');
    }
  });
  inputEl.addEventListener('blur', ()=> setTimeout(()=>listEl.classList.add('hidden'),180));
  inputEl.addEventListener('change', function(){ if(this.value===''){ idEl.value=''; document.getElementById('btnLogin')?.setAttribute('disabled','true'); if(modoRegistro) document.getElementById('btnGenerarClave')?.setAttribute('disabled','true'); } });
}

/* ====================== Lists de eventos (_list) ====================== */
function fillSelectOptions(selectId, items, placeholderText){
  const sel = document.getElementById(selectId);
  if(!sel) return;
  const current = sel.value || '';
  sel.innerHTML = '';
  const p = document.createElement('option');
  p.value = '';
  p.textContent = placeholderText || '(opcional)';
  sel.appendChild(p);
  items.forEach(v=>{
    const s = String(v||'').trim();
    if(!s) return;
    const opt = document.createElement('option');
    opt.value = s;
    opt.textContent = s;
    sel.appendChild(opt);
  });
  try { if(current && Array.from(sel.options).some(o=>o.value===current)) sel.value=current; } catch(e){}
}
function fillSelectOptionsFromObjects(selectId, items, keyName, placeholderText){
  const sel = document.getElementById(selectId);
  if(!sel) return;
  const current = sel.value || '';
  sel.innerHTML = '';
  const p = document.createElement('option');
  p.value = '';
  p.textContent = placeholderText || '(opcional)';
  sel.appendChild(p);
  items.forEach(obj=>{
    const s = obj && obj[keyName] ? String(obj[keyName]).trim() : '';
    if(!s) return;
    const opt = document.createElement('option');
    opt.value = s;
    opt.textContent = s;
    sel.appendChild(opt);
  });
  try { if(current && Array.from(sel.options).some(o=>o.value===current)) sel.value=current; } catch(e){}
}
async function loadEventLists(){
  try {
    const json = await gvizFetch(EVENTS_SHEET_ID, 'categorias_list');
    const headers = gvizGetHeaders(json);
    const rows = gvizGetRows(json);
    let idxTitulo = headers.indexOf('titulo'); if(idxTitulo === -1) idxTitulo = 0;
    const cats = rows.map(r => r && r.c ? _cellToString(r.c[idxTitulo]) : '')
      .map(s=>String(s||'').trim())
      .filter(s=>s && s.toLowerCase() !== 'titulo');
    evLists.categorias = Array.from(new Set(cats));
  } catch(e){ evLists.categorias = []; }

  try {
    const json = await gvizFetch(EVENTS_SHEET_ID, 'localidad_list');
    const rows = gvizGetRows(json);
    const locs = rows.map(r => r && r.c ? _cellToString(r.c[0]) : '')
      .map(s=>String(s||'').trim())
      .filter(s=>s && s.toLowerCase() !== 'localidad');
    evLists.localidades = Array.from(new Set(locs));
  } catch(e){ evLists.localidades = []; }

  try {
    const json = await gvizFetch(EVENTS_SHEET_ID, 'lugares_list');
    const headers = gvizGetHeaders(json);
    const rows = gvizGetRows(json);
    let idxLugar = headers.indexOf('lugar'); if(idxLugar === -1) idxLugar = 0;
    let idxDir = headers.indexOf('direccion'); if(idxDir === -1) idxDir = 1;
    let idxLlegar = headers.indexOf('llegar'); if(idxLlegar === -1) idxLlegar = 2;

    const lugares = rows.map(r=>{
      const c = r && r.c ? r.c : [];
      return { lugar:_cellToString(c[idxLugar]), direccion:_cellToString(c[idxDir]), llegar:_cellToString(c[idxLlegar]) };
    }).filter(o=>o.lugar && o.lugar.toLowerCase() !== 'lugar');

    const seen = new Set();
    const uniq = [];
    for(const o of lugares){
      const k = o.lugar.toLowerCase();
      if(!seen.has(k)){ seen.add(k); uniq.push(o); }
    }
    evLists.lugares = uniq;
  } catch(e){ evLists.lugares = []; }

  try {
    const json = await gvizFetch(EVENTS_SHEET_ID, 'partner_list');
    const headers = gvizGetHeaders(json);
    const rows = gvizGetRows(json);
    let idxPartner = headers.indexOf('partner'); if(idxPartner === -1) idxPartner = 0;
    let idxLogo = headers.indexOf('logo'); if(idxLogo === -1) idxLogo = 1;

    const partners = rows.map(r=>{
      const c = r && r.c ? r.c : [];
      return { partner:_cellToString(c[idxPartner]), logo:_cellToString(c[idxLogo]) };
    }).filter(o=>o.partner && o.partner.toLowerCase() !== 'partner');

    const seen = new Set();
    const uniq = [];
    for(const o of partners){
      const k = o.partner.toLowerCase();
      if(!seen.has(k)){ seen.add(k); uniq.push(o); }
    }
    evLists.partners = uniq;
  } catch(e){ evLists.partners = []; }

  fillSelectOptions('ev-categoria', evLists.categorias, 'Seleccioná una categoría');
  fillSelectOptions('ev-localidad', evLists.localidades, 'Seleccioná la localidad');
  fillSelectOptionsFromObjects('ev-lugar', evLists.lugares, 'lugar', 'Seleccioná un lugar (opcional)');
  for(let i=1;i<=6;i++){
    const id = (i===1) ? 'ev-partner' : ('ev-partner'+i);
    fillSelectOptionsFromObjects(id, evLists.partners, 'partner', 'Seleccioná un partner (opcional)');
  }
}

async function loadPromosCategorias(){
  try {
    const json = await gvizFetch(PROMOS_SHEET_ID, 'categorias_list');
    const headers = gvizGetHeaders(json);
    const rows = gvizGetRows(json);
    let idxTitulo = headers.indexOf('titulo'); if(idxTitulo === -1) idxTitulo = 0;
    const cats = rows.map(r => r && r.c ? _cellToString(r.c[idxTitulo]) : '')
      .map(s=>String(s||'').trim())
      .filter(s=>s && s.toLowerCase() !== 'titulo');
    const uniqueCats = Array.from(new Set(cats));
    fillSelectOptions('promo-categoria', uniqueCats, 'Categoría de la promo');
  } catch(e){ 
    console.error('Error cargando categorías de promos:', e);
  }
}

function onLugarChangeUpdateDireccion(){
  const sel = document.getElementById('ev-lugar');
  const dir = document.getElementById('ev-direccion');
  const lleg = document.getElementById('ev-llegar');
  if(!sel || !dir || !lleg) return;
  const val = String(sel.value||'').trim().toLowerCase();
  const found = evLists.lugares.find(o => String(o.lugar||'').trim().toLowerCase() === val);
  dir.value = found ? (found.direccion || '') : '';
  lleg.value = found ? (found.llegar || '') : '';
}

/* ====================== API helpers ====================== */
async function postJson(url, body){
  const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, mode:'cors', body: JSON.stringify(body) });
  const text = await r.text();
  let json;
  try { json = text ? JSON.parse(text) : null; } catch(e){ json = { rawText:text }; }
  return { status:r.status, json };
}
function htmlEscape(s){ return String(s||'').replace(/[&<>"']/g, function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; }); }

function setMsg(elId, kind, msg){
  const el = document.getElementById(elId);
  if(!el) return;
  el.innerHTML = `<div class="msg ${kind === 'ok' ? 'ok' : 'err'}">${htmlEscape(msg)}</div>`;
}

async function events_post(payload){
  const body = Object.assign({}, payload || {});
  if(body.accion && !body.action){ body.action = body.accion; delete body.accion; }
  if(!body.advertiserId && sesion && sesion.id) body.advertiserId = String(sesion.id);
  return postJson(WORKER_EVENTS_URL, body);
}
async function promos_post(payload){
  const body = Object.assign({}, payload || {});
  if(body.accion && !body.action){ body.action = body.accion; delete body.accion; }
  if(!body.advertiserId && sesion && sesion.id) body.advertiserId = String(sesion.id);
  return postJson(WORKER_COMMERCE_URL, body);
}

/* ====================== Promos UI (nuevo, similar a eventos) ====================== */
function promoGet(id){ return String(document.getElementById(id)?.value || '').trim(); }

function promoSetCreateMode(){
  editingPromoId = null;
  const btn = document.getElementById('promo-create');
  if(btn){
    btn.textContent = 'Crear promo';
    btn.dataset.mode = '';
  }
}
function promoClearForm(){
  document.getElementById('promo-text').value = '';
  document.getElementById('promo-categoria').value = '';
  document.getElementById('promo-desde').value = '';
  document.getElementById('promo-hasta').value = '';
  document.getElementById('promo-otros').value = '';
}
function promoCancelEdit(){
  promoSetCreateMode();
  promoClearForm();
  setMsg('promos-msg', 'ok', 'Edición cancelada.');
}

function renderPromosCards(promos){
  const list = document.getElementById('promos-list');
  if(!Array.isArray(promos) || promos.length === 0){
    list.innerHTML = '<div class="small-muted">No hay promos registradas.</div>';
    return;
  }

  let html = '<div class="card-list">';
  for(const p of promos){
    const promo = htmlEscape(p.promo || '');
    const categoria = htmlEscape(p.categoria || '');
    const desde = htmlEscape(toDateInputValue(p.desde) || (p.desde || ''));
    const hasta = htmlEscape(toDateInputValue(p.hasta) || (p.hasta || ''));
    const pid = htmlEscape(p.promo_id || '');
    const otros = htmlEscape(p.otros || '');
    const isPaused = (p.pausado === true || String(p.pausado).toUpperCase() === 'TRUE');
    const estadoTxt = isPaused ? '<span style="color:#c00;font-weight:800">PAUSADO</span>' : '<span style="color:#060;font-weight:800">ACTIVO</span>';
    const pauseBtnText = isPaused ? 'Reanudar' : 'Pausar';

    html += `
      <div class="card">
        <div class="card-title">${promo}</div>
        <div class="card-meta">
          <div><b>Categoría:</b> ${categoria || '-'}</div>
          <div><b>Estado:</b> ${estadoTxt}</div>
          <div><b>Desde:</b> ${desde || '-'}</div>
          <div><b>Hasta:</b> ${hasta || '-'}</div>
          <div class="full"><b>Descripción:</b> ${otros || '-'}</div>
        </div>
        <div class="card-actions">
          <button data-promo-action="pause" data-pid="${pid}" data-paused="${isPaused}">${pauseBtnText}</button>
          <button data-promo-action="edit" data-pid="${pid}">Editar</button>
          <button data-promo-action="duplicate" data-pid="${pid}">Duplicar</button>
          <button data-promo-action="delete" data-pid="${pid}" style="background:#e74c3c;color:#fff;border:0;">Borrar</button>
        </div>
      </div>
    `;
  }
  html += '</div>';
  list.innerHTML = html;
}

function renderPromosTable(promos){
  const list = document.getElementById('promos-list');
  if(!promos || promos.length === 0){
    list.innerHTML = '<div class="small-muted">No hay promos registradas.</div>';
    return;
  }

  let html = '<table><thead><tr><th>Promo</th><th>Categoria</th><th>Desde</th><th>Hasta</th><th>promo_id</th><th>Descripción</th><th>Estado</th><th>Acciones</th></tr></thead><tbody>';
  for(const p of promos){
    const promo = htmlEscape(p.promo || '');
    const categoria = htmlEscape(p.categoria || '');
    const desde = htmlEscape(toDateInputValue(p.desde) || (p.desde || ''));
    const hasta = htmlEscape(toDateInputValue(p.hasta) || (p.hasta || ''));
    const pid = htmlEscape(p.promo_id || '');
    const otros = htmlEscape(p.otros || '');
    const isPaused = (p.pausado === true || String(p.pausado).toUpperCase() === 'TRUE');
    const estadoTxt = isPaused ? '<span style="color:#c00">PAUSADO</span>' : '<span style="color:#060">ACTIVO</span>';
    const pauseBtnText = isPaused ? 'Reanudar' : 'Pausar';
    html += `<tr>
      <td>${promo}</td>
      <td>${categoria}</td>
      <td>${desde}</td>
      <td>${hasta}</td>
      <td style="font-size:0.9em;color:#555">${pid}</td>
      <td>${otros}</td>
      <td>${estadoTxt}</td>
      <td>
        <button data-promo-action="pause" data-pid="${pid}" data-paused="${isPaused}">${pauseBtnText}</button>
        <button data-promo-action="edit" data-pid="${pid}">Editar</button>
        <button data-promo-action="delete" data-pid="${pid}">Borrar</button>
        <button data-promo-action="duplicate" data-pid="${pid}">Duplicar</button>
      </td>
    </tr>`;
  }
  html += '</tbody></table>';
  list.innerHTML = html;
}

function bindPromosListActions(){
  const list = document.getElementById('promos-list');
  list.querySelectorAll('button[data-promo-action]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const action = btn.getAttribute('data-promo-action');
      const pid = btn.getAttribute('data-pid');

      if(action === 'pause'){
        const isPaused = btn.getAttribute('data-paused') === 'true';
        const newPauseState = isPaused ? 'FALSE' : 'TRUE';
        const msg = isPaused ? 'Reanudando promo...' : 'Pausando promo...';
        setMsg('promos-msg', 'ok', msg);
        const r = await promos_post({ action: 'updatePromo', payload: { promo_id: pid, pausado: newPauseState } });
        if(r.status === 200 && r.json && r.json.success){
          setMsg('promos-msg', 'ok', isPaused ? 'Promo reanudada.' : 'Promo pausada.');
          await loadPromosUI();
        } else {
          setMsg('promos-msg', 'err', 'Error pausando/reanudando: ' + JSON.stringify(r.json));
        }
      }

      if(action === 'delete'){
        if(!confirm('Confirmar borrar promo?')) return;
        setMsg('promos-msg', 'ok', 'Borrando promo...');
        const r = await promos_post({ action: 'deletePromo', payload: { promo_id: pid } });
        if(r.status === 200 && r.json && r.json.success){
          setMsg('promos-msg', 'ok', 'Promo borrada.');
          await loadPromosUI();
        } else {
          setMsg('promos-msg', 'err', 'Error borrando: ' + JSON.stringify(r.json));
        }
      }

      if(action === 'edit'){
        const found = (window.__lastPromos || []).find(x => String(x.promo_id||'') === String(pid));
        if(!found){ alert('No se encontró la promo (refrescá).'); return; }

        editingPromoId = pid;
        const btnCreate = document.getElementById('promo-create');
        btnCreate.textContent = 'Guardar cambios';
        btnCreate.dataset.mode = 'edit';

        document.getElementById('promo-text').value = found.promo || '';
        document.getElementById('promo-categoria').value = found.categoria || '';
        document.getElementById('promo-desde').value = toDateInputValue(found.desde);
        document.getElementById('promo-hasta').value = toDateInputValue(found.hasta);
        document.getElementById('promo-otros').value = found.otros || '';

        setMsg('promos-msg', 'ok', 'Editando promo. Modificá y tocá "Guardar cambios".');
        try { document.getElementById('promo-text')?.scrollIntoView({ behavior:'smooth', block:'start' }); } catch(e){}
      }

      if(action === 'duplicate'){
        const found = (window.__lastPromos || []).find(x => String(x.promo_id||'') === String(pid));
        if(!found){ alert('No se encontró la promo (refrescá).'); return; }
        setMsg('promos-msg', 'ok', 'Duplicando promo...');
        const r = await promos_post({ action: 'createPromo', payload: {
          promo: found.promo || '',
          categoria: found.categoria || '',
          desde: toDateInputValue(found.desde) || '',
          hasta: toDateInputValue(found.hasta) || '',
          otros: found.otros || ''
        }});
        if(r.status === 200 && r.json && (r.json.success || r.json.created)){
          setMsg('promos-msg', 'ok', 'Promo duplicada.');
          await loadPromosUI();
        } else {
          setMsg('promos-msg', 'err', 'Error duplicando: ' + JSON.stringify(r.json));
        }
      }
    });
  });
}

function renderPromosList(promos){
  const isMobile = window.matchMedia && window.matchMedia('(max-width:720px)').matches;
  if(isMobile) renderPromosCards(promos);
  else renderPromosTable(promos);
  bindPromosListActions();
}

async function loadPromosUI(){
  const st = document.getElementById('promos-status');
  const list = document.getElementById('promos-list');

  if(!sesion || !sesion.id){
    st.textContent = 'No logueado: inicia sesión para gestionar promos.';
    list.innerHTML = '';
    return;
  }

  st.textContent = 'Cargando promos...';
  list.innerHTML = 'Cargando promos...';

  const res = await promos_post({ action: 'getPromos' });
  if(res.status !== 200){
    st.textContent = 'Error cargando promos: ' + res.status;
    list.innerHTML='';
    return;
  }

  const data = res.json || {};
  const promos = data.promos || data.rows || [];
  window.__lastPromos = promos;

  renderPromosList(promos);
  st.textContent = 'Promos cargadas: ' + promos.length;
}

/* ====================== Events UI (VIP) ====================== */
function evGet(id){ return String(document.getElementById(id)?.value || '').trim(); }

function clearEventForm(){
  const ids = ['ev-nombre_evento','ev-categoria','ev-localidad','ev-lugar','ev-direccion','ev-llegar','ev-descripcion','ev-fecha','ev-hora','ev-hora2','ev-instagram','ev-entradas','ev-img1','ev-img2','ev-img3',
    'ev-partner','ev-partner2','ev-partner3','ev-partner4','ev-partner5','ev-partner6'];
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    el.value = '';
  });
}

function buildEventPayloadFromForm(){
  return {
    nombre_evento: evGet('ev-nombre_evento'),
    categoria: evGet('ev-categoria'),
    localidad: evGet('ev-localidad'),
    lugar: evGet('ev-lugar'),
    direccion: evGet('ev-direccion'),
    llegar: evGet('ev-llegar'),
    descripcion: evGet('ev-descripcion'),
    fecha: evGet('ev-fecha'),
    hora: evGet('ev-hora'),
    hora2: evGet('ev-hora2'),
    instagram: evGet('ev-instagram'),
    entradas: evGet('ev-entradas'),
    img1: evGet('ev-img1'),
    img2: evGet('ev-img2'),
    img3: evGet('ev-img3'),
    partner: evGet('ev-partner'),
    partner2: evGet('ev-partner2'),
    partner3: evGet('ev-partner3'),
    partner4: evGet('ev-partner4'),
    partner5: evGet('ev-partner5'),
    partner6: evGet('ev-partner6')
  };
}

function renderEventsCards(events){
  const list = document.getElementById('eventos-list');
  if(!Array.isArray(events) || events.length === 0){
    list.innerHTML = '<div class="small-muted">No hay eventos cargados.</div>';
    return;
  }

  let html = '<div class="card-list">';
  for(const e of events){
    const eventoId = htmlEscape(e.evento_id || '');
    const fechaTxt = htmlEscape(formatDateForTable(e.fecha));
    const horaTxt = htmlEscape(formatTimeForTable(e.hora2 || e.hora || ''));
    const isPaused = (e.pausado === true || String(e.pausado).toUpperCase() === 'TRUE');
    const estadoTxt = isPaused ? '<span style="color:#c00;font-weight:800">PAUSADO</span>' : '<span style="color:#060;font-weight:800">ACTIVO</span>';
    const pauseBtnText = isPaused ? 'Reanudar' : 'Pausar';

    html += `
      <div class="card">
        <div class="card-title">${htmlEscape(e.nombre_evento || '')}</div>
        <div class="card-meta">
          <div><b>Fecha:</b> ${fechaTxt || '-'}</div>
          <div><b>Hora:</b> ${horaTxt || '-'}</div>
          <div class="full"><b>Lugar:</b> ${htmlEscape(e.lugar || '') || '-'}</div>
          <div class="full"><b>Localidad:</b> ${htmlEscape(e.localidad || '') || '-'}</div>
          <div class="full"><b>Estado:</b> ${estadoTxt}</div>
          <div class="full"><span class="events-small">${eventoId ? ('ID: '+eventoId) : '<span style="color:#c00">SIN ID</span>'}</span></div>
        </div>
        <div class="card-actions">
          <button data-ev-action="pause" data-ev-id="${eventoId}" data-paused="${isPaused}">${pauseBtnText}</button>
          <button data-ev-action="edit" data-ev-id="${eventoId}">Editar</button>
          <button data-ev-action="delete" data-ev-id="${eventoId}" style="background:#e74c3c;color:#fff;border:0;">Borrar</button>
        </div>
      </div>
    `;
  }
  html += '</div>';
  list.innerHTML = html;
}

function renderEventsTable(events){
  const list = document.getElementById('eventos-list');
  if(!Array.isArray(events) || events.length === 0){
    list.innerHTML = '<div class="small-muted">No hay eventos cargados.</div>';
    return;
  }

  let html = '<table><thead><tr><th>Nombre</th><th>Fecha</th><th>Hora</th><th>Lugar</th><th>Localidad</th><th>Estado</th><th>Acciones</th></tr></thead><tbody>';
  for(const e of events){
    const eventoId = htmlEscape(e.evento_id || '');
    const fechaTxt = htmlEscape(formatDateForTable(e.fecha));
    const horaTxt = htmlEscape(formatTimeForTable(e.hora2 || e.hora || ''));
    const isPaused = (e.pausado === true || String(e.pausado).toUpperCase() === 'TRUE');
    const estadoTxt = isPaused ? '<span style="color:#c00">PAUSADO</span>' : '<span style="color:#060">ACTIVO</span>';
    const pauseBtnText = isPaused ? 'Reanudar' : 'Pausar';
    html += `<tr>
      <td>${htmlEscape(e.nombre_evento || '')}<div class="events-small">${eventoId ? ('ID: '+eventoId) : '<span style="color:#c00">SIN ID</span>'}</div></td>
      <td>${fechaTxt}</td>
      <td>${horaTxt}</td>
      <td>${htmlEscape(e.lugar || '')}</td>
      <td>${htmlEscape(e.localidad || '')}</td>
      <td>${estadoTxt}</td>
      <td class="actions">
        <button data-ev-action="pause" data-ev-id="${eventoId}" data-paused="${isPaused}">${pauseBtnText}</button>
        <button data-ev-action="edit" data-ev-id="${eventoId}">Editar</button>
        <button data-ev-action="delete" data-ev-id="${eventoId}">Borrar</button>
      </td>
    </tr>`;
  }
  html += '</tbody></table>';
  list.innerHTML = html;
}

function bindEventsListActions(){
  const list = document.getElementById('eventos-list');
  list.querySelectorAll('button[data-ev-action]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const action = btn.getAttribute('data-ev-action');
      const evId = btn.getAttribute('data-ev-id') || '';
      if(!evId){ alert('Evento sin ID.'); return; }

      if(action === 'pause'){
        const isPaused = btn.getAttribute('data-paused') === 'true';
        const newPauseState = !isPaused;
        const msg = isPaused ? 'Reanudando evento...' : 'Pausando evento...';
        setMsg('eventos-msg', 'ok', msg);
        const res = await events_post({ action:'pauseVipEvent', payload: { evento_id: evId, pause: newPauseState } });
        if(res.status === 200 && res.json && res.json.success){
          setMsg('eventos-msg', 'ok', isPaused ? 'Evento reanudado.' : 'Evento pausado.');
          await loadEventsUI();
        } else {
          setMsg('eventos-msg', 'err', 'Error pausando/reanudando: ' + JSON.stringify(res.json));
        }
      }

      if(action === 'delete'){
        if(!confirm('Confirmar borrar evento?')) return;
        setMsg('eventos-msg', 'ok', 'Borrando evento...');
        const res = await events_post({ action:'deleteVipEvent', payload: { evento_id: evId } });
        if(res.status === 200 && res.json && (res.json.success || res.json.deleted)){
          setMsg('eventos-msg', 'ok', 'Evento VIP borrado.');
          await loadEventsUI();
        } else {
          setMsg('eventos-msg', 'err', 'Error borrando: ' + JSON.stringify(res.json));
        }
      }

      if(action === 'edit'){
        const found = (window.__lastEvents || []).find(x => String(x.evento_id||'') === String(evId));
        if(!found){ alert('No se encontró el evento en la lista (refrescá).'); return; }

        editingEventId = evId;
        const btnCreate = document.getElementById('ev-create');
        btnCreate.textContent = 'Guardar cambios';
        btnCreate.dataset.mode = 'edit';

        document.getElementById('ev-nombre_evento').value = found.nombre_evento || '';
        document.getElementById('ev-categoria').value = found.categoria || '';
        document.getElementById('ev-localidad').value = found.localidad || '';
        document.getElementById('ev-lugar').value = found.lugar || '';
        onLugarChangeUpdateDireccion();

        document.getElementById('ev-descripcion').value = found.descripcion || '';

        document.getElementById('ev-fecha').value = toDateInputValue(found.fecha);
        document.getElementById('ev-hora').value = toTimeInputValue(found.hora);
        document.getElementById('ev-hora2').value = found.hora2 || '';

        document.getElementById('ev-instagram').value = found.instagram || '';
        document.getElementById('ev-entradas').value = found.entradas || '';
        document.getElementById('ev-img1').value = found.img1 || '';
        document.getElementById('ev-img2').value = found.img2 || '';
        document.getElementById('ev-img3').value = found.img3 || '';

        document.getElementById('ev-partner').value = found.partner || '';
        document.getElementById('ev-partner2').value = found.partner2 || '';
        document.getElementById('ev-partner3').value = found.partner3 || '';
        document.getElementById('ev-partner4').value = found.partner4 || '';
        document.getElementById('ev-partner5').value = found.partner5 || '';
        document.getElementById('ev-partner6').value = found.partner6 || '';

        setMsg('eventos-msg', 'ok', 'Editando evento. Modificá y tocá "Guardar cambios".');
        try { document.getElementById('ev-nombre_evento')?.scrollIntoView({ behavior:'smooth', block:'start' }); } catch(e){}
      }
    });
  });
}

function renderEventsList(events){
  const isMobile = window.matchMedia && window.matchMedia('(max-width:720px)').matches;
  if(isMobile) renderEventsCards(events);
  else renderEventsTable(events);
  bindEventsListActions();
}

async function loadEventsUI(){
  const st = document.getElementById('eventos-status');
  const list = document.getElementById('eventos-list');

  if(!sesion || !sesion.id){
    st.textContent = 'No logueado.';
    list.innerHTML = '';
    return;
  }

  st.textContent = 'Cargando eventos...';
  list.innerHTML = 'Cargando eventos...';

  const res = await events_post({ action:'getVipEvents' });
  if(res.status !== 200){
    st.textContent = 'Error cargando eventos: ' + res.status;
    list.innerHTML = '';
    setMsg('eventos-msg', 'err', 'Error cargando: ' + JSON.stringify(res.json));
    return;
  }

  const data = res.json || {};
  const events = data.events || [];
  window.__lastEvents = events;
  renderEventsList(events);
  st.textContent = 'Eventos cargados: ' + events.length;
}

function cancelEventEdit(){
  editingEventId = null;
  const btn = document.getElementById('ev-create');
  btn.dataset.mode = '';
  btn.textContent = 'Crear evento';
  clearEventForm();
  setMsg('eventos-msg', 'ok', 'Edición cancelada.');
}

/* ====================== INIT ====================== */
document.addEventListener('DOMContentLoaded', ()=>{
  showAutocomplete(document.getElementById('comercio-buscar'), document.getElementById('autocomplete-list'), document.getElementById('comercio-id'));
  showAutocomplete(document.getElementById('comercio-buscar2'), document.getElementById('autocomplete-list2'), document.getElementById('comercio-id2'), true);

  cargarComercios(()=>{});
  loadEventLists().then(()=>{
    document.getElementById('ev-lugar')?.addEventListener('change', onLugarChangeUpdateDireccion);
  }).catch(()=>{});
  loadPromosCategorias().catch(()=>{});

  document.getElementById('btnCrearComercio').addEventListener('click', ()=> window.open(FORM_URL,'_blank'));

  // Promos buttons
  document.getElementById('promo-refresh')?.addEventListener('click', loadPromosUI);
  document.getElementById('promo-cancel')?.addEventListener('click', promoCancelEdit);

  document.getElementById('promo-create')?.addEventListener('click', async (e)=>{
    e.preventDefault();
    if(!sesion || !sesion.id){ alert('No logueado.'); return; }

    const btn = document.getElementById('promo-create');
    btn.setAttribute('disabled','true');

    try{
      const promo = promoGet('promo-text');
      const categoria = promoGet('promo-categoria');
      const desde = promoGet('promo-desde');
      const hasta = promoGet('promo-hasta');
      const otros = promoGet('promo-otros');

      if(!promo){ alert('Ingresá texto de promo'); return; }

      if(btn.dataset.mode === 'edit' && editingPromoId){
        setMsg('promos-msg', 'ok', 'Guardando cambios...');
        const r = await promos_post({ action: 'updatePromo', payload: { promo_id: editingPromoId, promo, categoria, desde: desde||'', hasta: hasta||'', otros: otros||'' } });
        if(r.status === 200 && r.json && r.json.success){
          setMsg('promos-msg', 'ok', 'Promo actualizada.');
          promoSetCreateMode();
          promoClearForm();
          await loadPromosUI();
        } else {
          setMsg('promos-msg', 'err', 'Error actualizando: ' + JSON.stringify(r.json));
        }
      } else {
        setMsg('promos-msg', 'ok', 'Creando promo...');
        const r = await promos_post({ action: 'createPromo', payload: { promo, categoria, desde: desde||'', hasta: hasta||'', otros: otros||'' } });
        if(r.status === 200 && r.json && (r.json.success || r.json.created)){
          setMsg('promos-msg', 'ok', 'Promo creada.');
          promoClearForm();
          await loadPromosUI();
        } else {
          setMsg('promos-msg', 'err', 'Error creando: ' + JSON.stringify(r.json));
        }
      }
    } finally {
      btn.removeAttribute('disabled');
    }
  });

  // Eventos botones
  document.getElementById('ev-refresh')?.addEventListener('click', loadEventsUI);
  document.getElementById('ev-cancel')?.addEventListener('click', cancelEventEdit);

  document.getElementById('ev-create')?.addEventListener('click', async ()=>{
    if(!sesion || !sesion.id){ alert('No logueado'); return; }
    const btn = document.getElementById('ev-create');
    btn.setAttribute('disabled','true');

    try{
      const payload = buildEventPayloadFromForm();

      // ✅ obligatorios
      if(!payload.nombre_evento){ alert('Falta Nombre del evento'); return; }
      if(!payload.fecha){ alert('Falta Fecha'); return; }
      if(!payload.categoria){ alert('Falta Categoría'); return; }
      if(!payload.localidad){ alert('Falta Localidad'); return; }
      if(!payload.lugar){ alert('Falta Lugar'); return; }

      if(btn.dataset.mode === 'edit' && editingEventId){
        setMsg('eventos-msg', 'ok', 'Guardando cambios...');
        const res = await events_post({ action:'updateVipEvent', payload: Object.assign({ evento_id: editingEventId }, payload) });
        if(res.status === 200 && res.json && (res.json.success || res.json.updated)){
          setMsg('eventos-msg', 'ok', 'Evento actualizado.');
          editingEventId = null;
          btn.dataset.mode = '';
          btn.textContent = 'Crear evento';
          clearEventForm();
          await loadEventsUI();
        } else {
          setMsg('eventos-msg', 'err', 'Error actualizando: ' + JSON.stringify(res.json));
        }
      } else {
        setMsg('eventos-msg', 'ok', 'Creando evento...');
        const res = await events_post({ action:'createVipEvent', payload });
        if(res.status === 200 && res.json && (res.json.success || res.json.created)){
          setMsg('eventos-msg', 'ok', 'Evento creado.');
          clearEventForm();
          await loadEventsUI();
        } else {
          setMsg('eventos-msg', 'err', 'Error creando: ' + JSON.stringify(res.json));
        }
      }
    } finally {
      btn.removeAttribute('disabled');
    }
  });

  // Login
  const btnLogin = document.getElementById('btnLogin');
  const originalLoginBtnText = btnLogin ? (btnLogin.textContent || 'Ingresar') : 'Ingresar';

  async function mostrarPanelDashboard(){
    if(!sesion || !sesion.id){ mostrarPanel('login'); return; }
    document.getElementById('nombre-comercio').textContent = sesion.nombre;

    const url = `${WORKER_ORIGIN}/commerce?id=${encodeURIComponent(sesion.id)}&nombre=${encodeURIComponent(sesion.nombre)}&planilla_id=${encodeURIComponent(sesion.planilla_id||'')}`;
    try{
      const r = await fetch(url, { method:'GET', mode:'cors' });
      const datos = await r.json().catch(()=>({ error:'Respuesta inválida'}));
      if(datos.error){ document.getElementById('campos-datos-comercio').innerHTML = `<b>Error:</b> ${datos.error}`; mostrarPanel('dashboard'); return; }
      if(datos.planilla_id && datos.planilla_id !== sesion.planilla_id){ sesion.planilla_id = datos.planilla_id; localStorage.setItem('planilla_id', datos.planilla_id); }

      const campos = ["nombre","nivel","subnivel","segmento","categoria","tags","adicionales","pie","descripcion","direccion","lat","lng","telefono","whatsapp","mail","instagram","facebook","youtube","tiktok","linkedin","logo","verificado","gold","img1","img2","img3","img4","link"];
      let html = '';
      campos.forEach(c=> html += `<div><label>${c}</label><input type="text" name="${c}" value="${datos[c]||''}" /></div>`);
      html += `<input type="hidden" name="__id" value="${sesion.id}"/>`;
      document.getElementById('campos-datos-comercio').innerHTML = html;

      document.getElementById('link-support_dashboard').href = `https://wa.me/${SUPPORT_NUMBER}?text=${encodeURIComponent('Solicito modificación de datos\\nComercio: ' + sesion.nombre + '\\nId: ' + sesion.id)}`;
      mostrarPanel('dashboard');

      if(btnLogin){ btnLogin.removeAttribute('disabled'); btnLogin.textContent = originalLoginBtnText; }

      // Cargar listas (promos/eventos) cuando corresponda
      setTimeout(()=>{ try{ loadPromosUI(); }catch(e){} }, 250);
      setTimeout(()=>{ try{ loadEventsUI(); }catch(e){} }, 250);
    }catch(err){
      document.getElementById('campos-datos-comercio').innerHTML = `<b>Error conexión con Worker.</b>`;
      mostrarPanel('dashboard');
      if(btnLogin){ btnLogin.removeAttribute('disabled'); btnLogin.textContent = originalLoginBtnText; }
    }
  }

  document.getElementById('login-form').onsubmit = async function(e){
    e.preventDefault();
    const nombre = document.getElementById('comercio-buscar').value.trim();
    const clave = document.getElementById('clave').value.trim();
    const id = document.getElementById('comercio-id').value.trim();
    const nivelSeleccion = document.getElementById('comercio-buscar')?.dataset?.nivel || '';
    if(!id && !nombre){ document.getElementById('login-msg').innerHTML = "<span class='error'>Elegí un comercio de la lista.</span>"; return; }
    if(id && !isAllowedLevel(nivelSeleccion)){
      document.getElementById('login-msg').innerHTML = "<span class='error'>No está permitido iniciar sesión para este anunciante (nivel no autorizado).</span>";
      return;
    }

    btnLogin.setAttribute('disabled','true');
    btnLogin.textContent = 'Ingresando...';
    document.getElementById('login-msg').innerHTML = "<span>Ingresando...</span>";

    const payload = { accion:'login', comercio_id:id||'', nombre:nombre, password:clave };
    try{
      const r = await fetch(WORKER_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload), mode:'cors' });
      const text = await r.text();
      let res;
      try{ res = JSON.parse(text); }catch(e){ res = { success:false, message: text }; }

      if(r.status===200 && res.success){
        btnLogin.textContent = 'Cargando datos...';
        localStorage.setItem('comercio_id', res.id || id);
        localStorage.setItem('comercio_nombre', res.nombre || nombre);
        if(res.planilla_id) localStorage.setItem('planilla_id', res.planilla_id);
        sesion = { id: res.id || id, nombre: res.nombre || nombre, planilla_id: res.planilla_id || '' };
        document.getElementById('login-msg').innerHTML = "<span class='success'>"+(res.message||'Ingresado')+"</span>";
        setTimeout(()=> mostrarPanelDashboard(), 300);
        return;
      }

      btnLogin.removeAttribute('disabled');
      btnLogin.textContent = originalLoginBtnText;
      document.getElementById('login-msg').innerHTML = "<span class='error'>"+(res.message||'Login falló')+"</span>";
    }catch(err){
      btnLogin.removeAttribute('disabled');
      btnLogin.textContent = originalLoginBtnText;
      document.getElementById('login-msg').innerHTML = "<span class='error'>Error de conexión.</span>";
    }
  };

  // Logout
  document.getElementById('logout-btn').addEventListener('click', ()=>{
    localStorage.removeItem('comercio_id'); localStorage.removeItem('comercio_nombre'); localStorage.removeItem('planilla_id');
    sesion=null;
    btnLogin.removeAttribute('disabled');
    btnLogin.textContent = originalLoginBtnText;
    mostrarPanel('login');
  });

  // Auto login
  if(localStorage.getItem('comercio_id') && localStorage.getItem('comercio_nombre')){
    sesion = {
      id: localStorage.getItem('comercio_id'),
      nombre: localStorage.getItem('comercio_nombre'),
      planilla_id: localStorage.getItem('planilla_id')||''
    };
    mostrarPanelDashboard();
  }

  // Tabs
  (function(){
    const tabDatos = document.getElementById('tab-datos');
    const tabPromos = document.getElementById('tab-promos');
    const tabEventos = document.getElementById('tab-eventos');
    const datosPanel = document.getElementById('datos-panel');
    const promosPanel = document.getElementById('promos-panel');
    const eventosPanel = document.getElementById('eventos-panel');

    function hideAll(){
      datosPanel.style.display='none';
      promosPanel.style.display='none';
      eventosPanel.style.display='none';
      tabDatos.classList.remove('tab-active'); tabDatos.setAttribute('aria-selected','false');
      tabPromos.classList.remove('tab-active'); tabPromos.setAttribute('aria-selected','false');
      tabEventos.classList.remove('tab-active'); tabEventos.setAttribute('aria-selected','false');
    }
    function showDatos(){ hideAll(); datosPanel.style.display='block'; tabDatos.classList.add('tab-active'); tabDatos.setAttribute('aria-selected','true'); }
    function showPromos(){ hideAll(); promosPanel.style.display='block'; tabPromos.classList.add('tab-active'); tabPromos.setAttribute('aria-selected','true'); setTimeout(()=>loadPromosUI(),50); }
    function showEventos(){ hideAll(); eventosPanel.style.display='block'; tabEventos.classList.add('tab-active'); tabEventos.setAttribute('aria-selected','true'); setTimeout(()=>loadEventsUI(),50); }

    tabDatos.addEventListener('click', (e)=>{ e.preventDefault(); showDatos(); });
    tabPromos.addEventListener('click', (e)=>{ e.preventDefault(); showPromos(); });
    tabEventos.addEventListener('click', (e)=>{ e.preventDefault(); showEventos(); });
    showDatos();
  })();
});
</script>
</body>
</html>
