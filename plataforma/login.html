<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Panel Comercios - Login & Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f6f7fb;margin:0;padding:0}
    .container{max-width:980px;margin:20px auto;background:#fff;border-radius:12px;box-shadow:0 2px 16px #0002;padding:24px}
    label{display:block;margin:12px 0 6px;font-weight:500}
    input,button,textarea,select{width:100%;padding:8px;margin-bottom:10px;border-radius:5px;border:1px solid #bbb;box-sizing:border-box}
    .autocomplete-list{position:absolute;background:#fff;border:1px solid #bbb;z-index:10;max-height:220px;overflow-y:auto;width:93%}
    .autocomplete-item{padding:8px;cursor:pointer}
    .autocomplete-item:hover{background:#e7f7fd}
    .hidden{display:none}
    .success{color:#060;font-weight:bold}
    .error{color:#c00}
    button.primary{margin-top:10px;padding:12px 0;font-size:1.05em;border-radius:7px;background:#3dc879;color:#fff;border:1px solid #2a8}
    .link{color:#3498db;cursor:pointer;text-decoration:underline;display:inline-block;margin-top:8px}
    .panel{display:none}
    .panel.active{display:block}
    #debug{background:#111;color:#bff;padding:10px;border-radius:6px;max-height:160px;overflow:auto;font-size:12px;margin-top:8px;white-space:pre-wrap}
    .blocked { background:#f4f6f4; border:1px solid #dfe8df; }
    .info-banner{background:#fffbe5;border:1px solid #f5c26b;padding:10px;border-radius:6px;margin-top:8px}
    .small-muted{font-size:0.95em;color:#555}
    .small-warning{font-size:0.9em;color:#a33;margin-top:6px}
    .muted-note{font-size:0.95em;color:#444;margin-top:6px}
    /* Promos specific */
    .box{border:1px solid #ddd;padding:12px;border-radius:6px;margin-bottom:12px;background:#fafafa}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
    tr:hover{background:#f7f7f7}
    .actions button{padding:6px 8px;margin-right:6px}
    .msg{padding:8px;border-radius:6px;margin-bottom:12px}
    .ok{background:#e6ffed;border:1px solid #b7f0c6}
    .err{background:#ffecec;border:1px solid #fabbbb}
    .secondary{background:#666;color:#fff;border:0;padding:8px 12px;border-radius:6px;cursor:pointer}
    .spinner{display:inline-block;width:16px;height:16px;border:2px solid #ccc;border-top-color:#333;border-radius:50%;animation:spin .8s linear infinite;margin-left:8px;vertical-align:middle}
    @keyframes spin{to{transform:rotate(360deg)}}
    .promos-row-controls { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .promo-input { flex:1; min-width:160px; }
    .promo-select { width:220px; min-width:140px; }
  </style>
</head>
<body>
  <div class="container">
    <div id="panel-login" class="panel active">
      <h2>Ingresar a tu comercio</h2>
      <form id="login-form" autocomplete="off">
        <label>Comercio</label>
        <div style="position:relative;">
          <input type="text" id="comercio-buscar" placeholder="Buscá tu comercio..." autocomplete="off" required>
          <div id="autocomplete-list" class="autocomplete-list hidden"></div>
        </div>
        <input type="hidden" id="comercio-id">
        <label>Clave</label>
        <input type="password" id="clave" placeholder="Clave..." required minlength="1">
        <button id="btnLogin" class="primary" disabled>Ingresar</button>

        <div id="login-msg"></div>
        <div id="level-warning" class="small-muted"></div>

        <!-- Zócalo / banner para crear comercio -->
        <div id="create-commerce-banner" class="info-banner">
          <strong>¿Tu anuncio no aparece en la guía?</strong>
          <div class="small-muted">Si tu comercio, servicio u organización no figura en la guía, completá el formulario para solicitar la creación del anuncio. Esto publica el anuncio y el equipo técnico asignará el nivel correspondiente.</div>
          <button id="btnCrearComercio" style="margin-top:8px;width:100%;">Solicitar creación de anuncio (formulario)</button>
          <div class="small-warning">Importante: Crear/publicar el anuncio es distinto de generar la contraseña de acceso. Las cuentas sólo pueden generarse para anunciantes con nivel permitido (1, 2 o 5 y superiores). Para otras consultas contactá a soporte.</div>
        </div>

        <div id="report-area" style="display:none;">
          <button id="reportBtn">Contactar Soporte (WhatsApp)</button>
        </div>
      </form>

      <div style="text-align:center;margin-top:8px;">
        <span class="link" onclick="mostrarPanel('registro')">¿Necesitás generar tu contraseña? Ir a Generar contraseña</span>
      </div>
    </div>

    <div id="panel-registro" class="panel">
      <h2>Generar contraseña / Registrar acceso</h2>
      <p class="muted-note">
        Este flujo sirve para generar la contraseña directamente para un anunciante que ya tiene su anuncio cargado en la guía.
        Si tu anuncio NO está en la guía, volvé al apartado "Ingresar" y solicitá la creación del anuncio mediante el formulario.
      </p>

      <label>Buscar anuncio (seleccioná el anuncio ya publicado)</label>
      <div style="position:relative;">
        <input type="text" id="comercio-buscar2" placeholder="Buscá tu comercio..." autocomplete="off">
        <div id="autocomplete-list2" class="autocomplete-list hidden"></div>
      </div>
      <input type="hidden" id="comercio-id2">

      <label>Contraseña</label>
      <input type="password" id="nueva-clave" placeholder="Ingresá la nueva contraseña (mínimo 4 caracteres)" minlength="4" disabled>
      <label>Confirmar contraseña</label>
      <input type="password" id="nueva-clave-confirm" placeholder="Repetí la contraseña" minlength="4" disabled>

      <div style="display:flex;gap:8px;">
        <button id="btnGenerarClave" class="primary" style="flex:1" disabled>Generar y registrar contraseña</button>
      </div>

      <div id="reg-msg"></div>

      <div style="text-align:center;margin-top:8px;">
        <span class="link" onclick="mostrarPanel('login')">Volver al login</span>
      </div>

      <div style="margin-top:10px" class="small-muted">
        Nota técnica: cuando generes la contraseña aquí, el sistema intentará registrarla automáticamente en la hoja "anunciantes" en la columna BG (encabezado "clave"). Si preferís que el equipo la registre manualmente o necesitás soporte, contactá a soporte por WhatsApp.
      </div>
    </div>

    <div id="panel-dashboard" class="panel">
      <div style="font-size:1.2em;margin-bottom:10px">¡Hola <span id="nombre-comercio"></span>!</div>
      <form id="form-datos-comercio">
        <div id="campos-datos-comercio"></div>
        <button type="submit" style="background:#3dc879;color:#fff;padding:10px;border:none;border-radius:6px">Guardar cambios</button>
        <div id="msg-datos-comercio"></div>
      </form>

      <!-- START: Promos section (integrated) -->
      <div style="margin-top:18px;border-top:1px solid #eee;padding-top:12px">
        <h3>Promos / Ofertas</h3>
        <div id="promos-status" class="small-muted">Cargando configuración de promos...</div>

        <div style="margin-top:8px;background:#fbfbff;border:1px solid #e6e8ff;padding:10px;border-radius:6px">
          <div class="promos-row-controls">
            <input id="promo-text" class="promo-input" type="text" placeholder="Texto de la promo (ej: 10% OFF)" />
            <select id="promo-categoria" class="promo-select" aria-label="Categoría de la promo">
              <option value="">Categoría (opcional)</option>
            </select>
            <input id="promo-desde" type="date" style="width:140px" />
            <input id="promo-hasta" type="date" style="width:140px" />
            <input id="promo-otros" class="promo-input" type="text" placeholder="Otros (ej: Hasta agotar stock 50 unidades)" style="max-width:300px" />
            <button id="promo-create" style="min-width:140px">Crear promo</button>
            <button id="promo-refresh" class="secondary" style="min-width:120px">Refrescar lista</button>
          </div>
        </div>

        <div id="promos-list" style="margin-top:12px">Cargando promos...</div>
      </div>
      <!-- END: Promos section -->

      <div style="margin-top:10px">
        <a id="link-support-dashboard" href="#" target="_blank">WhatsApp Soporte</a>
      </div>
      <div style="margin-top:8px">
        <button id="logout-btn" style="background:#e74c3c;color:#fff;border:none;padding:8px;border-radius:6px">Cerrar sesión</button>
      </div>
    </div>

    <h3>Debug / Registros</h3>
    <div id="debug"></div>
  </div>

<script>
/* === CONFIG === */
const WORKER_URL = "https://login.liqkoargentina.workers.dev/login";
const WORKER_ORIGIN = (new URL(WORKER_URL)).origin;
const SHEET_ID = "170kTZ-ViCPxPli86g-n_XMuMv1S3O0-DbGwNFGYVnjY";
const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSdZDgpGMYyb5uh1xpsJCN1MzNGoSgGZ9W9EUqQqAYFdB2EyBQ/viewform";
/* ================= */

/* Teléfono de soporte (usar siempre este número) */
const SUPPORT_NUMBER = "5492245459957"; // +54 9 224 5459957

/* Campos que NO deben ser editables desde el panel. */
const BLOCKED = ["__id","id","planilla_id","planilla id","codigo","nivel","nivel_acceso","verificado","gold","subnivel","nivelacceso"];

let comercios = [];
let categorias = []; // NEW: list of categories from categorias_list
let sesion = null;
const debugEl = document.getElementById('debug');
function debugLog(...args){ console.log(...args); try { debugEl.textContent += args.map(a=>typeof a==='object'?JSON.stringify(a,null,2):String(a)).join(' ') + "\n\n"; debugEl.scrollTop = debugEl.scrollHeight; }catch(e){} }

function mostrarPanel(panel){ ['panel-login','panel-registro','panel-dashboard'].forEach(id=>document.getElementById(id).classList.remove('active')); document.getElementById('panel-'+panel)?.classList.add('active'); }

function openWhatsApp(text){ window.open(`https://wa.me/${SUPPORT_NUMBER}?text=${encodeURIComponent(text)}`,'_blank'); }

function enableReportButton(payloadText){ document.getElementById('report-area').style.display='block'; document.getElementById('reportBtn').onclick = ()=> openWhatsApp(payloadText + "\n\nPor favor revisen. Gracias."); }

/* Helpers para niveles */
function parseLevel(levelStr){
  if(levelStr===undefined || levelStr===null) return NaN;
  const s = String(levelStr).trim().replace(',', '.');
  const m = s.match(/^(\d+(\.\d+)?)/);
  return m ? parseFloat(m[1]) : NaN;
}
function isAllowedLevel(levelStr){
  const n = parseLevel(levelStr);
  if(isNaN(n)) return false;
  return n === 1 || n === 2 || n >= 5;
}

/* Cargar lista de comercios (autocompletado) and categories */
function cargarComercios(callback){
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=anunciantes`;
  fetch(url, {cache:'no-store'}).then(r=>r.text()).then(text=>{
    try{
      const start=text.indexOf('{'), end=text.lastIndexOf('}');
      const jsonText=text.slice(start,end+1);
      const json=JSON.parse(jsonText);
      const cols=(json.table && json.table.cols)? json.table.cols.map(c=>(c&&c.label)?String(c.label).toLowerCase().trim():''):[];
      let idxNombre = cols.findIndex(h=>/nombre|comercio|title|titulo/.test(h)); if(idxNombre===-1) idxNombre=1;
      let idxId = cols.findIndex(h=>/id|planilla|planilla_id|codigo/.test(h)); if(idxId===-1) idxId=61;
      let idxNivel = cols.findIndex(h=>/nivel|nivel_acceso|nivelacceso/.test(h));
      comercios=(json.table.rows||[]).map(row=>{
        const nombre = (row.c && row.c[idxNombre] && row.c[idxNombre].v)?row.c[idxNombre].v:'';
        const id = (row.c && row.c[idxId] && row.c[idxId].v)?row.c[idxId].v:'';
        const nivel = (idxNivel!==-1 && row.c && row.c[idxNivel] && row.c[idxNivel].v)?row.c[idxNivel].v:'';
        return { nombre, id, nivel };
      }).filter(c=>c.nombre);
      debugLog('Comercios cargados:', comercios.length);
      // Also load categories after comercios (we can run independently too)
      cargarCategorias(()=> callback && callback());
    }catch(e){
      debugLog('Error parseando lista de comercios', e);
      // still attempt to load categories
      cargarCategorias(()=> callback && callback());
    }
  }).catch(err=>{ debugLog('Error fetch lista de comercios', err); cargarCategorias(()=> callback && callback()); });
}

/* NEW: cargar categorias desde sheet 'categorias_list' to populate promo-categoria select */
function cargarCategorias(callback){
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent('categorias_list')}`;
  fetch(url, {cache:'no-store'}).then(r=>r.text()).then(text=>{
    try{
      const start=text.indexOf('{'), end=text.lastIndexOf('}');
      const jsonText=text.slice(start,end+1);
      const json=JSON.parse(jsonText);
      // find column labels
      const cols=(json.table && json.table.cols)? json.table.cols.map(c=>(c&&c.label)?String(c.label).toLowerCase().trim():''):[];
      // assume first column is 'titulo', second is 'logo'
      const idxTitulo = 0;
      const rows = json.table.rows || [];
      categorias = rows.map(r=> {
        const title = (r.c && r.c[idxTitulo] && r.c[idxTitulo].v) ? String(r.c[idxTitulo].v).trim() : '';
        return title;
      }).filter(t => t && t.toLowerCase() !== 'titulo');
      // dedupe and sort lightly
      categorias = Array.from(new Set(categorias));
      debugLog('Categorias cargadas:', categorias.length, categorias.slice(0,20));
      populateCategoriaSelect();
      callback && callback();
    }catch(e){
      debugLog('Error parseando categorias_list', e);
      categorias = [];
      populateCategoriaSelect();
      callback && callback();
    }
  }).catch(err=>{
    debugLog('Error fetch categorias_list', err);
    categorias = [];
    populateCategoriaSelect();
    callback && callback();
  });
}

/* Fill the promo-categoria select with categories */
function populateCategoriaSelect(){
  const sel = document.getElementById('promo-categoria');
  if(!sel) return;
  // clear existing options except first
  const first = sel.querySelector('option');
  sel.innerHTML = '';
  sel.appendChild(first || (() => {
    const o = document.createElement('option'); o.value=''; o.textContent='Categoría (opcional)'; return o;
  })());
  categorias.forEach(cat=>{
    const opt = document.createElement('option');
    opt.value = cat;
    opt.textContent = cat;
    sel.appendChild(opt);
  });
}

/* Autocomplete helper (unchanged) */
function showAutocomplete(inputEl, listEl, idEl, modoRegistro=false){
  if(!inputEl||!listEl||!idEl) return;
  inputEl.addEventListener('input', function(){
    const val=this.value.trim().toLowerCase(); listEl.innerHTML='';
    if(modoRegistro) document.getElementById('reg-msg').innerHTML = '';
    document.getElementById('level-warning').textContent = '';
    if(val.length<2){ listEl.classList.add('hidden'); idEl.value=''; document.getElementById('btnLogin')?.setAttribute('disabled','true'); if(modoRegistro) document.getElementById('btnGenerarClave')?.setAttribute('disabled','true'); return; }
    const matches = comercios.filter(c=>c.nombre.toLowerCase().includes(val));
    if(matches.length){
      matches.slice(0,20).forEach(c=>{
        const item=document.createElement('div'); item.className='autocomplete-item';
        let lvlLabel = c.nivel ? ` — nivel ${c.nivel}` : '';
        item.textContent=c.nombre + (c.id?(' ('+c.id+')'):'' ) + lvlLabel;
        item.onclick=function(){
          inputEl.value=c.nombre; idEl.value=c.id||''; inputEl.dataset.nivel = c.nivel || '';
          listEl.classList.add('hidden');
          const allowed = isAllowedLevel(c.nivel);
          const lvlWarningEl = document.getElementById('level-warning');
          if(allowed){
            document.getElementById('btnLogin')?.removeAttribute('disabled');
            if(lvlWarningEl) lvlWarningEl.innerHTML = `<span class="success">Anunciante nivel ${c.nivel} — permitido crear cuenta / iniciar sesión.</span>`;
          } else {
            document.getElementById('btnLogin')?.setAttribute('disabled','true');
            if(lvlWarningEl){
              if(c.nivel) lvlWarningEl.innerHTML = `<span class="error">Anunciante nivel ${c.nivel} — NO puede crear cuenta ni iniciar sesión desde aquí. Para otras consultas contactá soporte.</span>`;
              else lvlWarningEl.innerHTML = `<span class="error">No hay información de nivel para este anunciante — no es posible crear cuenta desde aquí. Si tu comercio no está en la guía, completá el formulario.</span>`;
            }
          }
          if(modoRegistro){
            const pwdInput = document.getElementById('nueva-clave');
            const pwdConfirm = document.getElementById('nueva-clave-confirm');
            if(allowed){
              document.getElementById('btnGenerarClave')?.removeAttribute('disabled');
              pwdInput.removeAttribute('disabled');
              pwdConfirm.removeAttribute('disabled');
            } else {
              document.getElementById('btnGenerarClave')?.setAttribute('disabled','true');
              pwdInput.setAttribute('disabled','true');
              pwdConfirm.setAttribute('disabled','true');
            }
          }
        };
        listEl.appendChild(item);
      });
      listEl.classList.remove('hidden');
    } else {
      const item=document.createElement('div'); item.style.padding='10px'; item.style.background='#fffbe5';
      item.innerHTML = `<b>¿Tu comercio no está publicado?</b><br>
                        <div class="small-muted">Si no aparece en la guía, debés solicitar la creación del comercio (anuncio) mediante el formulario. Crear comercio es distinto de generar la contraseña de acceso.</div>
                        <button id="btnRegistrarComercio" style="margin-top:8px;width:100%;">Solicitar creación de comercio</button>
                        <div class="small-warning" style="margin-top:8px;">Recordá: las cuentas de acceso solo se generan para anunciantes con nivel 1, 2 o 5 y superiores. Para cambios de nivel o productos comerciales contactá soporte.</div>`;
      listEl.appendChild(item);
      setTimeout(()=>{ const btn=document.getElementById('btnRegistrarComercio'); if(btn) btn.onclick=()=> window.open(FORM_URL,'_blank'); },50);
      listEl.classList.remove('hidden');
    }
  });
  inputEl.addEventListener('blur', ()=> setTimeout(()=>listEl.classList.add('hidden'),180));
  inputEl.addEventListener('change', function(){ if(this.value===''){ idEl.value=''; document.getElementById('btnLogin')?.setAttribute('disabled','true'); if(modoRegistro) document.getElementById('btnGenerarClave')?.setAttribute('disabled','true'); } });
}

/* Eventos y login */
let originalLoginBtnText = null;
document.addEventListener('DOMContentLoaded', ()=>{
  cargarComercios(()=>{
    showAutocomplete(document.getElementById('comercio-buscar'), document.getElementById('autocomplete-list'), document.getElementById('comercio-id'));
    showAutocomplete(document.getElementById('comercio-buscar2'), document.getElementById('autocomplete-list2'), document.getElementById('comercio-id2'), true);
  });

  const btnLogin = document.getElementById('btnLogin');
  if(btnLogin) originalLoginBtnText = btnLogin.textContent || 'Ingresar';

  document.getElementById('login-form').onsubmit = async function(e){
    e.preventDefault(); document.getElementById('report-area').style.display='none';
    const nombre = document.getElementById('comercio-buscar').value.trim();
    const clave = document.getElementById('clave').value.trim();
    const id = document.getElementById('comercio-id').value.trim();
    const nivelSeleccion = document.getElementById('comercio-buscar')?.dataset?.nivel || '';
    if(!id && !nombre){ document.getElementById('login-msg').innerHTML = "<span class='error'>Elegí un comercio de la lista.</span>"; return; }
    if(id && !isAllowedLevel(nivelSeleccion)){
      document.getElementById('login-msg').innerHTML = "<span class='error'>No está permitido iniciar sesión para este anunciante (nivel no autorizado).</span>";
      return;
    }

    if(btnLogin){
      btnLogin.setAttribute('disabled','true');
      btnLogin.textContent = 'Ingresando...';
    }
    document.getElementById('login-msg').innerHTML = "<span>Ingresando...</span>";
    const payload = { accion:'login', comercio_id:id||'', nombre:nombre, password:clave };
    try{
      const r = await fetch(WORKER_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload), mode:'cors' });
      const text = await r.text();
      let res;
      try{ res = JSON.parse(text); }catch(e){ res = { success:false, message: text }; }
      debugLog('Login worker ->', r.status, res);
      if(r.status===200 && res.success){
        if(btnLogin){
          btnLogin.textContent = 'Cargando datos...';
          btnLogin.setAttribute('disabled','true');
        }
        localStorage.setItem('comercio_id', res.id || id);
        localStorage.setItem('comercio_nombre', res.nombre || nombre);
        if(res.planilla_id) localStorage.setItem('planilla_id', res.planilla_id);
        sesion = { id: res.id || id, nombre: res.nombre || nombre, planilla_id: res.planilla_id || '' };
        document.getElementById('login-msg').innerHTML = "<span class='success'>"+(res.message||'Ingresado')+"</span>";
        setTimeout(()=> mostrarPanelDashboard(),500);
        return;
      }

      if(btnLogin){
        btnLogin.removeAttribute('disabled');
        btnLogin.textContent = originalLoginBtnText;
      }
      document.getElementById('login-msg').innerHTML = "<span class='error'>"+(res.message||'Login falló')+"</span>";
      enableReportButton(`Intento login\nPayload: ${JSON.stringify(payload)}\nWorker status: ${r.status}\nWorker body: ${JSON.stringify(res)}`);
    }catch(err){
      debugLog('Error fetch worker', err);
      if(btnLogin){
        btnLogin.removeAttribute('disabled');
        btnLogin.textContent = originalLoginBtnText;
      }
      document.getElementById('login-msg').innerHTML = "<span class='error'>Error de conexión.</span>";
      enableReportButton(`Error fetch worker: ${err}`);
    }
  };

  // Create commerce (external form)
  document.getElementById('btnCrearComercio').addEventListener('click', ()=> window.open(FORM_URL,'_blank'));

  // Registro / Generar clave: UI validation and POST to worker to register clave in sheet
  const pwdInput = document.getElementById('nueva-clave');
  const pwdConfirm = document.getElementById('nueva-clave-confirm');
  const btnGenerar = document.getElementById('btnGenerarClave');

  function updatePwdButtonState(){
    const id = document.getElementById('comercio-id2').value.trim();
    const nivel = document.getElementById('comercio-buscar2')?.dataset?.nivel || '';
    const pwd = pwdInput.value || '';
    const pwdc = pwdConfirm.value || '';
    if(!id) { btnGenerar.setAttribute('disabled','true'); return; }
    if(!isAllowedLevel(nivel)) { btnGenerar.setAttribute('disabled','true'); return; }
    if(pwd.length < 4) { btnGenerar.setAttribute('disabled','true'); return; }
    if(pwd !== pwdc) { btnGenerar.setAttribute('disabled','true'); return; }
    btnGenerar.removeAttribute('disabled');
  }

  pwdInput?.addEventListener('input', updatePwdButtonState);
  pwdConfirm?.addEventListener('input', updatePwdButtonState);

  btnGenerar.addEventListener('click', async ()=>{
    const nombre = document.getElementById('comercio-buscar2').value.trim();
    const id = document.getElementById('comercio-id2').value.trim();
    const nivel = document.getElementById('comercio-buscar2')?.dataset?.nivel || '';
    const pwd = pwdInput.value || '';

    if(!id || !nombre){ document.getElementById('reg-msg').innerHTML = "<span class='error'>Buscá tu comercio o completá el formulario de creación si no está publicado.</span>"; return; }
    if(!isAllowedLevel(nivel)){ document.getElementById('reg-msg').innerHTML = "<span class='error'>No está permitido generar la clave para este anunciante (nivel no autorizado). Contactá soporte para otras consultas.</span>"; return; }
    if(pwd.length < 4){ document.getElementById('reg-msg').innerHTML = "<span class='error'>La contraseña debe tener al menos 4 caracteres.</span>"; return; }

    btnGenerar.setAttribute('disabled','true');
    pwdInput.setAttribute('disabled','true');
    pwdConfirm.setAttribute('disabled','true');
    document.getElementById('reg-msg').innerHTML = "<span>Registrando contraseña...</span>";

    const saveUrl = `${WORKER_ORIGIN}/commerce?id=${encodeURIComponent(id)}&planilla_id=${encodeURIComponent('')}`;
    const body = { accion: 'set_clave', __id: id, nombre: nombre, clave: pwd };

    try{
      const r = await fetch(saveUrl, { method:'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body), mode:'cors' });
      const resText = await r.text();
      let res;
      try{ res = JSON.parse(resText); } catch(e){ res = { success: (r.status===200), message: resText }; }
      debugLog('Set clave ->', r.status, res);

      const ok = (r.status === 200) && (res && (res.success === true || res.aprobado === true || res.ok === true));
      if(ok){
        document.getElementById('reg-msg').innerHTML = "<span class='success'>Contraseña registrada correctamente en la hoja. Podés usarla para iniciar sesión.</span>";
        pwdInput.value = '';
        pwdConfirm.value = '';
        setTimeout(()=> mostrarPanel('login'), 1200);
        return;
      } else {
        document.getElementById('reg-msg').innerHTML = "<span class='error'>No se pudo registrar la contraseña. "+(res && res.message?res.message:'')+"</span>";
      }
    }catch(err){
      debugLog('Error registrando clave', err);
      document.getElementById('reg-msg').innerHTML = "<span class='error'>Error de conexión al registrar la contraseña. Enviando mensaje a soporte...</span>";
      const manualMsg = `Solicitud registro de clave (manual)\nComercio: ${nombre}\nId: ${id}\nNivel: ${nivel || '(sin info)'}\nContraseña solicitada por el anunciante: ${pwd}\nPor favor anotar en la hoja 'anunciantes' en la columna BG (encabezado 'clave').`;
      openWhatsApp(manualMsg);
    } finally {
      btnGenerar.removeAttribute('disabled');
      pwdInput.removeAttribute('disabled');
      pwdConfirm.removeAttribute('disabled');
      updatePwdButtonState();
    }
  });

  document.getElementById('btnSolicitarAlta')?.addEventListener('click', ()=> window.open(FORM_URL,'_blank'));
  document.getElementById('reportBtn')?.addEventListener('click', ()=> openWhatsApp('Necesito asistencia.'));

  document.getElementById('logout-btn').addEventListener('click', ()=> {
    localStorage.removeItem('comercio_id'); localStorage.removeItem('comercio_nombre'); localStorage.removeItem('planilla_id'); sesion=null;
    const btn = document.getElementById('btnLogin');
    if(btn){
      btn.removeAttribute('disabled');
      btn.textContent = originalLoginBtnText;
    }
    mostrarPanel('login');
  });

  if(localStorage.getItem('comercio_id') && localStorage.getItem('comercio_nombre')){ sesion = { id: localStorage.getItem('comercio_id'), nombre: localStorage.getItem('comercio_nombre'), planilla_id: localStorage.getItem('planilla_id')||'' }; mostrarPanelDashboard(); }
});

/* Dashboard: pedir datos al Worker -> Apps Script */
async function mostrarPanelDashboard(){
  if(!sesion || !sesion.id){ mostrarPanel('login'); return; }
  document.getElementById('nombre-comercio').textContent = sesion.nombre;
  debugLog('Pidiendo datos para id:', sesion.id);
  const url = `${WORKER_ORIGIN}/commerce?id=${encodeURIComponent(sesion.id)}&nombre=${encodeURIComponent(sesion.nombre)}&planilla_id=${encodeURIComponent(sesion.planilla_id||'')}`;
  try{
    const r = await fetch(url, { method:'GET', mode:'cors' });
    const datos = await r.json().catch(()=>({ error:'Respuesta inválida'}));
    debugLog('/commerce ->', datos);
    if(datos.error){ document.getElementById('campos-datos-comercio').innerHTML = `<b>Error:</b> ${datos.error}`; mostrarPanel('dashboard'); return; }
    if(datos.planilla_id && datos.planilla_id !== sesion.planilla_id){ sesion.planilla_id = datos.planilla_id; localStorage.setItem('planilla_id', datos.planilla_id); }
    const campos = ["nombre","nivel","subnivel","segmento","categoria","tags","adicionales","pie","descripcion","direccion","lat","lng","telefono","whatsapp","mail","instagram","facebook","youtube","tiktok","linkedin","logo","verificado","gold","img1","img2","img3","img4","link"];
    let html = '';
    campos.forEach(c=> html += `<div><label>${c}</label><input type="text" name="${c}" value="${datos[c]||''}" /></div>`);
    html += `<input type="hidden" name="__id" value="${sesion.id}"/>`;
    document.getElementById('campos-datos-comercio').innerHTML = html;
    document.getElementById('link-support-dashboard').href = `https://wa.me/${SUPPORT_NUMBER}?text=${encodeURIComponent('Solicito modificación de datos\\nComercio: ' + sesion.nombre + '\\nId: ' + sesion.id)}`;
    mostrarPanel('dashboard');

    const btn = document.getElementById('btnLogin');
    if(btn){
      btn.removeAttribute('disabled');
      btn.textContent = originalLoginBtnText;
    }

    // After dashboard data is loaded, trigger promos load (if section present)
    setTimeout(()=>{ try{ if(document.getElementById('promos-list')) loadPromosUI(); }catch(e){} }, 300);
  }catch(err){
    debugLog('Error al consultar /commerce', err);
    document.getElementById('campos-datos-comercio').innerHTML = `<b>Error conexión con Worker.</b>`;
    mostrarPanel('dashboard');
    const btn = document.getElementById('btnLogin');
    if(btn){
      btn.removeAttribute('disabled');
      btn.textContent = originalLoginBtnText;
    }
  }
}

/* Guardar cambios via Worker -> Apps Script */
document.addEventListener('submit', function(e){
  if(e.target && e.target.id === 'form-datos-comercio'){ e.preventDefault();
    if(!sesion || !sesion.id){ document.getElementById('msg-datos-comercio').textContent = 'Sesión no válida.'; return; }
    const fd = new FormData(e.target);
    const data = {};
    fd.forEach((v,k)=> data[k]=v);
    if(!data.__id) data.__id = sesion.id;
    debugLog('Guardar ->', data);
    const saveUrl = `${WORKER_ORIGIN}/commerce?id=${encodeURIComponent(sesion.id)}&planilla_id=${encodeURIComponent(sesion.planilla_id||'')}`;
    fetch(saveUrl, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data), mode:'cors' })
      .then(r=>r.json().catch(()=>({success:false, raw:'no json'})))
      .then(res=>{ debugLog('respuesta guardar ->', res); if(res && res.success) document.getElementById('msg-datos-comercio').textContent = '¡Datos guardados!'; else document.getElementById('msg-datos-comercio').textContent = 'Error al guardar.'; })
      .catch(err=>{ debugLog('Error guardando', err); document.getElementById('msg-datos-comercio').textContent = 'Error de conexión.'; });
  }
});

/* ------------------ Promos: Listar / Crear / Editar / Borrar ------------------ */
/* Requiere: WORKER_ORIGIN (already defined), sesion (id and nombre) */
async function promos_post(path, payload){
  // Enviamos advertiserId in body if not present (worker expects advertiserId)
  const body = Object.assign({}, payload, { advertiserId: (sesion && sesion.id) ? sesion.id : '' });
  const url = WORKER_ORIGIN + path;
  try {
    const r = await fetch(url, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(body), mode:'cors' });
    const text = await r.text();
    try { return { status: r.status, json: JSON.parse(text) }; } catch(e){ return { status: r.status, json: { error:'invalid json', text } }; }
  } catch(err){
    return { status: 0, json: { error: String(err) } };
  }
}

async function loadPromosUI(){
  const st = document.getElementById('promos-status');
  const list = document.getElementById('promos-list');
  if(!sesion || !sesion.id){ st.textContent = 'No logueado: inicia sesión para gestionar promos.'; list.innerHTML = ''; return; }
  st.textContent = 'Cargando promos...';
  list.innerHTML = 'Cargando promos...';
  // Pedimos promos vía Worker -> Apps Script: action getPromos
  const res = await promos_post('/commerce', { action: 'getPromos' });
  if(res.status !== 200){ st.textContent = 'Error cargando promos: ' + (res.json && (res.json.error || res.json.message) ? (res.json.error || res.json.message) : res.status); list.innerHTML=''; return; }
  const data = res.json || {};
  const promos = data.promos || data.rows || [];
  renderPromosList(promos);
  st.textContent = 'Promos cargadas: ' + promos.length;
}

function renderPromosList(promos){
  const list = document.getElementById('promos-list');
  if(!promos || promos.length === 0){ list.innerHTML = '<div class="small-muted">No hay promos registradas.</div>'; return; }
  let html = '<table><thead><tr><th>Promo</th><th>Categoria</th><th>Desde</th><th>Hasta</th><th>promo_id</th><th>otros</th><th>Acciones</th></tr></thead><tbody>';
  for(const p of promos){
    const promo = htmlEscape(p.promo || '');
    const categoria = htmlEscape(p.categoria || '');
    const desde = htmlEscape(p.desde || '');
    const hasta = htmlEscape(p.hasta || '');
    const pid = htmlEscape(p.promo_id || '');
    const otros = htmlEscape(p.otros || '');
    html += `<tr>
      <td>${promo}</td>
      <td>${categoria}</td>
      <td>${desde}</td>
      <td>${hasta}</td>
      <td style="font-size:0.9em;color:#555">${pid}</td>
      <td>${otros}</td>
      <td>
        <button data-action="edit" data-pid="${pid}">Editar</button>
        <button data-action="delete" data-pid="${pid}">Borrar</button>
      </td>
    </tr>`;
  }
  html += '</tbody></table>';
  list.innerHTML = html;

  // Attach handlers
  list.querySelectorAll('button').forEach(b=>{
    b.addEventListener('click', async (ev)=>{
      const action = b.getAttribute('data-action');
      const pid = b.getAttribute('data-pid');
      if(action === 'delete'){
        if(!confirm('Confirmar borrar promo?')) return;
        const r = await promos_post('/commerce', { action: 'deletePromo', payload: { promo_id: pid } });
        if(r.status === 200 && r.json && r.json.success){ alert('Promo borrada'); loadPromosUI(); } else { alert('Error borrando: ' + JSON.stringify(r.json)); }
      } else if(action === 'edit'){
        // better UX: prompt for all fields including categoria
        const newText = prompt('Editar texto de promo:', '');
        if(newText === null) return;
        const newCategoria = prompt('Categoria (dejar vacía para no cambiar):','');
        const newDesde = prompt('Desde (YYYY-MM-DD):','');
        const newHasta = prompt('Hasta (YYYY-MM-DD):','');
        const newOtros = prompt('Otros (nota opcional):','');
        const payload = { promo_id: pid };
        if(newText) payload.promo = newText;
        if(newCategoria) payload.categoria = newCategoria;
        if(newDesde) payload.desde = newDesde;
        if(newHasta) payload.hasta = newHasta;
        if(newOtros) payload.otros = newOtros;
        const r = await promos_post('/commerce', { action: 'updatePromo', payload: payload });
        if(r.status === 200 && r.json && r.json.success){ alert('Promo actualizada'); loadPromosUI(); } else { alert('Error actualizando: ' + JSON.stringify(r.json)); }
      }
    });
  });
}

function htmlEscape(s){ return String(s||'').replace(/[&<>"']/g, function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; }); }

/* Crear promo desde form - includes categoria selection and robust payload */
document.addEventListener('click', function(e){
  if(!e.target) return;

  // Crear promo
  if(e.target.id === 'promo-create'){
    (async ()=>{
      if(!sesion || !sesion.id){ alert('No logueado.'); return; }
      const promo = document.getElementById('promo-text').value.trim();
      const categoria = document.getElementById('promo-categoria').value || '';
      const desde = document.getElementById('promo-desde').value;
      const hasta = document.getElementById('promo-hasta').value;
      const otros = document.getElementById('promo-otros').value.trim();
      if(!promo){ alert('Ingresá texto de promo'); return; }

      // UI feedback
      const statusEl = document.getElementById('promos-status');
      statusEl.textContent = 'Creando promo...';
      const btn = e.target;
      btn.setAttribute('disabled','true');
      const spinner = document.createElement('span'); spinner.className='spinner'; btn.appendChild(spinner);

      // Build payload exactly as backend expects
      const payload = {
        action: 'createPromo',
        payload: { promo: promo, categoria: categoria, desde: desde || '', hasta: hasta || '', otros: otros || '' },
        advertiserId: String(sesion.id || '')
      };

      debugLog('Creating promo - request payload:', payload);

      try {
        const url = WORKER_ORIGIN + '/commerce';
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          mode: 'cors',
          body: JSON.stringify(payload)
        });

        const text = await res.text();
        let body;
        try { body = JSON.parse(text); } catch(e) { body = { rawText: text }; }

        debugLog('CreatePromo response status:', res.status, 'body:', body);

        if(res.status === 200 && body && (body.success === true || body.created === true)){
          statusEl.textContent = 'Promo creada correctamente.';
          document.getElementById('promo-text').value = '';
          document.getElementById('promo-categoria').value = '';
          document.getElementById('promo-desde').value = '';
          document.getElementById('promo-hasta').value = '';
          document.getElementById('promo-otros').value = '';
          await loadPromosUI();
        } else {
          const errMsg = `Error creando promo. HTTP ${res.status} - ${JSON.stringify(body)}`;
          statusEl.textContent = errMsg;
          debugLog(errMsg);
          if(body && body.message) alert('Error: ' + body.message);
        }
      } catch(err){
        const errText = 'Error de conexión al crear promo: ' + String(err);
        document.getElementById('promos-status').textContent = errText;
        debugLog(errText, err);
        alert('Error de conexión. Revisa la consola para más detalles.');
      } finally {
        try { btn.removeChild(spinner); } catch(e){}
        btn.removeAttribute('disabled');
      }
    })();
    return;
  }

  // Refrescar promos
  if(e.target.id === 'promo-refresh'){
    loadPromosUI();
    return;
  }

  // Other handlers preserved in renderPromosList
});

/* End Promos block */

/* Misc: initialization to ensure categories loaded even if not available earlier */
(function initCategoriesOnLoad(){
  // If cargarComercios already ran, cargarCategorias was called there.
  // Ensure select is populated if categorias already loaded.
  if(window.addEventListener) {
    window.addEventListener('load', () => {
      // small delay to allow previous fetches
      setTimeout(()=> populateCategoriaSelect(), 500);
    });
  }
})();
</script>
</body>
</html>
