<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body { font-family: Arial, sans-serif; background: #f7f7f7; margin:0; padding:0; }
      .container { max-width: 700px; margin: 30px auto; background: #fff; border-radius: 10px; box-shadow: 0 2px 12px #0002; padding: 28px 28px 12px 28px;}
      .tabs { display: flex; margin-bottom: 18px; }
      .tab {
        flex: 1; padding: 12px 0; text-align: center; cursor: pointer; background: #efefef;
        border: 1px solid #ccc; border-bottom: none; border-radius: 7px 7px 0 0;
        margin-right: 2px; transition: background .2s;
      }
      .tab.active { background: #fff; font-weight: bold; }
      .tab-content { background: #fff; border: 1px solid #ccc; border-radius: 0 0 7px 7px; padding: 22px; }
      label { display: block; margin: 14px 0 4px; font-weight: 500;}
      input, select, textarea { width: 100%; padding: 7px; margin-bottom: 8px; border-radius:4px; border:1px solid #bbb;}
      textarea { min-height: 48px;}
      .hidden { display: none; }
      .error { color: #c00; font-size: 0.95em; }
      .success { color: #060; font-size: 1.07em; margin-top: 15px;}
      button { margin-top: 18px; padding: 10px 0; width: 100%; font-size: 1.1em; border-radius:5px; border:1px solid #2a8; background:#3dc879; color:#fff; font-weight:bold;}
      .info { color:#666; font-size:0.93em; margin-bottom:8px;}
      .required-star { color: #d00; font-weight:bold;}
      .link-btn { color: #2a8; background: none; border: none; text-decoration: underline; cursor: pointer; font-size: 1em; margin-top: 10px;}
    </style>
  </head>
  <body>
    <div class="container">

      <!-- Pantalla de login inicial -->
      <div id="login-inicial">
        <h2>Ingresar</h2>
        <form id="form-login" autocomplete="off">
          <label>Email</label>
          <input type="email" name="email" required placeholder="Ej: tu@email.com" />
          <label>Contraseña</label>
          <input type="password" name="pass" id="pass-login" required minlength="8" placeholder="Mínimo 8 caracteres" />
          <span id="pass-error-login" class="error"></span>
          <button type="submit">Ingresar</button>
          <div id="resultado-login"></div>
        </form>
        <div style="margin-top:18px;">
          ¿No tenés cuenta?
          <button type="button" class="link-btn" id="btn-ir-registro">Crear cuenta nueva</button>
        </div>
      </div>

      <!-- Pantalla de registro -->
      <div id="registro" class="hidden">
        <div class="tabs">
          <div class="tab active" id="tab-nuevo">Registro usuario</div>
        </div>
        <div class="tab-content" id="content-nuevo">
          <form id="form-nuevo" autocomplete="off">
            <label>Email <span class="required-star">*</span></label>
            <input type="email" name="email" required placeholder="Ej: tu@email.com" />
            <label>Nombre de usuario <span class="required-star">*</span></label>
            <input type="text" name="nombre" required placeholder="Ej: Juan Pérez" />
            <label>WhatsApp <span class="required-star">*</span></label>
            <input type="text" name="whatsapp" required placeholder="Ej: 2245500000"/>
            <label>Contraseña <span class="required-star">*</span></label>
            <input type="password" name="pass" id="pass-nuevo" required minlength="8" placeholder="Mínimo 8 caracteres" />
            <span id="pass-error-nuevo" class="error"></span>
            <button type="submit">Registrar usuario</button>
            <div id="resultado-nuevo"></div>
          </form>
          <div id="form-google" class="hidden" style="margin-top:30px;">
            <h3>Completá los datos de tu comercio</h3>
            <iframe src="https://docs.google.com/forms/d/YOUR_GOOGLE_FORM_ID/viewform?embedded=true" width="100%" height="1200" frameborder="0" marginheight="0" marginwidth="0">Cargando…</iframe>
          </div>
        </div>
        <div style="margin-top:18px;">
          ¿Ya tenés cuenta?
          <button type="button" class="link-btn" id="btn-ir-login">Volver a ingresar</button>
        </div>
      </div>
    </div>

    <script>
      // Cambio entre login y registro
      document.getElementById('btn-ir-registro').onclick = function() {
        document.getElementById('login-inicial').classList.add('hidden');
        document.getElementById('registro').classList.remove('hidden');
      };
      document.getElementById('btn-ir-login').onclick = function() {
        document.getElementById('registro').classList.add('hidden');
        document.getElementById('login-inicial').classList.remove('hidden');
      };

      // Validación de contraseña
      function validaPass(passEl, errEl) {
        passEl.addEventListener('input', function() {
          if(this.value.length < 8) {
            errEl.textContent = "La contraseña debe tener al menos 8 caracteres.";
          } else {
            errEl.textContent = "";
          }
        });
      }
      validaPass(document.getElementById('pass-nuevo'), document.getElementById('pass-error-nuevo'));
      validaPass(document.getElementById('pass-login'), document.getElementById('pass-error-login'));

      // Enviar formulario login
      document.getElementById('form-login').onsubmit = function(e) {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(this));
        if(data.pass.length < 8) {
          document.getElementById('pass-error-login').textContent = "La contraseña debe tener al menos 8 caracteres.";
          return;
        }
        document.getElementById('resultado-login').textContent = "Ingresando...";
        google.script.run.withSuccessHandler(function(msg) {
          document.getElementById('resultado-login').innerHTML = msg.success
            ? '<span class="success">'+msg.message+'</span>'
            : '<span class="error">'+msg.message+'</span>';
        }).loginUsuario(data);
      };

      // Enviar formulario de registro usuario
      document.getElementById('form-nuevo').onsubmit = function(e) {
        e.preventDefault();
        var data = Object.fromEntries(new FormData(this));
        if(data.pass.length < 8) {
          document.getElementById('pass-error-nuevo').textContent = "La contraseña debe tener al menos 8 caracteres.";
          return;
        }
        document.getElementById('resultado-nuevo').textContent = "Registrando...";
        google.script.run.withSuccessHandler(function(msg) {
          document.getElementById('resultado-nuevo').innerHTML = '<span class="success">'+msg+'</span>';
          // Mostrar el form de Google solo si el registro fue exitoso
          document.getElementById('form-nuevo').classList.add('hidden');
          document.getElementById('form-google').classList.remove('hidden');
        }).registrarUsuarioNuevoComercio(data);
      };
    </script>
  </body>
</html>
