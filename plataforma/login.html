<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Acceso anunciantes</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 2em; }
    .formbox { max-width: 350px; margin: auto; border-radius: 12px; padding: 2em; background: #f7f7f7; box-shadow: 0 2px 12px #0002; }
    h2 { text-align: center; }
    button, input[type="submit"] { background: #006699; color: #fff; border: none; padding: 10px 22px; border-radius: 8px; font-size: 1.1em; margin-top: 1em; width: 100%; }
    button.google { background:#ea4335; margin-bottom:14px;}
    input, label { display:block; width:100%; margin-top:8px;}
    .small { font-size: 0.97em; color: #333; margin-top: 1em; }
    .msg { margin-top:1em; color:#e53935;}
    .success { color: #388e3c;}
  </style>
</head>
<body>
  <div class="formbox" id="loginbox">
    <h2>Acceso a anunciantes</h2>
    <button class="google" id="google-login">Ingresar con Google</button>
    <hr>
    <form id="form-login">
      <label for="lemail">Email</label>
      <input type="email" id="lemail" required>
      <label for="lpass">Contraseña</label>
      <input type="password" id="lpass" required>
      <input type="submit" value="Ingresar">
    </form>
    <div class="small">¿No tenés cuenta? <a href="#" onclick="showRegister();return false;">Registrate aquí</a></div>
    <div id="msg" class="msg"></div>
  </div>

  <div class="formbox" id="registerbox" style="display:none;">
    <h2>Registro de anunciantes</h2>
    <form id="form-register">
      <label for="rnombre">Nombre o comercio</label>
      <input type="text" id="rnombre" required>
      <label for="remail">Email</label>
      <input type="email" id="remail" required>
      <label for="rpass">Contraseña</label>
      <input type="password" id="rpass" required>
      <input type="submit" value="Registrarme">
    </form>
    <div class="small">¿Ya tenés cuenta? <a href="#" onclick="showLogin();return false;">Iniciar sesión</a></div>
    <div id="msgreg" class="msg"></div>
  </div>
  <script>
    // Configuración Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyC__YRb9phBPEL563dkDHZhht-sdTXy6XE",
      authDomain: "anunciantes-guialocal.firebaseapp.com",
      projectId: "anunciantes-guialocal",
      storageBucket: "anunciantes-guialocal.appspot.com",
      messagingSenderId: "1046169260713",
      appId: "1:1046169260713:web:5ae883a5f2d16619d18fb8",
      measurementId: "G-CNR1Y6VW06"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    function showRegister() {
      document.getElementById("loginbox").style.display = "none";
      document.getElementById("registerbox").style.display = "block";
    }
    function showLogin() {
      document.getElementById("loginbox").style.display = "block";
      document.getElementById("registerbox").style.display = "none";
    }

    document.getElementById('google-login').onclick = async function() {
      const provider = new firebase.auth.GoogleAuthProvider();
      try {
        const result = await auth.signInWithPopup(provider);
        await saveUserIfNew(result.user, true);
        checkAprobado(result.user.email);
      } catch (e) {
        document.getElementById('msg').innerText = "Error: " + e.message;
      }
    };

    document.getElementById('form-login').onsubmit = async function(e) {
      e.preventDefault();
      let email = document.getElementById('lemail').value;
      let pass = document.getElementById('lpass').value;
      try {
        const cred = await auth.signInWithEmailAndPassword(email, pass);
        checkAprobado(cred.user.email);
      } catch (e) {
        document.getElementById('msg').innerText = "Error: " + e.message;
      }
    };

    document.getElementById('form-register').onsubmit = async function(e) {
      e.preventDefault();
      let nombre = document.getElementById('rnombre').value;
      let email = document.getElementById('remail').value;
      let pass = document.getElementById('rpass').value;
      try {
        const cred = await auth.createUserWithEmailAndPassword(email, pass);
        await db.collection("anunciantes").doc(email).set({
          nombre: nombre,
          email: email,
          creado: new Date(),
          aprobado: false,
          google: false
        });
        document.getElementById('msgreg').innerHTML = "<span class='success'>¡Registro exitoso! Esperá aprobación del administrador.</span>";
      } catch (e) {
        document.getElementById('msgreg').innerText = "Error: " + e.message;
      }
    };

    async function saveUserIfNew(user, isGoogle=false) {
      const doc = await db.collection("anunciantes").doc(user.email).get();
      if (!doc.exists) {
        await db.collection("anunciantes").doc(user.email).set({
          nombre: user.displayName || "",
          email: user.email,
          creado: new Date(),
          aprobado: false,
          google: isGoogle
        });
      }
    }

    async function checkAprobado(email) {
      const doc = await db.collection("anunciantes").doc(email).get();
      if (!doc.exists) {
        document.getElementById('msg').innerText = "Usuario no registrado.";
      } else if (!doc.data().aprobado) {
        document.getElementById('msg').innerText = "Tu registro está pendiente de aprobación. Esperá que el administrador active tu cuenta.";
        auth.signOut();
      } else {
        window.location.href = "panel-anunciantes.html";
      }
    }
  </script>
</body>
</html>
