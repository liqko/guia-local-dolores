<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Login Comercios</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f7f7f7; min-height: 100vh; margin:0; padding:0;}
    .container { max-width: 400px; margin: 40px auto; background: #fff; border-radius: 10px; box-shadow: 0 2px 12px #0002; padding: 28px 28px 18px 28px;}
    label { display: block; margin: 14px 0 4px; font-weight: 500; }
    input { width: 100%; padding: 7px; margin-bottom: 8px; border-radius:4px; border:1px solid #bbb;}
    .autocomplete-list { position:absolute; background:#fff; border:1px solid #bbb; z-index:10; max-height:180px; overflow-y:auto; width:91%; }
    .autocomplete-item { padding:7px; cursor:pointer; }
    .autocomplete-item:hover { background:#e7f7fd; }
    .hidden { display: none; }
    .success { color: #060; font-weight:bold; }
    .error { color: #c00; }
    button { margin-top: 16px; padding: 10px 0; width: 100%; font-size: 1.1em; border-radius:5px; border:1px solid #2a8; background:#3dc879; color:#fff; font-weight:bold;}
    .link { color: #3498db; cursor:pointer; text-decoration:underline; margin-top:14px; display:inline-block;}
    .panel { display: none; }
    .panel.active { display: block; }
    h2, h3 { text-align:center; }
    .info { background: #fffbe5; padding: 15px; border-radius: 8px; margin: 10px 0; color: #555; text-align: center;}
  </style>
  <script>
    // Redirección automática a www si no estás en www
    if (location.hostname === "guialocaldolores.com.ar") {
      location.href = location.protocol + "//www.guialocaldolores.com.ar" + location.pathname + location.search;
    }
  </script>
</head>
<body>
  <div class="container">
    <!-- LOGIN PANEL -->
    <div id="panel-login" class="panel active">
      <h2>Ingresar a tu comercio</h2>
      <form id="login-form" autocomplete="off">
        <label>Comercio</label>
        <div style="position:relative;">
          <input type="text" id="comercio-buscar" name="comercio" placeholder="Buscá tu comercio..." required autocomplete="off">
          <div id="autocomplete-list" class="autocomplete-list hidden"></div>
        </div>
        <input type="hidden" id="comercio-id" name="comercio_id">
        <label>Clave</label>
        <input type="password" id="clave" name="clave" placeholder="Clave de acceso..." required minlength="4">
        <button type="submit">Ingresar</button>
        <div id="login-msg"></div>
      </form>
      <div style="text-align:center;">
        <span class="link" onclick="mostrarPanel('registro')">¿No tenés cuenta? Registrate</span>
      </div>
    </div>

    <!-- REGISTRO PANEL -->
    <div id="panel-registro" class="panel">
      <h2>Registrate</h2>
      <form id="register-form" autocomplete="off">
        <label>Comercio</label>
        <div style="position:relative;">
          <input type="text" id="comercio-buscar2" name="comercio_reg" placeholder="Buscá tu comercio..." required autocomplete="off">
          <div id="autocomplete-list2" class="autocomplete-list hidden"></div>
        </div>
        <input type="hidden" id="comercio-id2" name="comercio_id_reg">
        <label>Contraseña</label>
        <input type="password" id="password_reg" name="password_reg" placeholder="Elige una contraseña..." required minlength="4">
        <button type="submit">Crear cuenta</button>
        <div id="reg-msg"></div>
      </form>
      <div style="text-align:center;">
        <span class="link" onclick="mostrarPanel('login')">Ya tengo cuenta</span>
      </div>
    </div>

    <!-- PANEL ALTA NUEVO COMERCIO -->
    <div id="panel-nuevo-comercio" class="panel">
      <h2>Alta de nuevo comercio</h2>
      <div class="info">
        Tu comercio aún no está publicado.<br>
        <b>Completá el formulario para pedir el alta.</b><br>
        El proceso puede tardar hasta <b>48 hs hábiles</b>.<br>
        <button id="btnFormComercio">Ir al formulario de alta</button>
      </div>
      <div style="text-align:center;">
        <span class="link" onclick="mostrarPanel('login')">Volver al login</span>
      </div>
    </div>
  </div>

<script>
// CONFIGURACIÓN
const SHEET_ID = "170kTZ-ViCPxPli86g-n_XMuMv1S3O0-DbGwNFGYVnjY";
const SHEET_ANUNCIANTES = "anunciantes";
const WORKER_URL = "https://login.liqkoargentina.workers.dev/login";
const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSdZDgpGMYyb5uh1xpsJCN1MzNGoSgGZ9W9EUqQqAYFdB2EyBQ/viewform";
const PANEL_URL = "https://www.guialocaldolores.com.ar/anunciantes/panel/";

let comercios = [];

// Cambia de panel entre login, registro y alta nuevo comercio
function mostrarPanel(panel) {
  document.getElementById('panel-login').classList.remove('active');
  document.getElementById('panel-registro').classList.remove('active');
  document.getElementById('panel-nuevo-comercio').classList.remove('active');
  if (panel === 'login') document.getElementById('panel-login').classList.add('active');
  else if (panel === 'registro') document.getElementById('panel-registro').classList.add('active');
  else if (panel === 'nuevo-comercio') document.getElementById('panel-nuevo-comercio').classList.add('active');
}

// --- AUTOCOMPLETADO ---
function cargarComercios(callback) {
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${SHEET_ANUNCIANTES}`;
  fetch(url)
    .then(res => res.text())
    .then(text => {
      const json = JSON.parse(text.substr(47).slice(0, -2));
      comercios = json.table.rows.map(row => ({
        nombre: row.c[1] ? row.c[1].v : "",
        id: row.c[61] ? row.c[61].v : ""
      }));
      if (callback) callback();
    });
}

function showAutocomplete(inputEl, listEl, idEl, modoRegistro = false) {
  inputEl.addEventListener('input', function() {
    const val = this.value.trim().toLowerCase();
    listEl.innerHTML = '';
    if (val.length < 2) { listEl.classList.add('hidden'); return; }
    const matches = comercios.filter(c => c.nombre.toLowerCase().includes(val));
    matches.slice(0, 10).forEach(c => {
      const item = document.createElement('div');
      item.className = 'autocomplete-item';
      item.textContent = c.nombre;
      item.onclick = function() {
        inputEl.value = c.nombre;
        idEl.value = c.id;
        listEl.classList.add('hidden');
      };
      listEl.appendChild(item);
    });

    // SI NO HAY NINGUN RESULTADO, MOSTRAR OPCIÓN DE REGISTRAR NUEVO COMERCIO
    if (matches.length === 0) {
      const item = document.createElement('div');
      item.style.padding = "10px";
      item.style.background = "#fffbe5";
      item.innerHTML = `
        <b>¿Tu comercio aún no está publicado?</b><br>
        <button id="btnRegistrarComercio" style="margin-top:8px;">Solicitar alta de nuevo comercio</button>
      `;
      listEl.appendChild(item);
      setTimeout(() => {
        const btn = document.getElementById('btnRegistrarComercio');
        if(btn){
          btn.onclick = function() {
            mostrarPanel('nuevo-comercio');
          };
        }
      }, 100);
    }
    listEl.classList.toggle('hidden', !matches.length && inputEl.value.length < 2);
  });
  inputEl.addEventListener('blur', function() {
    setTimeout(() => listEl.classList.add('hidden'), 200);
  });
  inputEl.addEventListener('change', function() {
    if (this.value === "") idEl.value = "";
  });
}

// --- LOGIN y REGISTRO ---
document.addEventListener('DOMContentLoaded', () => {
  cargarComercios(() => {
    showAutocomplete(
      document.getElementById('comercio-buscar'),
      document.getElementById('autocomplete-list'),
      document.getElementById('comercio-id')
    );
    showAutocomplete(
      document.getElementById('comercio-buscar2'),
      document.getElementById('autocomplete-list2'),
      document.getElementById('comercio-id2'),
      true // modoRegistro
    );
  });

  // LOGIN
  document.getElementById("login-form").onsubmit = function(e) {
    e.preventDefault();
    const nombre = document.getElementById('comercio-buscar').value.trim();
    const clave = document.getElementById('clave').value.trim();
    if (!nombre) {
      document.getElementById('login-msg').innerHTML = "<span class='error'>Elegí un comercio de la lista.</span>";
      return;
    }
    document.getElementById('login-msg').innerHTML = "<span>Ingresando...</span>";
    fetch(WORKER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        accion: "login",
        nombre: nombre,
        password: clave
      })
    })
    .then(r => r.json())
    .then(res => {
      if (res.success) {
        // Guarda ID y nombre del comercio en localStorage
        localStorage.setItem("comercio_id", res.id);
        localStorage.setItem("comercio_nombre", res.nombre);
        document.getElementById('login-msg').innerHTML = "<span class='success'>" + res.message + "</span>";
        setTimeout(() => {
          window.top.location.href = PANEL_URL;
        }, 1000);
      } else {
        document.getElementById('login-msg').innerHTML = "<span class='error'>" + (res.message || "Login incorrecto") + "</span>";
      }
    })
    .catch(() => {
      document.getElementById('login-msg').innerHTML = "<span class='error'>Error de conexión.</span>";
    });
  };

  // REGISTRO
  document.getElementById("register-form").onsubmit = function(e) {
    e.preventDefault();
    const comercio = document.getElementById('comercio-buscar2').value.trim();
    const comercio_id = document.getElementById('comercio-id2').value.trim();
    const password = document.getElementById('password_reg').value.trim();
    if (!comercio_id) {
      document.getElementById('reg-msg').innerHTML = "<span class='error'>Elegí un comercio de la lista.</span>";
      return;
    }
    document.getElementById('reg-msg').innerHTML = "<span>Registrando...</span>";
    fetch(WORKER_URL, {
      method: "POST",
      body: JSON.stringify({
        accion: "registrar",
        password: password,
        comercio_id: comercio_id,
        comercio_nombre: comercio
      }),
      headers: { "Content-Type": "application/json" }
    })
    .then(r => r.json())
    .then(res => {
      if (res.success) {
        document.getElementById('reg-msg').innerHTML = "<span class='success'>" + res.message + "</span>";
        setTimeout(() => { window.top.location.href = PANEL_URL; }, 2000);
      } else {
        document.getElementById('reg-msg').innerHTML = "<span class='error'>" + res.message + "</span>";
      }
    })
    .catch(() => {
      document.getElementById('reg-msg').innerHTML = "<span class='error'>Error de conexión.</span>";
    });
  };

  // Botón para ir al formulario de alta de comercio nuevo
  document.getElementById('btnFormComercio')?.addEventListener('click', function() {
    window.open(FORM_URL, "_blank");
  });
});
</script>
</body>
</html>
