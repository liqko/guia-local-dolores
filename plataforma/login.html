<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      html, body { height: 100%; margin: 0; padding: 0; }
      body { font-family: Arial, sans-serif; background: #f7f7f7; min-height: 100vh; }
      .container {
        max-width: 700px;
        margin: 30px auto;
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 2px 12px #0002;
        padding: 28px 28px 12px 28px;
        max-height: 90vh;
        overflow-y: auto;
      }
      label { display: block; margin: 14px 0 4px; font-weight: 500;}
      input { width: 100%; padding: 7px; margin-bottom: 8px; border-radius:4px; border:1px solid #bbb;}
      .hidden { display: none; }
      .error { color: #c00; font-size: 0.95em; }
      .success { color: #060; font-size: 1.07em; margin-top: 15px;}
      button { margin-top: 18px; padding: 10px 0; width: 100%; font-size: 1.1em; border-radius:5px; border:1px solid #2a8; background:#3dc879; color:#fff; font-weight:bold;}
      .info { color:#666; font-size:0.93em; margin-bottom:8px;}
      .required-star { color: #d00; font-weight:bold;}
      .link-btn { color: #2a8; background: none; border: none; text-decoration: underline; cursor: pointer; font-size: 1em; margin-top: 10px;}
      .autocomplete-list { position:absolute; background:#fff; border:1px solid #bbb; z-index:10; max-height:180px; overflow-y:auto; width:100%; }
      .autocomplete-item { padding:7px; cursor:pointer; }
      .autocomplete-item:hover, .autocomplete-active { background:#e7f7fd; }
      .relative { position:relative; }
      .separador {margin: 32px 0 16px 0; border-top: 1px solid #ccc;}
      h2 {margin-bottom: 16px;}
    </style>
  </head>
  <body>
    <div class="container">

      <!-- Login inicial -->
      <div id="login-inicial">
        <h2>Ingresar</h2>
        <form id="form-login" autocomplete="off">
          <label>Email</label>
          <input type="email" name="email" required placeholder="Ej: tu@email.com" />
          <label>Contraseña</label>
          <input type="password" name="pass" id="pass-login" required minlength="8" placeholder="Mínimo 8 caracteres" />
          <span id="pass-error-login" class="error"></span>
          <button type="submit">Ingresar</button>
          <div id="resultado-login"></div>
        </form>
        <div style="margin-top:18px;">
          ¿No tenés cuenta?
          <button type="button" class="link-btn" id="btn-ir-registro">Crear cuenta nueva</button>
        </div>
      </div>

      <!-- Registro -->
      <div id="registro" class="hidden">
        <h2>Registrarse</h2>
        <div>
          <button type="button" id="btn-comercio-existente" class="tab active">Comercio existente</button>
          <button type="button" id="btn-comercio-nuevo" class="tab">Nuevo comercio</button>
        </div>
        <div id="form-comercio-existente">
          <form id="form-existente" autocomplete="off">
            <div class="relative">
              <label>Buscá tu comercio <span class="required-star">*</span></label>
              <input type="text" id="comercio-busqueda" name="comercio_nombre" autocomplete="off" required placeholder="Escribí las primeras letras del nombre" />
              <input type="hidden" name="comercio_id" id="comercio-id" />
              <div id="autocomplete-list" class="autocomplete-list hidden"></div>
            </div>
            <div class="info">
              Si tu comercio necesita correcciones, podrás actualizarlas luego desde tu panel.
            </div>
            <label>Nombre de usuario <span class="required-star">*</span></label>
            <input type="text" name="nombre" required placeholder="Ej: Juan Pérez" />
            <label>Email <span class="required-star">*</span></label>
            <input type="email" name="email" required placeholder="Ej: tu@email.com" />
            <label>WhatsApp <span class="required-star">*</span></label>
            <input type="text" name="whatsapp" required placeholder="Ej: 2245500000"/>
            <label>Contraseña <span class="required-star">*</span></label>
            <input type="password" name="pass" id="pass-existente" required minlength="8" placeholder="Mínimo 8 caracteres" />
            <span id="pass-error-existente" class="error"></span>
            <button type="submit">Registrar usuario</button>
            <div id="resultado-existente"></div>
          </form>
        </div>
        <div id="form-comercio-nuevo" class="hidden">
          <form id="form-nuevo" autocomplete="off">
            <label>Nombre de usuario <span class="required-star">*</span></label>
            <input type="text" name="nombre" required placeholder="Ej: Juan Pérez" />
            <label>Email <span class="required-star">*</span></label>
            <input type="email" name="email" required placeholder="Ej: tu@email.com" />
            <label>WhatsApp <span class="required-star">*</span></label>
            <input type="text" name="whatsapp" required placeholder="Ej: 2245500000"/>
            <label>Contraseña <span class="required-star">*</span></label>
            <input type="password" name="pass" id="pass-nuevo" required minlength="8" placeholder="Mínimo 8 caracteres" />
            <span id="pass-error-nuevo" class="error"></span>
            <button type="submit">Registrar usuario</button>
            <div id="resultado-nuevo"></div>
          </form>
          <div class="separador"></div>
          <div>
            <h3>Completá los datos de tu comercio</h3>
            <iframe
              src="https://docs.google.com/forms/d/e/1FAIpQLSdZDgpGMYyb5uh1xpsJCN1MzNGoSgGZ9W9EUqQqAYFdB2EyBQ/viewform?embedded=true"
              width="100%"
              height="1400"
              frameborder="0"
              marginheight="0"
              marginwidth="0"
              style="border:none; display:block;">
              Cargando…
            </iframe>
          </div>
        </div>
        <div style="margin-top:18px;">
          ¿Ya tenés cuenta?
          <button type="button" class="link-btn" id="btn-ir-login">Volver a ingresar</button>
        </div>
      </div>
    </div>

    <script>
      // Tabs visuales de registro
      document.getElementById('btn-comercio-existente').onclick = function() {
        this.classList.add('active');
        document.getElementById('btn-comercio-nuevo').classList.remove('active');
        document.getElementById('form-comercio-existente').classList.remove('hidden');
        document.getElementById('form-comercio-nuevo').classList.add('hidden');
      };
      document.getElementById('btn-comercio-nuevo').onclick = function() {
        this.classList.add('active');
        document.getElementById('btn-comercio-existente').classList.remove('active');
        document.getElementById('form-comercio-nuevo').classList.remove('hidden');
        document.getElementById('form-comercio-existente').classList.add('hidden');
      };

      // Cambio entre login y registro
      document.getElementById('btn-ir-registro').onclick = function() {
        document.getElementById('login-inicial').classList.add('hidden');
        document.getElementById('registro').classList.remove('hidden');
      };
      document.getElementById('btn-ir-login').onclick = function() {
        document.getElementById('registro').classList.add('hidden');
        document.getElementById('login-inicial').classList.remove('hidden');
      };

      // Autocompletado de comercios (nombre en B, id en BJ)
      let timer, lastValue = "";
      const inputBusqueda = document.getElementById('comercio-busqueda');
      const listaAuto = document.getElementById('autocomplete-list');
      const inputId = document.getElementById('comercio-id');
      if (inputBusqueda) {
        inputBusqueda.addEventListener('input', function() {
          const val = this.value.trim();
          if (val.length < 2) { listaAuto.classList.add('hidden'); return; }
          clearTimeout(timer);
          timer = setTimeout(function() {
            if (val === lastValue) return;
            lastValue = val;
            google.script.run.withSuccessHandler(function(comercios) {
              listaAuto.innerHTML = "";
              if (!comercios.length) {
                listaAuto.classList.add('hidden');
                return;
              }
              comercios.forEach(function(c) {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                item.textContent = c.nombre;
                item.onclick = function() {
                  inputBusqueda.value = c.nombre;
                  inputId.value = c.id;
                  listaAuto.classList.add('hidden');
                };
                listaAuto.appendChild(item);
              });
              listaAuto.classList.remove('hidden');
            }).buscarComerciosPorNombre(val);
          }, 200);
        });

        inputBusqueda.addEventListener('blur', function() {
          setTimeout(() => listaAuto.classList.add('hidden'), 200);
        });

        inputBusqueda.addEventListener('change', function() {
          if (this.value === "") inputId.value = "";
        });
      }

      // Validación de contraseña
      function validaPass(passEl, errEl) {
        passEl.addEventListener('input', function() {
          if(this.value.length < 8) {
            errEl.textContent = "La contraseña debe tener al menos 8 caracteres.";
          } else {
            errEl.textContent = "";
          }
        });
      }
      validaPass(document.getElementById('pass-existente'), document.getElementById('pass-error-existente'));
      validaPass(document.getElementById('pass-nuevo'), document.getElementById('pass-error-nuevo'));
      validaPass(document.getElementById('pass-login'), document.getElementById('pass-error-login'));

      // Enviar formulario login
      document.getElementById('form-login').onsubmit = function(e) {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(this));
        if(data.pass.length < 8) {
          document.getElementById('pass-error-login').textContent = "La contraseña debe tener al menos 8 caracteres.";
          return;
        }
        document.getElementById('resultado-login').textContent = "Ingresando...";
        google.script.run.withSuccessHandler(function(msg) {
          document.getElementById('resultado-login').innerHTML = msg.success
            ? '<span class="success">'+msg.message+'</span>'
            : '<span class="error">'+msg.message+'</span>';
        }).loginUsuario(data);
      };

      // Enviar formulario comercio existente
      document.getElementById('form-existente').onsubmit = function(e) {
        e.preventDefault();
        if(!inputId.value) {
          alert("Debés elegir un comercio de la lista desplegable.");
          return;
        }
        var data = Object.fromEntries(new FormData(this));
        if(data.pass.length < 8) {
          document.getElementById('pass-error-existente').textContent = "La contraseña debe tener al menos 8 caracteres.";
          return;
        }
        document.getElementById('resultado-existente').textContent = "Registrando...";
        google.script.run.withSuccessHandler(function(msg) {
          document.getElementById('resultado-existente').innerHTML = '<span class="success">'+msg+'</span>';
        }).registrarUsuarioComercioExistente(data);
      };

      // Enviar formulario nuevo comercio (registro de usuario)
      document.getElementById('form-nuevo').onsubmit = function(e) {
        e.preventDefault();
        var data = Object.fromEntries(new FormData(this));
        if(data.pass.length < 8) {
          document.getElementById('pass-error-nuevo').textContent = "La contraseña debe tener al menos 8 caracteres.";
          return;
        }
        document.getElementById('resultado-nuevo').textContent = "Registrando...";
        google.script.run.withSuccessHandler(function(msg) {
          document.getElementById('resultado-nuevo').innerHTML = '<span class="success">'+msg+'</span>';
        }).registrarUsuarioNuevoComercio(data);
      };
    </script>
  </body>
</html>
