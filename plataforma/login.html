<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Panel Comercios - Login & Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#f5f7fb; --card:#fff; --muted:#6b7280; --accent:#2f9e6a;
      --accent-2:#1f7a50; --danger:#e65144; --shadow: 0 6px 22px rgba(15,23,42,0.08);
      --radius:12px; --gap:12px;
    }
    *{box-sizing:border-box;font-family:Inter, "Helvetica Neue", Arial, sans-serif}
    body{background:var(--bg);margin:0;padding:20px;color:#111}
    .container{max-width:920px;margin:18px auto;background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:22px}
    h2{margin:0 0 12px;font-weight:600;color:#0b2540}
    label{display:block;margin-bottom:6px;font-weight:600;color:var(--muted);font-size:0.9rem}
    input[type="text"], input[type="password"], textarea, select {
      width:100%;padding:10px;border-radius:8px;border:1px solid #dde3ea;background:#fbfdff;
      font-size:0.95rem;color:#102030; margin-bottom:10px;
    }
    textarea{min-height:72px;resize:vertical}
    .row{display:flex;gap:var(--gap);}
    .col{flex:1}
    .actions{display:flex;gap:10px;align-items:center}
    button{cursor:pointer;border-radius:8px;padding:10px 14px;border:0;font-weight:600}
    button.primary{background:var(--accent);color:#fff}
    button.ghost{background:transparent;border:1px solid #d0d7df;color:#0b2540}
    .link{color:#1e90ff;cursor:pointer;text-decoration:underline;display:inline-block;margin-top:6px}
    .autocomplete-list{position:absolute;background:#fff;border:1px solid #d7dde6;z-index:30;max-height:250px;overflow-y:auto;width:100%;border-radius:8px;box-shadow:0 8px 24px rgba(12,20,30,0.06)}
    .autocomplete-item{padding:10px;border-bottom:1px solid #f1f5f9;cursor:pointer}
    .autocomplete-item:hover{background:#f1fcf7}
    .hidden{display:none}
    .success{color:#0a8a3a;font-weight:700}
    .error{color:var(--danger);font-weight:700}
    .panel{display:none}
    .panel.active{display:block}
    #debug{background:#0b1220;color:#bfe7d2;padding:10px;border-radius:8px;max-height:160px;overflow:auto;font-size:12px;margin-top:12px;white-space:pre-wrap}
    /* Dashboard layout */
    .tabs{display:flex;gap:8px;border-bottom:1px solid #e6eef3;margin-bottom:12px}
    .tab{padding:8px 12px;border-radius:8px;cursor:pointer;background:transparent;color:#0b2540}
    .tab.active{background:linear-gradient(180deg,#eef7f0,#e2f4e1);border:1px solid #d6efe0}
    #campos-datos-comercio{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:10px}
    .field { display:flex;flex-direction:column }
    .blocked { background: linear-gradient(90deg,#fbfdfc,#f6f8f7); border:1px dashed #d7e6de; color:#234b3a; position:relative; }
    .top-actions{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:12px}
    footer{font-size:0.85rem;color:var(--muted);margin-top:12px;text-align:center}
    /* loading overlay */
    #loading-overlay{position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(11,18,32,0.45);display:none;align-items:center;justify-content:center;z-index:2000}
    .loader { width:72px;height:72px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:linear-gradient(90deg,#fff,#f1f8f2);box-shadow:0 6px 20px rgba(6,15,10,0.12)}
    .spinner{width:36px;height:36px;border:4px solid #e6f3ea;border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .loading-text{color:#fff;margin-top:12px;font-weight:700}
    /* small */
    .muted{color:var(--muted);font-size:0.9rem}
    @media (max-width:640px){ .row{flex-direction:column} #campos-datos-comercio{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="container">
    <!-- LOGIN PANEL -->
    <div id="panel-login" class="panel active">
      <h2>Ingresar a tu comercio</h2>
      <form id="login-form" autocomplete="off">
        <label>Comercio</label>
        <div style="position:relative;">
          <input type="text" id="comercio-buscar" placeholder="Buscá tu comercio..." autocomplete="off" required>
          <div id="autocomplete-list" class="autocomplete-list hidden"></div>
        </div>
        <input type="hidden" id="comercio-id">
        <label>Clave</label>
        <input type="password" id="clave" placeholder="Clave..." required minlength="1">
        <div class="actions" style="margin-top:6px">
          <button id="btnLogin" class="primary" disabled>Ingresar</button>
          <button type="button" class="ghost" onclick="location.href=FORM_URL">Solicitar alta</button>
        </div>
        <div id="login-msg" style="margin-top:8px"></div>
        <div id="report-area" style="display:none;margin-top:8px">
          <button id="reportBtn" class="ghost">Contactar Soporte (WhatsApp)</button>
        </div>
      </form>
    </div>

    <!-- DASHBOARD (con pestañas) -->
    <div id="panel-dashboard" class="panel">
      <div class="top-actions">
        <div style="font-size:1.1em">¡Hola <strong id="nombre-comercio"></strong>!</div>
        <div>
          <a id="link-support-dashboard" class="link" href="#" target="_blank">WhatsApp Soporte</a>
        </div>
      </div>

      <div class="tabs" role="tablist" aria-label="Panel tabs">
        <div class="tab active" data-tab="datos">Datos</div>
        <div class="tab" data-tab="prote">Protegidos</div>
        <div class="tab" data-tab="func">Funciones</div>
      </div>

      <div id="tab-datos" class="tab-panel">
        <form id="form-datos-comercio">
          <div id="campos-datos-comercio" aria-live="polite"></div>
          <div style="display:flex;gap:8px;margin-top:12px;">
            <button id="btnGuardar" type="submit" class="primary" style="flex:1">Guardar cambios</button>
            <button id="logout-btn" type="button" class="ghost" style="flex:0">Cerrar sesión</button>
          </div>
          <div id="msg-datos-comercio" style="margin-top:10px"></div>
        </form>
      </div>

      <div id="tab-prote" class="tab-panel hidden">
        <div class="muted">Campos protegidos (solo lectura). Hacé click en "Mostrar" para ver.</div>
        <div style="margin-top:8px;">
          <button id="toggle-prote" class="ghost">Mostrar datos protegidos</button>
        </div>
        <div id="campos-protegidos" style="margin-top:12px;display:none"></div>
      </div>

      <div id="tab-func" class="tab-panel hidden">
        <h3 style="margin-top:0">Funciones</h3>
        <div class="muted">Aquí aparecerán las funcionalidades para el anunciante (ej. estadísticas, promociones, facturación).</div>
        <div style="margin-top:12px" id="func-placeholder">
          <!-- placeholders para futuras funcionalidades -->
        </div>
      </div>
    </div>

    <h3 style="margin-top:18px">Debug / Registros</h3>
    <div id="debug"></div>
    <footer>Panel de comercios — interfaz con pestañas y feedback</footer>
  </div>

  <!-- Loading overlay -->
  <div id="loading-overlay">
    <div style="text-align:center">
      <div class="loader"><div class="spinner" role="status" aria-label="Cargando"></div></div>
      <div class="loading-text">Cargando datos del comercio...</div>
    </div>
  </div>

<script>
/* CONFIG - no tocar si no querés */
const WORKER_URL = "https://login.liqkoargentina.workers.dev/login";
const WORKER_ORIGIN = (new URL(WORKER_URL)).origin;
const SHEET_ID = "170kTZ-ViCPxPli86g-n_XMuMv1S3O0-DbGwNFGYVnjY";
const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSdZDgpGMYyb5uh1xpsJCN1MzNGoSgGZ9W9EUqQqAYFdB2EyBQ/viewform";
/* Campos que NO deben ser editables desde el panel (se muestran en pestaña 'Protegidos') */
const BLOCKED = ["__id","id","planilla_id","planilla id","codigo","nivel","nivel_acceso","verificado","gold","subnivel","nivelacceso"];

let comercios = [];
let sesion = null;
let loginInProgress = false;
const debugEl = document.getElementById('debug');
function debugLog(...args){ console.log(...args); try { debugEl.textContent += args.map(a=>typeof a==='object'?JSON.stringify(a,null,2):String(a)).join(' ') + "\n\n"; debugEl.scrollTop = debugEl.scrollHeight; }catch(e){} }

/* UI helpers */
function showOverlay(msg){ document.getElementById('loading-overlay').style.display='flex'; if(msg) document.querySelector('.loading-text').textContent = msg; }
function hideOverlay(){ document.getElementById('loading-overlay').style.display='none'; document.querySelector('.loading-text').textContent = 'Cargando datos del comercio...'; }
function disableBtn(btn){ if(!btn) return; btn.dataset.disabled = '1'; btn.setAttribute('disabled','true'); }
function enableBtn(btn){ if(!btn) return; delete btn.dataset.disabled; btn.removeAttribute('disabled'); }

/* Tabs */
document.addEventListener('click', function(e){
  const t = e.target.closest('.tab');
  if(t){
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const tab = t.dataset.tab;
    document.querySelectorAll('.tab-panel').forEach(p=>p.classList.add('hidden'));
    document.getElementById('tab-'+tab).classList.remove('hidden');
  }
});

/* Autocomplete / cargar comercios */
function cargarComercios(callback){
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=anunciantes`;
  fetch(url, {cache:'no-store'}).then(r=>r.text()).then(text=>{
    try{
      const start=text.indexOf('{'), end=text.lastIndexOf('}');
      const jsonText=text.slice(start,end+1);
      const json=JSON.parse(jsonText);
      const cols=(json.table && json.table.cols)? json.table.cols.map(c=>(c&&c.label)?String(c.label).toLowerCase().trim():''):[];
      let idxNombre = cols.findIndex(h=>/nombre|comercio|title|titulo/.test(h)); if(idxNombre===-1) idxNombre=1;
      let idxId = cols.findIndex(h=>/id|planilla|planilla_id|codigo/.test(h)); if(idxId===-1) idxId=61;
      comercios=(json.table.rows||[]).map(row=>({ nombre:(row.c && row.c[idxNombre] && row.c[idxNombre].v)?row.c[idxNombre].v:'', id:(row.c && row.c[idxId] && row.c[idxId].v)?row.c[idxId].v:'' })).filter(c=>c.nombre);
      debugLog('Comercios cargados:', comercios.length);
      callback && callback();
    }catch(e){
      debugLog('Error parseando lista de comercios', e);
      callback && callback();
    }
  }).catch(err=>{ debugLog('Error fetch lista de comercios', err); callback && callback(); });
}

function showAutocomplete(inputEl, listEl, idEl){
  if(!inputEl||!listEl||!idEl) return;
  let debounceTimer;
  inputEl.addEventListener('input', function(){
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(()=>{
      const val=this.value.trim().toLowerCase(); listEl.innerHTML='';
      if(val.length<2){ listEl.classList.add('hidden'); idEl.value=''; document.getElementById('btnLogin')?.setAttribute('disabled','true'); return; }
      const matches = comercios.filter(c=>c.nombre.toLowerCase().includes(val));
      if(matches.length){
        matches.slice(0,20).forEach(c=>{
          const item=document.createElement('div'); item.className='autocomplete-item'; item.textContent=c.nombre + (c.id?(' ('+c.id+')'):'');
          item.onclick=function(){ inputEl.value=c.nombre; idEl.value=c.id||''; listEl.classList.add('hidden'); document.getElementById('btnLogin')?.removeAttribute('disabled'); };
          listEl.appendChild(item);
        });
        listEl.classList.remove('hidden');
      } else {
        const item=document.createElement('div'); item.style.padding='10px'; item.style.background='#fffbe5';
        item.innerHTML = `<b>¿Tu comercio no está publicado?</b><br><button id="btnRegistrarComercio" style="margin-top:8px;width:100%;">Solicitar alta</button>`;
        listEl.appendChild(item);
        setTimeout(()=>{ const btn=document.getElementById('btnRegistrarComercio'); if(btn) btn.onclick=()=> mostrarPanel('registro'); },50);
        listEl.classList.remove('hidden');
      }
    }, 180);
  });
  inputEl.addEventListener('blur', ()=> setTimeout(()=>listEl.classList.add('hidden'),200));
  inputEl.addEventListener('change', function(){ if(this.value===''){ idEl.value=''; document.getElementById('btnLogin')?.setAttribute('disabled','true'); } });
}

/* LOGIN */
document.addEventListener('DOMContentLoaded', ()=>{
  cargarComercios(()=>{ showAutocomplete(document.getElementById('comercio-buscar'), document.getElementById('autocomplete-list'), document.getElementById('comercio-id')); });
  document.getElementById('login-form').onsubmit = async function(e){
    e.preventDefault();
    // Evitar doble submit por bandera
    if (loginInProgress) return;
    const nombre = document.getElementById('comercio-buscar').value.trim();
    const clave = document.getElementById('clave').value.trim();
    const id = document.getElementById('comercio-id').value.trim();
    if(!id && !nombre){ document.getElementById('login-msg').innerHTML = "<span class='error'>Elegí un comercio de la lista.</span>"; return; }

    // Estado visual inmediato: deshabilitar botón y mostrar overlay
    loginInProgress = true;
    const btn = document.getElementById('btnLogin');
    disableBtn(btn);
    showOverlay('Verificando credenciales...');

    document.getElementById('login-msg').innerHTML = "<span>Ingresando...</span>";

    const payload = { accion:'login', comercio_id:id||'', nombre:nombre, password:clave };

    // Timeout / abort safety
    const controller = new AbortController();
    const timeout = setTimeout(()=> controller.abort(), 15000);

    try{
      const r = await fetch(WORKER_URL, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify(payload),
        mode:'cors',
        signal: controller.signal
      });

      clearTimeout(timeout);

      const text = await r.text();
      let res;
      try { res = JSON.parse(text); } catch(e) { res = { success:false, message: text }; }

      debugLog('Login worker ->', r.status, res);

      if (r.status === 200 && res.success) {
        // Guardar sesión local y mostrar mensaje inmediato
        localStorage.setItem('comercio_id', res.id || id);
        localStorage.setItem('comercio_nombre', res.nombre || nombre);
        if(res.planilla_id) localStorage.setItem('planilla_id', res.planilla_id);
        sesion = { id: res.id || id, nombre: res.nombre || nombre, planilla_id: res.planilla_id || '' };
        document.getElementById('login-msg').innerHTML = "<span class='success'>"+(res.message||'Ingresado')+"</span>";

        // Opcional: ocultar el botón para que no esté visible mientras cargan datos
        btn.style.display = 'none';

        // Espera ligera para que se vea el mensaje y luego carga el dashboard
        setTimeout(async ()=>{
          try {
            await mostrarPanelDashboard(); // mostrarPanelDashboard se encarga de mostrar overlay y ocultarlo al terminar
          } finally {
            // Restaurar estado del botón cuando termine (en caso de volver al login)
            btn.style.display = '';
          }
        }, 200);

        return;
      }

      // Si login falló
      document.getElementById('login-msg').innerHTML = "<span class='error'>"+(res.message||'Login falló')+"</span>";
      enableReportButton(`Intento login\nPayload: ${JSON.stringify(payload)}\nWorker status: ${r.status}\nWorker body: ${JSON.stringify(res)}`);
    } catch(err){
      if (err.name === 'AbortError') {
        document.getElementById('login-msg').innerHTML = "<span class='error'>Timeout: la petición tardó demasiado. Intentá de nuevo.</span>";
      } else {
        debugLog('Error fetch worker', err);
        document.getElementById('login-msg').innerHTML = "<span class='error'>Error de conexión. Intentá nuevamente.</span>";
        enableReportButton(`Error fetch worker: ${err}`);
      }
    } finally {
      clearTimeout(timeout);
      loginInProgress = false;
      enableBtn(btn);
      // hideOverlay se debe llamar por mostrarPanelDashboard() al terminar; 
      // si ocurrió error y no se llamó al dashboard, ocultamos overlay aquí
      if (!document.getElementById('tab-datos') || document.getElementById('campos-datos-comercio').innerHTML === '') {
        hideOverlay();
      }
    }
  };

  document.getElementById('btnSolicitarAlta')?.addEventListener('click', ()=> window.open(FORM_URL,'_blank'));
  document.getElementById('logout-btn').addEventListener('click', ()=> { localStorage.removeItem('comercio_id'); localStorage.removeItem('comercio_nombre'); localStorage.removeItem('planilla_id'); sesion=null; mostrarPanel('login'); });
  if(localStorage.getItem('comercio_id') && localStorage.getItem('comercio_nombre')){ sesion = { id: localStorage.getItem('comercio_id'), nombre: localStorage.getItem('comercio_nombre'), planilla_id: localStorage.getItem('planilla_id')||'' }; mostrarPanelDashboard(); }
});

/* MOSTRAR DASHBOARD: pedir datos al worker y construir pestañas */
async function mostrarPanelDashboard(){
  if(!sesion || !sesion.id){ mostrarPanel('login'); return; }
  mostrarPanel('dashboard');
  document.getElementById('nombre-comercio').textContent = sesion.nombre;
  showOverlay('Cargando datos del comercio...');
  // fetch datos
  try{
    const url = `${WORKER_ORIGIN}/commerce?id=${encodeURIComponent(sesion.id)}&nombre=${encodeURIComponent(sesion.nombre)}&planilla_id=${encodeURIComponent(sesion.planilla_id||'')}`;
    const r = await fetch(url, { method:'GET', mode:'cors' });
    const datos = await r.json().catch(()=>({ error:'Respuesta inválida'}));
    debugLog('/commerce ->', datos);
    if(datos.error){ hideOverlay(); document.getElementById('campos-datos-comercio').innerHTML = `<b>Error:</b> ${datos.error}`; return; }
    if(datos.planilla_id && datos.planilla_id !== sesion.planilla_id){ sesion.planilla_id = datos.planilla_id; localStorage.setItem('planilla_id', datos.planilla_id); }
    buildDashboardFields(datos);
    hideOverlay();
  }catch(err){
    debugLog('Error al consultar /commerce', err);
    hideOverlay();
    document.getElementById('campos-datos-comercio').innerHTML = `<b>Error conexión con Worker.</b>`;
  }
}

/* Construir campos en "Datos" (solo campos no bloqueados) y en "Protegidos" (read-only ocultos) */
function buildDashboardFields(datos){
  const camposPreferred = ["nombre","direccion","lat","lng","telefono","whatsapp","mail","descripcion","tags","categoria","segmento","logo","img1","img2","img3","img4","link","pie","adicionales"];
  const datosContainer = document.getElementById('campos-datos-comercio');
  const proteContainer = document.getElementById('campos-protegidos');
  datosContainer.innerHTML = '';
  proteContainer.innerHTML = '';
  // Add editable fields (only those in camposPreferred)
  camposPreferred.forEach(c=>{
    const value = datos[c] || '';
    const div = document.createElement('div'); div.className='field';
    div.innerHTML = `<label>${escapeHtml(c)}</label><input type="text" name="${escapeHtml(c)}" value="${escapeHtml(String(value))}" />`;
    datosContainer.appendChild(div);
  });
  // Add hidden id
  const hidden = document.createElement('input'); hidden.type='hidden'; hidden.name='__id'; hidden.value = datos.__id || sesion.id || '';
  datosContainer.appendChild(hidden);
  // Protegidos: show blocked fields (readOnly)
  Object.keys(datos).forEach(k=>{
    if(BLOCKED.some(b=>b.toLowerCase().trim() === String(k).toLowerCase().trim())){
      const val = datos[k] || '';
      const d = document.createElement('div'); d.className='field';
      d.innerHTML = `<label>${escapeHtml(k)}</label><input type="text" name="${escapeHtml(k)}" value="${escapeHtml(String(val))}" readonly class="blocked" />`;
      proteContainer.appendChild(d);
    }
  });
  // Ensure block toggle works
  document.getElementById('toggle-prote').onclick = function(){
    const el = document.getElementById('campos-protegidos');
    if(el.style.display === 'none' || el.style.display === ''){ el.style.display='block'; this.textContent='Ocultar datos protegidos'; } else { el.style.display='none'; this.textContent='Mostrar datos protegidos'; }
  };
  // Attach form submit handler (prevent double submit, disable buttons)
  const form = document.getElementById('form-datos-comercio');
  form.onsubmit = function(e){
    e.preventDefault();
    if(this.dataset.sending === '1') return;
    this.dataset.sending = '1';
    const btn = document.getElementById('btnGuardar');
    disableBtn(btn);
    const fd = new FormData(this);
    const data = {};
    fd.forEach((v,k)=> data[k]=v);
    if(!data.__id) data.__id = sesion.id;
    showOverlay('Guardando cambios...');
    // Post to worker save endpoint
    const saveUrl = `${WORKER_ORIGIN}/commerce?id=${encodeURIComponent(sesion.id)}&planilla_id=${encodeURIComponent(sesion.planilla_id||'')}`;
    fetch(saveUrl, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data), mode:'cors' })
      .then(r=>r.json().catch(()=>({success:false, raw:'no json'})))
      .then(res=>{ debugLog('respuesta guardar ->', res); if(res && res.success) { document.getElementById('msg-datos-comercio').textContent = '¡Datos guardados!'; } else { document.getElementById('msg-datos-comercio').textContent = 'Error al guardar.'; } })
      .catch(err=>{ debugLog('Error guardando', err); document.getElementById('msg-datos-comercio').textContent = 'Error de conexión.'; })
      .finally(()=>{ hideOverlay(); enableBtn(btn); delete form.dataset.sending; });
  };
}

/* Helpers */
function escapeHtml(str){ return String(str).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); }); }
function mostrarPanel(panel){ ['panel-login','panel-registro','panel-dashboard'].forEach(id=>document.getElementById(id).classList.remove('active')); document.getElementById('panel-'+panel)?.classList.add('active'); }
function enableReportButton(payloadText){ document.getElementById('report-area').style.display='block'; document.getElementById('reportBtn').onclick = ()=> openWhatsApp(payloadText + "\n\nPor favor revisen. Gracias."); }
function openWhatsApp(text){ const number="5492245459957"; window.open(`https://wa.me/${number}?text=${encodeURIComponent(text)}`,'_blank'); }
</script>
</body>
</html>
