<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Comercios y Promos</title>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;500&display=swap" rel="stylesheet">
  <style>
    /* Estilos completos y responsivos (resumen: variables, card layout, botones, sociales, vermas, etc.) */
    :root { --accent1:#ff4e50; --accent2:#f9d423; --card-bg:rgba(255,255,255,0.96); --text:#24324d; --map-blue:#0e5076;}
    html,body{margin:0;padding:0;font-family:'Montserrat', 'Segoe UI', Arial, sans-serif;background:linear-gradient(135deg,var(--accent2) 0%,var(--accent1) 100%);color:var(--text);-webkit-font-smoothing:antialiased}
    .header-flex{display:flex;gap:18px;justify-content:center;align-items:center;margin-top:40px;flex-wrap:wrap}
    .main-logo{width:72px;height:72px;border-radius:14px;background:#fff;box-shadow:0 6px 18px rgba(0,0,0,0.08);object-fit:cover}
    .header-title{color:#fff;font-size:2.15rem;font-weight:900;text-align:center;margin:0;padding:4px 10px;text-shadow:0 2px 12px rgba(0,0,0,0.25)}
    .search-container{display:flex;justify-content:center;margin-top:20px}
    .search-box{width:360px;padding:14px 18px;border-radius:14px;border:none;outline:none;font-size:1rem;background:rgba(255,255,255,0.9);box-shadow:0 6px 20px rgba(0,0,0,0.08)}
    .categories-bar{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin:14px 0 6px 0}
    .category-chip{background:#fff9cc;color:var(--accent1);border:2px solid var(--accent2);padding:8px 16px;border-radius:14px;font-weight:700;cursor:pointer}
    .category-chip.selected,.category-chip:hover{background:var(--accent1);color:#fff;border-color:var(--accent1)}
    .cards-container{display:flex;flex-direction:column;gap:20px;align-items:center;padding:28px 14px 80px 14px}
    .card{width:100%;max-width:880px;background:var(--card-bg);border-radius:18px;padding:18px;box-shadow:0 12px 30px rgba(0,0,0,0.08);border:1px solid rgba(255,255,255,0.6);display:flex;flex-direction:column;gap:12px}
    .card-logos-row{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .left-row{display:flex;gap:12px;align-items:center;min-width:0}
    .logo-comercio{width:72px;height:72px;border-radius:12px;object-fit:cover;background:#fff;border:2px solid rgba(249,212,35,0.27)}
    .title-block{min-width:0}
    .card-title{font-size:1.18rem;font-weight:800;color:var(--accent1);margin-bottom:6px;word-break:break-word}
    .cat-label{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:10px;background:rgba(255,78,80,0.06);border:1px solid rgba(0,0,0,0.06);font-weight:800;color:var(--accent2)}
    .logo-categoria{width:36px;height:36px;border-radius:8px;object-fit:cover;border:2px solid rgba(255,78,80,0.2);background:#fff}
    .promo-row{background:transparent;border-left:4px solid var(--accent2);padding:10px 12px;font-weight:800;color:#222;border-radius:6px;box-shadow:0 6px 18px rgba(249,212,35,0.06)}
    .fecha-row{color:var(--map-blue);font-weight:700;display:flex;align-items:center;gap:8px}
    .otros-row{color:var(--accent1);font-style:italic}
    .info-row{display:flex;align-items:center;gap:10px;color:var(--text)}
    .info-row .icon{color:var(--accent1);font-size:1.1rem;min-width:26px;text-align:center}
    .card-footer{display:flex;justify-content:space-between;gap:12px;align-items:flex-start;flex-wrap:wrap}
    .contact-block{display:flex;flex-direction:column;gap:8px;min-width:50%}
    .socials{display:flex;gap:8px;align-items:center}
    .socials a{display:inline-flex;align-items:center;justify-content:center;width:38px;height:38px;border-radius:10px;background:rgba(0,0,0,0.03);color:var(--accent1);font-size:1.2rem;text-decoration:none}
    .btn-maps{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;background:linear-gradient(90deg,#0e76a8 0%, #0e5076 100%);color:#fff;font-weight:800;border-radius:12px;text-decoration:none;box-shadow:0 8px 20px rgba(14,80,118,0.18)}
    .details-grid{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .badge{background:#fff;padding:6px 10px;border-radius:10px;border:1px solid rgba(0,0,0,0.04);font-weight:700}
    .extras-container{margin-top:6px;background:rgba(0,0,0,0.02);padding:12px;border-radius:10px}
    .extras-table{width:100%;border-collapse:collapse;font-size:0.95rem}
    .extras-table td{padding:6px 8px;vertical-align:top;border-bottom:1px dashed rgba(0,0,0,0.04)}
    .vermas{display:inline-flex;gap:8px;align-items:center;cursor:pointer;color:var(--map-blue);font-weight:700;text-decoration:underline;background:none;border:none;padding:0}
    .paginator{display:flex;justify-content:center;gap:16px;margin:18px 0 40px;align-items:center}
    .paginator button{padding:8px 14px;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff;border:none;border-radius:8px;font-weight:800;cursor:pointer}
    .paginator button[disabled]{background:#eee;color:#aaa;cursor:default}
    @media (max-width:900px){.search-box{width:92%;max-width:680px}.card{padding:14px}.logo-comercio{width:64px;height:64px}.socials a{width:34px;height:34px}}
    @media (max-width:600px){.card{padding:12px}.card-logos-row{flex-direction:column;align-items:flex-start;gap:8px}.contact-block{min-width:100%}.btn-maps{width:100%;justify-content:center}}
  </style>
</head>
<body>
  <div class="header-flex">
    <img class="main-logo" src="https://raw.githubusercontent.com/liqko/guia-local-dolores/refs/heads/main/img/plataforma/descuentos.png" alt="Logo">
    <h1 class="header-title">PROMOS & DESCUENTOS</h1>
  </div>

  <div class="search-container">
    <input id="search" class="search-box" placeholder="Buscar por nombre, categoría o promo...">
  </div>

  <div id="categoriesBar" class="categories-bar"></div>
  <div id="cards" class="cards-container"></div>
  <div id="paginator" class="paginator"></div>

  <script>
    // URL del Apps Script /exec (actualizala si redeployaste)
    const DATA_URL = "https://script.google.com/macros/s/AKfycbwFB1sAjvEEXPqxX-ePdZOJdeOv3DPx0O3dbAoa1QQMzNA9NxPBAad2XJ_uBeTMSjQz/exec";

    let comerciosData = [];
    let filtrados = [];
    let currentPage = 1;
    const itemsPerPage = 10;
    let categoriasSet = new Set();
    let categoriaFiltro = "";

    function fechaHumana(fecha) {
      if (!fecha) return "";
      if (!isNaN(fecha) && typeof fecha !== "string") {
        const base = Date.UTC(1899,11,30);
        fecha = new Date(base + Number(fecha) * 86400000);
      }
      const d = new Date(fecha);
      if (isNaN(d.getTime())) return String(fecha);
      const meses = ["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"];
      return `${d.getUTCDate()} de ${meses[d.getUTCMonth()]} de ${d.getUTCFullYear()}`;
    }

    function escapeHtml(text) {
      if (text === null || text === undefined) return "";
      return String(text).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");
    }

    function encodeUrl(u) {
      if (!u) return '';
      u = String(u).trim();
      if (/^https?:\/\//i.test(u)) return u;
      if (/^mailto:/i.test(u) || /^tel:/i.test(u)) return u;
      if (/^www\./i.test(u)) return 'https://' + u;
      return 'https://' + u;
    }

    function makeWhatsAppLink(wh) {
      // SOLO usa el campo 'whatsapp' (no usa telefono)
      if (!wh) return "";
      const s = String(wh).trim();
      if (/^https?:\/\//i.test(s)) return s;
      const digits = s.replace(/[^0-9+]/g,'');
      const numeric = digits.replace(/\+/g,'');
      if (numeric.length >= 6) {
        const clean = digits.replace(/\+/g,'');
        return 'https://wa.me/' + clean;
      }
      return encodeUrl(s);
    }

    function makeMapLink(llegarVal, domicilioVal) {
      if (llegarVal && String(llegarVal).trim()) {
        const v = String(llegarVal).trim();
        if (/^https?:\/\//i.test(v)) return v;
        if (/^-?\d+(\.\d+)?\s*,\s*-?\d+(\.\d+)?$/.test(v)) {
          const coords = v.replace(/\s+/g,'');
          return `https://www.google.com/maps?q=${coords}`;
        }
        return encodeUrl(v);
      }
      if (domicilioVal && String(domicilioVal).trim()) {
        const q = encodeURIComponent(String(domicilioVal).trim());
        return `https://www.google.com/maps/search/?api=1&query=${q}`;
      }
      return "";
    }

    function encodeTel(t) {
      if (!t) return '';
      return String(t).replace(/[^\d+]/g, '');
    }

    function renderCategoriesBar() {
      const bar = document.getElementById('categoriesBar');
      bar.innerHTML = '';
      if (categoriasSet.size <= 1) return;
      Array.from(categoriasSet).forEach(cat => {
        const btn = document.createElement('button');
        btn.className = 'category-chip' + (categoriaFiltro === cat ? ' selected' : '');
        btn.textContent = cat;
        btn.onclick = () => {
          categoriaFiltro = (categoriaFiltro === cat ? "" : cat);
          document.getElementById('search').value = "";
          aplicarFiltro("");
        };
        bar.appendChild(btn);
      });
      if (categoriaFiltro) {
        const limpiar = document.createElement('button');
        limpiar.className = 'category-chip';
        limpiar.style.background = '#eee';
        limpiar.style.color = '#333';
        limpiar.textContent = 'Todas las categorías';
        limpiar.onclick = () => { categoriaFiltro = ''; aplicarFiltro(''); };
        bar.insertBefore(limpiar, bar.firstChild);
      }
    }

    function renderCards(data, page = 1) {
      const cardsDiv = document.getElementById('cards');
      cardsDiv.innerHTML = '';
      const start = (page-1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pageData = data.slice(start, end);
      let count = 0;

      pageData.forEach(com => {
        const card = document.createElement('div');
        card.className = 'card';

        // Left block: logo + title + category
        const leftHtml = `
          <div class="left-row">
            ${com.logo ? `<img class="logo-comercio" src="${encodeUrl(com.logo)}" alt="${escapeHtml(com.nombre||'')}" onerror="this.style.display='none'">` : ''}
            <div class="title-block">
              <div class="card-title">${escapeHtml(com.nombre||'')}</div>
              ${com.categoria ? `<div class="cat-label">${com.logo1 ? `<img class="logo-categoria" src="${encodeUrl(com.logo1)}" alt="cat" style="margin-right:8px; vertical-align:middle;" onerror="this.style.display='none'">` : ''}${escapeHtml(com.categoria)}</div>` : ''}
            </div>
          </div>
        `;

        // Socials
        const socials = [];
        if (com.whatsapp) { const wa = makeWhatsAppLink(com.whatsapp); socials.push(`<a href="${encodeUrl(wa)}" target="_blank" rel="noopener" title="WhatsApp"><i class="ri-whatsapp-line"></i></a>`); }
        if (com.facebook) socials.push(`<a href="${encodeUrl(com.facebook)}" target="_blank" rel="noopener" title="Facebook"><i class="ri-facebook-line"></i></a>`);
        if (com.youtube) socials.push(`<a href="${encodeUrl(com.youtube)}" target="_blank" rel="noopener" title="YouTube"><i class="ri-youtube-line"></i></a>`);
        if (com.tiktok) socials.push(`<a href="${encodeUrl(com.tiktok)}" target="_blank" rel="noopener" title="TikTok"><i class="ri-tiktok-line"></i></a>`);
        if (com.instagram) socials.push(`<a href="${encodeUrl(com.instagram)}" target="_blank" rel="noopener" title="Instagram"><i class="ri-instagram-line"></i></a>`);
        if (com.linkedin) socials.push(`<a href="${encodeUrl(com.linkedin)}" target="_blank" rel="noopener" title="LinkedIn"><i class="ri-linkedin-line"></i></a>`);
        const socialsHtml = socials.length ? `<div class="socials">${socials.join('')}</div>` : '';

        // Promo, fechas y otros
        const promoHtml = com.promo ? `<div class="promo-row"><i class="ri-gift-line" style="margin-right:8px"></i>${escapeHtml(com.promo)}</div>` : '';
        const fechaHtml = (com.desde || com.hasta) ? `<div class="fecha-row"><i class="ri-calendar-event-line" style="margin-right:6px"></i>${com.desde?fechaHumana(com.desde):''}${(com.desde && com.hasta)?' — ':''}${com.hasta?fechaHumana(com.hasta):''}</div>` : '';
        const otrosHtml = com.otros ? `<div class="otros-row"><i class="ri-information-line" style="margin-right:6px"></i>${escapeHtml(com.otros)}</div>` : '';

        // Contacto y botón como llegar
        const mapLink = makeMapLink(com.llegar, com.domicilio);
        const domicilioHtml = com.domicilio ? `<div class="info-row"><span class="icon"><i class="ri-map-pin-line"></i></span><span>${escapeHtml(com.domicilio)}</span></div>` : '';
        const telefonoHtml = com.telefono ? `<div class="info-row"><span class="icon"><i class="ri-phone-line"></i></span><a href="tel:${encodeTel(com.telefono)}" style="color:var(--text);text-decoration:none;font-weight:800">${escapeHtml(com.telefono)}</a></div>` : '';
        const btnMapHtml = mapLink ? `<a class="btn-maps" href="${encodeUrl(mapLink)}" target="_blank" rel="noopener"><i class="ri-directions-line"></i> COMO LLEGAR</a>` : '';

        // Extras destacado y VER MÁS
        let extrasHtml = '';
        const extras = com.extras || {};
        const posiblesCantidadKeys = ['cantidad','unidades','stock','cantidad_unidades','cant'];
        const cantidadVals = [];
        posiblesCantidadKeys.forEach(k => { if (k in extras && extras[k] !== '') cantidadVals.push(`${k}: ${escapeHtml(String(extras[k]))}`); });
        if (cantidadVals.length) { extrasHtml += `<div class="details-grid"><div class="badge"><i class="ri-stack-line" style="margin-right:8px"></i>${cantidadVals.join(' · ')}</div></div>`; }
        ['precio','precio_unitario','oferta','unidad'].forEach(k => { if (k in extras && extras[k] !== '') { extrasHtml += `<div class="details-grid"><div class="badge">${escapeHtml(String(extras[k]))}</div></div>`; } });

        let allExtrasHtml = '';
        const extrasKeys = Object.keys(extras).filter(k => extras[k] !== '' && extras[k] !== null && extras[k] !== undefined);
        if (extrasKeys.length) {
          allExtrasHtml += `<div class="extras-container" style="display:none" data-visible="false">`;
          allExtrasHtml += `<table class="extras-table">`;
          extrasKeys.forEach(k => {
            allExtrasHtml += `<tr><td style="width:28%; font-weight:800;">${escapeHtml(k)}</td><td>${escapeHtml(String(extras[k]))}</td></tr>`;
          });
          allExtrasHtml += `</table></div>`;
        }

        const footerHtml = `
          <div class="card-footer">
            <div class="contact-block">
              ${domicilioHtml}
              ${telefonoHtml}
              ${fechaHtml}
              ${extrasHtml}
              ${otrosHtml}
            </div>
            <div style="display:flex; align-items:center; gap:10px;">
              ${btnMapHtml}
              ${socialsHtml}
            </div>
          </div>
        `;

        const vermasBtn = extrasKeys.length ? `<button class="vermas" onclick="toggleExtras(this)"><i class="ri-add-line"></i> VER MÁS</button>` : '';

        card.innerHTML = `
          <div class="card-logos-row">
            ${leftHtml}
            ${socialsHtml ? '' : ''}
          </div>
          ${promoHtml}
          ${vermasBtn}
          ${footerHtml}
          ${allExtrasHtml}
        `;

        cardsDiv.appendChild(card);
        count++;
      });

      if (count === 0) {
        cardsDiv.innerHTML = "<p style='color:#b02a2a; font-weight:800'>No hay comercios para mostrar.</p>";
      }

      renderPaginator(data.length, page);
    }

    function toggleExtras(btn) {
      const container = btn.parentElement.parentElement.querySelector('.extras-container');
      if (!container) return;
      const vis = container.getAttribute('data-visible') === 'true';
      container.style.display = vis ? 'none' : 'block';
      container.setAttribute('data-visible', (!vis).toString());
      btn.innerHTML = vis ? `<i class="ri-add-line"></i> VER MÁS` : `<i class="ri-subtract-line"></i> VER MENOS`;
    }

    function renderPaginator(total, page) {
      const paginatorDiv = document.getElementById('paginator');
      const totalPages = Math.ceil(total / itemsPerPage);
      if (totalPages <= 1) { paginatorDiv.innerHTML = ''; return; }
      paginatorDiv.innerHTML = `<button id="prevPage" ${page<=1?'disabled':''}>Anterior</button>
        <span style="font-weight:800; align-self:center;">Página ${page} / ${totalPages}</span>
        <button id="nextPage" ${page>=totalPages?'disabled':''}>Siguiente</button>`;
      document.getElementById('prevPage').onclick = () => { if (currentPage>1) { currentPage--; renderCards(filtrados,currentPage); window.scrollTo({top:0,behavior:'smooth'}); } };
      document.getElementById('nextPage').onclick = () => { if (currentPage<totalPages) { currentPage++; renderCards(filtrados,currentPage); window.scrollTo({top:0,behavior:'smooth'}); } };
    }

    function aplicarFiltro(search) {
      const filtro = (search||"").trim().toLowerCase();
      if (categoriaFiltro) {
        filtrados = comerciosData.filter(c => c.categoria && c.categoria.toLowerCase() === categoriaFiltro.toLowerCase());
      } else if (filtro) {
        let matchCat = Array.from(categoriasSet).find(cat => cat.toLowerCase() === filtro);
        if (matchCat) {
          categoriaFiltro = matchCat;
          filtrados = comerciosData.filter(c => c.categoria && c.categoria.toLowerCase() === matchCat.toLowerCase());
        } else {
          filtrados = comerciosData.filter(c => {
            const inMain = (c.nombre && c.nombre.toLowerCase().includes(filtro))
              || (c.categoria && c.categoria.toLowerCase().includes(filtro))
              || (c.promo && c.promo.toLowerCase().includes(filtro));
            if (inMain) return true;
            if (c.extras) return Object.values(c.extras).some(v => String(v || '').toLowerCase().includes(filtro));
            return false;
          });
        }
      } else {
        filtrados = comerciosData;
      }
      currentPage = 1;
      renderCards(filtrados, currentPage);
      renderCategoriesBar();
    }

    // carga de datos
    function loadData() {
      if (!DATA_URL) { document.getElementById('cards').innerHTML = '<p style="color:#b02a2a">Falta DATA_URL</p>'; return; }
      fetch(DATA_URL).then(res => {
        if (!res.ok) throw new Error('HTTP ' + res.status);
        return res.json();
      }).then(data => {
        comerciosData = Array.isArray(data) ? data : [];
        comerciosData = comerciosData.map(c => { if (!c.extras) c.extras = {}; return c; });
        filtrados = comerciosData;
        categoriasSet = new Set(comerciosData.map(c => c.categoria).filter(Boolean));
        renderCards(filtrados, currentPage);
        renderCategoriesBar();
      }).catch(err => {
        document.getElementById('cards').innerHTML = `<p style="color:#b02a2a">No se pudieron cargar los comercios.<br>${err}</p>`;
      });
    }

    document.getElementById('search').addEventListener('input', function(){ categoriaFiltro=''; aplicarFiltro(this.value); });

    loadData();
  </script>
</body>
</html>
