<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Eventos VIP — Panel</title>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;500&display=swap" rel="stylesheet">
  <style>
    :root{
      --grad1:#f9d423; --grad2:#ff4e50;
      --text:#24324d; --muted:#6b7a90; --accent:#ff4e50; --accent2:#f9d423;
      --panel:#fff; --shadow:0 6px 30px #0001;
      --radius:16px;
    }
    *{box-sizing:border-box;}
    html,body{margin:0;min-height:100%;background:linear-gradient(135deg, var(--grad1) 0%, var(--grad2) 100%);font-family:'Montserrat','Segoe UI',Arial,sans-serif;color:var(--text);}

    /* Header */
    .header-flex{display:flex;justify-content:center;align-items:center;gap:14px;margin:20px 0 10px;flex-wrap:wrap;padding:0 12px;}
    .main-logo{width:64px;height:64px;border-radius:14px;background:#fff;box-shadow:0 2px 14px rgba(44,60,90,0.14);object-fit:cover;display:block;}
    .header-title{font-size:1.9rem;font-weight:900;letter-spacing:.8px;text-align:center;margin:0;line-height:1.16;padding:2px 8px;color:#fff;
      text-shadow:0 2px 12px rgba(0,0,0,0.18);}
    .header-action{display:flex;justify-content:center;margin:8px 0 0;width:100%;}
    .join-channel{display:inline-flex;align-items:center;gap:10px;padding:12px 16px;background:linear-gradient(90deg,#ff6a00 0%, #ff0044 100%);color:#fff;font-weight:900;border-radius:14px;text-decoration:none;box-shadow:0 8px 28px rgba(255,78,80,0.28);border:2px solid rgba(255,255,255,0.18);font-size:1.02rem;}
    .join-channel:hover{transform:translateY(-2px);box-shadow:0 12px 34px rgba(255,78,80,0.36);transition:all .12s ease;}

    /* Controls */
    .controls{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin:12px 0 6px;padding:0 12px;}
    .input, .select, .button{border-radius:14px;border:none;box-shadow:0 4px 12px rgba(0,0,0,0.08);font-weight:800;}
    .input{padding:12px 14px;background:#fff;width:100%;max-width:680px;}
    .select{padding:12px;background:#fff;min-width:140px;}
    .button{padding:12px 14px;background:linear-gradient(90deg,#0e76a8,#0e5076);color:#fff;cursor:pointer}
    .button.secondary{background:#fff;color:#0e5076;border:2px solid #0e5076}

    /* Cards */
    .cards{display:flex;flex-direction:column;gap:16px;justify-content:flex-start;align-items:center;padding:16px 10px 32px;min-height:320px;}
    .card{background:rgba(255,255,255,0.95);border-radius:18px;box-shadow:var(--shadow);max-width:940px;width:100%;min-width:280px;padding:14px;display:flex;flex-direction:column;gap:10px;}
    .card:hover{transform:translateY(-4px);box-shadow:0 12px 34px #ff4e5040, 0 2px 10px #0002;transition:transform .15s;}
    .card-head{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .logo-org{width:60px;height:60px;border-radius:12px;object-fit:cover;background:#fff;border:2px solid #f9d42344;}
    .title{font-size:1.14rem;font-weight:900;color:#fff;background:#ff4e50;border-radius:10px;padding:6px 10px;}
    .badge{display:inline-flex;align-items:center;gap:6px;background:#fff;border:2px solid #111;border-radius:10px;padding:6px 10px;color:#f9d423;font-weight:900;
      -webkit-text-stroke:0.9px #000;text-shadow:-1px -1px 0 #000,1px -1px 0 #000,-1px 1px 0 #000,1px 1px 0 #000;}
    .row{display:flex;gap:8px;align-items:center;color:#24324d;flex-wrap:wrap}
    .row i{color:#ff4e50;font-size:1.1rem}
    .muted{color:#334a6b;font-weight:700}
    .actions{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .btn{display:inline-flex;align-items:center;gap:6px;padding:10px 12px;border-radius:12px;border:none;cursor:pointer;font-weight:900}
    .btn.edit{background:#0b6bb3;color:#fff}
    .btn.dup{background:#f9d423;color:#24324d}
    .btn.pause{background:#ffcfaa;color:#222}
    .btn.delete{background:#c83232;color:#fff}
    .btn i{font-size:1.2rem}

    /* Paginator */
    .paginator{display:flex;justify-content:center;gap:14px;margin:16px 0 34px;align-items:center}
    .paginator button{padding:10px 14px;background:linear-gradient(90deg,#ff4e50,#f9d423);color:#fff;border:none;border-radius:10px;font-weight:800;cursor:pointer}
    .paginator .page{background:#fff;color:#243;min-width:44px;border-radius:10px;padding:8px 10px;font-weight:900}

    /* Modal (mobile-first) */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.55);display:none;align-items:flex-end;justify-content:center;z-index:9999}
    .modal.open{display:flex}
    .sheet{background:#fff;border-top-left-radius:18px;border-top-right-radius:18px;box-shadow:0 -8px 16px rgba(0,0,0,0.18);width:100%;max-width:940px;max-height:88vh;overflow:auto}
    .sheet-head{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:#ffefe6;border-top-left-radius:18px;border-top-right-radius:18px;border-bottom:1px solid #ffe0d0}
    .sheet-title{font-weight:900;color:#0e5076}
    .sheet-body{padding:12px;display:grid;grid-template-columns:1fr;gap:10px}
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-weight:900;color:#223}
    .field input,.field textarea{padding:12px;border-radius:12px;border:1.5px solid #e6eefc;background:#fff;font-weight:800}
    .field textarea{min-height:90px;resize:vertical}
    .sheet-actions{display:flex;gap:10px;justify-content:flex-end;padding:12px;border-top:1px solid #eee;background:#fafafa}
    .sheet-actions .btn{padding:12px 14px}
    .two-cols{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:700px){ .two-cols{grid-template-columns:1fr} }

    /* Desktop adjustments second */
    @media (min-width:900px){
      .header-flex{margin:28px 0 12px}
      .header-title{font-size:2.2rem}
      .cards{padding:18px 20px 40px}
      .sheet-body{grid-template-columns:repeat(2,1fr)}
      .wide{grid-column:1/-1}
    }
  </style>
</head>
<body>
  <div class="header-flex">
    <img class="main-logo" src="https://res.cloudinary.com/dw3oovvb1/image/upload/v1761321330/jodjkgolixgk4rlisrur.png" alt="Logo">
    <h1 class="header-title">EVENTOS VIP — Panel</h1>
  </div>
  <div class="header-action">
    <a class="join-channel" href="https://www.guialocaldolores.com.ar/suma-tu-evento/" target="_blank" rel="noopener noreferrer" title="Sumá tu evento VIP">
      ⚡️ Sumá tu evento VIP
    </a>
  </div>

  <div class="controls">
    <input id="advId" class="input" placeholder="ID del anunciante (ej: 12345) — o usar ?id= en la URL">
    <input id="search" class="input" placeholder="Buscar por nombre, categoría, lugar...">
    <select id="catFilter" class="select">
      <option value="">Todas las categorías</option>
    </select>
    <button id="btnLoad" class="button">Cargar eventos</button>
    <button id="btnNew" class="button secondary">Nuevo evento VIP</button>
  </div>

  <div id="cards" class="cards"></div>
  <div id="paginator" class="paginator"></div>

  <!-- Modal hoja inferior -->
  <div id="modal" class="modal" aria-modal="true" role="dialog">
    <div class="sheet">
      <div class="sheet-head">
        <div class="sheet-title" id="modalTitle">Editar evento</div>
        <button id="modalClose" class="btn delete" type="button"><i class="ri-close-line"></i> Cerrar</button>
      </div>
      <div class="sheet-body" id="formBody">
        <!-- Campos del formulario -->
        <div class="field">
          <label>Nombre del evento</label>
          <input id="f_nombre_evento" placeholder="Ej: Fiesta de la Ciudad">
        </div>
        <div class="field">
          <label>Categoría</label>
          <input id="f_categoria" placeholder="Ej: Música, Teatro, Deportes">
        </div>
        <div class="two-cols">
          <div class="field">
            <label>Localidad</label>
            <input id="f_localidad" placeholder="Ej: Dolores">
          </div>
          <div class="field">
            <label>Lugar</label>
            <input id="f_lugar" placeholder="Ej: Plaza Principal">
          </div>
        </div>
        <div class="field">
          <label>Dirección</label>
          <input id="f_direccion" placeholder="Ej: Belgrano 123">
        </div>
        <div class="field">
          <label>Cómo llegar (link o dirección)</label>
          <input id="f_llegar" placeholder="Link de Google Maps o dirección">
        </div>

        <!-- Fechas: cargar en edición (mobile-first) -->
        <div class="two-cols wide">
          <div class="field">
            <label>Fecha desde</label>
            <input id="f_fecha_desde" type="date">
          </div>
          <div class="field">
            <label>Fecha hasta</label>
            <input id="f_fecha_hasta" type="date">
          </div>
        </div>

        <div class="two-cols">
          <div class="field">
            <label>Hora (principal)</label>
            <input id="f_hora" type="time">
          </div>
          <div class="field">
            <label>Hora 2 (opcional)</label>
            <input id="f_hora2" type="time">
          </div>
        </div>

        <div class="field wide">
          <label>Descripción</label>
          <textarea id="f_descripcion" placeholder="Detalles del evento, artistas, programa..."></textarea>
        </div>
        <div class="two-cols">
          <div class="field">
            <label>Instagram (texto plano)</label>
            <input id="f_instagram" placeholder="Ej: https://instagram.com/p/...">
          </div>
          <div class="field">
            <label>Entradas / Inscripción (URL)</label>
            <input id="f_entradas" placeholder="URL de tickets/inscripción">
          </div>
        </div>
        <div class="two-cols">
          <div class="field">
            <label>Imagen 1 (URL)</label>
            <input id="f_img1" placeholder="https://...">
          </div>
          <div class="field">
            <label>Imagen 2 (URL)</label>
            <input id="f_img2" placeholder="https://...">
          </div>
        </div>
        <div class="field">
          <label>Imagen 3 (URL)</label>
          <input id="f_img3" placeholder="https://...">
        </div>

        <div class="field">
          <label>Organizador (si no se completa, se autocompleta por id_anunciante)</label>
          <input id="f_organizador" placeholder="Nombre del organizador">
        </div>
        <div class="field">
          <label>Logo del organizador (URL)</label>
          <input id="f_logo_organizador" placeholder="https://...">
        </div>

        <!-- Partners -->
        <div class="two-cols">
          <div class="field">
            <label>Partner 1</label>
            <input id="f_partner" placeholder="Nombre">
          </div>
          <div class="field">
            <label>Logo Partner 1</label>
            <input id="f_logo_partner" placeholder="https://...">
          </div>
        </div>
        <div class="two-cols">
          <div class="field">
            <label>Partner 2</label>
            <input id="f_partner2" placeholder="Nombre">
          </div>
          <div class="field">
            <label>Logo Partner 2</label>
            <input id="f_logo_partner2" placeholder="https://...">
          </div>
        </div>
        <div class="two-cols">
          <div class="field">
            <label>Partner 3</label>
            <input id="f_partner3" placeholder="Nombre">
          </div>
          <div class="field">
            <label>Logo Partner 3</label>
            <input id="f_logo_partner3" placeholder="https://...">
          </div>
        </div>

        <input id="f_evento_id" type="hidden">
      </div>
      <div class="sheet-actions">
        <button id="btnSave" class="btn edit" type="button"><i class="ri-check-line"></i> Guardar</button>
        <button id="btnDuplicate" class="btn dup" type="button"><i class="ri-file-copy-2-line"></i> Duplicar</button>
      </div>
    </div>
  </div>

  <script>
    /* Config */
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxTqt5VG9d4mBPYA92t75q1_n1YBMM5nQ1fMz_SsI1_hdEcspBs6EPwXRGR_cWv_HNzkA/exec";
    const SERVER_SECRET = "PzbqSEw9xNrwvWruJN7njiW905uwMiBS";

    /* Estado */
    let vipEvents = [];
    let filtered = [];
    let currentPage = 1;
    const itemsPerPage = 10;
    let currentEdit = null;

    /* Utilidades */
    function qs(name){
      const u = new URL(location.href);
      return u.searchParams.get(name);
    }
    function safe(v){ return (v===null||v===undefined) ? '' : String(v); }
    function toDateObj(any){
      if (!any) return null;
      if (Object.prototype.toString.call(any) === '[object Date]') return isNaN(any.getTime()) ? null : any;
      const s = String(any).trim();
      let m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/); if (m) return new Date(parseInt(m[1],10),parseInt(m[2],10)-1,parseInt(m[3],10));
      m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/); if (m) return new Date(parseInt(m[3],10),parseInt(m[2],10)-1,parseInt(m[1],10));
      m = s.match(/^Date\((\d{4}),\s*(\d+),\s*(\d+)(?:,\s*(\d+),\s*(\d+))?/); if (m) return new Date(parseInt(m[1],10),parseInt(m[2],10),parseInt(m[3],10));
      const d = new Date(s); return isNaN(d.getTime()) ? null : d;
    }
    function formatInputDate(any){
      const d = toDateObj(any);
      if (!d) return '';
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const da = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${da}`;
    }
    function formatHumanDate(any){
      const d = toDateObj(any);
      if (!d) return '';
      const meses = ["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"];
      const dias = ["domingo","lunes","martes","miércoles","jueves","viernes","sábado"];
      return `${dias[d.getDay()]} ${d.getDate()} de ${meses[d.getMonth()]} de ${d.getFullYear()}`;
    }
    function formatTime(any){
      const s = String(any||'').trim();
      let m = s.match(/^Date\(\d{4},\d{1,2},\d{1,2},(\d{1,2}),(\d{1,2})/); if (m) return `${String(m[1]).padStart(2,'0')}:${String(m[2]).padStart(2,'0')}`;
      m = s.match(/^(\d{1,2}):(\d{2})(:\d{2})?$/); if (m) return `${String(m[1]).padStart(2,'0')}:${m[2]}`;
      return s;
    }
    function escapeHtml(text){
      if (text===null||text===undefined) return "";
      return String(text).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");
    }
    function safeUrl(u){ u=String(u||'').trim(); if(!u) return ''; if(!/^https?:\/\//i.test(u)) return ''; return u; }

    /* API */
    async function apiPost(body){
      const res = await fetch(WEBAPP_URL, {
        method:'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(body)
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }
    async function fetchVipEvents(advertiserId){
      const resp = await apiPost({ action:'getVipEvents', advertiserId, serverSecret: SERVER_SECRET });
      return resp && resp.events ? resp.events : [];
    }
    async function updateVip(advertiserId, payload){
      const resp = await apiPost({ action:'updateVipEvent', advertiserId, serverSecret: SERVER_SECRET, payload });
      return resp;
    }
    async function createVip(advertiserId, payload){
      const resp = await apiPost({ action:'createVipEvent', advertiserId, serverSecret: SERVER_SECRET, payload });
      return resp;
    }
    async function deleteVip(advertiserId, evento_id){
      const resp = await apiPost({ action:'deleteVipEvent', advertiserId, serverSecret: SERVER_SECRET, payload: { evento_id } });
      return resp;
    }
    async function pauseVip(advertiserId, evento_id, pause){
      const resp = await apiPost({ action:'pauseVipEvent', advertiserId, serverSecret: SERVER_SECRET, payload: { evento_id, pause } });
      return resp;
    }

    /* UI */
    function hydrateCatFilter(events){
      const sel = document.getElementById('catFilter');
      const cur = sel.value || '';
      const cats = Array.from(new Set(events.map(e => String(e.categoria||'').trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b,'es',{sensitivity:'base'}));
      sel.innerHTML = '<option value="">Todas las categorías</option>';
      cats.forEach(c => {
        const o = document.createElement('option');
        o.value = c; o.textContent = c;
        sel.appendChild(o);
      });
      if (cur && cats.includes(cur)) sel.value = cur;
    }

    function renderEvents(data, page=1){
      const cont = document.getElementById('cards');
      cont.innerHTML = '';
      const start = (page-1)*itemsPerPage;
      const end = start + itemsPerPage;
      const pageData = data.slice(start,end);
      if (!pageData.length){
        cont.innerHTML = "<p style='color:#b02a2a;font-weight:bold'>No hay eventos VIP para mostrar.</p>";
        document.getElementById('paginator').innerHTML='';
        return;
      }
      pageData.forEach(ev=>{
        const card = document.createElement('div');
        card.className = 'card';

        const logo = safeUrl(ev.logo_organizador) ? `<img class="logo-org" src="${ev.logo_organizador}" alt="Organizador" onerror="this.style.display='none'">` : '';
        const title = escapeHtml(ev.nombre_evento || ev.nombre || '(sin título)');
        const catBadge = ev.categoria ? `<div class="badge"><i class="ri-price-tag-3-line"></i> ${escapeHtml(ev.categoria)}</div>` : '';

        // Rango de fechas (desde/hasta) — compat: usa 'fecha' si aún no existe
        const desdeRaw = ev.fecha_desde || ev.fechaDesde || ev.fecha || '';
        const hastaRaw = ev.fecha_hasta || ev.fechaHasta || '';
        const fechaText = (desdeRaw && hastaRaw)
          ? `${formatHumanDate(desdeRaw)} — ${formatHumanDate(hastaRaw)}`
          : (desdeRaw ? formatHumanDate(desdeRaw) : '');

        const horaShown = formatTime(ev.hora_unificada || ev.hora || ev.hora2 || '');

        const lugar = ev.lugar ? `<div class="row"><i class="ri-map-pin-line"></i><div class="muted">${escapeHtml(ev.lugar)}</div></div>` : '';
        const direccion = ev.direccion ? `<div class="row"><i class="ri-road-map-line"></i><div class="muted">${escapeHtml(ev.direccion)}</div></div>` : '';
        const fechaRow = (fechaText || horaShown)
          ? `<div class="row"><i class="ri-calendar-event-line"></i><div class="muted">${escapeHtml(fechaText)}${(fechaText && horaShown) ? ' • ' : ''}${escapeHtml(horaShown)}</div></div>`
          : '';

        const paus = String(ev.pausado||'').toLowerCase();
        const isPaused = paus==='true' || paus==='1' || paus==='si' || paus==='sí' || paus==='yes' || paus==='x';

        card.innerHTML = `
          <div class="card-head">
            ${logo}
            <div class="title">${title}</div>
            ${catBadge}
          </div>
          ${fechaRow}
          ${lugar}
          ${direccion}
          <div class="row"><i class="ri-user-3-line"></i><div class="muted">${escapeHtml(ev.organizador || '(organizador)')}</div></div>
          <div class="actions">
            <button class="btn edit" type="button"><i class="ri-pencil-line"></i> Editar</button>
            <button class="btn dup" type="button"><i class="ri-file-copy-2-line"></i> Duplicar</button>
            <button class="btn pause" type="button"><i class="${isPaused?'ri-play-line':'ri-pause-line'}"></i> ${isPaused?'Reanudar':'Pausar'}</button>
            <button class="btn delete" type="button"><i class="ri-delete-bin-6-line"></i> Borrar</button>
          </div>
        `;
        const [btnEdit, btnDup, btnPause, btnDel] = card.querySelectorAll('.btn');

        btnEdit.onclick = ()=> openEdit(ev);
        btnDup.onclick = ()=> duplicateEvent(ev);
        btnPause.onclick = async ()=>{
          const advId = getAdvertiserId();
          if (!advId) return alert('Ingrese ID del anunciante.');
          try{
            await pauseVip(advId, String(ev.evento_id||'').trim(), !isPaused);
            await reload();
          } catch(e){ alert('Error al pausar/reanudar: ' + e.message); }
        };
        btnDel.onclick = async ()=>{
          if (!confirm('¿Eliminar este evento VIP?')) return;
          const advId = getAdvertiserId();
          if (!advId) return alert('Ingrese ID del anunciante.');
          try{
            await deleteVip(advId, String(ev.evento_id||'').trim());
            await reload();
          } catch(e){ alert('Error al borrar: ' + e.message); }
        };

        cont.appendChild(card);
      });
      renderPaginator(data.length, page);
    }

    function renderPaginator(total, page){
      const div = document.getElementById('paginator');
      const totalPages = Math.ceil(total / itemsPerPage);
      if (totalPages<=1){ div.innerHTML=''; return; }
      div.innerHTML = `
        <button id="prev"${page<=1?' disabled':''}>Anterior</button>
        <span class="page">Página ${page} / ${totalPages}</span>
        <button id="next"${page>=totalPages?' disabled':''}>Siguiente</button>
      `;
      const prev = document.getElementById('prev');
      const next = document.getElementById('next');
      prev && (prev.onclick = ()=>{ if (currentPage>1){ currentPage--; renderEvents(filtered,currentPage); window.scrollTo({top:0,behavior:'smooth'});} });
      next && (next.onclick = ()=>{ if (currentPage<totalPages){ currentPage++; renderEvents(filtered,currentPage); window.scrollTo({top:0,behavior:'smooth'});} });
    }

    function applyFilter(){
      const q = String(document.getElementById('search').value||'').trim().toLowerCase();
      const cat = String(document.getElementById('catFilter').value||'').trim().toLowerCase();
      filtered = vipEvents.filter(ev=>{
        if (cat && (!ev.categoria || String(ev.categoria).toLowerCase() !== cat)) return false;
        if (!q) return true;
        const hay = [
          ev.nombre_evento||ev.nombre||'',
          ev.categoria||'',
          ev.organizador||'',
          ev.lugar||'',
          ev.direccion||'',
          ev.descripcion||''
        ].join(' ').toLowerCase();
        return hay.indexOf(q)!==-1;
      });
      currentPage = 1;
      renderEvents(filtered, currentPage);
    }

    function getAdvertiserId(){
      const fromUrl = qs('id') || qs('advertiserId') || qs('advertiserID');
      const inputVal = String(document.getElementById('advId').value||'').trim();
      return String(fromUrl || inputVal || '').trim();
    }

    async function reload(){
      const advId = getAdvertiserId();
      if (!advId) return alert('Ingresá el ID del anunciante (o agregalo como ?id= en la URL)');
      try{
        const events = await fetchVipEvents(advId);
        vipEvents = Array.isArray(events) ? events : [];
        filtered = vipEvents.slice();
        hydrateCatFilter(vipEvents);
        applyFilter();
      } catch(e){
        alert('Error al cargar eventos VIP: ' + e.message);
      }
    }

    /* Modal edición */
    const modal = document.getElementById('modal');
    const modalClose = document.getElementById('modalClose');
    modalClose.onclick = ()=> closeModal();
    modal.onclick = (evt)=>{ if(evt.target===modal) closeModal(); };

    function openEdit(ev){
      currentEdit = ev || null;
      document.getElementById('modalTitle').textContent = ev ? 'Editar evento' : 'Nuevo evento VIP';

      // Cargar fechas en edición (si existen) — compatibilidad con 'fecha'
      const desdeRaw = ev ? (ev.fecha_desde || ev.fechaDesde || ev.fecha || '') : '';
      const hastaRaw = ev ? (ev.fecha_hasta || ev.fechaHasta || '') : '';

      // Setear campos
      setVal('f_evento_id', ev ? (ev.evento_id||'') : '');
      setVal('f_nombre_evento', ev ? (ev.nombre_evento||ev.nombre||'') : '');
      setVal('f_categoria', ev ? (ev.categoria||'') : '');
      setVal('f_localidad', ev ? (ev.localidad||'') : '');
      setVal('f_lugar', ev ? (ev.lugar||'') : '');
      setVal('f_direccion', ev ? (ev.direccion||'') : '');
      setVal('f_llegar', ev ? (ev.llegar||'') : '');
      setVal('f_fecha_desde', formatInputDate(desdeRaw));
      setVal('f_fecha_hasta', formatInputDate(hastaRaw));
      setVal('f_hora', formatTime(ev ? (ev.hora||'') : ''));
      setVal('f_hora2', formatTime(ev ? (ev.hora2||'') : ''));
      setVal('f_descripcion', ev ? (ev.descripcion||'') : '');
      setVal('f_instagram', ev ? (ev.instagram||'') : '');
      setVal('f_entradas', ev ? (ev.entradas||'') : '');
      setVal('f_img1', ev ? (ev.img1||'') : '');
      setVal('f_img2', ev ? (ev.img2||'') : '');
      setVal('f_img3', ev ? (ev.img3||'') : '');
      setVal('f_organizador', ev ? (ev.organizador||'') : '');
      setVal('f_logo_organizador', ev ? (ev.logo_organizador||'') : '');
      setVal('f_partner', ev ? (ev.partner||'') : '');
      setVal('f_logo_partner', ev ? (ev.logo_partner||'') : '');
      setVal('f_partner2', ev ? (ev.partner2||'') : '');
      setVal('f_logo_partner2', ev ? (ev.logo_partner2||'') : '');
      setVal('f_partner3', ev ? (ev.partner3||'') : '');
      setVal('f_logo_partner3', ev ? (ev.logo_partner3||'') : '');

      modal.classList.add('open');
    }
    function closeModal(){
      modal.classList.remove('open');
      currentEdit = null;
    }
    function getVal(id){ return String(document.getElementById(id).value||'').trim(); }
    function setVal(id,v){ document.getElementById(id).value = v==null ? '' : v; }

    function collectPayloadFromForm(){
      const payload = {
        evento_id: getVal('f_evento_id'),
        nombre_evento: getVal('f_nombre_evento'),
        categoria: getVal('f_categoria'),
        localidad: getVal('f_localidad'),
        lugar: getVal('f_lugar'),
        direccion: getVal('f_direccion'),
        llegar: getVal('f_llegar'),
        descripcion: getVal('f_descripcion'),
        instagram: getVal('f_instagram'),
        entradas: getVal('f_entradas'),
        img1: getVal('f_img1'),
        img2: getVal('f_img2'),
        img3: getVal('f_img3'),
        hora: getVal('f_hora'),
        hora2: getVal('f_hora2'),
        organizador: getVal('f_organizador'),
        logo_organizador: getVal('f_logo_organizador'),
        partner: getVal('f_partner'),
        logo_partner: getVal('f_logo_partner'),
        partner2: getVal('f_partner2'),
        logo_partner2: getVal('f_logo_partner2'),
        partner3: getVal('f_partner3'),
        logo_partner3: getVal('f_logo_partner3'),

        // NUEVO: enviar fechas desde/hasta (el backend se actualizará para soportarlas)
        fecha_desde: getVal('f_fecha_desde'),
        fecha_hasta: getVal('f_fecha_hasta')
      };

      // COMPAT: mientras el backend actualiza VIP a fecha_desde/fecha_hasta,
      // mandamos también 'fecha' igual a 'fecha_desde' para no romper nada
      if (payload.fecha_desde) payload.fecha = payload.fecha_desde;

      return payload;
    }

    document.getElementById('btnSave').onclick = async ()=>{
      const advId = getAdvertiserId();
      if (!advId) return alert('Ingrese ID del anunciante.');
      const payload = collectPayloadFromForm();
      try{
        if (payload.evento_id){
          await updateVip(advId, payload);
        } else {
          const pNew = Object.assign({}, payload);
          delete pNew.evento_id;
          await createVip(advId, pNew);
        }
        closeModal();
        await reload();
      } catch(e){
        alert('Error al guardar: ' + e.message);
      }
    };

    /* Duplicar: crea una copia del evento */
    async function duplicateEvent(ev){
      const advId = getAdvertiserId();
      if (!advId) return alert('Ingrese ID del anunciante.');
      const copy = {
        // Campos principales
        nombre_evento: ev.nombre_evento || ev.nombre || '',
        categoria: ev.categoria || '',
        localidad: ev.localidad || '',
        lugar: ev.lugar || '',
        direccion: ev.direccion || '',
        llegar: ev.llegar || '',
        descripcion: ev.descripcion || '',
        instagram: ev.instagram || '',
        entradas: ev.entradas || '',
        img1: ev.img1 || '',
        img2: ev.img2 || '',
        img3: ev.img3 || '',
        hora: formatTime(ev.hora||''),
        hora2: formatTime(ev.hora2||''),
        organizador: ev.organizador || '',
        logo_organizador: ev.logo_organizador || '',
        partner: ev.partner || '',
        logo_partner: ev.logo_partner || '',
        partner2: ev.partner2 || '',
        logo_partner2: ev.logo_partner2 || '',
        partner3: ev.partner3 || '',
        logo_partner3: ev.logo_partner3 || '',

        // NUEVO: fechas desde/hasta y compat 'fecha'
        fecha_desde: formatInputDate(ev.fecha_desde || ev.fecha || ''),
        fecha_hasta: formatInputDate(ev.fecha_hasta || ''),
        fecha: formatInputDate(ev.fecha_desde || ev.fecha || '')
      };
      // Pequeño distintivo
      if (copy.nombre_evento) copy.nombre_evento = copy.nombre_evento + ' (copia)';

      try{
        await createVip(advId, copy);
        await reload();
      } catch(e){
        alert('Error al duplicar: ' + e.message);
      }
    }

    /* Nuevo evento: abre modal vacío */
    document.getElementById('btnNew').onclick = ()=> openEdit(null);

    /* Cargar: lee id y trae eventos */
    document.getElementById('btnLoad').onclick = reload;

    /* Filtros */
    document.getElementById('search').addEventListener('input', applyFilter);
    document.getElementById('catFilter').addEventListener('change', applyFilter);

    /* Auto: si viene ?id= */
    (function autoLoad(){
      const id = getAdvertiserId();
      if (id){ document.getElementById('advId').value = id; reload(); }
    })();
  </script>
</body>
</html>
