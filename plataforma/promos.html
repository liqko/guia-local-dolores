<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Comercios y Promos</title>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;500&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0; padding: 0;
      font-family: 'Montserrat', 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #f9d423 0%, #ff4e50 100%);
      min-height: 100vh;
      color: #24324d;
      font-style: normal;
    }
    .header-flex { display:flex; justify-content:center; align-items:center; gap:18px; margin-top:45px; margin-bottom:0; flex-wrap:wrap; width:100%; }
    .main-logo { width:74px; height:74px; border-radius:15px; background:#fff; box-shadow:0 2px 14px rgba(44,60,90,0.14); object-fit:cover; display:block; }
    .header-title { font-size:2.35em; font-weight:900; letter-spacing:1.2px; text-align:center; margin:0; flex:1 1 340px; min-width:140px; max-width:500px; line-height:1.13; padding:2px 8px; color:#ff4e50; }
    .search-container { display:flex; justify-content:center; margin-top:24px; margin-bottom:0; flex-wrap:wrap; }
    .search-box { width:340px; padding:16px 20px; font-size:1.12em; border:none; border-radius:15px; outline:none; margin-bottom:18px; background:rgba(255,255,255,0.82); box-shadow:0 4px 20px #0001; }
    .categories-bar { display:flex; flex-wrap:wrap; gap:9px; justify-content:center; margin:0 0 18px 0; padding:0; }
    .category-chip { background:#fff9cc; color:#ff4e50; border:2px solid #f9d423; border-radius:14px; padding:7px 18px; font-size:1em; font-weight:600; cursor:pointer; box-shadow:0 2px 6px #f9d42325; }
    .category-chip.selected, .category-chip:hover { background:#ff4e50; color:#fff; border:2px solid #ff4e50; }

    .cards-container { display:flex; flex-direction:column; gap:30px; justify-content:flex-start; align-items:center; padding:40px 10px 32px 10px; min-height:340px; }
    .card { background: rgba(255,255,255,0.92); border-radius:18px; box-shadow:0 6px 30px #0001; max-width:880px; min-width:260px; width:100%; padding:18px; display:flex; flex-direction:column; gap:12px; }
    .card:hover { transform: translateY(-6px); box-shadow:0 12px 34px #ff4e5040, 0 2px 10px #0002; transition:transform .15s; }
    .card-logos-row { display:flex; gap:12px; align-items:center; margin-bottom:0; }
    .logo-comercio { width:64px; height:64px; border-radius:12px; object-fit:cover; background:#fff; border:2px solid #f9d42344; }
    .card-title { font-size:1.18rem; font-weight:800; color:#ff4e50; margin:0; word-break:break-word; 
      -webkit-text-stroke: 0.7px #000;
      text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
    }
    .logo-categoria { width:36px; height:36px; object-fit:cover; border-radius:8px; vertical-align:middle; margin-right:8px; }

    .cat-label { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:10px; background:#ff4e5011; border:2px solid #111; color:#f9d423; font-weight:800; 
      -webkit-text-stroke: 0.9px #000;
      text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
    }
    .promo-row { border-left:4px solid #f9d423; padding:10px 12px; font-weight:800; color:#222; border-radius:6px; }
    .otros-row { color:#ff4e50; font-style:italic; }
    .date-label { font-size:0.75em; font-weight:800; text-transform:uppercase; margin-bottom:4px; }
    .date-desde { color:#1a8a3a; font-weight:700; }
    .date-hasta { color:#c83232; font-weight:700; }
    .fecha-row { display:flex; align-items:center; gap:8px; }

    .info-row { display:flex; align-items:center; gap:8px; color:#24324d; }
    .info-row .icon { color:#ff4e50; font-size:1.1rem; min-width:26px; text-align:center; }

    .btn-maps { display:inline-flex; align-items:center; gap:8px; padding:10px 14px; background:linear-gradient(90deg,#0e76a8 0%, #0e5076 100%); color:#fff; font-weight:800; border-radius:12px; text-decoration:none; }

    .socials { display:flex; gap:8px; align-items:center; margin-top:8px; }
    .socials a { display:inline-flex; align-items:center; justify-content:center; width:38px; height:38px; border-radius:10px; background:rgba(0,0,0,0.03); color:#ff4e50; text-decoration:none; font-size:1.05rem; }
    .extras-container { margin-top:6px; background:rgba(0,0,0,0.02); padding:12px; border-radius:10px; }
    .extras-table { width:100%; border-collapse:collapse; font-size:0.95rem; }
    .extras-table td { padding:6px 8px; vertical-align:top; border-bottom:1px dashed rgba(0,0,0,0.04); }
    .vermas { display:inline-flex; gap:8px; align-items:center; cursor:pointer; color:#0e5076; font-weight:700; border:none; background:none; padding:0; }

    .badge { background:#fff; padding:6px 10px; border-radius:10px; border:1px solid rgba(0,0,0,0.04); font-weight:700; display:inline-block; margin-right:8px; }

    .paginator { display:flex; justify-content:center; gap:16px; margin:18px 0 40px; align-items:center; }
    .paginator button { padding:8px 14px; background:linear-gradient(90deg,#ff4e50,#f9d423); color:#fff; border:none; border-radius:8px; font-weight:800; cursor:pointer; }

    @media (max-width:900px) {
      .search-box { width:92%; max-width:680px; }
      .logo-comercio { width:64px; height:64px; }
      .socials a { width:34px; height:34px; }
    }
    @media (max-width:600px) {
      .card-logos-row { flex-direction:column; align-items:flex-start; gap:8px; }
      .btn-maps { width:100%; justify-content:center; }
    }
  </style>
</head>
<body>
  <div class="header-flex">
    <img class="main-logo" src="https://res.cloudinary.com/dw3oovvb1/image/upload/v1761321330/jodjkgolixgk4rlisrur.png" alt="Logo">
    <h1 class="header-title">PROMOS & DESCUENTOS</h1>
  </div>

  <div class="search-container">
    <input id="search" class="search-box" placeholder="Buscar por nombre, categoría o promo...">
  </div>

  <div id="categoriesBar" class="categories-bar"></div>
  <div id="cards" class="cards-container"></div>
  <div id="paginator" class="paginator"></div>

  <script>
    const DATA_URL = "https://script.google.com/macros/s/AKfycbwFB1sAjvEEXPqxX-ePdZOJdeOv3DPx0O3dbAoa1QQMzNA9NxPBAad2XJ_uBeTMSjQz/exec";

    let comerciosData = [];
    let filtrados = [];
    let currentPage = 1;
    const itemsPerPage = 10;
    let categoriasSet = new Set();
    let categoriaFiltro = "";

    function fechaHumana(fecha) {
      if (!fecha) return "";
      if (!isNaN(fecha) && typeof fecha !== "string") {
        const base = Date.UTC(1899,11,30);
        fecha = new Date(base + Number(fecha) * 86400000);
      }
      const d = new Date(fecha);
      if (isNaN(d.getTime())) return String(fecha);
      const meses = ["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"];
      return `${d.getUTCDate()} de ${meses[d.getUTCMonth()]} de ${d.getUTCFullYear()}`;
    }

    function escapeHtml(text) {
      if (text === null || text === undefined) return "";
      return String(text).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");
    }

    function encodeUrl(u) {
      if (!u) return '';
      u = String(u).trim();
      if (/^https?:\/\//i.test(u)) return u;
      if (/^mailto:/i.test(u) || /^tel:/i.test(u)) return u;
      if (/^www\./i.test(u)) return 'https://' + u;
      return 'https://' + u;
    }

    function normalizeDigits(s) {
      if (!s) return '';
      return String(s).replace(/[^\d]/g, '');
    }

    function makeWhatsAppLink(wh) {
      if (!wh) return "";
      const s = String(wh).trim();
      if (!s) return "";
      // if already a full URL leave as-is
      if (/^https?:\/\//i.test(s)) return s;
      // if contains wa.me or api.whatsapp skip normalization (but ensure protocol)
      if (/^(?:https?:\/\/)?(?:wa\.me|api\.whatsapp\.com)/i.test(s)) {
        return (/^https?:\/\//i.test(s) ? s : 'https://' + s.replace(/^\/+/, ''));
      }
      // extract digits
      const digits = s.replace(/[^0-9]/g, '');
      if (digits.length >= 6) return 'https://wa.me/' + digits;
      // fallback: try to encode as URL
      return encodeUrl(s);
    }

    // Resolve whatsapp value checking multiple possible locations (top-level and extras)
    // phoneComparison: optionally pass the telephone field (kept for compatibility)
    function getWhatsAppForCom(com, phoneComparison) {
      if (!com) return "";
      const candidates = [];
      if (com.whatsapp) candidates.push(com.whatsapp);
      const extras = com.extras || {};
      // common explicit variants
      const keys = ['whatsapp','whatsapp_url','whatsapp_link','wa','wpp','wsp','whats','whats_app','whatsappnumber','whatsapp_num'];
      keys.forEach(k => { if (k in extras && extras[k]) candidates.push(extras[k]); });
      // also check any extras key that looks like wa/wpp/whats/whatsapp (this avoids matching 'telefono')
      Object.keys(extras).forEach(k => {
        if (/^(?:wa|wpp|whats|whatsapp)/i.test(k) && extras[k]) candidates.push(extras[k]);
      });

      for (let i = 0; i < candidates.length; i++) {
        const v = candidates[i];
        if (!v) continue;
        const str = String(v).trim();
        if (!str) continue;
        const link = makeWhatsAppLink(str);
        if (!link) continue;
        // NOTE: changed: do NOT skip when whatsapp equals telefono.
        // Return first valid whatsapp candidate found.
        return link;
      }
      return "";
    }

    function makeMapLink(llegarVal, domicilioVal) {
      if (llegarVal && String(llegarVal).trim()) {
        const v = String(llegarVal).trim();
        if (/^https?:\/\//i.test(v)) return v;
        if (/^-?\d+(\.\d+)?\s*,\s*-?\d+(\.\d+)?$/.test(v)) {
          const coords = v.replace(/\s+/g,'');
          return `https://www.google.com/maps?q=${coords}`;
        }
        return encodeUrl(v);
      }
      if (domicilioVal && String(domicilioVal).trim()) {
        const q = encodeURIComponent(String(domicilioVal).trim());
        return `https://www.google.com/maps/search/?api=1&query=${q}`;
      }
      return "";
    }

    function encodeTel(t) {
      if (!t) return '';
      return String(t).replace(/[^\d+]/g, '');
    }

    function safeUrl(u) {
      try {
        const v = encodeUrl(u);
        if (!v) return '';
        if (/^https?:\/\/\s*$/i.test(v)) return '';
        return v;
      } catch (e) { return ''; }
    }

    function renderCategoriesBar() {
      const bar = document.getElementById('categoriesBar');
      bar.innerHTML = '';
      if (categoriasSet.size <= 1) return;
      Array.from(categoriasSet).forEach(cat => {
        const btn = document.createElement('button');
        btn.className = 'category-chip' + (categoriaFiltro === cat ? ' selected' : '');
        btn.textContent = cat;
        btn.onclick = () => {
          categoriaFiltro = (categoriaFiltro === cat ? '' : cat);
          document.getElementById('search').value = '';
          aplicarFiltro('');
        };
        bar.appendChild(btn);
      });
      if (categoriaFiltro) {
        const limpiar = document.createElement('button');
        limpiar.className = 'category-chip';
        limpiar.style.background = '#eee';
        limpiar.style.color = '#333';
        limpiar.textContent = 'Todas las categorías';
        limpiar.onclick = () => { categoriaFiltro = ''; aplicarFiltro(''); };
        bar.insertBefore(limpiar, bar.firstChild);
      }
    }

    function buildCatLabel(com) {
      if (!com || !com.categoria || !String(com.categoria).trim()) return '';
      let imgHtml = '';
      if (com.logo1) {
        const src = safeUrl(com.logo1);
        if (src) imgHtml = `<img class="logo-categoria" src="${src}" alt="${escapeHtml(com.categoria)}" onerror="this.style.display='none'">`;
      }
      return `<div class="cat-label" style="margin-top:8px">${imgHtml}${escapeHtml(com.categoria)}</div>`;
    }

    function renderCards(data, page = 1) {
      const cardsDiv = document.getElementById('cards');
      cardsDiv.innerHTML = '';
      const start = (page - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pageData = data.slice(start, end);
      let count = 0;

      pageData.forEach(com => {
        // If this item has no visible fields (defensive), skip it
        if (!hasMeaningfulData(com)) return;

        const card = document.createElement('div');
        card.className = 'card';

        // Build top row (logo + title + category)
        const leftParts = [];
        if (com.logo && safeUrl(com.logo)) {
          leftParts.push(`<img class="logo-comercio" src="${safeUrl(com.logo)}" alt="${escapeHtml(com.nombre||'')}" onerror="this.style.display='none'">`);
        }
        leftParts.push(`<div class="title-block"><div class="card-title">${escapeHtml(com.nombre||'')}</div>${buildCatLabel(com)}</div>`);

        const leftHtml = `<div class="card-logos-row"><div class="left-row" style="display:flex;gap:12px;align-items:center">${leftParts.join('')}</div></div>`;

        const promoHtml = (com.promo && String(com.promo).trim()) ? `<div class="promo-row"><i class="ri-gift-line" style="margin-right:8px"></i>${escapeHtml(com.promo)}</div>` : '';
        const otrosHtml = (com.otros && String(com.otros).trim()) ? `<div class="otros-row"><i class="ri-information-line" style="margin-right:6px"></i>${escapeHtml(com.otros)}</div>` : '';

        const desdeHtml = com.desde ? `<div><div class="date-label">DESDE</div><div class="fecha-row date-desde"><i class="ri-calendar-event-line"></i> ${fechaHumana(com.desde)}</div></div>` : '';
        const hastaHtml = com.hasta ? `<div><div class="date-label">HASTA</div><div class="fecha-row date-hasta"><i class="ri-calendar-event-line"></i> ${fechaHumana(com.hasta)}</div></div>` : '';

        const domicilioHtml = (com.domicilio && String(com.domicilio).trim()) ? `<div class="info-row"><i class="ri-map-pin-line icon"></i>${escapeHtml(com.domicilio)}</div>` : '';
        // Telephone shown as plain text (no tel: link)
        const telefonoHtml = (com.telefono && String(com.telefono).trim()) ? `<div class="info-row"><i class="ri-phone-line icon"></i><span style="font-weight:700">${escapeHtml(com.telefono)}</span></div>` : '';

        // Socials - ensure whatsapp is used when present (now returns even if matches telefono)
        const socials = [];
        const waLink = getWhatsAppForCom(com, com.telefono);
        if (waLink) {
          const href = safeUrl(waLink) || waLink;
          if (href) socials.push(`<a href="${href}" target="_blank" rel="noopener" title="WhatsApp"><i class="ri-whatsapp-line"></i></a>`);
        }
        if (com.instagram && safeUrl(com.instagram)) socials.push(`<a href="${safeUrl(com.instagram)}" target="_blank" rel="noopener" title="Instagram"><i class="ri-instagram-line"></i></a>`);
        if (com.facebook && safeUrl(com.facebook)) socials.push(`<a href="${safeUrl(com.facebook)}" target="_blank" rel="noopener" title="Facebook"><i class="ri-facebook-line"></i></a>`);
        if (com.youtube && safeUrl(com.youtube)) socials.push(`<a href="${safeUrl(com.youtube)}" target="_blank" rel="noopener" title="YouTube"><i class="ri-youtube-line"></i></a>`);
        if (com.tiktok && safeUrl(com.tiktok)) socials.push(`<a href="${safeUrl(com.tiktok)}" target="_blank" rel="noopener" title="TikTok"><i class="ri-tiktok-line"></i></a>`);
        if (com.linkedin && safeUrl(com.linkedin)) socials.push(`<a href="${safeUrl(com.linkedin)}" target="_blank" rel="noopener" title="LinkedIn"><i class="ri-linkedin-line"></i></a>`);
        const socialsHtml = socials.length ? `<div class="socials">${socials.join('')}</div>` : '';

        // Extras badges (only if useful keys exist)
        let extrasBadges = '';
        if (com.extras) {
          const e = com.extras;
          const keys = ['cantidad','unidades','stock','cantidad_unidades','cant','precio','precio_unitario','oferta','unidad'];
          const badges = [];
          keys.forEach(k => { if (k in e && e[k] !== '') badges.push(`<span class="badge">${escapeHtml(String(e[k]))}</span>`); });
          if (badges.length) extrasBadges = `<div class="details-grid" style="margin-top:6px">${badges.join('')}</div>`;
        }

        let allExtrasHtml = '';
        const extrasObj = com.extras || {};
        const extrasKeys = Object.keys(extrasObj).filter(k => extrasObj[k] !== '' && extrasObj[k] !== null && extrasObj[k] !== undefined);
        if (extrasKeys.length) {
          let rows = '';
          extrasKeys.forEach(k => { rows += `<tr><td style="width:30%;font-weight:800">${escapeHtml(k)}</td><td>${escapeHtml(String(extrasObj[k]))}</td></tr>`; });
          allExtrasHtml = `<div class="extras-container" style="display:none" data-visible="false"><table class="extras-table">${rows}</table></div>`;
        }

        // Map link (only if makeMapLink returns something)
        const mapLink = makeMapLink(com.llegar, com.domicilio);
        const mapHtml = mapLink ? `<div style="margin-top:10px"><a class="btn-maps" href="${mapLink}" target="_blank" rel="noopener"><i class="ri-donut-chart-line" style="margin-right:8px"></i> COMO LLEGAR</a></div>` : '';

        // Build final card only with the parts that exist (avoids empty rows)
        card.innerHTML = `
          ${leftHtml}
          ${promoHtml}
          ${otrosHtml}
          ${desdeHtml}
          ${hastaHtml}
          ${extrasBadges}
          ${domicilioHtml}
          ${telefonoHtml}
          ${mapHtml}
          ${socialsHtml}
          ${allExtrasHtml}
          ${extrasKeys.length ? `<button class="vermas" onclick="toggleExtras(this)"><i class="ri-add-line"></i> VER MÁS</button>` : ''}
        `;

        cardsDiv.appendChild(card);
        count++;
      });

      if (count === 0) {
        cardsDiv.innerHTML = "<p style='color:#b02a2a;font-weight:bold'>No hay comercios para mostrar.</p>";
      }
      renderPaginator(data.length, page);
    }

    function toggleExtras(btn) {
      const container = btn.parentElement.querySelector('.extras-container');
      if (!container) return;
      const visible = container.getAttribute('data-visible') === 'true';
      container.style.display = visible ? 'none' : 'block';
      container.setAttribute('data-visible', (!visible).toString());
      btn.innerHTML = visible ? `<i class="ri-add-line"></i> VER MÁS` : `<i class="ri-subtract-line"></i> VER MENOS`;
    }

    function renderPaginator(total, page) {
      const paginatorDiv = document.getElementById('paginator');
      const totalPages = Math.ceil(total / itemsPerPage);
      if (totalPages <= 1) { paginatorDiv.innerHTML = ''; return; }
      paginatorDiv.innerHTML = `<button id="prevPage" ${page<=1?'disabled':''}>Anterior</button><span style="font-weight:800">Página ${page} / ${totalPages}</span><button id="nextPage" ${page>=totalPages?'disabled':''}>Siguiente</button>`;
      document.getElementById('prevPage').onclick = () => { if (currentPage>1) { currentPage--; renderCards(filtrados,currentPage); window.scrollTo({top:0,behavior:'smooth'}); } };
      document.getElementById('nextPage').onclick = () => { if (currentPage<totalPages) { currentPage++; renderCards(filtrados,currentPage); window.scrollTo({top:0,behavior:'smooth'}); } };
    }

    function aplicarFiltro(search) {
      const q = (search||'').trim().toLowerCase();
      if (categoriaFiltro) {
        filtrados = comerciosData.filter(c => c.categoria && c.categoria.toLowerCase() === categoriaFiltro.toLowerCase());
      } else if (q) {
        let matchCat = Array.from(categoriasSet).find(cat => cat.toLowerCase() === q);
        if (matchCat) { categoriaFiltro = matchCat; filtrados = comerciosData.filter(c => c.categoria && c.categoria.toLowerCase() === matchCat.toLowerCase()); }
        else {
          filtrados = comerciosData.filter(c => {
            const main = (c.nombre && c.nombre.toLowerCase().includes(q)) || (c.categoria && c.categoria.toLowerCase().includes(q)) || (c.promo && c.promo.toLowerCase().includes(q));
            if (main) return true;
            if (c.extras) return Object.values(c.extras).some(v => String(v||'').toLowerCase().includes(q));
            return false;
          });
        }
      } else {
        filtrados = comerciosData;
      }
      currentPage = 1;
      renderCards(filtrados,currentPage);
      renderCategoriesBar();
    }

    // Only keep rows that have at least one meaningful visible value
    function hasMeaningfulData(c) {
      if (!c) return false;
      const props = ['nombre','promo','categoria','domicilio','telefono','instagram','facebook','youtube','tiktok','linkedin','logo','llegar'];
      for (let i=0;i<props.length;i++){
        const k = props[i];
        if (k in c && c[k] !== null && c[k] !== undefined && String(c[k]).trim() !== '') return true;
      }
      // check extras for any visible meaningful value
      if (c.extras) {
        const vals = Object.values(c.extras);
        if (vals.some(v => v !== null && v !== undefined && String(v).trim() !== '')) return true;
      }
      return false;
    }

    function loadData() {
      if (!DATA_URL) { document.getElementById('cards').innerHTML = '<p style="color:#b02a2a">Falta DATA_URL</p>'; return; }
      fetch(DATA_URL).then(res => { if (!res.ok) throw new Error('HTTP ' + res.status); return res.json(); })
      .then(data => {
        comerciosData = Array.isArray(data) ? data : [];
        // Ensure extras exist and normalize some fallbacks, but DO NOT fallback whatsapp from telefono
        comerciosData = comerciosData.map(c => {
          if (!c.extras) c.extras = {};
          if ((!c.categoria || String(c.categoria).trim() === '') && c.extras && c.extras.categoria) c.categoria = String(c.extras.categoria);
          if ((!c.promo || String(c.promo).trim() === '') && c.extras && c.extras.promo) c.promo = String(c.extras.promo);
          return c;
        })
        // Filter out rows that have no meaningful data (prevents empty cards)
        comerciosData = comerciosData.filter(hasMeaningfulData);

        filtrados = comerciosData;
        categoriasSet = new Set(comerciosData.map(c => c.categoria).filter(Boolean));
        renderCards(filtrados,currentPage);
        renderCategoriesBar();
      }).catch(err => { document.getElementById('cards').innerHTML = `<p style="color:#b02a2a">No se pudieron cargar los comercios.<br>${err}</p>`; });
    }

    document.getElementById('search').addEventListener('input', function(){ categoriaFiltro=''; aplicarFiltro(this.value); });
    loadData();
  </script>
</body>
</html>
