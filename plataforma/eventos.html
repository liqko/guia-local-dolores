<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Agenda - Eventos (corregido)</title>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">
  <style>
    /* Interfaz más simple y directa */
    :root{ --accent:#22529a; --muted:#6b7b8f; --card:#fff; --bg:#f4f7fb; --vip:#ff8c00; }
    body{ margin:0; font-family:Arial, Helvetica, sans-serif; background:var(--bg); color:#122033; }
    .container{ max-width:980px; margin:18px auto; padding:12px; box-sizing:border-box; }
    header{ display:flex; gap:12px; align-items:center; }
    .logo{ width:64px; height:64px; border-radius:10px; object-fit:cover; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,0.06); }
    h1{ font-size:1.35rem; margin:0; color:var(--accent); }
    p.subtitle{ margin:0; color:var(--muted); font-size:0.95rem; }

    .controls{ display:flex; gap:10px; align-items:center; margin-top:12px; flex-wrap:wrap; }
    .search{ flex:1 1 320px; padding:10px 12px; border-radius:8px; border:1px solid #d7dee9; background:#fff; }
    .main-tabs{ display:flex; gap:8px; }
    .main-tab{ padding:8px 10px; border-radius:8px; background:#fff; border:1px solid #e6edf6; cursor:pointer; font-weight:700; color:var(--muted); }
    .main-tab.active{ background:var(--accent); color:#fff; border-color:var(--accent); box-shadow:0 8px 18px rgba(34,82,154,0.12); transform:translateY(-1px); }

    .chips{ margin-top:12px; display:flex; gap:8px; flex-wrap:wrap; }
    .chip{ padding:7px 11px; border-radius:999px; background:#fff; border:1px solid #e6edf6; cursor:pointer; font-weight:600; color:var(--muted); }
    .chip.selected{ background:var(--accent); color:#fff; border-color:var(--accent); }

    .debug{ margin-top:12px; color:#8a2a2a; font-weight:700; font-size:0.95rem; }

    .cards{ margin-top:14px; display:flex; flex-direction:column; gap:14px; }
    .card{ background:var(--card); border-radius:10px; padding:12px; box-shadow:0 6px 18px rgba(16,30,60,0.04); display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap; }
    .card.vip{ border-left:6px solid var(--vip); background:linear-gradient(90deg,#fff7f0, #fff); }
    .thumb{ width:96px; height:72px; object-fit:cover; border-radius:8px; background:#f1f3f6; }
    .info{ flex:1 1 320px; }
    .title{ margin:0; font-weight:800; color:#122033; }
    .meta{ color:var(--muted); font-size:0.93rem; margin-top:6px; display:flex; gap:8px; flex-wrap:wrap; }
    .desc{ margin-top:8px; color:#263448; font-size:0.95rem; max-height:88px; overflow:hidden; }

    .partners{ margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .partner-logo{ width:48px; height:48px; object-fit:contain; border-radius:6px; background:#fff; border:1px solid #eef2f7; padding:4px; }

    .pager{ margin-top:14px; display:flex; gap:8px; justify-content:center; align-items:center; }
    .btn{ padding:8px 12px; background:var(--accent); color:#fff; border-radius:8px; border:none; cursor:pointer; font-weight:800; }
    .btn.secondary{ background:#fff; color:var(--accent); border:1px solid #d7dee9; }

    .small-muted{ color:var(--muted); font-size:0.9rem; }

    @media(max-width:680px){
      .thumb{ width:76px; height:56px; }
      .logo{ width:56px; height:56px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <img class="logo" id="logo" src="https://raw.githubusercontent.com/liqko/guia-local-dolores/refs/heads/main/img/plataforma/eventos.png" alt="logo">
      <div>
        <h1>Agenda de Eventos</h1>
        <p class="subtitle">Filtros: pestañas por Categoría u Organizador — carga robusta del endpoint</p>
      </div>
    </header>

    <div class="controls">
      <input id="search" class="search" placeholder="Buscar por nombre, descripción, lugar..." />
      <div class="main-tabs" role="tablist" aria-label="Agrupar por">
        <button class="main-tab active" data-mode="all">Todos</button>
        <button class="main-tab" data-mode="category">Categoría</button>
        <button class="main-tab" data-mode="organizer">Organizador</button>
      </div>
    </div>

    <div id="chips" class="chips" aria-hidden="true"></div>

    <div id="debug" class="debug" aria-live="polite"></div>

    <div id="cards" class="cards"></div>

    <div class="pager" id="pager"></div>
  </div>

  <script>
    // --------------- CONFIGURACIÓN RÁPIDA ---------------
    // 1) Si preferís usar tu WebApp (exec) pon la URL aquí (recomendado si la hoja NO está publicada)
    const WEBAPP_URL = ""; // ej: "https://script.google.com/macros/s/XXX/exec"
    // 2) Si usás GViz directo (sheet debe estar pública o accesible) pon aquí la URL (ya está la que pasaste)
    const GVIZ_URL = "https://docs.google.com/spreadsheets/d/1CCNDvrIFFufiLXmYkm4YcmtZVpk6rG2gJQQYXzA186o/gviz/tq?tqx=out:json&gid=338324539";

    const DATA_URL = WEBAPP_URL || GVIZ_URL;

    // paginación
    const PER_PAGE = 8;
    let page = 1;

    // datos
    let allEvents = [];
    let filtered = [];
    const categories = new Set();
    const organizers = new Set();

    // UI state
    let mode = "all"; // "all" | "category" | "organizer"
    let activeChip = "";
    let searchQ = "";

    // elements
    const searchEl = document.getElementById('search');
    const tabs = document.querySelectorAll('.main-tab');
    const chipsEl = document.getElementById('chips');
    const debugEl = document.getElementById('debug');
    const cardsEl = document.getElementById('cards');
    const pagerEl = document.getElementById('pager');

    // utilidades
    function safe(v){ return v === null || v === undefined ? "" : String(v); }
    function safeUrl(u){
      if(!u) return "";
      u = String(u).trim();
      if(/^https?:\/\//i.test(u)) return u;
      if(/^www\./i.test(u)) return 'https://' + u;
      return u;
    }
    function fmtDate(d){
      if(!d) return "";
      if(/^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
      const m = String(d).match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if(m) return `${m[3]}-${m[2].padStart(2,'0')}-${m[1].padStart(2,'0')}`;
      return d;
    }
    function horaHumana(h){
      if(!h) return "";
      const m = String(h).match(/^(\d{1,2}):(\d{2})/);
      if(m) return `${m[1].padStart(2,'0')}:${m[2]} hs`;
      return h;
    }

    // parseo GViz (robusto) o JSON simple si WEBAPP devuelve array
    async function loadData(){
      debug("Cargando datos...");
      try {
        const res = await fetch(DATA_URL, {cache: "no-store"});
        if(!res.ok) throw new Error("HTTP " + res.status);
        const text = await res.text();

        // Si WEBAPP_URL devuelve JSON: intentar parsear
        if (WEBAPP_URL) {
          try {
            const json = JSON.parse(text);
            handleRawData(json);
            return;
          } catch(e){
            // si falla, seguimos a parseo gviz
            console.warn("No JSON directo desde WebApp, intentando GViz parse", e);
          }
        }

        // GViz format: /*O_o*/google.visualization.Query.setResponse({...});
        const start = text.indexOf('{');
        const end = text.lastIndexOf('}');
        if (start === -1 || end === -1) throw new Error("Respuesta inesperada (no JSON).");
        const jsonText = text.substring(start, end + 1);
        const obj = JSON.parse(jsonText);
        const rows = (obj.table && obj.table.rows) ? obj.table.rows : [];
        // convert rows (cells) -> objetos usando indices que nos pasaste
        const parsed = [];
        for(let i=0;i<rows.length;i++){
          const c = rows[i].c || [];
          // index mapping (según tu estructura)
          // aprobado(0)	nivel(1)	evento_id(2)	id_anunciante(3)	organizador(4)	logo_organizador(5)	categoria(6)	logo_categoria(7)	nombre_evento(8)	localidad(9)	lugar(10)	direccion(11)	llegar(12)	fecha(13)	hora(14)	hora2(15)	descripcion(16)	instagram(17)	img1(18)	img2(19)	img3(20)	entradas(21)	partner(22)	logo_partner(23)	partner2(24)	logo_partner2(25)	partner3(26)	logo_partner3(27)	partner4(28)	logo_partner4(29)	partner5(30)	logo_partner5(31)	partner6(32)	logo_partner6(33)	audit(34)
          const val = idx => (c[idx] && c[idx].v !== undefined) ? c[idx].v : "";
          const aprobado = safe(val(0));
          const ev = {
            aprobado,
            nivel: safe(val(1)),
            evento_id: safe(val(2)),
            id_anunciante: safe(val(3)),
            organizador: safe(val(4)),
            logo_organizador: safe(val(5)),
            categoria: safe(val(6)),
            logo_categoria: safe(val(7)),
            nombre: safe(val(8)),
            localidad: safe(val(9)),
            lugar: safe(val(10)),
            direccion: safe(val(11)),
            llegar: safe(val(12)),
            fecha: safe(val(13)),
            fecha_iso: fmtDate(safe(val(13))),
            hora: safe(val(14)),
            hora2: safe(val(15)),
            descripcion: safe(val(16)),
            instagram: safe(val(17)),
            imgs: [safe(val(18)), safe(val(19)), safe(val(20))].filter(Boolean),
            entradas: safe(val(21)),
            partners: []
          };
          // partners pares (nombre, logo)
          for(let p=22;p<=32;p+=2){
            const name = safe(val(p));
            const logo = safe(val(p+1));
            if(name || logo) ev.partners.push({name, logo});
          }
          parsed.push(ev);
        }
        handleRawData(parsed, true);
      } catch (err) {
        debug("ERROR: " + err.message);
        console.error(err);
        cardsEl.innerHTML = `<div style="color:#b02a2a;font-weight:800">No se pudieron cargar los eventos: ${escapeHtml(String(err.message || err))}</div>`;
      }
    }

    // normalizar y almacenar
    function handleRawData(raw, fromGviz=false){
      allEvents = [];
      categories.clear(); organizers.clear();
      // Si raw viene como {events: [...] } o array flexible
      let rows = [];
      if(Array.isArray(raw)) rows = raw;
      else if(raw && Array.isArray(raw.events)) rows = raw.events;
      else if(raw && Array.isArray(raw.rows)) rows = raw.rows;
      else if(raw && raw.data && Array.isArray(raw.data)) rows = raw.data;
      else {
        // intentar extraer valores de gviz (si fue parse gviz ya se pasó array)
        if(fromGviz) rows = raw;
        else {
          debug("Formato de datos inesperado. Revisa WebApp o GViz.");
          cardsEl.innerHTML = `<div style="color:#b02a2a;font-weight:800">Formato de datos inesperado desde el endpoint.</div>`;
          return;
        }
      }

      // Filtrar filas "aprobadas" si existe campo aprobado; si ninguna fila marcada como aprobada, fallback: mostrar todo y avisar
      let anyApproved = false;
      // detect if objects include 'aprobado'
      const hasAprobadoField = rows.some(r => 'aprobado' in r || (r[0] !== undefined && typeof r[0] === 'string'));
      // normalize rows that may already be objects from webapp
      rows.forEach(r => {
        // si r es un objeto con keys humanos, mantenemos; si r es array de celdas (gviz parse ya convirtió), lo pasamos como ya convertidos arriba
        if (Array.isArray(r)) {
          // ya convertido por gviz parser => r has properties
          if (r.nombre || r.nombre_evento || r.nombre) {
            // keep as-is (though parser already returned object shape)
          }
        } else if (typeof r === 'object') {
          // check aprobado field possibilities
          const a = safe(r.aprobado || r.aprobado_evento || r['aprobado'] || r['Aprobado'] || r[0] || '');
          if(a) {
            const s = String(a).toLowerCase().trim();
            if(['si','sí','1','true','ok','✓','aprobado'].includes(s)) anyApproved = true;
          }
        }
      });

      // build normalized array of events
      rows.forEach(entry => {
        // if entry is from our gviz parser, it already has .nombre etc
        let ev = {};
        if (entry && typeof entry === 'object' && !(entry instanceof Array) && ('nombre' in entry || 'nombre_evento' in entry || entry.nombre_evento !== undefined || entry.nombre !== undefined)) {
          // prefer usual keys
          ev = {
            aprobado: safe(entry.aprobado || entry.Aprobado || entry.approved || ''),
            nivel: safe(entry.nivel || entry.level || ''),
            nombre: safe(entry.nombre || entry.nombre_evento || entry.title || ''),
            organizador: safe(entry.organizador || entry.organizer || ''),
            logo_organizador: safe(entry.logo_organizador || entry.logo || entry.logo1 || ''),
            categoria: safe(entry.categoria || entry.category || ''),
            lugar: safe(entry.lugar || entry.location || ''),
            direccion: safe(entry.direccion || entry.address || ''),
            fecha: safe(entry.fecha || entry.date || ''),
            fecha_iso: fmtDate(safe(entry.fecha || entry.date || '')),
            hora: safe(entry.hora || entry.time || ''),
            descripcion: safe(entry.descripcion || entry.description || ''),
            instagram: safe(entry.instagram || entry.ig || ''),
            imgs: Array.isArray(entry.imgs) ? entry.imgs.map(s=>safe(s)).filter(Boolean) : [safe(entry.img1), safe(entry.img2), safe(entry.img3)].filter(Boolean),
            entradas: safe(entry.entradas || entry.link || entry.url || ''),
            partners: Array.isArray(entry.partners) ? entry.partners.map(p=>({name:safe(p.name), logo:safe(p.logo)})).filter(Boolean) : (entry.partners || [])
          };
        } else {
          // fallback: assume already normalized by GViz parser earlier
          ev = entry;
        }
        // mark approval if present
        const aprob = String(ev.aprobado || ev.Aprobado || ev.approved || '').toLowerCase();
        ev._approved = ['si','sí','1','true','ok','✓','aprobado'].includes(aprob);

        // decide whether to include (if anyApproved true, include only approved; otherwise include all but show aviso)
        if(anyApproved && !ev._approved) return;
        allEvents.push(ev);
        if(ev.categoria) categories.add(ev.categoria);
        if(ev.organizador) organizers.add(ev.organizador);
      });

      // If anyApproved true but no events after filtering -> warn
      if(anyApproved && allEvents.length === 0){
        debug("Se detectaron filas con 'aprobado' pero ninguna aprobada quedó para mostrar.");
      }

      // If no approved flags (anyApproved false), show aviso en debug
      if(!anyApproved) debug("No se detectó campo 'aprobado' en la data o ninguna fila marcada: mostrando todas las filas.");

      // sort by fecha_iso si disponible
      allEvents.sort((a,b) => (a.fecha_iso||'').localeCompare(b.fecha_iso||''));

      // inicializar UI
      filtered = allEvents.slice();
      renderTabsState();
      renderChips(); // chips vacíos inicialmente
      renderCards();
      renderPager();
      debug(`${allEvents.length} eventos cargados. Categorías: ${categories.size}. Organizadores: ${organizers.size}.`);
      console.log("EVENTS LOADED:", allEvents);
    }

    // UI render
    function renderTabsState(){
      tabs.forEach(t => {
        t.classList.toggle('active', t.getAttribute('data-mode') === mode);
      });
      // show chips only for category or organizer; hide for all
      chipsEl.style.display = (mode === 'all') ? 'none' : 'flex';
      chipsEl.setAttribute('aria-hidden', mode === 'all' ? 'true' : 'false');
    }

    function renderChips(){
      chipsEl.innerHTML = "";
      if(mode === 'category'){
        const arr = Array.from(categories).sort((a,b)=>a.localeCompare(b));
        arr.forEach(cat=>{
          const b = document.createElement('button');
          b.className = 'chip' + (activeChip === cat ? ' selected' : '');
          b.textContent = cat;
          b.onclick = ()=> { activeChip = (activeChip === cat ? '' : cat); applyFilters(); renderChips(); };
          chipsEl.appendChild(b);
        });
      } else if(mode === 'organizer'){
        const arr = Array.from(organizers).sort((a,b)=>a.localeCompare(b));
        arr.forEach(org=>{
          const b = document.createElement('button');
          b.className = 'chip' + (activeChip === org ? ' selected' : '');
          b.textContent = org;
          b.onclick = ()=> { activeChip = (activeChip === org ? '' : org); applyFilters(); renderChips(); };
          chipsEl.appendChild(b);
        });
      }
    }

    function applyFilters(){
      const q = (searchQ || "").trim().toLowerCase();
      filtered = allEvents.filter(ev => {
        if(mode === 'category' && activeChip) {
          if(!(ev.categoria && String(ev.categoria).toLowerCase() === String(activeChip).toLowerCase())) return false;
        }
        if(mode === 'organizer' && activeChip){
          if(!(ev.organizador && String(ev.organizador).toLowerCase() === String(activeChip).toLowerCase())) return false;
        }
        if(q){
          const hay = [ev.nombre, ev.descripcion, ev.lugar, ev.direccion, ev.categoria, ev.organizador, ev.localidad].join(' ').toLowerCase();
          return hay.indexOf(q) !== -1;
        }
        return true;
      });
      page = 1;
      renderCards();
      renderPager();
    }

    // dibuja tarjetas
    function renderCards(){
      cardsEl.innerHTML = "";
      if(filtered.length === 0){
        cardsEl.innerHTML = `<div style="color:#b02a2a;font-weight:800">No hay eventos para mostrar.</div>`;
        return;
      }
      const start = (page - 1) * PER_PAGE;
      const pageSlice = filtered.slice(start, start + PER_PAGE);
      pageSlice.forEach(ev => {
        const isVip = String((ev.nivel||'')).toLowerCase().includes('vip');
        const card = document.createElement('div');
        card.className = 'card' + (isVip ? ' vip' : '');
        const imgSrc = safeUrl((ev.imgs && ev.imgs[0]) || ev.logo_organizador || ev.logo_categoria);
        const imgHtml = imgSrc ? `<img class="thumb" src="${imgSrc}" alt="" onerror="this.style.display='none'">` : `<div class="thumb" aria-hidden="true"></div>`;
        const titulo = escapeHtml(ev.nombre || '(Sin título)');
        const metaParts = [];
        if(ev.fecha_iso) metaParts.push(ev.fecha_iso);
        else if(ev.fecha) metaParts.push(ev.fecha);
        if(ev.hora) metaParts.push(horaHumana(ev.hora));
        if(ev.lugar) metaParts.push(ev.lugar);
        const meta = metaParts.join(' • ');
        const desc = escapeHtml(ev.descripcion || '').replace(/\n/g,' ');
        let partnersHtml = '';
        if(ev.partners && ev.partners.length){
          partnersHtml = `<div class="partners">` + ev.partners.map(p=>{
            const l = safeUrl(p.logo);
            return `<div title="${escapeHtml(p.name)}" style="display:flex;align-items:center;gap:8px"><img class="partner-logo" src="${l||''}" onerror="this.style.display='none'"/><div class="small-muted">${escapeHtml(p.name)}</div></div>`;
          }).join('') + `</div>`;
        }
        const entradasBtn = ev.entradas ? `<a class="btn" href="${safeUrl(ev.entradas)}" target="_blank" rel="noopener">Entradas</a>` : '';
        const instaBtn = ev.instagram ? `<a class="btn secondary" href="${safeUrl(ev.instagram)}" target="_blank" rel="noopener">IG</a>` : '';
        card.innerHTML = `
          <div>${imgHtml}</div>
          <div class="info">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px;flex-wrap:wrap">
              <div>
                <div class="title">${titulo}</div>
                <div class="meta">${escapeHtml(meta)} ${ev.categoria ? ' • ' + escapeHtml(ev.categoria) : ''}</div>
                <div class="small-muted" style="margin-top:6px">${ev.organizador ? 'Organiza: ' + escapeHtml(ev.organizador) : ''}</div>
              </div>
              <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end;">
                ${entradasBtn}
                ${instaBtn}
              </div>
            </div>
            <div class="desc">${desc}</div>
            ${partnersHtml}
          </div>
        `;
        cardsEl.appendChild(card);
      });
    }

    // paginador simple
    function renderPager(){
      pagerEl.innerHTML = '';
      const totalPages = Math.max(1, Math.ceil(filtered.length / PER_PAGE));
      if(totalPages <= 1) return;
      const prev = document.createElement('button');
      prev.className = 'btn secondary';
      prev.textContent = 'Anterior';
      prev.disabled = page <= 1;
      prev.onclick = ()=>{ if(page>1) page--; renderCards(); renderPager(); window.scrollTo({top:0,behavior:'smooth'}); };
      const next = document.createElement('button');
      next.className = 'btn';
      next.textContent = 'Siguiente';
      next.disabled = page >= totalPages;
      next.onclick = ()=>{ if(page<totalPages) page++; renderCards(); renderPager(); window.scrollTo({top:0,behavior:'smooth'}); };
      const info = document.createElement('div');
      info.className = 'small-muted';
      info.style.fontWeight = '800';
      info.textContent = `Página ${page} / ${totalPages}  — ${filtered.length} eventos`;
      pagerEl.appendChild(prev);
      pagerEl.appendChild(info);
      pagerEl.appendChild(next);
    }

    function debug(msg){
      debugEl.textContent = msg;
      console.log(msg);
    }

    // eventos UI
    searchEl.addEventListener('input', e => {
      searchQ = e.target.value || '';
      activeChip = '';
      applyFilters();
    });

    tabs.forEach(t => {
      t.addEventListener('click', ()=> {
        mode = t.getAttribute('data-mode') || 'all';
        activeChip = '';
        renderTabsState();
        renderChips();
        applyFilters();
      });
    });

    // escape html helper
    function escapeHtml(text){
      if(text === null || text === undefined) return '';
      return String(text).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");
    }

    // iniciar carga
    loadData();
  </script>
</body>
</html>
