<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Agenda de Eventos — Estricto (Estructura fija)</title>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">
  <style>
    :root{ --accent:#22529a; --vip:#ff8c00; --muted:#6b7b8f; --bg:#f6f9fd; --card:#fff; }
    body{ margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:#122033; }
    .wrap{ max-width:1020px;margin:18px auto;padding:14px; }
    header{ display:flex;gap:12px;align-items:center; }
    .logo{ width:64px;height:64px;border-radius:10px;object-fit:cover;background:#fff;border:1px solid #e6eef9;padding:6px; }
    h1{ margin:0;color:var(--accent);font-size:1.25rem; }
    p.sub{ margin:0;color:var(--muted);font-size:0.95rem; }

    .controls{ display:flex;gap:10px;align-items:center;margin-top:12px;flex-wrap:wrap; }
    .search{ padding:10px 12px;border-radius:10px;border:1px solid #e6edf6;background:#fff;min-width:240px;flex:1 1 320px; }
    .select{ padding:9px;border-radius:10px;border:1px solid #e6edf6;background:#fff; }
    .checkbox{ display:flex;align-items:center;gap:8px;color:var(--muted); }

    .debug{ margin-top:10px;color:#8a2a2a;font-weight:700;font-size:0.95rem; }

    .cards{ margin-top:14px; display:flex; flex-direction:column; gap:12px; }
    .card{ background:var(--card); border-radius:10px; padding:12px; box-shadow:0 6px 18px rgba(16,30,60,0.04); display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap; }
    .card.vip{ border-left:6px solid var(--vip); background:linear-gradient(90deg,#fff7f0,#fff); }
    .thumb{ width:110px; height:80px; object-fit:cover; border-radius:8px; background:#f3f5f8; }
    .info{ flex:1 1 420px; }
    .title{ margin:0;font-weight:800;color:#122033; font-size:1.06rem; }
    .meta{ color:var(--muted); font-size:0.92rem; margin-top:6px; display:flex; gap:8px; flex-wrap:wrap; }
    .desc{ margin-top:8px;color:#263448;font-size:0.95rem; max-height:86px; overflow:hidden; }

    .partners{ margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .partner-logo{ width:48px;height:48px; object-fit:contain;border-radius:6px;background:#fff;border:1px solid #eef2f7;padding:4px; }

    .pager{ margin-top:14px; display:flex; gap:8px; justify-content:center; align-items:center; }
    .btn{ padding:8px 12px;border-radius:8px;border:none;background:var(--accent);color:#fff;font-weight:800;cursor:pointer; }
    .btn.alt{ background:#fff;color:var(--accent);border:1px solid #e6edf6; }

    .small{ color:var(--muted); font-size:0.92rem; }

    @media(max-width:720px){
      .thumb{ width:84px;height:64px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <img class="logo" id="logo" src="https://raw.githubusercontent.com/liqko/guia-local-dolores/refs/heads/main/img/plataforma/eventos.png" alt="logo">
      <div>
        <h1>Agenda de Eventos</h1>
        <p class="sub">Uso estricto de la estructura que enviaste. Solo se muestran filas con "aprobado" marcado (columna 0) por defecto. Fecha legible en español y hora unificada.</p>
      </div>
    </header>

    <div class="controls">
      <input id="search" class="search" placeholder="Buscar por nombre, descripción, lugar..." />
      <select id="selCategory" class="select"><option value="">Todas las categorías</option></select>
      <select id="selOrganizer" class="select"><option value="">Todos los organizadores</option></select>
      <label class="checkbox"><input type="checkbox" id="showAll"> Ver todo (incluir no aprobados)</label>
    </div>

    <div style="margin-top:10px; display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
      <div class="small">Fuente de datos: <span id="sheetUrl"></span></div>
      <div class="small">Registros totales: <span id="countTotal">0</span></div>
      <div class="small">Aprobados: <span id="countApproved">0</span></div>
      <div id="status" class="small" style="margin-left:8px;color:#6b7b8f"></div>
    </div>

    <div id="debug" class="debug" aria-live="polite"></div>

    <div id="cards" class="cards"></div>

    <div class="pager" id="pager"></div>
  </div>

  <script>
    // ---------- CONFIG (uso estricto de la estructura que diste) ----------
    const GVIZ_URL = "https://docs.google.com/spreadsheets/d/1CCNDvrIFFufiLXmYkm4YcmtZVpk6rG2gJQQYXzA186o/gviz/tq?tqx=out:json&gid=338324539";
    const DATA_URL = GVIZ_URL; // sin detecciones: la estructura es la que vos me diste
    document.getElementById('sheetUrl').textContent = DATA_URL;

    // ---------- Indices fijos según estructura que pasaste ----------
    const IDX = {
      aprobado: 0, nivel: 1, nombre: 8, organizador: 4, logo_organizador: 5, categoria: 6,
      lugar: 10, direccion: 11, fecha: 13, hora: 14, hora2: 15, descripcion: 16,
      instagram: 17, img1: 18, img2: 19, img3: 20, entradas: 21
    };

    // ---------- Estado ----------
    let all = [], filtered = [], approvedCount = 0;
    const PER_PAGE = 8;
    let page = 1;

    // UI
    const searchEl = document.getElementById('search');
    const selCategory = document.getElementById('selCategory');
    const selOrganizer = document.getElementById('selOrganizer');
    const showAllEl = document.getElementById('showAll');
    const debugEl = document.getElementById('debug');
    const countTotalEl = document.getElementById('countTotal');
    const countApprovedEl = document.getElementById('countApproved');
    const cardsEl = document.getElementById('cards');
    const pagerEl = document.getElementById('pager');
    const statusEl = document.getElementById('status');

    // ---------- helpers ----------
    const safe = v => v === null || v === undefined ? "" : String(v);
    const esc = s => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    const safeUrl = u => { if(!u) return ""; u = String(u).trim(); if(/^https?:\/\//i.test(u)) return u; if(/^www\./i.test(u)) return 'https://' + u; return u; };
    const horaHum = h => {
      if(!h) return '';
      // Date(...) pattern de Google Sheets
      let m = String(h).match(/^Date\(\d{4},\d{1,2},\d{1,2},(\d{1,2}),(\d{1,2})/);
      if (m) return `${String(m[1]).padStart(2,'0')}:${String(m[2]).padStart(2,'0')} hs`;
      // hh:mm or h:mm
      m = String(h).match(/^(\d{1,2}):(\d{2})(:\d{2})?$/);
      if (m) return `${String(m[1]).padStart(2,'0')}:${m[2]} hs`;
      return h;
    };

    // devuelve fecha en estilo hispanohablante: "lunes 12 de noviembre de 2025"
    function fechaHumana(valor) {
      if (!valor) return "";
      // manejar ISO yyyy-mm-dd
      if (/^\d{4}-\d{2}-\d{2}$/.test(valor)) {
        const [anio, mes, dia] = valor.split("-");
        const fecha = new Date(parseInt(anio,10), parseInt(mes,10)-1, parseInt(dia,10));
        return formatoFechaEsp(fecha);
      }
      // dd/mm/yyyy
      if (/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/.test(valor)) {
        const match = valor.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
        const dia = parseInt(match[1],10), mes = parseInt(match[2],10), anio = parseInt(match[3],10);
        const fecha = new Date(anio, mes-1, dia);
        return formatoFechaEsp(fecha);
      }
      // Date(yyyy,mm,dd) o Date(yyyy,mm,dd,hh,mm)
      if (/^Date\((\d{4}),\s*(\d+),\s*(\d+)/.test(valor)) {
        const m = valor.match(/^Date\((\d{4}),\s*(\d+),\s*(\d+)(?:,\s*(\d+),\s*(\d+))?/);
        const anio = parseInt(m[1],10);
        const mes = parseInt(m[2],10);
        const dia = parseInt(m[3],10);
        const fecha = new Date(anio, mes, dia);
        return formatoFechaEsp(fecha);
      }
      // intentar Date.parse
      const d = new Date(valor);
      if (!isNaN(d.getTime())) return formatoFechaEsp(d);
      return valor;
    }

    function formatoFechaEsp(fecha){
      const dias = ["domingo","lunes","martes","miércoles","jueves","viernes","sábado"];
      const meses = ["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"];
      const diaNombre = dias[fecha.getDay()];
      const dia = fecha.getDate();
      const mesNombre = meses[fecha.getMonth()];
      const anio = fecha.getFullYear();
      // resultado: "lunes 12 de noviembre de 2025"
      return `${diaNombre} ${dia} de ${mesNombre} de ${anio}`;
    }

    // hora unificada: si hay hora2 no vacía usa hora2, si no usa hora
    function horaUnificada(ev){
      const h2 = safe(ev.hora2 || "");
      const h1 = safe(ev.hora || "");
      const chosen = h2.trim() !== "" ? h2 : h1;
      return horaHum(chosen);
    }

    // detecta valores "true" de checkbox de Sheets (boolean o string)
    function isCheckedValue(v){
      if (v === true) return true;
      if (v === false) return false;
      const s = String(v||'').toLowerCase().trim();
      return ['si','sí','true','1','ok','✓','x'].includes(s);
    }

    // ---------- carga estricta usando índices fijos ----------
    async function load() {
      debugEl.textContent = "Cargando (uso índices fijos)...";
      try {
        const res = await fetch(DATA_URL, {cache:'no-store'});
        if(!res.ok) throw new Error('HTTP ' + res.status);
        const text = await res.text();
        // parse GViz wrapper
        const start = text.indexOf('{'), end = text.lastIndexOf('}');
        if (start === -1 || end === -1) throw new Error('Respuesta inesperada, GViz wrapper no encontrada');
        const jsonText = text.substring(start, end+1);
        const obj = JSON.parse(jsonText);
        const rows = (obj.table && obj.table.rows) ? obj.table.rows : [];
        all = [];
        approvedCount = 0;
        const cats = new Set();
        const orgs = new Set();

        for(let i=0;i<rows.length;i++){
          const c = rows[i].c || [];
          const val = idx => (c[idx] && c[idx].v !== undefined) ? c[idx].v : "";

          // usar exactamente la columna 0 como 'aprobado'
          const apro = val(IDX.aprobado);
          const aprobado = isCheckedValue(apro);

          // construir evento
          const ev = {
            aprobado,
            nivel: safe(val(IDX.nivel)),
            nombre: safe(val(IDX.nombre)),
            organizador: safe(val(IDX.organizador)),
            logo_organizador: safe(val(IDX.logo_organizador)),
            categoria: safe(val(IDX.categoria)),
            lugar: safe(val(IDX.lugar)),
            direccion: safe(val(IDX.direccion)),
            fecha: safe(val(IDX.fecha)),
            fecha_iso: dateISO(safe(val(IDX.fecha))),
            hora: safe(val(IDX.hora)),
            hora2: safe(val(IDX.hora2)),
            descripcion: safe(val(IDX.descripcion)),
            instagram: safe(val(IDX.instagram)),
            imgs: [safe(val(IDX.img1)), safe(val(IDX.img2)), safe(val(IDX.img3))].filter(Boolean),
            entradas: safe(val(IDX.entradas)),
            partners: []
          };

          // partners de acuerdo a tu estructura (22..33)
          for(let p=22;p<=32;p+=2){
            const name = val(p);
            const logo = val(p+1);
            if(name || logo) ev.partners.push({ name: safe(name), logo: safe(logo) });
          }

          all.push(ev);
          if(ev.categoria) cats.add(ev.categoria);
          if(ev.organizador) orgs.add(ev.organizador);
          if(ev.aprobado) approvedCount++;
        }

        // por defecto: si existe la columna en posición 0 usamos estrictamente aprobados
        countTotalEl.textContent = all.length;
        countApprovedEl.textContent = approvedCount;
        document.getElementById('status').textContent = approvedCount === 0 ? 'No hay eventos aprobados en la hoja.' : '';

        // llenar selects con los valores de los eventos aprobados por defecto (si showAll está activado, se mostrará todo)
        const approvedEvents = all.filter(e => e.aprobado);
        populate(selCategory, new Set(approvedEvents.map(e=>e.categoria).filter(Boolean)));
        populate(selOrganizer, new Set(approvedEvents.map(e=>e.organizador).filter(Boolean)));

        // aplicar filtros iniciales: por defecto showAll = false -> mostramos solo aprobados
        showAllEl.checked = false;
        filtered = approvedEvents.slice();
        page = 1;
        renderCards();
        renderPager();

        debugEl.textContent = `Carga completa. Total filas: ${all.length}. Aprobados: ${approvedCount}. Mostrando solo aprobados por defecto.`;
        console.log('All events (raw normalized):', all);
      } catch(err) {
        console.error(err);
        debugEl.textContent = 'ERROR durante carga: ' + (err.message || err);
        cardsEl.innerHTML = `<div style="color:#b02a2a;font-weight:800">No se pudieron cargar los eventos: ${esc(err.message || err)}</div>`;
      }
    }

    // ---------- filtrado y render ----------
    function applyFilters(){
      const q = (searchEl.value||'').trim().toLowerCase();
      const cat = selCategory.value;
      const org = selOrganizer.value;
      const includeAll = showAllEl.checked; // si true incluimos no aprobados
      let source = includeAll ? all : all.filter(e=>e.aprobado);
      filtered = source.filter(ev => {
        if(cat && (!ev.categoria || String(ev.categoria).toLowerCase() !== String(cat).toLowerCase())) return false;
        if(org && (!ev.organizador || String(ev.organizador).toLowerCase() !== String(org).toLowerCase())) return false;
        if(q){
          const hay = [ev.nombre, ev.descripcion, ev.lugar, ev.direccion, ev.categoria, ev.organizador, ev.fecha].join(' ').toLowerCase();
          return hay.indexOf(q) !== -1;
        }
        return true;
      });
      page = 1;
      renderCards();
      renderPager();
      statusEl.textContent = `Mostrando ${filtered.length} / ${all.length} (aprobados: ${approvedCount})${includeAll ? ' — mostrando no aprobados también' : ''}`;
    }

    function renderCards(){
      cardsEl.innerHTML = '';
      if(!filtered || filtered.length === 0){
        cardsEl.innerHTML = `<div style="color:#b02a2a;font-weight:800">No hay eventos para mostrar con ese filtro.</div>`;
        return;
      }
      const start = (page-1) * PER_PAGE;
      const slice = filtered.slice(start, start + PER_PAGE);
      slice.forEach(ev => {
        const isVip = (ev.nivel||'').toLowerCase().includes('vip');
        const card = document.createElement('div');
        card.className = 'card' + (isVip ? ' vip' : '');
        const imgSrc = safeUrl((ev.imgs && ev.imgs[0]) || ev.logo_organizador || '');
        const imgHtml = imgSrc ? `<img class="thumb" src="${esc(imgSrc)}" alt="" onerror="this.style.display='none'">` : `<div class="thumb" aria-hidden="true"></div>`;
        const metaParts = [];
        const fechaDisplay = fechaHumana(ev.fecha_iso || ev.fecha);
        if(fechaDisplay) metaParts.push(fechaDisplay);
        const horaUni = horaUnificada(ev);
        if(horaUni) metaParts.push(horaUni);
        if(ev.lugar) metaParts.push(ev.lugar);
        const meta = metaParts.join(' • ');
        const desc = esc(ev.descripcion || '').slice(0,800);
        const partnersHtml = (ev.partners && ev.partners.length) ? `<div class="partners">${ev.partners.map(p=>`<div title="${esc(p.name)}" style="display:flex;align-items:center;gap:8px"><img class="partner-logo" src="${esc(safeUrl(p.logo))}" onerror="this.style.display='none'"><div class="small">${esc(p.name)}</div></div>`).join('')}</div>` : '';
        const entradasBtn = ev.entradas ? `<a class="btn" href="${esc(safeUrl(ev.entradas))}" target="_blank" rel="noopener">Entradas</a>` : '';
        const instaBtn = ev.instagram ? `<a class="btn alt" href="${esc(safeUrl(ev.instagram))}" target="_blank" rel="noopener">Instagram</a>` : '';

        card.innerHTML = `
          <div>${imgHtml}</div>
          <div class="info">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px;flex-wrap:wrap">
              <div>
                <div class="title">${esc(ev.nombre || '(Sin título)')}</div>
                <div class="meta">${esc(meta)}${ev.categoria ? ' • ' + esc(ev.categoria) : ''}</div>
                <div class="small" style="margin-top:6px">${ev.organizador ? 'Organiza: ' + esc(ev.organizador) : ''}${ev.aprobado ? ' • Aprobado' : ''}</div>
              </div>
              <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
                ${entradasBtn}
                ${instaBtn}
              </div>
            </div>
            <div class="desc">${desc}</div>
            ${partnersHtml}
          </div>
        `;
        cardsEl.appendChild(card);
      });
    }

    function renderPager(){
      pagerEl.innerHTML = '';
      const totalPages = Math.max(1, Math.ceil(filtered.length / PER_PAGE));
      if(totalPages <= 1) return;
      const prev = document.createElement('button'); prev.className='btn alt'; prev.textContent='Anterior'; prev.disabled = page<=1;
      prev.onclick = ()=>{ if(page>1) page--; renderCards(); renderPager(); window.scrollTo({top:0,behavior:'smooth'}); };
      const next = document.createElement('button'); next.className='btn'; next.textContent='Siguiente'; next.disabled = page>=totalPages;
      next.onclick = ()=>{ if(page<totalPages) page++; renderCards(); renderPager(); window.scrollTo({top:0,behavior:'smooth'}); };
      const info = document.createElement('div'); info.className='small'; info.style.fontWeight='800';
      info.textContent = `Página ${page} / ${totalPages} — ${filtered.length} eventos`;
      pagerEl.appendChild(prev); pagerEl.appendChild(info); pagerEl.appendChild(next);
    }

    // ---------- UI events ----------
    searchEl.addEventListener('input', () => applyFilters());
    selCategory.addEventListener('change', () => { selOrganizer.value=''; applyFilters(); });
    selOrganizer.addEventListener('change', () => { selCategory.value=''; applyFilters(); });
    showAllEl.addEventListener('change', () => {
      if(showAllEl.checked){
        // si pediste ver todo, repoblar selects con todos los valores
        populateSelectsFromAll();
      } else {
        populateSelectsFromApproved();
      }
      applyFilters();
    });

    function populateSelectsFromApproved(){
      const approved = all.filter(e=>e.aprobado);
      populate(selCategory, new Set(approved.map(e=>e.categoria).filter(Boolean)));
      populate(selOrganizer, new Set(approved.map(e=>e.organizador).filter(Boolean)));
    }
    function populateSelectsFromAll(){
      populate(selCategory, new Set(all.map(e=>e.categoria).filter(Boolean)));
      populate(selOrganizer, new Set(all.map(e=>e.organizador).filter(Boolean)));
    }
    function populate(sel, set){
      sel.innerHTML = '<option value="">(todos)</option>';
      Array.from(set).sort().forEach(v => {
        const o = document.createElement('option'); o.value = v; o.textContent = v; sel.appendChild(o);
      });
    }

    // ---------- inicio ----------
    load();
  </script>
</body>
</html>
