<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Guía Local Dolores - Turismo</title>
<style>
  body {
    background: transparent;
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 20px;
  }
  #search-wrapper {
    background: #f5f5f5;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
  }
  #search-field, #search-field-type {
    font-size: 1rem;
    padding: 8px;
    margin-right: 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
  }
  #search-field {
    width: 60%;
  }
  #listado {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
  }
  .tarjeta {
    background: #f5f5f5;
    border-radius: 8px;
    padding: 15px;
    width: calc(33% - 10px);
    box-sizing: border-box;
    box-shadow: 0 2px 5px rgb(0 0 0 / 0.1);
    display: flex;
    flex-direction: column;
  }
  .tarjeta img {
    max-width: 100%;
    border-radius: 6px;
    margin-bottom: 10px;
    object-fit: contain;
    max-height: 100px;
  }
  .tarjeta h3 {
    margin: 0 0 6px 0;
    font-size: 1.1rem;
  }
  .tarjeta p {
    margin: 4px 0;
    flex-grow: 1;
  }
  .botones {
    margin-top: 10px;
  }
  .boton-mapa {
    background-color: #0078d7;
    color: white;
    padding: 6px 12px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    text-decoration: none;
    font-size: 0.9rem;
  }
  .boton-mapa:hover {
    background-color: #005ea2;
  }
  @media (max-width: 900px) {
    .tarjeta {
      width: calc(50% - 10px);
    }
  }
  @media (max-width: 500px) {
    .tarjeta {
      width: 100%;
    }
    #search-field {
      width: 100%;
      margin-bottom: 10px;
    }
  }
</style>
</head>
<body>

<div id="search-wrapper">
  <select id="search-field-type" title="Seleccionar campo de búsqueda">
    <option value="all" selected>Buscar en todo</option>
    <option value="nombre">Nombre</option>
    <option value="categoria1">Categoría 1</option>
    <option value="categoria2">Categoría 2</option>
    <option value="subcategoria">Subcategoría</option>
  </select>
  <input type="text" id="search-field" placeholder="Buscar por nombre, categoría o subcategoría..." />
</div>

<div id="listado">
  <!-- Aquí se cargan los datos -->
</div>

<script>
  const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTTPvnE6DszbG6M7h84ZAdzpRdpTvH3k5wPuVz7sQf0Oa4tpFD4sJOqjZc3H4gY9lAT7lnUQh4Tpe1C7/pub?output=csv';

  const listado = document.getElementById('listado');
  const searchField = document.getElementById('search-field');
  const searchFieldType = document.getElementById('search-field-type');

  // Utilidad para normalizar texto: quitar tildes y pasar a minúsculas
  function normalizeText(text) {
    return text.toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
  }

  // Cargar CSV desde Google Sheets
  async function fetchData() {
    const response = await fetch(sheetUrl);
    const csvText = await response.text();
    return csvToArray(csvText);
  }

  // Convierte CSV a array de objetos
  function csvToArray(str, delimiter = ",") {
    const lines = str.trim().split("\n");
    const headers = lines.shift().split(delimiter).map(h => h.trim());
    return lines.map(line => {
      const values = line.split(delimiter);
      let obj = {};
      headers.forEach((header, i) => {
        obj[header] = values[i] ? values[i].trim() : "";
      });
      return obj;
    });
  }

  // Crear tarjeta de anunciante
  function createCard(item) {
    const card = document.createElement('div');
    card.className = 'tarjeta';

    if(item.logo){
      const img = document.createElement('img');
      img.src = item.logo;
      img.alt = item.nombre;
      card.appendChild(img);
    }

    const title = document.createElement('h3');
    title.textContent = item.nombre;
    card.appendChild(title);

    if(item.descripcion){
      const desc = document.createElement('p');
      desc.textContent = item.descripcion;
      card.appendChild(desc);
    }

    // Mostrar dirección y botón "Cómo llegar" SOLO si nivel = 3 (sin importar subnivel)
    if(item.nivel === "3") {
      if(item.direccion){
        const dir = document.createElement('p');
        dir.textContent = "Dirección: " + item.direccion;
        card.appendChild(dir);
      }
      if(item.maps && item.maps !== ""){
        const botones = document.createElement('div');
        botones.className = 'botones';
        const botonMapa = document.createElement('a');
        botonMapa.href = item.maps;
        botonMapa.target = "_blank";
        botonMapa.className = 'boton-mapa';
        botonMapa.textContent = '¿Cómo llegar?';
        botones.appendChild(botonMapa);
        card.appendChild(botones);
      }
    }

    return card;
  }

  // Renderizar listado filtrado
  function renderList(data, filterText, filterField) {
    listado.innerHTML = "";
    const normalizedFilter = normalizeText(filterText);
    const filtered = data.filter(item => {
      if (!filterText) return true;
      // Buscar según campo seleccionado o en todos si "all"
      if(filterField === "all"){
        return (
          normalizeText(item.nombre).includes(normalizedFilter) ||
          normalizeText(item.categoria1).includes(normalizedFilter) ||
          normalizeText(item.categoria2).includes(normalizedFilter) ||
          normalizeText(item.subcategoria).includes(normalizedFilter)
        );
      } else {
        return normalizeText(item[filterField]).includes(normalizedFilter);
      }
    });

    if(filtered.length === 0){
      listado.textContent = "No se encontraron resultados.";
      return;
    }

    filtered.forEach(item => {
      listado.appendChild(createCard(item));
    });
  }

  // Carga inicial
  let globalData = [];
  fetchData().then(data => {
    globalData = data;
    renderList(globalData, "", "all");
  });

  // Eventos buscador
  searchField.addEventListener('input', () => {
    renderList(globalData, searchField.value, searchFieldType.value);
  });
  searchFieldType.addEventListener('change', () => {
    // Cambia placeholder según selección
    const placeholders = {
      all: "Buscar por nombre, categoría o subcategoría...",
      nombre: "Buscar por nombre...",
      categoria1: "Buscar por categoría 1...",
      categoria2: "Buscar por categoría 2...",
      subcategoria: "Buscar por subcategoría..."
    };
    searchField.placeholder = placeholders[searchFieldType.value];
    renderList(globalData, searchField.value, searchFieldType.value);
  });
</script>

</body>
</html>
