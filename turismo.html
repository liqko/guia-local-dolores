<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Guía Local Dolores - Turismo Filtros</title>
<style>
  body {
    background: transparent;
    font-family: Arial, sans-serif;
    margin: 20px;
    padding: 0;
  }
  #filters {
    background: #f5f5f5;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }
  select, input[type="text"] {
    padding: 8px;
    font-size: 1rem;
    border: 1px solid #ccc;
    border-radius: 5px;
    min-width: 150px;
  }
  #listado {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
  }
  .tarjeta {
    background: #f5f5f5;
    border-radius: 8px;
    padding: 15px;
    width: calc(33% - 10px);
    box-sizing: border-box;
    box-shadow: 0 2px 5px rgb(0 0 0 / 0.1);
    display: flex;
    flex-direction: column;
  }
  .tarjeta img {
    max-width: 100%;
    border-radius: 6px;
    margin-bottom: 10px;
    object-fit: contain;
    max-height: 100px;
  }
  .tarjeta h3 {
    margin: 0 0 6px 0;
    font-size: 1.1rem;
  }
  .tarjeta p {
    margin: 4px 0;
    flex-grow: 1;
  }
  .botones {
    margin-top: 10px;
  }
  .boton-mapa {
    background-color: #0078d7;
    color: white;
    padding: 6px 12px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    text-decoration: none;
    font-size: 0.9rem;
  }
  .boton-mapa:hover {
    background-color: #005ea2;
  }
  @media (max-width: 900px) {
    .tarjeta {
      width: calc(50% - 10px);
    }
  }
  @media (max-width: 500px) {
    .tarjeta {
      width: 100%;
    }
    #filters {
      flex-direction: column;
    }
  }
</style>
</head>
<body>

<div id="filters">
  <select id="filtro-rubro">
    <option value="">-- Rubro --</option>
  </select>
  <select id="filtro-categoria">
    <option value="">-- Categoría --</option>
  </select>
  <select id="filtro-subcategoria">
    <option value="">-- Subcategoría --</option>
  </select>
  <input type="text" id="filtro-nombre" placeholder="Buscar por nombre..." />
</div>

<div id="listado">Cargando datos...</div>

<script>
  const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTTPvnE6DszbG6M7h84ZAdzpRdpTvH3k5wPuVz7sQf0Oa4tpFD4sJOqjZc3H4gY9lAT7lnUQh4Tpe1C7/pub?output=csv';

  const listado = document.getElementById('listado');
  const filtroRubro = document.getElementById('filtro-rubro');
  const filtroCategoria = document.getElementById('filtro-categoria');
  const filtroSubcategoria = document.getElementById('filtro-subcategoria');
  const filtroNombre = document.getElementById('filtro-nombre');

  function normalizeText(text) {
    return text ? text.toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase() : "";
  }

  function csvToArray(str, delimiter = ",") {
    const lines = str.trim().split("\n");
    const headers = lines.shift().split(delimiter).map(h => h.trim());
    return lines.map(line => {
      const values = line.split(delimiter);
      let obj = {};
      headers.forEach((header, i) => {
        obj[header] = values[i] ? values[i].trim() : "";
      });
      return obj;
    });
  }

  function uniqueSorted(arr) {
    return [...new Set(arr.filter(a => a && a !== ""))].sort((a,b) => a.localeCompare(b));
  }

  function createOption(value) {
    const opt = document.createElement('option');
    opt.value = value;
    opt.textContent = value;
    return opt;
  }

  function createCard(item) {
    const card = document.createElement('div');
    card.className = 'tarjeta';

    if(item.logo){
      const img = document.createElement('img');
      img.src = item.logo;
      img.alt = item.nombre;
      card.appendChild(img);
    }

    const title = document.createElement('h3');
    title.textContent = item.nombre;
    card.appendChild(title);

    if(item.descripcion){
      const desc = document.createElement('p');
      desc.textContent = item.descripcion;
      card.appendChild(desc);
    }

    // Mostrar dirección y botón "Cómo llegar" SOLO si nivel = 3
    if(item.nivel === "3") {
      if(item.direccion){
        const dir = document.createElement('p');
        dir.textContent = "Dirección: " + item.direccion;
        card.appendChild(dir);
      }
      if(item.maps){
        const botones = document.createElement('div');
        botones.className = 'botones';
        const botonMapa = document.createElement('a');
        botonMapa.href = item.maps;
        botonMapa.target = "_blank";
        botonMapa.className = 'boton-mapa';
        botonMapa.textContent = '¿Cómo llegar?';
        botones.appendChild(botonMapa);
        card.appendChild(botones);
      }
    }

    return card;
  }

  function renderList(data) {
    listado.innerHTML = "";
    if(data.length === 0){
      listado.textContent = "No se encontraron resultados.";
      return;
    }
    data.forEach(item => {
      listado.appendChild(createCard(item));
    });
  }

  function filterData(data) {
    const r = normalizeText(filtroRubro.value);
    const c = normalizeText(filtroCategoria.value);
    const s = normalizeText(filtroSubcategoria.value);
    const n = normalizeText(filtroNombre.value);

    return data.filter(item => {
      const rubros = [item.rubro1, item.rubro2].map(normalizeText);
      const categorias = [item.categoria1, item.categoria2].map(normalizeText);
      const subcategoria = normalizeText(item.subcategoria);
      const nombre = normalizeText(item.nombre);

      const matchRubro = r === "" || rubros.includes(r);
      const matchCategoria = c === "" || categorias.includes(c);
      const matchSubcategoria = s === "" || subcategoria.includes(s);
      const matchNombre = n === "" || nombre.includes(n);

      return matchRubro && matchCategoria && matchSubcategoria && matchNombre;
    });
  }

  let globalData = [];

  fetch(sheetUrl)
    .then(res => res.text())
    .then(text => {
      globalData = csvToArray(text);

      // llenar filtros
      const rubros = uniqueSorted(globalData.flatMap(i => [i.rubro1, i.rubro2]));
      rubros.forEach(r => filtroRubro.appendChild(createOption(r)));

      const categorias = uniqueSorted(globalData.flatMap(i => [i.categoria1, i.categoria2]));
      categorias.forEach(c => filtroCategoria.appendChild(createOption(c)));

      const subcategorias = uniqueSorted(globalData.map(i => i.subcategoria));
      subcategorias.forEach(s => filtroSubcategoria.appendChild(createOption(s)));

      renderList(globalData);
    });

  [filtroRubro, filtroCategoria, filtroSubcategoria].forEach(sel =>
    sel.addEventListener('change', () => {
      const filtered = filterData(globalData);
      renderList(filtered);
    })
  );

  filtroNombre.addEventListener('input', () => {
    const filtered = filterData(globalData);
    renderList(filtered);
  });

</script>
</body>
</html>
