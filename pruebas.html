<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Panel Comercios - Login & Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Google Font Inter -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    :root{
      --bg: #f6f7fb;
      --card: #ffffff;
      --muted: #6b7280;
      --primary: #3dc879;
      --danger: #e74c3c;
      --accent: #3498db;
      --radius: 12px;
      --shadow: 0 6px 18px rgba(12,24,40,0.06);
      --text: #0f1724;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{font-family:Inter, Arial, Helvetica, sans-serif;background:var(--bg);margin:0;color:var(--text);-webkit-font-smoothing:antialiased}
    .container{max-width:980px;margin:28px auto;background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:22px}

    h2{margin:0 0 8px;font-weight:700}
    h3{margin:0;font-size:1.05rem}
    label{display:block;margin:12px 0 6px;font-weight:600;color:var(--muted);font-size:0.95rem}
    .small-muted{font-size:0.95rem;color:var(--muted)}
    .muted-note{font-size:0.95rem;color:#444;margin-top:6px}

    input,textarea,select{width:100%;padding:10px;border-radius:10px;border:1px solid #e6e9ee;background:#fff;font-size:0.95rem}
    input::placeholder, textarea::placeholder{color:#9aa3b2}
    input:focus, select:focus, textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 6px 20px rgba(52,152,219,0.06)}
    button{cursor:pointer;font-family:inherit}
    button.primary{background:var(--primary);color:#fff;border:0;padding:10px 14px;border-radius:10px;font-weight:700}
    button.secondary{background:#f5f7fa;color:var(--muted);border:0;padding:8px 12px;border-radius:8px}
    .btn-ghost{background:transparent;border:1px solid #eef2f6;padding:8px 12px;border-radius:8px}
    .contact-support{background:var(--danger);color:#fff;border:0;padding:12px;border-radius:10px;font-weight:800;text-align:center;display:block;width:100%;box-shadow:0 6px 18px rgba(231,76,60,0.12)}

    .top-row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 2px 8px rgba(12,24,40,0.04);border:1px solid #f1f4f8}
    .info-banner{background:#fffbe5;border:1px solid #f5c26b;padding:10px;border-radius:10px;margin-top:8px}

    .tabs{display:flex;gap:8px;margin:12px 0 18px}
    .tab{padding:8px 14px;border-radius:999px;background:transparent;border:1px solid transparent;color:var(--muted);font-weight:700;cursor:pointer}
    .tab.active{background:var(--primary);color:#fff;box-shadow:0 6px 18px rgba(61,200,121,0.12)}

    .promos-row-controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .promo-input{flex:1;min-width:160px;padding:10px;border-radius:10px}
    .promo-select{min-width:180px;padding:10px;border-radius:10px}

    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:12px;border-bottom:1px solid #f1f4f8;text-align:left;font-size:0.95rem;vertical-align:middle}
    thead th{color:var(--muted);font-weight:700;font-size:0.9rem}
    tr:hover{background:#fbfdff}
    .action-btn{background:transparent;border:0;padding:6px 8px;border-radius:8px;color:var(--muted)}
    .action-btn .fa-fw{margin-right:6px}

    @media (max-width:780px){
      table, thead, tbody, th, td, tr { display:block; }
      thead { display:none; }
      tr { margin-bottom:12px;padding:12px;background:#fff;border-radius:10px;box-shadow:0 6px 18px rgba(12,24,40,0.04) }
      td{border:none;padding:8px 0}
      td.label{font-weight:700;color:var(--muted);display:inline-block;width:110px}
      .promos-row-controls{flex-direction:column;align-items:stretch}
    }

    .autocomplete-list{position:absolute;background:#fff;border:1px solid #e6e9ee;z-index:40;max-height:280px;overflow-y:auto;width:100%;border-radius:8px}
    .autocomplete-item{padding:10px;border-bottom:1px solid #f1f4f8;cursor:pointer}
    .autocomplete-item:hover{background:#f1fbff}

    #debug{background:#0b1220;color:#bff;padding:10px;border-radius:8px;max-height:160px;overflow:auto;font-size:12px;margin-top:12px;white-space:pre-wrap;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace}

    .muted-small{font-size:0.85rem;color:var(--muted)}
    a.link{color:var(--accent);text-decoration:none}
  </style>
</head>
<body>
  <div class="container">
    <div id="panel-login" class="panel active">
      <h2>Ingresar a tu comercio</h2>
      <form id="login-form" autocomplete="off" class="card">
        <label>Comercio</label>
        <div style="position:relative;">
          <input type="text" id="comercio-buscar" placeholder="Buscá tu comercio..." autocomplete="off" required>
          <div id="autocomplete-list" class="autocomplete-list hidden"></div>
        </div>
        <input type="hidden" id="comercio-id">
        <label>Clave</label>
        <input type="password" id="clave" placeholder="Clave..." required minlength="1">
        <div style="display:flex;gap:10px;align-items:center">
          <button id="btnLogin" class="primary" disabled>Ingresar</button>
          <button id="btnCrearComercio" type="button" class="btn-ghost">Solicitar creación</button>
        </div>

        <div id="login-msg" style="margin-top:8px"></div>
        <div id="level-warning" class="small-muted" style="margin-top:6px"></div>

        <div id="create-commerce-banner" class="info-banner">
          <strong>¿Tu anuncio no aparece en la guía?</strong>
          <div class="small-muted" style="margin-top:6px">Si tu comercio, servicio u organización no figura, completá el formulario de creación del anuncio.</div>
        </div>

      </form>

      <div style="text-align:center;margin-top:12px;">
        <a class="link" href="#" onclick="mostrarPanel('registro')">¿Necesitás generar tu contraseña? Ir a Generar contraseña</a>
      </div>
    </div>

    <div id="panel-registro" class="panel">
      <h2>Generar contraseña / Registrar acceso</h2>
      <div class="card">
        <p class="muted-note">Este flujo sirve para generar la contraseña directamente para un anunciante que ya tiene su anuncio cargado en la guía.</p>

        <label>Buscar anuncio (seleccioná el anuncio ya publicado)</label>
        <div style="position:relative;">
          <input type="text" id="comercio-buscar2" placeholder="Buscá tu comercio..." autocomplete="off">
          <div id="autocomplete-list2" class="autocomplete-list hidden"></div>
        </div>

        <input type="hidden" id="comercio-id2">
        <label>Contraseña</label>
        <input type="password" id="nueva-clave" placeholder="Ingresá la nueva contraseña (mínimo 4 caracteres)" minlength="4" disabled>
        <label>Confirmar contraseña</label>
        <input type="password" id="nueva-clave-confirm" placeholder="Repetí la contraseña" minlength="4" disabled>

        <div style="display:flex;gap:8px;">
          <button id="btnGenerarClave" class="primary" style="flex:1" disabled>Generar y registrar contraseña</button>
        </div>
        <div id="reg-msg" style="margin-top:8px"></div>

        <div style="text-align:center;margin-top:8px;">
          <a class="link" href="#" onclick="mostrarPanel('login')">Volver al login</a>
        </div>

        <div style="margin-top:10px" class="small-muted">
          Nota: al generar la contraseña, el sistema intentará registrarla en la hoja 'anunciantes' (columna BG).
        </div>
      </div>
    </div>

    <div id="panel-dashboard" class="panel">
      <div class="top-row" style="margin-bottom:12px">
        <div>
          <h2 style="margin:0 0 4px;font-weight:700">¡Hola <span id="nombre-comercio"></span>!</h2>
          <div class="muted-small">Panel de administración — gestioná tus promos y datos básicos</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <a id="link-support-dashboard" class="link" href="#" target="_blank"><i class="fa-solid fa-headset" style="margin-right:8px"></i>Soporte</a>
          <button id="logout-btn" style="background:var(--danger);color:#fff;border:none;padding:8px 10px;border-radius:10px">Cerrar sesión</button>
        </div>
      </div>

      <div class="tabs" role="tablist" aria-label="Secciones">
        <button id="tab-promos" class="tab active" role="tab" aria-selected="true" data-tab="promos">Promos</button>
        <button id="tab-datos" class="tab" role="tab" aria-selected="false" data-tab="datos">Datos</button>
      </div>

      <div id="tab-panel-datos" style="display:none" class="card">
        <form id="form-datos-comercio">
          <div id="campos-datos-comercio"></div>
          <div style="margin-top:10px">
            <button id="contact-support-data" type="button" class="contact-support">SI NECESITAS HACER CAMBIOS EN TUS DATOS CONTACTA A SOPORTE</button>
          </div>
          <div id="msg-datos-comercio" style="margin-top:8px"></div>
        </form>
      </div>

      <div id="tab-panel-promos" class="card" style="display:block">
        <h3 style="margin-bottom:6px">Promos / Ofertas</h3>
        <div id="promos-status" class="small-muted">Cargando configuración de promos...</div>

        <div style="margin-top:12px;background:#fbfbff;border:1px solid #e6e8ff;padding:12px;border-radius:12px">
          <div class="promos-row-controls">
            <input id="promo-text" class="promo-input" type="text" placeholder="Texto de la promo (ej: 10% OFF)" />
            <select id="promo-categoria" class="promo-select" aria-label="Categoría de la promo">
              <option value="">Categoría (opcional)</option>
            </select>
            <input id="promo-desde" type="date" style="width:140px" />
            <input id="promo-hasta" type="date" style="width:140px" />
            <input id="promo-otros" class="promo-input" type="text" placeholder="Otros (ej: Hasta agotar stock 50 unidades)" style="max-width:300px" />
            <button id="promo-create" class="primary" style="min-width:140px"><i class="fa-solid fa-plus" style="margin-right:8px"></i>Crear promo</button>
            <button id="promo-refresh" class="secondary" style="min-width:120px"><i class="fa-solid fa-rotate" style="margin-right:6px"></i>Refrescar</button>
          </div>
        </div>

        <div id="promos-list" style="margin-top:12px">Cargando promos...</div>
      </div>

      <div style="margin-top:12px" class="muted-small">Debug / Registros</div>
      <div id="debug"></div>
    </div>
  </div>

<script>
/* === CONFIG === */
const WORKER_URL = "https://login.liqkoargentina.workers.dev/login";
const WORKER_ORIGIN = (new URL(WORKER_URL)).origin;
const WORKER_COMMERCE_URL = WORKER_ORIGIN + '/commerce';
const SHEET_ID = "170kTZ-ViCPxPli86g-n_XMuMv1S3O0-DbGwNFGYVnjY";
const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSdZDgpGMYyb5uh1xpsJCN1MzNGoSgGZ9W9EUqQqAYFdB2EyBQ/viewform";
/* ================= */

const SUPPORT_NUMBER = "5492245459957";

const BLOCKED = ["__id","id","planilla_id","planilla id","codigo","nivel","nivel_acceso","verificado","gold","subnivel","nivelacceso"];

let comercios = [];
let categorias = [];
let sesion = null;
const debugEl = document.getElementById('debug');
function debugLog(...args){ console.log(...args); try { debugEl.textContent += args.map(a=>typeof a==='object'?JSON.stringify(a,null,2):String(a)).join(' ') + "\n\n"; debugEl.scrollTop = debugEl.scrollHeight; }catch(e){} }

function mostrarPanel(panel){ ['panel-login','panel-registro','panel-dashboard'].forEach(id=>document.getElementById(id).classList.remove('active')); document.getElementById('panel-'+panel)?.classList.add('active'); }

function openWhatsApp(text){ window.open(`https://wa.me/${SUPPORT_NUMBER}?text=${encodeURIComponent(text)}`,'_blank'); }

function enableReportButton(payloadText){ document.getElementById('report-area').style.display='block'; document.getElementById('reportBtn').onclick = ()=> openWhatsApp(payloadText + "\n\nPor favor revisen. Gracias."); }

/* Tab switching helper */
function switchTab(tabName){
  document.getElementById('tab-promos').classList.toggle('active', tabName === 'promos');
  document.getElementById('tab-datos').classList.toggle('active', tabName === 'datos');
  document.getElementById('tab-panel-promos').style.display = (tabName === 'promos') ? 'block' : 'none';
  document.getElementById('tab-panel-datos').style.display = (tabName === 'datos') ? 'block' : 'none';
}

/* Helpers para niveles */
function parseLevel(levelStr){
  if(levelStr===undefined || levelStr===null) return NaN;
  const s = String(levelStr).trim().replace(',', '.');
  const m = s.match(/^(\d+(\.\d+)?)/);
  return m ? parseFloat(m[1]) : NaN;
}
function isAllowedLevel(levelStr){
  const n = parseLevel(levelStr);
  if(isNaN(n)) return false;
  return n === 1 || n === 2 || n >= 5;
}

/* Cargar lista de comercios (autocompletado) and categories */
function cargarComercios(callback){
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=anunciantes`;
  fetch(url, {cache:'no-store'}).then(r=>r.text()).then(text=>{
    try{
      const start=text.indexOf('{'), end=text.lastIndexOf('}');
      const jsonText=text.slice(start,end+1);
      const json=JSON.parse(jsonText);
      const cols=(json.table && json.table.cols)? json.table.cols.map(c=>(c&&c.label)?String(c.label).toLowerCase().trim():''):[];
      let idxNombre = cols.findIndex(h=>/nombre|comercio|title|titulo/.test(h)); if(idxNombre===-1) idxNombre=1;
      let idxId = cols.findIndex(h=>/id|planilla|planilla_id|codigo/.test(h)); if(idxId===-1) idxId=61;
      let idxNivel = cols.findIndex(h=>/nivel|nivel_acceso|nivelacceso/.test(h));
      comercios=(json.table.rows||[]).map(row=>{
        const nombre = (row.c && row.c[idxNombre] && row.c[idxNombre].v)?row.c[idxNombre].v:'';
        const id = (row.c && row.c[idxId] && row.c[idxId].v)?row.c[idxId].v:'';
        const nivel = (idxNivel!==-1 && row.c && row.c[idxNivel] && row.c[idxNivel].v)?row.c[idxNivel].v:'';
        return { nombre, id, nivel };
      }).filter(c=>c.nombre);
      debugLog('Comercios cargados:', comercios.length);
      cargarCategorias(()=> callback && callback());
    }catch(e){
      debugLog('Error parseando lista de comercios', e);
      cargarCategorias(()=> callback && callback());
    }
  }).catch(err=>{ debugLog('Error fetch lista de comercios', err); cargarCategorias(()=> callback && callback()); });
}

/* cargar categorias desde sheet 'categorias_list' */
function cargarCategorias(callback){
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent('categorias_list')}`;
  fetch(url, {cache:'no-store'}).then(r=>r.text()).then(text=>{
    try{
      const start=text.indexOf('{'), end=text.lastIndexOf('}');
      const jsonText=text.slice(start,end+1);
      const json=JSON.parse(jsonText);
      const idxTitulo = 0;
      const rows = json.table.rows || [];
      categorias = rows.map(r=> {
        const raw = (r.c && r.c[idxTitulo] && r.c[idxTitulo].v) ? r.c[idxTitulo].v : '';
        return (typeof raw === 'string' ? raw.trim() : (raw===null || raw===undefined ? '' : String(raw).trim()));
      })
      .filter(t => t && t.toLowerCase() !== 'titulo');
      categorias = categorias.filter(c => typeof c === 'string' && c.trim().length > 0 && c.toLowerCase() !== 'true');
      categorias = Array.from(new Set(categorias));
      debugLog('Categorias cargadas:', categorias.length, categorias.slice(0,20));
      populateCategoriaSelect();
      callback && callback();
    }catch(e){
      debugLog('Error parseando categorias_list', e);
      categorias = [];
      populateCategoriaSelect();
      callback && callback();
    }
  }).catch(err=>{
    debugLog('Error fetch categorias_list', err);
    categorias = [];
    populateCategoriaSelect();
    callback && callback();
  });
}

/* Fill the promo-categoria select with categories */
function populateCategoriaSelect(){
  const sel = document.getElementById('promo-categoria');
  if(!sel) return;
  sel.innerHTML = '';
  const placeholder = document.createElement('option');
  placeholder.value = '';
  placeholder.textContent = '-- Seleccioná categoría --';
  placeholder.disabled = true;
  placeholder.selected = true;
  sel.appendChild(placeholder);
  categorias.forEach(cat=>{
    if(typeof cat !== 'string') return;
    const v = cat.trim();
    if(!v || v.toLowerCase() === 'true') return;
    const opt = document.createElement('option');
    opt.value = v;
    opt.textContent = v;
    sel.appendChild(opt);
  });
  if(sel.options.length === 1){
    placeholder.textContent = 'Categoría (opcional)';
    placeholder.disabled = false;
  }
}

/* Autocomplete helper */
function showAutocomplete(inputEl, listEl, idEl, modoRegistro=false){
  if(!inputEl||!listEl||!idEl) return;
  inputEl.addEventListener('input', function(){
    const val=this.value.trim().toLowerCase(); listEl.innerHTML='';
    if(modoRegistro) document.getElementById('reg-msg').innerHTML = '';
    document.getElementById('level-warning').textContent = '';
    if(val.length<2){ listEl.classList.add('hidden'); idEl.value=''; document.getElementById('btnLogin')?.setAttribute('disabled','true'); if(modoRegistro) document.getElementById('btnGenerarClave')?.setAttribute('disabled','true'); return; }
    const matches = comercios.filter(c=>c.nombre.toLowerCase().includes(val));
    if(matches.length){
      matches.slice(0,20).forEach(c=>{
        const item=document.createElement('div'); item.className='autocomplete-item';
        let lvlLabel = c.nivel ? ` — nivel ${c.nivel}` : '';
        item.textContent=c.nombre + (c.id?(' ('+c.id+')'):'' ) + lvlLabel;
        item.onclick=function(){
          inputEl.value=c.nombre; idEl.value=c.id||''; inputEl.dataset.nivel = c.nivel || '';
          listEl.classList.add('hidden');
          const allowed = isAllowedLevel(c.nivel);
          const lvlWarningEl = document.getElementById('level-warning');
          if(allowed){
            document.getElementById('btnLogin')?.removeAttribute('disabled');
            if(lvlWarningEl) lvlWarningEl.innerHTML = `<span class="success">Anunciante nivel ${c.nivel} — permitido crear cuenta / iniciar sesión.</span>`;
          } else {
            document.getElementById('btnLogin')?.setAttribute('disabled','true');
            if(lvlWarningEl){
              if(c.nivel) lvlWarningEl.innerHTML = `<span class="error">Anunciante nivel ${c.nivel} — NO puede crear cuenta ni iniciar sesión desde aquí. Para otras consultas contactá soporte.</span>`;
              else lvlWarningEl.innerHTML = `<span class="error">No hay información de nivel para este anunciante — no es posible crear cuenta desde aquí. Si tu comercio no está en la guía, completá el formulario.</span>`;
            }
          }
          if(modoRegistro){
            const pwdInput = document.getElementById('nueva-clave');
            const pwdConfirm = document.getElementById('nueva-clave-confirm');
            if(allowed){
              document.getElementById('btnGenerarClave')?.removeAttribute('disabled');
              pwdInput.removeAttribute('disabled');
              pwdConfirm.removeAttribute('disabled');
            } else {
              document.getElementById('btnGenerarClave')?.setAttribute('disabled','true');
              pwdInput.setAttribute('disabled','true');
              pwdConfirm.setAttribute('disabled','true');
            }
          }
        };
        listEl.appendChild(item);
      });
      listEl.classList.remove('hidden');
    } else {
      const item=document.createElement('div'); item.style.padding='10px'; item.style.background='#fffbe5';
      item.innerHTML = `<b>¿Tu comercio no está publicado?</b><br>
                        <div class="small-muted">Si no aparece en la guía, debés solicitar la creación del comercio (anuncio) mediante el formulario. Crear comercio es distinto de generar la contraseña de acceso.</div>
                        <button id="btnRegistrarComercio" style="margin-top:8px;width:100%;">Solicitar creación de comercio</button>
                        <div class="small-warning" style="margin-top:8px;">Recordá: las cuentas de acceso solo se generan para anunciantes con nivel 1, 2 o 5 y superiores. Para cambios de nivel o productos comerciales contactá soporte.</div>`;
      listEl.appendChild(item);
      setTimeout(()=>{ const btn=document.getElementById('btnRegistrarComercio'); if(btn) btn.onclick=()=> window.open(FORM_URL,'_blank'); },50);
      listEl.classList.remove('hidden');
    }
  });
  inputEl.addEventListener('blur', ()=> setTimeout(()=>listEl.classList.add('hidden'),180));
  inputEl.addEventListener('change', function(){ if(this.value===''){ idEl.value=''; document.getElementById('btnLogin')?.setAttribute('disabled','true'); if(modoRegistro) document.getElementById('btnGenerarClave')?.setAttribute('disabled','true'); } });
}

/* Eventos y login */
let originalLoginBtnText = null;
document.addEventListener('DOMContentLoaded', ()=>{
  try {
    showAutocomplete(document.getElementById('comercio-buscar'), document.getElementById('autocomplete-list'), document.getElementById('comercio-id'));
    showAutocomplete(document.getElementById('comercio-buscar2'), document.getElementById('autocomplete-list2'), document.getElementById('comercio-id2'), true);
  } catch(e){
    console.error('Autocomplete attach immediate error', e);
  }

  cargarComercios(()=>{
    try {
      populateCategoriaSelect();
      showAutocomplete(document.getElementById('comercio-buscar'), document.getElementById('autocomplete-list'), document.getElementById('comercio-id'));
      showAutocomplete(document.getElementById('comercio-buscar2'), document.getElementById('autocomplete-list2'), document.getElementById('comercio-id2'), true);
      debugLog('cargarComercios callback finished, comercios:', comercios.length, 'categorias:', categorias.length);
    } catch(e){
      console.error('Error in cargarComercios callback:', e);
    }
  });

  const btnLogin = document.getElementById('btnLogin');
  if(btnLogin) originalLoginBtnText = btnLogin.textContent || 'Ingresar';

  document.getElementById('login-form').onsubmit = async function(e){
    e.preventDefault(); document.getElementById('report-area').style.display='none';
    const nombre = document.getElementById('comercio-buscar').value.trim();
    const clave = document.getElementById('clave').value.trim();
    const id = document.getElementById('comercio-id').value.trim();
    const nivelSeleccion = document.getElementById('comercio-buscar')?.dataset?.nivel || '';
    if(!id && !nombre){ document.getElementById('login-msg').innerHTML = "<span class='error'>Elegí un comercio de la lista.</span>"; return; }
    if(id && !isAllowedLevel(nivelSeleccion)){
      document.getElementById('login-msg').innerHTML = "<span class='error'>No está permitido iniciar sesión para este anunciante (nivel no autorizado).</span>";
      return;
    }

    if(btnLogin){
      btnLogin.setAttribute('disabled','true');
      btnLogin.textContent = 'Ingresando...';
    }
    document.getElementById('login-msg').innerHTML = "<span>Ingresando...</span>";
    const payload = { accion:'login', comercio_id:id||'', nombre:nombre, password:clave };
    try{
      const r = await fetch(WORKER_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload), mode:'cors' });
      const text = await r.text();
      let res;
      try{ res = JSON.parse(text); }catch(e){ res = { success:false, message: text }; }
      debugLog('Login worker ->', r.status, res);
      if(r.status===200 && res.success){
        if(btnLogin){
          btnLogin.textContent = 'Cargando datos...';
          btnLogin.setAttribute('disabled','true');
        }
        localStorage.setItem('comercio_id', res.id || id);
        localStorage.setItem('comercio_nombre', res.nombre || nombre);
        if(res.planilla_id) localStorage.setItem('planilla_id', res.planilla_id);
        sesion = { id: res.id || id, nombre: res.nombre || nombre, planilla_id: res.planilla_id || '' };
        document.getElementById('login-msg').innerHTML = "<span class='success'>"+(res.message||'Ingresado')+"</span>";
        setTimeout(()=> mostrarPanelDashboard(),500);
        return;
      }

      if(btnLogin){
        btnLogin.removeAttribute('disabled');
        btnLogin.textContent = originalLoginBtnText;
      }
      document.getElementById('login-msg').innerHTML = "<span class='error'>"+(res.message||'Login falló')+"</span>";
      enableReportButton(`Intento login\nPayload: ${JSON.stringify(payload)}\nWorker status: ${r.status}\nWorker body: ${JSON.stringify(res)}`);
    }catch(err){
      debugLog('Error fetch worker', err);
      if(btnLogin){
        btnLogin.removeAttribute('disabled');
        btnLogin.textContent = originalLoginBtnText;
      }
      document.getElementById('login-msg').innerHTML = "<span class='error'>Error de conexión.</span>";
      enableReportButton(`Error fetch worker: ${err}`);
    }
  };

  document.getElementById('btnCrearComercio').addEventListener('click', ()=> window.open(FORM_URL,'_blank'));

  const pwdInput = document.getElementById('nueva-clave');
  const pwdConfirm = document.getElementById('nueva-clave-confirm');
  const btnGenerar = document.getElementById('btnGenerarClave');

  function updatePwdButtonState(){
    const id = document.getElementById('comercio-id2').value.trim();
    const nivel = document.getElementById('comercio-buscar2')?.dataset?.nivel || '';
    const pwd = pwdInput.value || '';
    const pwdc = pwdConfirm.value || '';
    if(!id) { btnGenerar.setAttribute('disabled','true'); return; }
    if(!isAllowedLevel(nivel)) { btnGenerar.setAttribute('disabled','true'); return; }
    if(pwd.length < 4) { btnGenerar.setAttribute('disabled','true'); return; }
    if(pwd !== pwdc) { btnGenerar.setAttribute('disabled','true'); return; }
    btnGenerar.removeAttribute('disabled');
  }

  pwdInput?.addEventListener('input', updatePwdButtonState);
  pwdConfirm?.addEventListener('input', updatePwdButtonState);

  btnGenerar.addEventListener('click', async ()=>{
    const nombre = document.getElementById('comercio-buscar2').value.trim();
    const id = document.getElementById('comercio-id2').value.trim();
    const nivel = document.getElementById('comercio-buscar2')?.dataset?.nivel || '';
    const pwd = pwdInput.value || '';

    if(!id || !nombre){ document.getElementById('reg-msg').innerHTML = "<span class='error'>Buscá tu comercio o completá el formulario de creación si no está publicado.</span>"; return; }
    if(!isAllowedLevel(nivel)){ document.getElementById('reg-msg').innerHTML = "<span class='error'>No está permitido generar la clave para este anunciante (nivel no autorizado). Contactá soporte para otras consultas.</span>"; return; }
    if(pwd.length < 4){ document.getElementById('reg-msg').innerHTML = "<span class='error'>La contraseña debe tener al menos 4 caracteres.</span>"; return; }

    btnGenerar.setAttribute('disabled','true');
    pwdInput.setAttribute('disabled','true');
    pwdConfirm.setAttribute('disabled','true');
    document.getElementById('reg-msg').innerHTML = "<span>Registrando contraseña...</span>";

    const saveUrl = `${WORKER_ORIGIN}/commerce?id=${encodeURIComponent(id)}&planilla_id=${encodeURIComponent('')}`;
    const body = { accion: 'set_clave', __id: id, nombre: nombre, clave: pwd };

    try{
      const r = await fetch(saveUrl, { method:'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body), mode:'cors' });
      const resText = await r.text();
      let res;
      try{ res = JSON.parse(resText); } catch(e){ res = { success: (r.status===200), message: resText }; }
      debugLog('Set clave ->', r.status, res);

      const ok = (r.status === 200) && (res && (res.success === true || res.aprobado === true || res.ok === true));
      if(ok){
        document.getElementById('reg-msg').innerHTML = "<span class='success'>Contraseña registrada correctamente en la hoja. Podés usarla para iniciar sesión.</span>";
        pwdInput.value = '';
        pwdConfirm.value = '';
        setTimeout(()=> mostrarPanel('login'), 1200);
        return;
      } else {
        document.getElementById('reg-msg').innerHTML = "<span class='error'>No se pudo registrar la contraseña. "+(res && res.message?res.message:'')+"</span>";
      }
    }catch(err){
      debugLog('Error registrando clave', err);
      document.getElementById('reg-msg').innerHTML = "<span class='error'>Error de conexión al registrar la contraseña. Enviando mensaje a soporte...</span>";
      const manualMsg = `Solicitud registro de clave (manual)\nComercio: ${nombre}\nId: ${id}\nNivel: ${nivel || '(sin info)'}\nContraseña solicitada por el anunciante: ${pwd}\nPor favor anotar en la hoja 'anunciantes' en la columna BG (encabezado 'clave').`;
      openWhatsApp(manualMsg);
    } finally {
      btnGenerar.removeAttribute('disabled');
      pwdInput.removeAttribute('disabled');
      pwdConfirm.removeAttribute('disabled');
      updatePwdButtonState();
    }
  });

  document.getElementById('btnSolicitarAlta')?.addEventListener('click', ()=> window.open(FORM_URL,'_blank'));
  document.getElementById('reportBtn')?.addEventListener('click', ()=> openWhatsApp('Necesito asistencia.'));

  document.getElementById('logout-btn').addEventListener('click', ()=> {
    localStorage.removeItem('comercio_id'); localStorage.removeItem('comercio_nombre'); localStorage.removeItem('planilla_id'); sesion=null;
    const btn = document.getElementById('btnLogin');
    if(btn){
      btn.removeAttribute('disabled');
      btn.textContent = originalLoginBtnText;
    }
    mostrarPanel('login');
  });

  // Tabs handlers
  document.getElementById('tab-promos').addEventListener('click', ()=> switchTab('promos'));
  document.getElementById('tab-datos').addEventListener('click', ()=> switchTab('datos'));

  // Contact support button in Datos
  document.getElementById('contact-support-data')?.addEventListener('click', ()=>{
    if(!sesion) { openWhatsApp('Necesito asistencia para actualizar datos de anunciante.'); return; }
    const msg = `Solicito modificación de datos\nComercio: ${sesion.nombre}\nId: ${sesion.id}\nPor favor, indicar los cambios a realizar.`;
    openWhatsApp(msg);
  });

  if(localStorage.getItem('comercio_id') && localStorage.getItem('comercio_nombre')){ sesion = { id: localStorage.getItem('comercio_id'), nombre: localStorage.getItem('comercio_nombre'), planilla_id: localStorage.getItem('planilla_id')||'' }; mostrarPanelDashboard(); }
});

/* Dashboard: pedir datos al Worker -> Apps Script */
async function mostrarPanelDashboard(){
  if(!sesion || !sesion.id){ mostrarPanel('login'); return; }
  document.getElementById('nombre-comercio').textContent = sesion.nombre;
  debugLog('Pidiendo datos para id:', sesion.id);
  const url = `${WORKER_ORIGIN}/commerce?id=${encodeURIComponent(sesion.id)}&nombre=${encodeURIComponent(sesion.nombre)}&planilla_id=${encodeURIComponent(sesion.planilla_id||'')}`;
  try{
    const r = await fetch(url, { method:'GET', mode:'cors' });
    const datos = await r.json().catch(()=>({ error:'Respuesta inválida'}));
    debugLog('/commerce ->', datos);
    if(datos.error){ document.getElementById('campos-datos-comercio').innerHTML = `<b>Error:</b> ${datos.error}`; switchTab('promos'); return; }
    if(datos.planilla_id && datos.planilla_id !== sesion.planilla_id){ sesion.planilla_id = datos.planilla_id; localStorage.setItem('planilla_id', datos.planilla_id); }

    // Reduced fields: OMIT 'nombre' (already shown in header) and only up to 'descripcion'
    const campos = ["nivel","subnivel","segmento","categoria","tags","adicionales","pie","descripcion"];
    let html = '';
    campos.forEach(c=> html += `<div><label>${c}</label><input type="text" name="${c}" value="${datos[c]||''}" /></div>`);
    html += `<input type="hidden" name="__id" value="${sesion.id}"/>`;
    document.getElementById('campos-datos-comercio').innerHTML = html;
    document.getElementById('link-support-dashboard').href = `https://wa.me/${SUPPORT_NUMBER}?text=${encodeURIComponent('Solicito modificación de datos\\nComercio: ' + sesion.nombre + '\\nId: ' + sesion.id)}`;
    // show promotions tab by default
    switchTab('promos');

    const btn = document.getElementById('btnLogin');
    if(btn){
      btn.removeAttribute('disabled');
      btn.textContent = originalLoginBtnText;
    }

    // After dashboard data is loaded, trigger promos load
    setTimeout(()=>{ try{ if(document.getElementById('promos-list')) loadPromosUI(); }catch(e){} }, 300);
  }catch(err){
    debugLog('Error al consultar /commerce', err);
    document.getElementById('campos-datos-comercio').innerHTML = `<b>Error conexión con Worker.</b>`;
    switchTab('promos');
  }
}

/* ------------------ Promos: Listar / Crear / Editar / Borrar ------------------ */
async function promos_post(pathOrUrl, payload){
  const body = Object.assign({}, payload || {});
  if(body.accion && !body.action){ body.action = body.accion; delete body.accion; }
  if(!body.advertiserId){
    if(typeof sesion !== 'undefined' && sesion && sesion.id) body.advertiserId = String(sesion.id);
    else if(window.sesion && window.sesion.id) body.advertiserId = String(window.sesion.id);
  }
  const url = (typeof pathOrUrl === 'string' && pathOrUrl.startsWith('http')) ? pathOrUrl : WORKER_COMMERCE_URL;
  try { debugLog('promos_post -> URL:', url, 'payload keys:', Object.keys(body)); } catch(e){}
  try {
    const r = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      mode: 'cors',
      body: JSON.stringify(body)
    });
    const text = await r.text();
    let json;
    try { json = text ? JSON.parse(text) : null; } catch(e){ json = { rawText: text }; }
    try { debugLog('promos_post response ->', { status: r.status, body: json }); } catch(e){}
    return { status: r.status, json: json };
  } catch(err){
    debugLog('promos_post fetch error ->', String(err));
    return { status: 0, json: { error: String(err) } };
  }
}

async function loadPromosUI(){
  const st = document.getElementById('promos-status');
  const list = document.getElementById('promos-list');
  if(!sesion || !sesion.id){ st.textContent = 'No logueado: inicia sesión para gestionar promos.'; list.innerHTML = ''; return; }
  st.textContent = 'Cargando promos...';
  list.innerHTML = 'Cargando promos...';
  const res = await promos_post(WORKER_COMMERCE_URL, { action: 'getPromos', advertiserId: String(sesion.id || '') });
  if(res.status !== 200){ st.textContent = 'Error cargando promos: ' + (res.json && (res.json.error || res.json.message) ? (res.json.error || res.json.message) : res.status); list.innerHTML=''; return; }
  const data = res.json || {};
  const promos = data.promos || data.rows || [];
  renderPromosList(promos);
  st.textContent = 'Promos cargadas: ' + promos.length;
}

function renderPromosList(promos){
  const list = document.getElementById('promos-list');
  if(!promos || promos.length === 0){ list.innerHTML = '<div class="small-muted">No hay promos registradas.</div>'; return; }
  let html = '<table><thead><tr><th>Promo</th><th>Categoria</th><th>Desde</th><th>Hasta</th><th>promo_id</th><th>otros</th><th>Acciones</th></tr></thead><tbody>';
  for(const p of promos){
    const promo = htmlEscape(p.promo || '');
    const categoria = htmlEscape(p.categoria || '');
    const desde = htmlEscape(p.desde || '');
    const hasta = htmlEscape(p.hasta || '');
    const pid = htmlEscape(p.promo_id || '');
    const otros = htmlEscape(p.otros || '');
    html += `<tr>
      <td>${promo}</td>
      <td>${categoria}</td>
      <td>${desde}</td>
      <td>${hasta}</td>
      <td style="font-size:0.9em;color:#555">${pid}</td>
      <td>${otros}</td>
      <td>
        <button class="action-btn" data-action="edit" data-pid="${pid}" title="Editar"><i class="fa-solid fa-pen-to-square"></i></button>
        <button class="action-btn" data-action="delete" data-pid="${pid}" title="Borrar"><i class="fa-solid fa-trash" style="color:#e14"></i></button>
      </td>
    </tr>`;
  }
  html += '</tbody></table>';
  list.innerHTML = html;

  list.querySelectorAll('button').forEach(b=>{
    b.addEventListener('click', async (ev)=>{
      const action = b.getAttribute('data-action');
      const pid = b.getAttribute('data-pid');
      if(action === 'delete'){
        if(!confirm('Confirmar borrar promo?')) return;
        const r = await promos_post(WORKER_COMMERCE_URL, { action: 'deletePromo', payload: { promo_id: pid } });
        if(r.status === 200 && r.json && r.json.success){ alert('Promo borrada'); loadPromosUI(); } else { alert('Error borrando: ' + JSON.stringify(r.json)); }
      } else if(action === 'edit'){
        const newText = prompt('Editar texto de promo:', '');
        if(newText === null) return;
        const newDesde = prompt('Desde (YYYY-MM-DD):','');
        const newHasta = prompt('Hasta (YYYY-MM-DD):','');
        const newOtros = prompt('Otros (nota opcional):','');
        const payload = { promo_id: pid };
        if(newText) payload.promo = newText;
        if(newDesde) payload.desde = newDesde;
        if(newHasta) payload.hasta = newHasta;
        if(newOtros) payload.otros = newOtros;
        const r = await promos_post(WORKER_COMMERCE_URL, { action: 'updatePromo', payload: payload });
        if(r.status === 200 && r.json && r.json.success){ alert('Promo actualizada'); loadPromosUI(); } else { alert('Error actualizando: ' + JSON.stringify(r.json)); }
      }
    });
  });
}

function htmlEscape(s){ return String(s||'').replace(/[&<>"']/g, function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; }); }

document.addEventListener('click', function(e){
  if(!e.target) return;

  if(e.target.id === 'promo-create'){
    (async ()=>{
      if(!sesion || !sesion.id){ alert('No logueado.'); return; }
      const promo = document.getElementById('promo-text').value.trim();
      const categoria = document.getElementById('promo-categoria').value || '';
      const desde = document.getElementById('promo-desde').value;
      const hasta = document.getElementById('promo-hasta').value;
      const otros = document.getElementById('promo-otros').value.trim();
      if(!promo){ alert('Ingresá texto de promo'); return; }

      const sel = document.getElementById('promo-categoria');
      if(sel && sel.hasAttribute('required') && !categoria){
        alert('Seleccioná una categoría obligatoria para la promo.');
        return;
      }

      const statusEl = document.getElementById('promos-status');
      statusEl.textContent = 'Creando promo...';
      const btn = e.target;
      btn.setAttribute('disabled','true');
      const spinner = document.createElement('span'); spinner.className='spinner'; btn.appendChild(spinner);

      const payload = {
        action: 'createPromo',
        payload: { promo: promo, categoria: categoria, desde: desde || '', hasta: hasta || '', otros: otros || '' },
        advertiserId: String(sesion.id || '')
      };

      debugLog('Creating promo - request payload:', payload);

      try {
        const r = await promos_post(WORKER_COMMERCE_URL, payload);
        debugLog('CreatePromo via promos_post ->', r);

        if(r.status === 200 && r.json && (r.json.success === true || r.json.created === true)){
          statusEl.textContent = 'Promo creada correctamente.';
          document.getElementById('promo-text').value = '';
          document.getElementById('promo-categoria').value = '';
          document.getElementById('promo-desde').value = '';
          document.getElementById('promo-hasta').value = '';
          document.getElementById('promo-otros').value = '';
          await loadPromosUI();
        } else {
          const errMsg = `Error creando promo. HTTP ${r.status} - ${JSON.stringify(r.json)}`;
          statusEl.textContent = errMsg;
          debugLog(errMsg);
          if(r.json && r.json.message) alert('Error: ' + r.json.message);
        }
      } catch(err){
        const errText = 'Error de conexión al crear promo: ' + String(err);
        document.getElementById('promos-status').textContent = errText;
        debugLog(errText, err);
        alert('Error de conexión. Revisa la consola para más detalles.');
      } finally {
        try { btn.removeChild(spinner); } catch(e){}
        btn.removeAttribute('disabled');
      }
    })();
    return;
  }

  if(e.target.id === 'promo-refresh'){
    loadPromosUI();
    return;
  }
});

/* Ensure categories loaded after window load */
(function initCategoriesOnLoad(){
  if(window.addEventListener) {
    window.addEventListener('load', () => {
      setTimeout(()=> populateCategoriaSelect(), 500);
    });
  }
})();
</script>
</body>
</html>
