<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Depuración Eventos por Organizador</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f3f6fb; padding: 20px;}
    .error { color: #b02a2a; font-weight:bold; }
    .ok { color: #29853b; }
    .evento { background:#fff; border-radius:12px; margin-bottom:20px; padding:20px; box-shadow:0 2px 8px #0001;}
    .clave {color:#555; font-weight:bold;}
  </style>
</head>
<body>
  <h1>Depuración Eventos de ORGANIZADOR</h1>
  <div id="result">Cargando...</div>
  <script>
    const ORGANIZADOR = "Municipalidad de Dolores";
    const URL = "https://docs.google.com/spreadsheets/d/17H2xueOlfBdsWDLspy8PWRMRFqbuEpQhA0VkUjSczxc/gviz/tq?tqx=out:json&sheet=eventos_grl";
    function esAprobado(valor) {
      if (valor === true) return true;
      if (!valor) return false;
      valor = valor.toString().trim().toLowerCase();
      return ["si", "sí", "✓", "✔", "✅", "x", "ok", "true"].some(v => valor === v);
    }
    function safe(c, idx) { return c[idx] && c[idx].v ? c[idx].v : ""; }
    fetch(URL)
      .then(r=>r.text())
      .then(text=>{
        let json;
        try {
          json = JSON.parse(text.substr(47).slice(0,-2));
        } catch(e) {
          document.getElementById('result').innerHTML = "<div class='error'>ERROR DE PARSEO JSON<br><pre style='font-size:12px;background:#eee;padding:10px;overflow:auto;'>" + text + "</pre></div>";
          return;
        }
        if(!json || !json.table || !json.table.rows) {
          document.getElementById('result').innerHTML = "<div class='error'>Estructura JSON inesperada</div>";
          return;
        }
        let rows = json.table.rows;
        let encontrados = [];
        for(let i=0;i<rows.length;i++) {
          let c = rows[i].c || [];
          let verificado = safe(c,0);
          if (!esAprobado(verificado)) continue;
          let organizadores = [safe(c,10),safe(c,12),safe(c,14),safe(c,16)].join(" ").toLowerCase();
          if (!organizadores.includes(ORGANIZADOR.toLowerCase())) continue;
          encontrados.push({ fila: i+1, datos: c.map(col=>col?col.v:"") });
        }
        if(encontrados.length===0){
          document.getElementById('result').innerHTML = "<div class='error'>NO ENCONTRADO NINGÚN EVENTO VERIFICADO DEL ORGANIZADOR '"+ORGANIZADOR+"'.<br>Prueba con otro nombre exacto, verifica que esté en K/M/O/Q, y que la hoja esté publicada para la web.</div>";
        } else {
          let html = "<div class='ok'>ENCONTRADOS "+encontrados.length+" REGISTROS para '"+ORGANIZADOR+"'</div>";
          encontrados.forEach(ev=>{
            html += "<div class='evento'><div class='clave'>Fila en hoja: "+ev.fila+"</div>";
            ev.datos.forEach((val,ix)=>{html+="<div><span class='clave'>Col "+String.fromCharCode(65+ix)+":</span> "+val+"</div>";});
            html+="</div>";
          });
          document.getElementById('result').innerHTML = html;
        }
      })
      .catch(err=>{
        document.getElementById('result').innerHTML = "<div class='error'>ERROR DE CONEXIÓN/CARGA: "+err+"</div>";
      });
  </script>
</body>
</html>
