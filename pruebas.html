<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Panel Comercios - Login & Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --muted:#6b7280;
      --primary:#3dc879;
      --danger:#e74c3c;
      --accent:#3498db;
      --radius:10px;
      --shadow: 0 2px 14px rgba(12,24,40,0.06);
      --text:#0f1724;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace;
    }
    *{box-sizing:border-box}
    body{font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:var(--bg); margin:0; color:var(--text); -webkit-font-smoothing:antialiased}
    .container{max-width:980px;margin:20px auto;background:var(--card);border-radius:12px;box-shadow:var(--shadow);padding:20px}
    h2{margin:0 0 8px;font-weight:600}
    label{display:block;margin:12px 0 6px;font-weight:600;color:var(--muted);font-size:0.95rem}
    input,button,textarea,select{width:100%;padding:10px;margin-bottom:10px;border-radius:8px;border:1px solid #e6e9ee;box-sizing:border-box;font-size:0.95rem}
    input:focus, select:focus, textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(52,152,219,0.06)}
    .autocomplete-list{position:absolute;background:#fff;border:1px solid #ddd;z-index:10;max-height:220px;overflow-y:auto;width:93%}
    .autocomplete-item{padding:8px;cursor:pointer}
    .autocomplete-item:hover{background:#eef8ff}
    .hidden{display:none}
    .success{color:#0a8a3b;font-weight:600}
    .error{color:#c53030}
    .link{color:var(--accent);cursor:pointer;text-decoration:underline;display:inline-block;margin-top:8px}
    .panel{display:none}
    .panel.active{display:block}

    /* Header small area */
    .top-actions{display:flex;gap:12px;align-items:center;justify-content:space-between}
    .small-muted{font-size:0.95em;color:var(--muted)}
    .info-banner{background:#fffbe5;border:1px solid #f5c26b;padding:10px;border-radius:8px;margin-top:8px}

    /* Tabs */
    .tabs { display:flex; gap:8px; margin:12px 0 16px; align-items:center; flex-wrap:wrap; }
    .tab { padding:8px 14px; border-radius:999px; background:transparent; border:1px solid transparent; cursor:pointer; color:var(--muted); font-weight:600 }
    .tab.active { background:var(--primary); color:#fff; border-color: rgba(0,0,0,0.04); box-shadow: 0 4px 10px rgba(61,200,121,0.12) }
    .tab:focus { outline:none; box-shadow:0 0 0 3px rgba(61,200,121,0.08) }

    /* Layout dashboard */
    .grid-2 { display:grid; grid-template-columns: 1fr 320px; gap:18px; }
    @media (max-width:900px){ .grid-2 { grid-template-columns: 1fr; } }

    /* Card style */
    .card { background:var(--card); padding:14px; border-radius:10px; box-shadow: 0 1px 6px rgba(12,24,40,0.03); border:1px solid #f1f4f8; }

    /* Promos: responsive table -> cards on small */
    table{width:100%;border-collapse:collapse;margin-top:6px}
    th,td{padding:10px;border-bottom:1px solid #f1f4f8;text-align:left;font-size:0.95rem}
    tr:hover{background:#fbfdff}
    @media (max-width:700px){
      table, thead, tbody, th, td, tr { display:block; }
      thead { display:none; }
      tr { margin-bottom:12px; border-radius:8px; box-shadow:var(--shadow); padding:10px; background:#fff }
      td { border:none; padding:6px 0; }
      td.label { font-weight:700; color:var(--muted); width:120px; display:inline-block }
    }

    /* Buttons */
    button.primary{background:var(--primary);color:#fff;border:0;padding:10px 12px;border-radius:8px;cursor:pointer}
    button.secondary{background:#f5f7fa;color:var(--muted);border:0;padding:8px 10px;border-radius:8px;cursor:pointer}
    button.danger{background:var(--danger);color:#fff;border:0;padding:12px;border-radius:8px;cursor:pointer;font-weight:700}

    /* Contact support red button (full width) */
    .contact-support { background:var(--danger); color:#fff; border:0; padding:12px; border-radius:8px; font-weight:700; text-align:center; cursor:pointer; display:block; width:100%;}
    .contact-support.small { padding:8px; font-size:0.95rem }

    /* Debug */
    #debug{background:#0b1220;color:#bff;padding:8px;border-radius:8px;max-height:160px;overflow:auto;font-size:12px;margin-top:8px;white-space:pre-wrap;font-family:var(--mono)}
  </style>
</head>
<body>
  <div class="container">
    <div id="panel-login" class="panel active">
      <h2>Ingresar a tu comercio</h2>
      <form id="login-form" autocomplete="off" class="card">
        <label>Comercio</label>
        <div style="position:relative;">
          <input type="text" id="comercio-buscar" placeholder="Buscá tu comercio..." autocomplete="off" required>
          <div id="autocomplete-list" class="autocomplete-list hidden"></div>
        </div>
        <input type="hidden" id="comercio-id">
        <label>Clave</label>
        <input type="password" id="clave" placeholder="Clave..." required minlength="1">
        <div style="display:flex;gap:8px;">
          <button id="btnLogin" class="primary" disabled>Ingresar</button>
        </div>

        <div id="login-msg"></div>
        <div id="level-warning" class="small-muted"></div>

        <div id="create-commerce-banner" class="info-banner">
          <strong>¿Tu anuncio no aparece en la guía?</strong>
          <div class="small-muted">Si tu comercio, servicio u organización no figura en la guía, completá el formulario para solicitar la creación del anuncio.</div>
          <button id="btnCrearComercio" style="margin-top:8px;width:100%;">Solicitar creación de anuncio (formulario)</button>
        </div>
      </form>

      <div style="text-align:center;margin-top:12px;">
        <span class="link" onclick="mostrarPanel('registro')">¿Necesitás generar tu contraseña? Ir a Generar contraseña</span>
      </div>
    </div>

    <div id="panel-registro" class="panel">
      <h2>Generar contraseña / Registrar acceso</h2>
      <div class="card">
        <p class="small-muted">Generá la contraseña directamente para un anunciante ya publicado en la guía.</p>
        <label>Buscar anuncio (seleccioná el anuncio ya publicado)</label>
        <div style="position:relative;">
          <input type="text" id="comercio-buscar2" placeholder="Buscá tu comercio..." autocomplete="off">
          <div id="autocomplete-list2" class="autocomplete-list hidden"></div>
        </div>
        <input type="hidden" id="comercio-id2">

        <label>Contraseña</label>
        <input type="password" id="nueva-clave" placeholder="Ingresá la nueva contraseña (mínimo 4 caracteres)" minlength="4" disabled>
        <label>Confirmar contraseña</label>
        <input type="password" id="nueva-clave-confirm" placeholder="Repetí la contraseña" minlength="4" disabled>

        <div style="display:flex;gap:8px;">
          <button id="btnGenerarClave" class="primary" style="flex:1" disabled>Generar y registrar contraseña</button>
        </div>
        <div id="reg-msg"></div>
        <div style="text-align:center;margin-top:8px;">
          <span class="link" onclick="mostrarPanel('login')">Volver al login</span>
        </div>
      </div>
    </div>

    <div id="panel-dashboard" class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
        <div>
          <h2>¡Hola <span id="nombre-comercio"></span>!</h2>
          <div class="small-muted">Panel de administración - accedé a tus promos y ver datos básicos</div>
        </div>
        <div style="text-align:right">
          <button id="logout-btn" class="secondary">Cerrar sesión</button>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs" role="tablist" aria-label="Secciones">
        <button id="tab-promos" class="tab active" role="tab" aria-selected="true" data-tab="promos">Promos</button>
        <button id="tab-datos" class="tab" role="tab" aria-selected="false" data-tab="datos">Datos</button>
      </div>

      <div class="card">
        <div id="tab-panel-datos" class="tab-panel" style="display:none;">
          <h3>Datos del comercio</h3>
          <form id="form-datos-comercio" autocomplete="off">
            <div id="campos-datos-comercio"></div>

            <!-- Reemplazamos el botón guardar por botón de contacto a soporte -->
            <div style="margin-top:8px">
              <button id="contact-support-data" type="button" class="contact-support">SI NECESITAS HACER CAMBIOS EN TUS DATOS CONTACTA A SOPORTE</button>
            </div>
            <div id="msg-datos-comercio" style="margin-top:8px"></div>
          </form>
        </div>

        <div id="tab-panel-promos" class="tab-panel" style="display:block;">
          <h3>Promos / Ofertas</h3>
          <div id="promos-status" class="small-muted">Cargando configuración de promos...</div>

          <div style="margin-top:8px;background:#fbfbff;border:1px solid #e6e8ff;padding:10px;border-radius:8px" class="card">
            <div class="promos-row-controls" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
              <input id="promo-text" class="promo-input" type="text" placeholder="Texto de la promo (ej: 10% OFF)" style="flex:1;min-width:160px" />
              <select id="promo-categoria" class="promo-select" aria-label="Categoría de la promo" required style="min-width:200px">
                <option value="" disabled selected>-- Seleccioná categoría --</option>
              </select>
              <input id="promo-desde" type="date" style="width:140px" />
              <input id="promo-hasta" type="date" style="width:140px" />
              <input id="promo-otros" class="promo-input" type="text" placeholder="Otros (ej: Hasta agotar stock)" style="max-width:300px" />
              <button id="promo-create" class="primary" style="min-width:140px">Crear promo</button>
              <button id="promo-refresh" class="secondary" style="min-width:120px">Refrescar lista</button>
            </div>
          </div>

          <div id="promos-list" style="margin-top:12px">Cargando promos...</div>
        </div>
      </div>

    </div>

    <h3 style="margin-top:18px">Debug / Registros</h3>
    <div id="debug"></div>
  </div>

<script>
/* === CONFIG === */
const WORKER_URL = "https://login.liqkoargentina.workers.dev/login";
const WORKER_ORIGIN = (new URL(WORKER_URL)).origin;
const WORKER_COMMERCE_URL = WORKER_ORIGIN + '/commerce';
const SHEET_ID = "1ffyftdylRAiS97L2Fy6xhPT3A876qeXXCaPI3SUFI-s";
const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSdZDgpGMYyb5uh1xpsJCN1MzNGoSgGZ9W9EUqQqAYFdB2EyBQ/viewform";
/* ================= */

const SUPPORT_NUMBER = "5492245459957";

const BLOCKED = ["__id","id","planilla_id","planilla id","codigo","nivel","nivel_acceso","verificado","gold","subnivel","nivelacceso"];

let comercios = [];
let categorias = [];
let sesion = null;
const debugEl = document.getElementById('debug');
function debugLog(...args){ console.log(...args); try { debugEl.textContent += args.map(a=>typeof a==='object'?JSON.stringify(a,null,2):String(a)).join(' ') + "\n\n"; debugEl.scrollTop = debugEl.scrollHeight; }catch(e){} }

function mostrarPanel(panel){ ['panel-login','panel-registro','panel-dashboard'].forEach(id=>document.getElementById(id).classList.remove('active')); document.getElementById('panel-'+panel)?.classList.add('active'); }

function openWhatsApp(text){ window.open(`https://wa.me/${SUPPORT_NUMBER}?text=${encodeURIComponent(text)}`,'_blank'); }

/* Helpers para tabs */
function switchDashboardTab(tabName){
  // tabName: 'promos' or 'datos'
  document.querySelectorAll('.tab').forEach(b=> {
    const t = b.dataset.tab;
    if(t===tabName) { b.classList.add('active'); b.setAttribute('aria-selected','true'); }
    else { b.classList.remove('active'); b.setAttribute('aria-selected','false'); }
  });
  document.getElementById('tab-panel-promos').style.display = (tabName==='promos') ? 'block' : 'none';
  document.getElementById('tab-panel-datos').style.display = (tabName==='datos') ? 'block' : 'none';
}

/* Helpers para niveles */
function parseLevel(levelStr){
  if(levelStr===undefined || levelStr===null) return NaN;
  const s = String(levelStr).trim().replace(',', '.');
  const m = s.match(/^(\d+(\.\d+)?)/);
  return m ? parseFloat(m[1]) : NaN;
}
function isAllowedLevel(levelStr){
  const n = parseLevel(levelStr);
  if(isNaN(n)) return false;
  return n === 1 || n === 2 || n >= 5;
}

/* Cargar lista de comercios (autocompletado) and categories */
function cargarComercios(callback){
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=anunciantes`;
  fetch(url, {cache:'no-store'}).then(r=>r.text()).then(text=>{
    try{
      const start=text.indexOf('{'), end=text.lastIndexOf('}');
      const jsonText=text.slice(start,end+1);
      const json=JSON.parse(jsonText);
      const cols=(json.table && json.table.cols)? json.table.cols.map(c=>(c&&c.label)?String(c.label).toLowerCase().trim():''):[];
      let idxNombre = cols.findIndex(h=>/nombre|comercio|title|titulo/.test(h)); if(idxNombre===-1) idxNombre=1;
      let idxId = cols.findIndex(h=>/id|planilla|planilla_id|codigo/.test(h)); if(idxId===-1) idxId=61;
      let idxNivel = cols.findIndex(h=>/nivel|nivel_acceso|nivelacceso/.test(h));
      comercios=(json.table.rows||[]).map(row=>{
        const nombre = (row.c && row.c[idxNombre] && row.c[idxNombre].v)?row.c[idxNombre].v:'';
        const id = (row.c && row.c[idxId] && row.c[idxId].v)?row.c[idxId].v:'';
        const nivel = (idxNivel!==-1 && row.c && row.c[idxNivel] && row.c[idxNivel].v)?row.c[idxNivel].v:'';
        return { nombre, id, nivel };
      }).filter(c=>c.nombre);
      debugLog('Comercios cargados:', comercios.length);
      cargarCategorias(()=> callback && callback());
    }catch(e){
      debugLog('Error parseando lista de comercios', e);
      cargarCategorias(()=> callback && callback());
    }
  }).catch(err=>{ debugLog('Error fetch lista de comercios', err); cargarCategorias(()=> callback && callback()); });
}

function cargarCategorias(callback){
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent('categorias_list')}`;
  fetch(url, {cache:'no-store'}).then(r=>r.text()).then(text=>{
    try{
      const start=text.indexOf('{'), end=text.lastIndexOf('}');
      const jsonText=text.slice(start,end+1);
      const json=JSON.parse(jsonText);
      const idxTitulo = 0;
      const rows = json.table.rows || [];
      categorias = rows.map(r=> {
        const raw = (r.c && r.c[idxTitulo] && r.c[idxTitulo].v) ? r.c[idxTitulo].v : '';
        return (typeof raw === 'string' ? raw.trim() : (raw===null || raw===undefined ? '' : String(raw).trim()));
      })
      .filter(t => t && t.toLowerCase() !== 'titulo');
      categorias = categorias.filter(c => typeof c === 'string' && c.trim().length > 0 && c.toLowerCase() !== 'true');
      categorias = Array.from(new Set(categorias));
      debugLog('Categorias cargadas:', categorias.length);
      populateCategoriaSelect();
      callback && callback();
    }catch(e){
      debugLog('Error parseando categorias_list', e);
      categorias = [];
      populateCategoriaSelect();
      callback && callback();
    }
  }).catch(err=>{
    debugLog('Error fetch categorias_list', err);
    categorias = [];
    populateCategoriaSelect();
    callback && callback();
  });
}

function populateCategoriaSelect(){
  const sel = document.getElementById('promo-categoria');
  if(!sel) return;
  sel.innerHTML = '';
  const placeholder = document.createElement('option');
  placeholder.value = '';
  placeholder.textContent = '-- Seleccioná categoría --';
  placeholder.disabled = true;
  placeholder.selected = true;
  sel.appendChild(placeholder);
  categorias.forEach(cat=>{
    if(typeof cat !== 'string') return;
    const v = cat.trim();
    if(!v || v.toLowerCase() === 'true') return;
    const opt = document.createElement('option');
    opt.value = v;
    opt.textContent = v;
    sel.appendChild(opt);
  });
}

/* Autocomplete helper (unchanged) */
function showAutocomplete(inputEl, listEl, idEl, modoRegistro=false){
  if(!inputEl||!listEl||!idEl) return;
  inputEl.addEventListener('input', function(){
    const val=this.value.trim().toLowerCase(); listEl.innerHTML='';
    if(modoRegistro) document.getElementById('reg-msg').innerHTML = '';
    document.getElementById('level-warning').textContent = '';
    if(val.length<2){ listEl.classList.add('hidden'); idEl.value=''; document.getElementById('btnLogin')?.setAttribute('disabled','true'); if(modoRegistro) document.getElementById('btnGenerarClave')?.setAttribute('disabled','true'); return; }
    const matches = comercios.filter(c=>c.nombre.toLowerCase().includes(val));
    if(matches.length){
      matches.slice(0,20).forEach(c=>{
        const item=document.createElement('div'); item.className='autocomplete-item';
        let lvlLabel = c.nivel ? ` — nivel ${c.nivel}` : '';
        item.textContent=c.nombre + (c.id?(' ('+c.id+')'):'' ) + lvlLabel;
        item.onclick=function(){
          inputEl.value=c.nombre; idEl.value=c.id||''; inputEl.dataset.nivel = c.nivel || '';
          listEl.classList.add('hidden');
          const allowed = isAllowedLevel(c.nivel);
          const lvlWarningEl = document.getElementById('level-warning');
          if(allowed){
            document.getElementById('btnLogin')?.removeAttribute('disabled');
            if(lvlWarningEl) lvlWarningEl.innerHTML = `<span class="success">Anunciante nivel ${c.nivel} — permitido crear cuenta / iniciar sesión.</span>`;
          } else {
            document.getElementById('btnLogin')?.setAttribute('disabled','true');
            if(lvlWarningEl){
              if(c.nivel) lvlWarningEl.innerHTML = `<span class="error">Anunciante nivel ${c.nivel} — NO puede crear cuenta ni iniciar sesión desde aquí. Para otras consultas contactá soporte.</span>`;
              else lvlWarningEl.innerHTML = `<span class="error">No hay información de nivel para este anunciante — no es posible crear cuenta desde aquí. Si tu comercio no está en la guía, completá el formulario.</span>`;
            }
          }
          if(modoRegistro){
            const pwdInput = document.getElementById('nueva-clave');
            const pwdConfirm = document.getElementById('nueva-clave-confirm');
            if(allowed){
              document.getElementById('btnGenerarClave')?.removeAttribute('disabled');
              pwdInput.removeAttribute('disabled');
              pwdConfirm.removeAttribute('disabled');
            } else {
              document.getElementById('btnGenerarClave')?.setAttribute('disabled','true');
              pwdInput.setAttribute('disabled','true');
              pwdConfirm.setAttribute('disabled','true');
            }
          }
        };
        listEl.appendChild(item);
      });
      list.classList.remove('hidden');
    } else {
      const item=document.createElement('div'); item.style.padding='10px'; item.style.background='#fffbe5';
      item.innerHTML = `<b>¿Tu comercio no está publicado?</b><br>
                        <div class="small-muted">Si no aparece en la guía, debés solicitar la creación del comercio (anuncio) mediante el formulario. Crear comercio es distinto de generar la contraseña de acceso.</div>
                        <button id="btnRegistrarComercio" style="margin-top:8px;width:100%;">Solicitar creación de comercio</button>
                        <div class="small-warning" style="margin-top:8px;">Recordá: las cuentas de acceso solo se generan para anunciantes con nivel 1, 2 o 5 y superiores. Para cambios de nivel o productos comerciales contactá soporte.</div>`;
      listEl.appendChild(item);
      setTimeout(()=>{ const btn=document.getElementById('btnRegistrarComercio'); if(btn) btn.onclick=()=> window.open(FORM_URL,'_blank'); },50);
      listEl.classList.remove('hidden');
    }
  });
  inputEl.addEventListener('blur', ()=> setTimeout(()=>listEl.classList.add('hidden'),180));
  inputEl.addEventListener('change', function(){ if(this.value===''){ idEl.value=''; document.getElementById('btnLogin')?.setAttribute('disabled','true'); if(modoRegistro) document.getElementById('btnGenerarClave')?.setAttribute('disabled','true'); } });
}

/* Eventos y login */
let originalLoginBtnText = null;
document.addEventListener('DOMContentLoaded', ()=>{
  cargarComercios(()=>{
    showAutocomplete(document.getElementById('comercio-buscar'), document.getElementById('autocomplete-list'), document.getElementById('comercio-id'));
    showAutocomplete(document.getElementById('comercio-buscar2'), document.getElementById('autocomplete-list2'), document.getElementById('comercio-id2'), true);
  });

  const btnLogin = document.getElementById('btnLogin');
  if(btnLogin) originalLoginBtnText = btnLogin.textContent || 'Ingresar';

  document.getElementById('login-form').onsubmit = async function(e){
    e.preventDefault(); document.getElementById('report-area').style.display='none';
    const nombre = document.getElementById('comercio-buscar').value.trim();
    const clave = document.getElementById('clave').value.trim();
    const id = document.getElementById('comercio-id').value.trim();
    const nivelSeleccion = document.getElementById('comercio-buscar')?.dataset?.nivel || '';
    if(!id && !nombre){ document.getElementById('login-msg').innerHTML = "<span class='error'>Elegí un comercio de la lista.</span>"; return; }
    if(id && !isAllowedLevel(nivelSeleccion)){
      document.getElementById('login-msg').innerHTML = "<span class='error'>No está permitido iniciar sesión para este anunciante (nivel no autorizado).</span>";
      return;
    }

    if(btnLogin){
      btnLogin.setAttribute('disabled','true');
      btnLogin.textContent = 'Ingresando...';
    }
    document.getElementById('login-msg').innerHTML = "<span>Ingresando...</span>";
    const payload = { accion:'login', comercio_id:id||'', nombre:nombre, password:clave };
    try{
      const r = await fetch(WORKER_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload), mode:'cors' });
      const text = await r.text();
      let res;
      try{ res = JSON.parse(text); }catch(e){ res = { success:false, message: text }; }
      debugLog('Login worker ->', r.status, res);
      if(r.status===200 && res.success){
        if(btnLogin){
          btnLogin.textContent = 'Cargando datos...';
          btnLogin.setAttribute('disabled','true');
        }
        localStorage.setItem('comercio_id', res.id || id);
        localStorage.setItem('comercio_nombre', res.nombre || nombre);
        if(res.planilla_id) localStorage.setItem('planilla_id', res.planilla_id);
        sesion = { id: res.id || id, nombre: res.nombre || nombre, planilla_id: res.planilla_id || '' };
        document.getElementById('login-msg').innerHTML = "<span class='success'>"+(res.message||'Ingresado')+"</span>";
        setTimeout(()=> mostrarPanelDashboard(),500);
        return;
      }

      if(btnLogin){
        btnLogin.removeAttribute('disabled');
        btnLogin.textContent = originalLoginBtnText;
      }
      document.getElementById('login-msg').innerHTML = "<span class='error'>"+(res.message||'Login falló')+"</span>";
    }catch(err){
      debugLog('Error fetch worker', err);
      if(btnLogin){
        btnLogin.removeAttribute('disabled');
        btnLogin.textContent = originalLoginBtnText;
      }
      document.getElementById('login-msg').innerHTML = "<span class='error'>Error de conexión.</span>";
    }
  };

  document.getElementById('btnCrearComercio').addEventListener('click', ()=> window.open(FORM_URL,'_blank'));

  document.getElementById('logout-btn').addEventListener('click', ()=> {
    localStorage.removeItem('comercio_id'); localStorage.removeItem('comercio_nombre'); localStorage.removeItem('planilla_id'); sesion=null;
    const btn = document.getElementById('btnLogin');
    if(btn){
      btn.removeAttribute('disabled');
      btn.textContent = originalLoginBtnText;
    }
    mostrarPanel('login');
  });

  // Tab buttons
  document.getElementById('tab-promos').addEventListener('click', ()=> switchDashboardTab('promos'));
  document.getElementById('tab-datos').addEventListener('click', ()=> switchDashboardTab('datos'));

  // Contact support button in Datos section
  document.getElementById('contact-support-data').addEventListener('click', ()=>{
    if(!sesion) { openWhatsApp('Necesito asistencia para actualizar datos de anunciante.'); return; }
    const msg = `Solicito modificación de datos\nComercio: ${sesion.nombre}\nId: ${sesion.id}\nPor favor, indicar los cambios a realizar.`;
    openWhatsApp(msg);
  });

  if(localStorage.getItem('comercio_id') && localStorage.getItem('comercio_nombre')){ sesion = { id: localStorage.getItem('comercio_id'), nombre: localStorage.getItem('comercio_nombre'), planilla_id: localStorage.getItem('planilla_id')||'' }; mostrarPanelDashboard(); }
});

/* Dashboard: pedir datos al Worker -> Apps Script */
async function mostrarPanelDashboard(){
  if(!sesion || !sesion.id){ mostrarPanel('login'); return; }
  document.getElementById('nombre-comercio').textContent = sesion.nombre;
  debugLog('Pidiendo datos para id:', sesion.id);
  const url = `${WORKER_ORIGIN}/commerce?id=${encodeURIComponent(sesion.id)}&nombre=${encodeURIComponent(sesion.nombre)}&planilla_id=${encodeURIComponent(sesion.planilla_id||'')}`;
  try{
    const r = await fetch(url, { method:'GET', mode:'cors' });
    const datos = await r.json().catch(()=>({ error:'Respuesta inválida'}));
    debugLog('/commerce ->', datos);
    if(datos.error){ document.getElementById('campos-datos-comercio').innerHTML = `<b>Error:</b> ${datos.error}`; switchDashboardTab('promos'); return; }
    if(datos.planilla_id && datos.planilla_id !== sesion.planilla_id){ sesion.planilla_id = datos.planilla_id; localStorage.setItem('planilla_id', datos.planilla_id); }

    // Campos reducidos: OMITIR 'nombre' (mostrado en el header) y sólo hasta 'descripcion'
    const campos = ["nivel","subnivel","segmento","categoria","tags","adicionales","pie","descripcion"];
    let html = '';
    campos.forEach(c=>{
      // skip blocked fields if any
      html += `<div><label>${c}</label><input type="text" name="${c}" value="${datos[c]||''}" /></div>`;
    });
    html += `<input type="hidden" name="__id" value="${sesion.id}"/>`;
    document.getElementById('campos-datos-comercio').innerHTML = html;

    // Default show Promos tab but keep tabs available
    switchDashboardTab('promos');

    // After dashboard data is loaded, trigger promos load
    setTimeout(()=>{ try{ if(document.getElementById('promos-list')) loadPromosUI(); }catch(e){} }, 300);
  }catch(err){
    debugLog('Error al consultar /commerce', err);
    document.getElementById('campos-datos-comercio').innerHTML = `<b>Error conexión con Worker.</b>`;
    switchDashboardTab('promos');
  }
}

/* El resto del JS (promos_post, loadPromosUI, renderPromosList, crear promo, etc.) se mantiene igual que antes.
   Para evitar duplicar código en este mensaje, incluyo las funciones esenciales aquí directamente. */

/* =========================
   SAFE replacement: promos_post
   ========================= */
async function promos_post(pathOrUrl, payload){
  const body = Object.assign({}, payload || {});
  if(body.accion && !body.action){ body.action = body.accion; delete body.accion; }
  if(!body.advertiserId){
    if(typeof sesion !== 'undefined' && sesion && sesion.id) body.advertiserId = String(sesion.id);
    else if(window.sesion && window.sesion.id) body.advertiserId = String(window.sesion.id);
  }
  const url = (typeof pathOrUrl === 'string' && pathOrUrl.startsWith('http')) ? pathOrUrl : WORKER_COMMERCE_URL;
  try {
    const r = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      mode: 'cors',
      body: JSON.stringify(body)
    });
    const text = await r.text();
    let json;
    try { json = text ? JSON.parse(text) : null; } catch(e){ json = { rawText: text }; }
    debugLog('promos_post ->', {status:r.status, body:json});
    return { status: r.status, json: json };
  } catch(err){
    debugLog('promos_post fetch error ->', String(err));
    return { status: 0, json: { error: String(err) } };
  }
}

async function loadPromosUI(){
  const st = document.getElementById('promos-status');
  const list = document.getElementById('promos-list');
  if(!sesion || !sesion.id){ st.textContent = 'No logueado: inicia sesión para gestionar promos.'; list.innerHTML = ''; return; }
  st.textContent = 'Cargando promos...';
  list.innerHTML = 'Cargando promos...';
  const res = await promos_post(WORKER_COMMERCE_URL, { action: 'getPromos', advertiserId: String(sesion.id || '') });
  if(res.status !== 200){ st.textContent = 'Error cargando promos'; list.innerHTML=''; return; }
  const data = res.json || {};
  const promos = data.promos || data.rows || [];
  renderPromosList(promos);
  st.textContent = 'Promos cargadas: ' + promos.length;
}

function renderPromosList(promos){
  const list = document.getElementById('promos-list');
  if(!promos || promos.length === 0){ list.innerHTML = '<div class="small-muted">No hay promos registradas.</div>'; return; }
  let html = '<table><thead><tr><th>Promo</th><th>Categoria</th><th>Desde</th><th>Hasta</th><th>promo_id</th><th>otros</th><th>Acciones</th></tr></thead><tbody>';
  for(const p of promos){
    const promo = htmlEscape(p.promo || '');
    const categoria = htmlEscape(p.categoria || '');
    const desde = htmlEscape(p.desde || '');
    const hasta = htmlEscape(p.hasta || '');
    const pid = htmlEscape(p.promo_id || '');
    const otros = htmlEscape(p.otros || '');
    html += `<tr>
      <td>${promo}</td>
      <td>${categoria}</td>
      <td>${desde}</td>
      <td>${hasta}</td>
      <td style="font-size:0.9em;color:#555">${pid}</td>
      <td>${otros}</td>
      <td>
        <button data-action="edit" data-pid="${pid}" class="secondary">Editar</button>
        <button data-action="delete" data-pid="${pid}" class="danger">Borrar</button>
      </td>
    </tr>`;
  }
  html += '</tbody></table>';
  list.innerHTML = html;

  list.querySelectorAll('button').forEach(b=>{
    b.addEventListener('click', async (ev)=>{
      const action = b.getAttribute('data-action');
      const pid = b.getAttribute('data-pid');
      if(action === 'delete'){
        if(!confirm('Confirmar borrar promo?')) return;
        const r = await promos_post(WORKER_COMMERCE_URL, { action: 'deletePromo', payload: { promo_id: pid } });
        if(r.status === 200 && r.json && r.json.success){ alert('Promo borrada'); loadPromosUI(); } else { alert('Error borrando: ' + JSON.stringify(r.json)); }
      } else if(action === 'edit'){
        const newText = prompt('Editar texto de promo:', '');
        if(newText === null) return;
        const newDesde = prompt('Desde (YYYY-MM-DD):','');
        const newHasta = prompt('Hasta (YYYY-MM-DD):','');
        const newOtros = prompt('Otros (nota opcional):','');
        const payload = { promo_id: pid };
        if(newText) payload.promo = newText;
        if(newDesde) payload.desde = newDesde;
        if(newHasta) payload.hasta = newHasta;
        if(newOtros) payload.otros = newOtros;
        const r = await promos_post(WORKER_COMMERCE_URL, { action: 'updatePromo', payload: payload });
        if(r.status === 200 && r.json && r.json.success){ alert('Promo actualizada'); loadPromosUI(); } else { alert('Error actualizando: ' + JSON.stringify(r.json)); }
      }
    });
  });
}

function htmlEscape(s){ return String(s||'').replace(/[&<>"']/g, function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; }); }

/* Crear promo desde form (sin cambios funcionales) */
document.addEventListener('click', function(e){
  if(!e.target) return;

  if(e.target.id === 'promo-create'){
    (async ()=>{
      if(!sesion || !sesion.id){ alert('No logueado.'); return; }
      const promo = document.getElementById('promo-text').value.trim();
      const categoria = document.getElementById('promo-categoria').value || '';
      const desde = document.getElementById('promo-desde').value;
      const hasta = document.getElementById('promo-hasta').value;
      const otros = document.getElementById('promo-otros').value.trim();
      if(!promo){ alert('Ingresá texto de promo'); return; }
      if(!categoria){
        alert('Seleccioná una categoría obligatoria para la promo.');
        return;
      }

      const statusEl = document.getElementById('promos-status');
      statusEl.textContent = 'Creando promo...';
      const btn = e.target;
      btn.setAttribute('disabled','true');
      const spinner = document.createElement('span'); spinner.className='spinner'; btn.appendChild(spinner);

      const payload = {
        action: 'createPromo',
        payload: { promo: promo, categoria: categoria, desde: desde || '', hasta: hasta || '', otros: otros || '' },
        advertiserId: String(sesion.id || '')
      };

      debugLog('Creating promo - request payload:', payload);

      try {
        const r = await promos_post(WORKER_COMMERCE_URL, payload);
        debugLog('CreatePromo via promos_post ->', r);
        if(r.status === 200 && r.json && (r.json.success === true || r.json.created === true)){
          statusEl.textContent = 'Promo creada correctamente.';
          document.getElementById('promo-text').value = '';
          document.getElementById('promo-categoria').value = '';
          document.getElementById('promo-desde').value = '';
          document.getElementById('promo-hasta').value = '';
          document.getElementById('promo-otros').value = '';
          await loadPromosUI();
        } else {
          const errMsg = `Error creando promo. HTTP ${r.status} - ${JSON.stringify(r.json)}`;
          statusEl.textContent = errMsg;
          debugLog(errMsg);
          if(r.json && r.json.message) alert('Error: ' + r.json.message);
        }
      } catch(err){
        const errText = 'Error de conexión al crear promo: ' + String(err);
        document.getElementById('promos-status').textContent = errText;
        debugLog(errText, err);
        alert('Error de conexión. Revisa la consola para más detalles.');
      } finally {
        try { btn.removeChild(spinner); } catch(e){}
        btn.removeAttribute('disabled');
      }
    })();
    return;
  }

  if(e.target.id === 'promo-refresh'){
    loadPromosUI();
    return;
  }
});

/* small init to ensure categories exist after load */
(function initCategoriesOnLoad(){ if(window.addEventListener){ window.addEventListener('load', ()=> setTimeout(()=> populateCategoriaSelect(), 500)); } })();

</script>
</body>
</html>
