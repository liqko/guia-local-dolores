<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Panel Comercios - Login & Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f6f7fb;margin:0;padding:0}
    .container{max-width:920px;margin:20px auto;background:#fff;border-radius:12px;box-shadow:0 2px 16px #0002;padding:24px}
    label{display:block;margin:12px 0 6px;font-weight:500}
    input,button,textarea,select{width:100%;padding:8px;margin-bottom:10px;border-radius:5px;border:1px solid #bbb;box-sizing:border-box}
    .autocomplete-list{position:absolute;background:#fff;border:1px solid #bbb;z-index:10;max-height:220px;overflow-y:auto;width:93%}
    .autocomplete-item{padding:8px;cursor:pointer}
    .autocomplete-item:hover{background:#e7f7fd}
    .hidden{display:none}
    .success{color:#060;font-weight:bold}
    .error{color:#c00}
    button.primary{margin-top:10px;padding:12px 0;font-size:1.05em;border-radius:7px;background:#3dc879;color:#fff;border:1px solid #2a8}
    .link{color:#3498db;cursor:pointer;text-decoration:underline;display:inline-block;margin-top:8px}
    .panel{display:none}
    .panel.active{display:block}
    #debug{background:#111;color:#bff;padding:10px;border-radius:6px;max-height:160px;overflow:auto;font-size:12px;margin-top:8px;white-space:pre-wrap}
    .blocked { background:#f4f6f4; border:1px solid #dfe8df; }
    .info-banner{background:#fffbe5;border:1px solid #f5c26b;padding:10px;border-radius:6px;margin-top:8px}
    .small-muted{font-size:0.95em;color:#555}
    .small-warning{font-size:0.9em;color:#a33;margin-top:6px}
    .muted-note{font-size:0.95em;color:#444;margin-top:6px}

    /* Tabs */
    .tabs { display:flex; gap:8px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    .tab-btn { background:#eee;border:1px solid #ddd;padding:8px 12px;border-radius:8px;cursor:pointer }
    .tab-btn.active { background:#3dc879;color:#fff;border-color:#29a25f }
    .tab-panel { display:none; margin-top:10px; }
    .tab-panel.active { display:block; }

    /* Promos list */
    .promos-list { border-collapse:collapse; width:100%; margin-top:10px; }
    .promos-list th, .promos-list td { padding:8px;border-bottom:1px solid #eee; text-align:left; vertical-align:middle }
    .inline-small { width:auto; display:inline-block; padding:6px 10px; border-radius:6px; background:#f5f5f5; margin-right:6px }
    .center { text-align:center; }
  </style>
</head>
<body>
  <div class="container">
    <div id="panel-login" class="panel active">
      <h2>Ingresar a tu comercio</h2>
      <form id="login-form" autocomplete="off">
        <label>Comercio</label>
        <div style="position:relative;">
          <input type="text" id="comercio-buscar" placeholder="Buscá tu comercio..." autocomplete="off" required>
          <div id="autocomplete-list" class="autocomplete-list hidden"></div>
        </div>
        <input type="hidden" id="comercio-id">
        <label>Clave</label>
        <input type="password" id="clave" placeholder="Clave..." required minlength="1">
        <button id="btnLogin" class="primary" disabled>Ingresar</button>

        <div id="login-msg"></div>
        <div id="level-warning" class="small-muted"></div>

        <div id="create-commerce-banner" class="info-banner">
          <strong>¿Tu anuncio no aparece en la guía?</strong>
          <div class="small-muted">Si tu comercio no figura en la guía, solicitá la creación del anuncio con el formulario.</div>
          <button id="btnCrearComercio" style="margin-top:8px;width:100%;">Solicitar creación de anuncio</button>
        </div>

        <div id="report-area" style="display:none;">
          <button id="reportBtn">Contactar Soporte (WhatsApp)</button>
        </div>
      </form>

      <div style="text-align:center;margin-top:8px;">
        <span class="link" onclick="mostrarPanel('registro')">¿Necesitás generar tu contraseña? Ir a Generar contraseña</span>
      </div>
    </div>

    <div id="panel-registro" class="panel">
      <h2>Generar contraseña / Registrar acceso</h2>
      <p class="muted-note">
        Este flujo sirve para generar la contraseña para un anunciante que ya tiene su anuncio cargado.
      </p>

      <label>Buscar anuncio (seleccioná el anuncio ya publicado)</label>
      <div style="position:relative;">
        <input type="text" id="comercio-buscar2" placeholder="Buscá tu comercio..." autocomplete="off">
        <div id="autocomplete-list2" class="autocomplete-list hidden"></div>
      </div>
      <input type="hidden" id="comercio-id2">

      <label>Contraseña</label>
      <input type="password" id="nueva-clave" placeholder="Ingresá la nueva contraseña (mínimo 4 caracteres)" minlength="4" disabled>
      <label>Confirmar contraseña</label>
      <input type="password" id="nueva-clave-confirm" placeholder="Repetí la contraseña" minlength="4" disabled>

      <div style="display:flex;gap:8px;">
        <button id="btnGenerarClave" class="primary" style="flex:1" disabled>Generar y registrar contraseña</button>
      </div>

      <div id="reg-msg"></div>

      <div style="text-align:center;margin-top:8px;">
        <span class="link" onclick="mostrarPanel('login')">Volver al login</span>
      </div>
    </div>

    <div id="panel-dashboard" class="panel">
      <div style="font-size:1.2em;margin-bottom:10px">¡Hola <span id="nombre-comercio"></span>!</div>

      <div class="tabs" style="margin-bottom:6px;">
        <button id="tab-btn-datos" class="tab-btn active">Datos</button>
        <button id="tab-btn-promos" class="tab-btn">Promociones</button>
        <a id="open-sheets-promos" class="link" href="https://docs.google.com/spreadsheets/d/1-9nk03fv_9_4ER60xf7jCUzprgElMIv5amqAlRtIowY/edit?gid=1812912737#fvid=302597456" target="_blank" style="margin-left:auto">Abrir mis promos (Sheets)</a>
      </div>

      <div id="tab-datos" class="tab-panel active">
        <form id="form-datos-comercio">
          <div id="campos-datos-comercio"></div>
          <button type="submit" disabled style="background:#ccc;color:#444;padding:10px;border:none;border-radius:6px">Los datos no son editables desde el panel</button>
          <div class="small-muted" style="margin-top:6px">Si querés solicitar cambios, usá <a id="link-support-dashboard" href="#" target="_blank">Contactar Soporte</a>.</div>
          <div id="msg-datos-comercio"></div>
        </form>
      </div>

      <div id="tab-promos" class="tab-panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <strong>Promociones</strong>
            <div class="small-muted">Solo se muestran las promociones asociadas a tu comercio. Para editar, usá el enlace "Abrir mis promos (Sheets)".</div>
          </div>
        </div>

        <div id="promos-loading" class="small-muted" style="margin-top:8px">Cargando promociones...</div>
        <div id="promos-error" class="error" style="display:none;margin-top:8px"></div>

        <table id="promos-table" class="promos-list" style="width:100%;display:none;margin-top:8px">
          <thead>
            <tr>
              <th>Promoción</th>
              <th style="width:140px">Desde / Hasta</th>
              <th style="width:120px">Publicado</th>
              <th style="width:160px">Contacto / Extras</th>
            </tr>
          </thead>
          <tbody id="promos-tbody"></tbody>
        </table>
      </div>

      <div style="margin-top:10px">
        <a id="link-support-dashboard" href="#" target="_blank">WhatsApp Soporte</a>
      </div>
      <div style="margin-top:8px">
        <button id="logout-btn" style="background:#e74c3c;color:#fff;border:none;padding:8px;border-radius:6px">Cerrar sesión</button>
      </div>
    </div>

    <h3>Debug / Registros</h3>
    <div id="debug"></div>
  </div>

<script>
/* === CONFIG === */
const WORKER_URL = "https://login.liqkoargentina.workers.dev/login";
const WORKER_ORIGIN = (new URL(WORKER_URL)).origin;
/* Sheet con anunciantes (autocompletado/login) */
const SHEET_ID = "170kTZ-ViCPxPli86g-n_XMuMv1S3O0-DbGwNFGYVnjY";
/* Sheet con promos (la que compartiste) */
const PROMOS_SHEET_ID = "1-9nk03fv_9_4ER60xf7jCUzprgElMIv5amqAlRtIowY";
const PROMOS_SHEET_NAME = "promos";
/* ================= */

const SUPPORT_NUMBER = "5492245459957";

const BLOCKED = ["__id","id","planilla_id","planilla id","codigo","nivel","nivel_acceso","nivelacceso","verificado","gold","subnivel"];

let comercios = [];
let sesion = null;
const debugEl = document.getElementById('debug');
function debugLog(...args){ console.log(...args); try { debugEl.textContent += args.map(a=>typeof a==='object'?JSON.stringify(a,null,2):String(a)).join(' ') + "\n\n"; debugEl.scrollTop = debugEl.scrollHeight; }catch(e){} }

function mostrarPanel(panel){ ['panel-login','panel-registro','panel-dashboard'].forEach(id=>document.getElementById(id).classList.remove('active')); document.getElementById('panel-'+panel)?.classList.add('active'); }
function openWhatsApp(text){ window.open(`https://wa.me/${SUPPORT_NUMBER}?text=${encodeURIComponent(text)}`,'_blank'); }
function enableReportButton(payloadText){ document.getElementById('report-area').style.display='block'; document.getElementById('reportBtn').onclick = ()=> openWhatsApp(payloadText + "\n\nPor favor revisen. Gracias."); }

function parseLevel(levelStr){
  if(levelStr===undefined || levelStr===null) return NaN;
  const s = String(levelStr).trim().replace(',', '.');
  const m = s.match(/^(\d+(\.\d+)?)/);
  return m ? parseFloat(m[1]) : NaN;
}
function isAllowedLevel(levelStr){
  const n = parseLevel(levelStr);
  if(isNaN(n)) return false;
  return n === 1 || n === 2 || n >= 5;
}

/* Cargar lista de comercios (autocompletado) */
function cargarComercios(callback){
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=anunciantes`;
  fetch(url, {cache:'no-store'}).then(r=>r.text()).then(text=>{
    try{
      const start=text.indexOf('{'), end=text.lastIndexOf('}');
      const jsonText=text.slice(start,end+1);
      const json=JSON.parse(jsonText);
      const cols=(json.table && json.table.cols)? json.table.cols.map(c=>(c&&c.label)?String(c.label).toLowerCase().trim():''):[];
      let idxNombre = cols.findIndex(h=>/nombre|comercio|title|titulo/.test(h)); if(idxNombre===-1) idxNombre=1;
      let idxId = cols.findIndex(h=>/id|planilla|planilla_id|codigo/.test(h)); if(idxId===-1) idxId=61;
      let idxNivel = cols.findIndex(h=>/nivel|nivel_acceso|nivelacceso/.test(h));
      comercios=(json.table.rows||[]).map(row=>{
        const nombre = (row.c && row.c[idxNombre] && row.c[idxNombre].v)?row.c[idxNombre].v:'';
        const id = (row.c && row.c[idxId] && row.c[idxId].v)?row.c[idxId].v:'';
        const nivel = (idxNivel!==-1 && row.c && row.c[idxNivel] && row.c[idxNivel].v)?row.c[idxNivel].v:'';
        return { nombre, id, nivel };
      }).filter(c=>c.nombre);
      debugLog('Comercios cargados:', comercios.length);
      callback && callback();
    }catch(e){
      debugLog('Error parseando lista de comercios', e);
      callback && callback();
    }
  }).catch(err=>{ debugLog('Error fetch lista de comercios', err); callback && callback(); });
}

/* Autocomplete helper */
function showAutocomplete(inputEl, listEl, idEl, modoRegistro=false){
  if(!inputEl||!listEl||!idEl) return;
  inputEl.addEventListener('input', function(){
    const val=this.value.trim().toLowerCase(); listEl.innerHTML='';
    if(modoRegistro) document.getElementById('reg-msg').innerHTML = '';
    document.getElementById('level-warning').textContent = '';
    if(val.length<2){ listEl.classList.add('hidden'); idEl.value=''; document.getElementById('btnLogin')?.setAttribute('disabled','true'); if(modoRegistro) document.getElementById('btnGenerarClave')?.setAttribute('disabled','true'); return; }
    const matches = comercios.filter(c=>c.nombre.toLowerCase().includes(val));
    if(matches.length){
      matches.slice(0,20).forEach(c=>{
        const item=document.createElement('div'); item.className='autocomplete-item';
        let lvlLabel = c.nivel ? ` — nivel ${c.nivel}` : '';
        item.textContent=c.nombre + (c.id?(' ('+c.id+')'):'' ) + lvlLabel;
        item.onclick=function(){
          inputEl.value=c.nombre; idEl.value=c.id||''; inputEl.dataset.nivel = c.nivel || '';
          listEl.classList.add('hidden');
          const allowed = isAllowedLevel(c.nivel);
          const lvlWarningEl = document.getElementById('level-warning');
          if(allowed){
            document.getElementById('btnLogin')?.removeAttribute('disabled');
            if(lvlWarningEl) lvlWarningEl.innerHTML = `<span class="success">Anunciante nivel ${c.nivel} — permitido crear cuenta / iniciar sesión.</span>`;
          } else {
            document.getElementById('btnLogin')?.setAttribute('disabled','true');
            if(lvlWarningEl){
              if(c.nivel) lvlWarningEl.innerHTML = `<span class="error">Anunciante nivel ${c.nivel} — NO puede crear cuenta ni iniciar sesión desde aquí. Para otras consultas contactá soporte.</span>`;
              else lvlWarningEl.innerHTML = `<span class="error">No hay información de nivel para este anunciante — no es posible crear cuenta desde aquí. Si tu comercio no está en la guía, completá el formulario.</span>`;
            }
          }
          if(modoRegistro){
            const pwdInput = document.getElementById('nueva-clave');
            const pwdConfirm = document.getElementById('nueva-clave-confirm');
            if(allowed){
              document.getElementById('btnGenerarClave')?.removeAttribute('disabled');
              pwdInput.removeAttribute('disabled');
              pwdConfirm.removeAttribute('disabled');
            } else {
              document.getElementById('btnGenerarClave')?.setAttribute('disabled','true');
              pwdInput.setAttribute('disabled','true');
              pwdConfirm.setAttribute('disabled','true');
            }
          }
        };
        listEl.appendChild(item);
      });
      listEl.classList.remove('hidden');
    } else {
      const item=document.createElement('div'); item.style.padding='10px'; item.style.background='#fffbe5';
      item.innerHTML = `<b>¿Tu comercio no está publicado?</b><br>
                        <div class="small-muted">Si no aparece en la guía, debés solicitar la creación del comercio mediante el formulario.</div>
                        <button id="btnRegistrarComercio" style="margin-top:8px;width:100%;">Solicitar creación de comercio</button>`;
      listEl.appendChild(item);
      setTimeout(()=>{ const btn=document.getElementById('btnRegistrarComercio'); if(btn) btn.onclick=()=> window.open(FORM_URL,'_blank'); },50);
      listEl.classList.remove('hidden');
    }
  });
  inputEl.addEventListener('blur', ()=> setTimeout(()=>listEl.classList.add('hidden'),180));
  inputEl.addEventListener('change', function(){ if(this.value===''){ idEl.value=''; document.getElementById('btnLogin')?.setAttribute('disabled','true'); if(modoRegistro) document.getElementById('btnGenerarClave')?.setAttribute('disabled','true'); } });
}

/* Events and login */
let originalLoginBtnText = null;
document.addEventListener('DOMContentLoaded', ()=>{
  cargarComercios(()=>{
    showAutocomplete(document.getElementById('comercio-buscar'), document.getElementById('autocomplete-list'), document.getElementById('comercio-id'));
    showAutocomplete(document.getElementById('comercio-buscar2'), document.getElementById('autocomplete-list2'), document.getElementById('comercio-id2'), true);
  });

  const btnLogin = document.getElementById('btnLogin');
  if(btnLogin) originalLoginBtnText = btnLogin.textContent || 'Ingresar';

  document.getElementById('login-form').onsubmit = async function(e){
    e.preventDefault(); document.getElementById('report-area').style.display='none';
    const nombre = document.getElementById('comercio-buscar').value.trim();
    const clave = document.getElementById('clave').value.trim();
    const id = document.getElementById('comercio-id').value.trim();
    const nivelSeleccion = document.getElementById('comercio-buscar')?.dataset?.nivel || '';
    if(!id && !nombre){ document.getElementById('login-msg').innerHTML = "<span class='error'>Elegí un comercio de la lista.</span>"; return; }
    if(id && !isAllowedLevel(nivelSeleccion)){
      document.getElementById('login-msg').innerHTML = "<span class='error'>No está permitido iniciar sesión para este anunciante (nivel no autorizado).</span>";
      return;
    }

    if(btnLogin){
      btnLogin.setAttribute('disabled','true');
      btnLogin.textContent = 'Ingresando...';
    }
    document.getElementById('login-msg').innerHTML = "<span>Ingresando...</span>";
    const payload = { accion:'login', comercio_id:id||'', nombre:nombre, password:clave };
    try{
      const r = await fetch(WORKER_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload), mode:'cors' });
      const text = await r.text();
      let res;
      try{ res = JSON.parse(text); }catch(e){ res = { success:false, message: text }; }
      debugLog('Login worker ->', r.status, res);
      if(r.status===200 && res.success){
        if(btnLogin){
          btnLogin.textContent = 'Cargando datos...';
          btnLogin.setAttribute('disabled','true');
        }
        localStorage.setItem('comercio_id', res.id || id);
        localStorage.setItem('comercio_nombre', res.nombre || nombre);
        if(res.planilla_id) localStorage.setItem('planilla_id', res.planilla_id);
        sesion = { id: res.id || id, nombre: res.nombre || nombre, planilla_id: res.planilla_id || '' };
        document.getElementById('login-msg').innerHTML = "<span class='success'>"+(res.message||'Ingresado')+"</span>";
        setTimeout(()=> mostrarPanelDashboard(),500);
        return;
      }

      if(btnLogin){
        btnLogin.removeAttribute('disabled');
        btnLogin.textContent = originalLoginBtnText;
      }
      document.getElementById('login-msg').innerHTML = "<span class='error'>"+(res.message||'Login falló')+"</span>";
      enableReportButton(`Intento login\nPayload: ${JSON.stringify(payload)}\nWorker status: ${r.status}\nWorker body: ${JSON.stringify(res)}`);
    }catch(err){
      debugLog('Error fetch worker', err);
      if(btnLogin){
        btnLogin.removeAttribute('disabled');
        btnLogin.textContent = originalLoginBtnText;
      }
      document.getElementById('login-msg').innerHTML = "<span class='error'>Error de conexión.</span>";
      enableReportButton(`Error fetch worker: ${err}`);
    }
  };

  document.getElementById('btnCrearComercio').addEventListener('click', ()=> window.open(FORM_URL,'_blank'));
  document.getElementById('reportBtn')?.addEventListener('click', ()=> openWhatsApp('Necesito asistencia.'));
  document.getElementById('logout-btn').addEventListener('click', ()=> {
    localStorage.removeItem('comercio_id'); localStorage.removeItem('comercio_nombre'); localStorage.removeItem('planilla_id'); sesion=null;
    const btn = document.getElementById('btnLogin');
    if(btn){
      btn.removeAttribute('disabled');
      btn.textContent = originalLoginBtnText;
    }
    mostrarPanel('login');
  });

  document.getElementById('tab-btn-datos').addEventListener('click', ()=> switchDashboardTab('datos'));
  document.getElementById('tab-btn-promos').addEventListener('click', ()=> switchDashboardTab('promos'));

  if(localStorage.getItem('comercio_id') && localStorage.getItem('comercio_nombre')){
    sesion = { id: localStorage.getItem('comercio_id'), nombre: localStorage.getItem('comercio_nombre'), planilla_id: localStorage.getItem('planilla_id')||'' };
    mostrarPanelDashboard();
  }
});

/* Dashboard: pedir datos y mostrar (solo lectura para Datos) */
async function mostrarPanelDashboard(){
  if(!sesion || !sesion.id){ mostrarPanel('login'); return; }
  document.getElementById('nombre-comercio').textContent = sesion.nombre;
  debugLog('Pidiendo datos para id:', sesion.id);
  const url = `${WORKER_ORIGIN}/commerce?id=${encodeURIComponent(sesion.id)}&nombre=${encodeURIComponent(sesion.nombre)}&planilla_id=${encodeURIComponent(sesion.planilla_id||'')}`;
  try{
    const r = await fetch(url, { method:'GET', mode:'cors' });
    const datos = await r.json().catch(()=>({ error:'Respuesta inválida'}));
    debugLog('/commerce ->', datos);
    if(datos.error){ document.getElementById('campos-datos-comercio').innerHTML = `<b>Error:</b> ${datos.error}`; mostrarPanel('dashboard'); return; }
    if(datos.planilla_id && datos.planilla_id !== sesion.planilla_id){ sesion.planilla_id = datos.planilla_id; localStorage.setItem('planilla_id', datos.planilla_id); }

    const campos = ["nombre","nivel","subnivel","segmento","categoria","tags","adicionales","pie","descripcion","direccion","lat","lng","telefono","whatsapp","mail","instagram","facebook","youtube","tiktok","linkedin","logo","verificado","gold","img1","img2","img3","img4","link"];
    let html = '';
    campos.forEach(c=>{
      const val = datos[c]||'';
      html += `<div><label>${c}</label><input type="text" name="${c}" value="${val}" readonly class="blocked" /></div>`;
    });
    html += `<input type="hidden" name="__id" value="${sesion.id}"/>`;
    document.getElementById('campos-datos-comercio').innerHTML = html;
    document.getElementById('link-support-dashboard').href = `https://wa.me/${SUPPORT_NUMBER}?text=${encodeURIComponent('Solicito modificación de datos\\nComercio: ' + sesion.nombre + '\\nId: ' + sesion.id)}`;
    mostrarPanel('dashboard');

    const btn = document.getElementById('btnLogin');
    if(btn){
      btn.removeAttribute('disabled');
      btn.textContent = originalLoginBtnText;
    }
  }catch(err){
    debugLog('Error al consultar /commerce', err);
    document.getElementById('campos-datos-comercio').innerHTML = `<b>Error conexión con Worker.</b>`;
    mostrarPanel('dashboard');
    const btn = document.getElementById('btnLogin');
    if(btn){
      btn.removeAttribute('disabled');
      btn.textContent = originalLoginBtnText;
    }
  }
}

/* -----------------------
   PESTAÑA PROMOCIONES (SOLO LECTURA)
   - carga promos desde la hoja 'promos' (consulta directa a Google Sheets)
   - filtra automáticamente por el id del comercio
   ----------------------- */

function switchDashboardTab(tab){
  document.getElementById('tab-btn-datos').classList.remove('active');
  document.getElementById('tab-btn-promos').classList.remove('active');
  document.getElementById('tab-datos').classList.remove('active');
  document.getElementById('tab-promos').classList.remove('active');

  if(tab === 'datos'){
    document.getElementById('tab-btn-datos').classList.add('active');
    document.getElementById('tab-datos').classList.add('active');
  } else if(tab === 'promos'){
    document.getElementById('tab-btn-promos').classList.add('active');
    document.getElementById('tab-promos').classList.add('active');
    loadPromos();
  }
}

/* Versión automática: detecta encabezados y busca la columna ID; luego consulta solo filas con ese id */
async function loadPromos(){
  if(!sesion || !sesion.id) return;
  document.getElementById('promos-loading').style.display = 'block';
  document.getElementById('promos-error').style.display = 'none';
  document.getElementById('promos-table').style.display = 'none';
  document.getElementById('promos-tbody').innerHTML = '';

  try{
    // 1) leer encabezados (limit 1)
    const urlHead = `https://docs.google.com/spreadsheets/d/${PROMOS_SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(PROMOS_SHEET_NAME)}&tq=${encodeURIComponent('select * limit 1')}`;
    const rHead = await fetch(urlHead, { method:'GET', cache:'no-store' });
    const textHead = await rHead.text();
    const s = textHead.indexOf('{'), e = textHead.lastIndexOf('}');
    if(s===-1 || e===-1) throw new Error('Respuesta inválida al leer encabezados');
    const jsonHead = JSON.parse(textHead.slice(s,e+1));
    const cols = (jsonHead.table && jsonHead.table.cols) ? jsonHead.table.cols.map(c => (c && c.label) ? String(c.label).trim() : '') : [];

    // 2) detectar columna id (intenta varios nombres)
    const nameCandidates = ['id','__id','comercio_id','anunciante','codigo','id_promocion'];
    let idIndex = -1;
    for(let i=0;i<cols.length;i++){
      const key = String(cols[i]||'').toLowerCase().trim();
      if(!key) continue;
      if(nameCandidates.includes(key)) { idIndex = i; break; }
      if(/\bid\b/.test(key)) { idIndex = i; break; }
    }
    if(idIndex === -1){
      idIndex = 0; // fallback: columna A
      console.warn('No se detectó columna "id" en encabezados. Usando columna A por defecto. Encabezados detectados:', cols);
    }

    // 3) convertir índice a letra
    function colIndexToLetter(index){
      let n = index + 1;
      let s = '';
      while(n>0){
        let rem = (n-1) % 26;
        s = String.fromCharCode(65 + rem) + s;
        n = Math.floor((n-1)/26);
      }
      return s;
    }
    const idColLetter = colIndexToLetter(idIndex);

    // 4) construir consulta para pedir solo filas donde idColLetter = sesion.id
    const safeId = String(sesion.id).replace(/'/g,"\\'");
    const tq = `select * where ${idColLetter} = '${safeId}'`;
    const url = `https://docs.google.com/spreadsheets/d/${PROMOS_SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(PROMOS_SHEET_NAME)}&tq=${encodeURIComponent(tq)}`;

    const r = await fetch(url, { method:'GET', cache:'no-store' });
    const text = await r.text();
    const start = text.indexOf('{');
    const end = text.lastIndexOf('}');
    if(start === -1 || end === -1){
      throw new Error('Respuesta inválida de Google Sheets al pedir filas');
    }
    const jsonText = text.slice(start, end+1);
    const json = JSON.parse(jsonText);

    // Mapear filas a objetos usando los encabezados (cols)
    const rows = (json.table && json.table.rows) ? json.table.rows.map(row => {
      const obj = {};
      (row.c || []).forEach((cell, i) => {
        const keyRaw = cols[i] || `col${i+1}`;
        const key = String(keyRaw).toLowerCase().replace(/\s+/g,'_');
        obj[key] = (cell && (cell.v !== undefined && cell.v !== null)) ? cell.v : '';
      });
      return obj;
    }) : [];

    debugLog('Promos cargadas (filtradas):', rows.length);
    renderPromosList(rows);
  }catch(err){
    console.error('loadPromos error:', err);
    debugLog('Error cargando promos desde Sheets', err);
    document.getElementById('promos-error').textContent = 'Error al cargar promociones. Verificá acceso público o nombre de pestaña.';
    document.getElementById('promos-error').style.display='block';
  } finally {
    document.getElementById('promos-loading').style.display = 'none';
  }
}

/* Render: solo muestra la info; no hay acciones de crear/editar/borrar desde el panel */
function renderPromosList(rows){
  const tbody = document.getElementById('promos-tbody');
  tbody.innerHTML = '';
  if(!rows || rows.length === 0){
    tbody.innerHTML = `<tr><td colspan="4" class="center small-muted">No hay promociones cargadas para este comercio.</td></tr>`;
    document.getElementById('promos-table').style.display = 'table';
    return;
  }

  rows.forEach(r=>{
    const promoText = r.promo || r.titulo || r.texto || '';
    const desde = r.desde || r.fecha_desde || '';
    const hasta = r.hasta || r.fecha_hasta || '';
    const publicar = (r.publicar === true || r.publicar === 'TRUE' || r.publicar === 'true' || r.publicar === '1' || r.publicar === 1) ? true : false;
    const contacto = [
      r.telefono || '',
      r.whatsapp || '',
      r.instagram || '',
      r.facebook || '',
      r.youtube || '',
      r.tiktok || '',
      r.linkedin || '',
      r.otros || ''
    ].filter(Boolean).join(' • ');

    const tr = document.createElement('tr');

    const textTd = document.createElement('td');
    textTd.innerHTML = `<strong>${escapeHtml(truncate(promoText,300))}</strong>`;

    const dateTd = document.createElement('td');
    dateTd.innerHTML = `<div>${escapeHtml(desde)}</div><div class="small-muted">${escapeHtml(hasta)}</div>`;

    const pubTd = document.createElement('td');
    pubTd.innerHTML = `<div>${publicar ? '<span class="inline-small">Publicado</span>' : '<span class="inline-small">No publicado</span>'}</div>`;

    const contactTd = document.createElement('td');
    contactTd.innerHTML = `<div class="small-muted">${escapeHtml(contacto)}</div>`;

    tr.appendChild(textTd);
    tr.appendChild(dateTd);
    tr.appendChild(pubTd);
    tr.appendChild(contactTd);

    tbody.appendChild(tr);
  });

  document.getElementById('promos-table').style.display = 'table';
}

/* Helpers */
function truncate(str, n){
  if(!str) return '';
  return str.length > n ? str.slice(0,n-1) + '…' : str;
}
function escapeHtml(unsafe) {
  if(unsafe === undefined || unsafe === null) return '';
  return String(unsafe).replace(/[&<"'>]/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; });
}
function toInputDateTime(value){
  if(!value) return '';
  const d = new Date(value);
  if(!isNaN(d.getTime())){
    const pad = n=>n.toString().padStart(2,'0');
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }
  return value;
}
</script>
</body>
</html>
