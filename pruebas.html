<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <title>Industrias, Comercios y Servicios</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    body { font-family:'Segoe UI','Roboto',Arial,sans-serif; font-style:italic; background:transparent; margin:0; color:#333;}
    .header{display:flex;align-items:center;padding:1rem;color:#006699;background-color:#f5e1d4;flex-wrap:wrap;width:100vw;box-sizing:border-box;}
    .header img{height:60px;margin-right:0.75rem;}
    .header h1{margin:0;font-size:2.2rem;font-weight:bold;letter-spacing:2px;line-height:1.1;}
    @media (max-width:900px){ .header h1{font-size:1.5rem;} .header img{height:40px;} }
    .selector-bar{ display: flex; gap: 0.5rem; flex-wrap: wrap; padding: 1rem 1rem 0.3rem 1rem; background: #f5e1d4; width: 100vw; box-sizing: border-box;}
    .selector-bar select {padding:0.5rem; border-radius:0.5rem; border:1px solid #ccc; font-size:1em; min-width: 120px; max-width: 100vw;}
    .buscador-global {display:flex; gap:0.5rem; padding:1rem; background: #f5e1d4; width:100vw; box-sizing:border-box;}
    .buscador-global input {padding:0.5rem; border-radius:0.5rem; border:1px solid #ccc; font-size:1em; flex:1; min-width:120px; max-width:100vw;}
    .no-tags-msg{ padding:1.2em 1em 0 1em; color:#c00; font-weight:bold;font-size:1.1em; width:100vw;box-sizing:border-box;}
    .paginacion-zocalo{ display:flex; justify-content:center; align-items:center; background:#f5e1d4; border-radius:1.5em; padding:0.6em; margin:1.2em auto; width:100vw; min-width: 0; max-width:100vw; box-sizing:border-box; box-shadow:0 2px 8px rgba(0,0,0,0.08); overflow-x:auto;}
    .pagination-bar{ display:inline-block; vertical-align:middle; margin:0 10px; background:#eaf0ea; border-radius:1.5em; padding:0.4em 1.1em; font-size:1em; width:auto; white-space:nowrap;}
    .pagination-bar button,.pagination-bar span{ margin:0 2px; padding:3px 10px; border:none; background:none; border-radius:4px; cursor:pointer; font-size:1em;}
    .pagination-bar span.active{ background:#006699; color:#fff; border:none; cursor:default; font-weight:bold;}
    .pagination-bar button[disabled]{opacity:0.5;cursor:not-allowed;}
    .pagination-bar button:hover:not([disabled]),.pagination-bar button:focus{ background:#f5e1d4; color:#006699; outline:none;}
    .pagination-bar span{color:#444;font-weight:500;}
    .pagination-bar span.dots{ cursor:default; background:none !important; color:#aaa; padding:3px 6px;}
    .grid{ display:grid; gap:1rem; grid-template-columns:1fr; padding:0.7rem; width:100vw; box-sizing:border-box; justify-content:center; align-items:start;}
    .destacadas-bar{ display:grid; gap:1rem; grid-template-columns:1fr; padding:0.7rem 0.7rem 0 0.7rem; width:100vw; box-sizing:border-box;}
    .destacadas-bar .card{ border:3px solid #d35400 !important; background:#ff7f50 !important; margin-bottom:0.5rem; color:#fff !important;}
    .card{ padding:0.8rem 0.7rem; border-radius:0.75rem; box-shadow:0 2px 6px rgba(0,0,0,0.1); background:#fff; position:relative; font-family:'Segoe UI','Roboto',Arial,sans-serif; display:flex; flex-direction:column; min-width:0; min-height:200px; max-width:600px; width:100%; margin:0 auto; box-sizing:border-box; overflow:hidden;}
    @media (max-width:600px){ .card{max-width:100vw;padding:0.5rem 0.2rem;} .grid, .destacadas-bar{padding:0.2rem;} }
    .nivel-1 { background: #b3e0ff; color: #222; }
    .nivel-2 { background: #b3e0ff; color: #222; border: 2px solid #007bff; }
    .nivel-3 { background: #fff; color: #222; }
    .nivel-4 { background: #d6a77a; }
    .nivel-5 { background: #f5e1d4; color: #222; border: 3px solid #ff7f50; }
    .logo-comercio{ max-width:110px; max-height:110px; object-fit:contain; border-radius:0.6rem; background:#fff; border:1px solid #eee; margin-bottom:1em; display:block;}
    .card .nombre{ font-weight:bold; font-size:1.1rem; color:#222; margin-bottom:0.1em; text-align:left; word-break:break-word;}
    .card .pie { font-size:1rem; color:#fff; margin-bottom:0.6em; margin-top:0.1em; text-align:left; font-weight:500; font-variant: normal; font-style:italic;
      text-shadow:
        -1px -1px 0 #000,  
         1px -1px 0 #000,
        -1px  1px 0 #000,
         1px  1px 0 #000;
      padding: 0.05em 0.25em;
      border-radius: 0.2em;
      background: rgba(0,0,0,0.08);
      display: inline-block;
    }
    .descripcion{ font-size:0.97rem; color:#333; margin-bottom:0.7em; margin-top:0.3em; width:100%; text-align:justify; white-space:pre-line; word-break:break-word;}
    .adicionales{ font-size:0.93rem; color:#333; margin-bottom:0.8em; margin-top:0.3em; width:100%; text-align:left;}
    .segmento-doble{height:0.9em;width:100%;display:block;}
    .espaciado{height:0.3em;width:100%;display:block;}
    .galeria-carrusel{ display:flex; overflow-x:auto; gap:0.5rem; margin:0.7em 0 0.5em 0; -webkit-overflow-scrolling:touch; width:100%; justify-content:flex-start; box-sizing:border-box; max-width:100vw;}
    .galeria-carrusel img.thumbnail{ flex:0 0 auto; width:96px; height:78px; object-fit:cover; border-radius:0.5rem; cursor:pointer; transition:transform 0.2s; min-width:0; max-width:100vw;}
    .galeria-carrusel img.thumbnail:hover{transform:scale(1.05);}
    .card img.thumbnail.solo{ width:100%; height:140px; max-width:100vw; max-height:180px; object-fit:contain; border-radius:0.5rem; margin:0.7em 0 0.5em 0; cursor:pointer; transition:transform 0.2s; display:block;}
    .termales-logo-container{ display:flex; justify-content:center; align-items:center; gap:0.5rem; flex-wrap:wrap; margin:0.7em 0 0.8em 0; width:100%;}
    .termales-logo{ max-width:100px; height:auto; display:inline-block; background:#fff; border-radius:0.6rem; border:1px solid #eee; padding:0.1em 0.1em;}
    @media (max-width:600px){ .termales-logo{max-width:60px;display:block;} .logo-comercio{max-width:60px;max-height:60px;} .card img.thumbnail.solo{height:90px;max-height:110px;} .galeria-carrusel img.thumbnail{width:70px;height:57px;} }
    .contacto-bloque,.redes-bloque,.web-mail-bloque{ margin-top:0.5em; margin-bottom:0.3em; width:100%; text-align:left;}
    .contacto-bloque > div, .redes-bloque > div, .web-mail-bloque > div{ margin-bottom:0.3em; word-break:break-word;}
    .badge-icons{position:absolute;top:8px;right:8px;display:flex;gap:4px;z-index:1;}
    .badge-icons img{height:40px;width:auto;}
    body.modal-open{overflow:hidden;}
    .modal-img-bg{ position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.8);z-index:9999;display:flex;align-items:center;justify-content:center;}
    .modal-img{ background:#fff;border-radius:1em;box-shadow:0 4px 32px #000c;padding:1em;position:relative;max-width:90vw;max-height:90vh;display:flex;flex-direction:column;align-items:center;}
    .modal-img img{max-width:80vw;max-height:72vh;border-radius:0.7em;box-shadow:0 2px 12px #0004;}
    .modal-img .cerrar-modal{position:absolute;top:0.7em;right:0.7em;font-size:2em;color:#d35400;background:none;border:none;cursor:pointer;}
    .modal-img .flecha-modal{position:absolute;top:50%;transform:translateY(-50%);font-size:2em;color:#006699;background:none;border:none;cursor:pointer;}
    .modal-img .flecha-modal.izq{left:0.2em;}
    .modal-img .flecha-modal.der{right:0.2em;}
    .modal-img .indicador{color:#666;font-size:1em;margin-top:0.5em;}
    .leyenda-nivel-4{background:#c00;color:#fff;font-weight:bold;text-align:center;padding:0.25em 0.4em;border-radius:0.5em;margin-top:0.7em;letter-spacing:1px;}
    .leyenda-nivel-3{background:#fff;color:#d35400;font-weight:bold;text-align:center;padding:0.25em 0.4em;border-radius:0.5em;margin-top:0.7em;border:2px solid #d35400;letter-spacing:1px;}
    .leyenda-nivel-espacio-gratis{background:#c00;color:#fff;font-weight:bold;text-align:center;padding:0.25em 0.4em;border-radius:0.5em;margin-top:0.7em;letter-spacing:1px;}
    .top-button{position:fixed;bottom:30px;right:30px;z-index:2000;background:#fff;color:#006699;font-size:2rem;padding:0.45em 0.55em;border-radius:50%;box-shadow:0 2px 8px rgba(0,0,0,0.14);border:none;cursor:pointer;display:none;align-items:center;justify-content:center;transition:background 0.15s;}
    .top-button:hover{background:#f5e1d4;}
    .nivel-1 .sin-direccion-social { background: #444; color: #fff; border-radius: 0.5em; padding: 0.5em 0.7em; text-align: center; font-style: italic; font-size: 1.05em; margin-bottom: 0.5em; margin-top: 0.2em; word-break:break-word;}
    .nivel-1 .sin-direccion-social i { color: #fff !important;}
  </style>
</head>
<body>
  <header class="header" id="titulo-principal">
    <img src="https://raw.githubusercontent.com/liqko/guia-local-dolores/refs/heads/main/img/plataforma/com.png" />
    <h1>Industrias, Comercios y Servicios</h1>
  </header>
  <div class="selector-bar">
    <select id="selectSegmento">
      <option value="">Todos los segmentos</option>
    </select>
    <select id="selectCategoria">
      <option value="">Todas las categorías</option>
    </select>
  </div>
  <div class="buscador-global">
    <input type="text" id="buscadorGlobal" placeholder="Buscar en toda la ficha (nombre, categoría, subcategoría, tags, etc.)..." style="flex:1;"/>
  </div>
  <div class="destacadas-bar" id="destacadasBar"></div>
  <div class="grid" id="contenedor"></div>
  <div class="paginacion-zocalo" id="paginador-abajo">
    <button onclick="cambiarPagina('prev')" id="btnAnterior" disabled>Anterior</button>
    <span id="paginationBar" class="pagination-bar"></span>
    <button onclick="cambiarPagina('next')" id="btnSiguiente">Siguiente</button>
  </div>
  <button id="topBtn" class="top-button" aria-label="Volver arriba" title="Volver arriba" onclick="window.scrollTo({ top: 0, behavior: 'smooth' });">↑</button>
  <div id="modalImg" style="display:none;"></div>
  <script>
    const url = 'https://opensheet.elk.sh/170kTZ-ViCPxPli86g-n_XMuMv1S3O0-DbGwNFGYVnjY/anunciantes';
    fetch(url)
      .then(res => res.json())
      .then(data => {
        const buscadorGlobal = document.getElementById('buscadorGlobal');
        const contenedor = document.getElementById('contenedor');
        const destacadasBar = document.getElementById('destacadasBar');
        const selectSegmento = document.getElementById('selectSegmento');
        const selectCategoria = document.getElementById('selectCategoria');
        const paginationBar = document.getElementById('paginationBar');
        const btnAnterior = document.getElementById('btnAnterior');
        const btnSiguiente = document.getElementById('btnSiguiente');
        const modalImg = document.getElementById('modalImg');
        const normalizar = texto => texto ? texto.toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu, "").trim() : "";

        function capitalizarFrase(str){
          return (str||"").toLowerCase()
            .replace(/(?:^|\s|-|\/)\S/g, l => l.toUpperCase());
        }
        const isAprobado = v => {
          if (typeof v === "boolean") return v;
          if (typeof v === "string") return v.trim().toLowerCase() === "true";
          return false;
        };
        function limpiarCampos(item) {
          const nuevo = {};
          for (let k in item) {
            if (!/^agregar\s/i.test(k)) nuevo[k] = item[k];
          }
          return nuevo;
        }
        const anunciantesData = data.filter(item => isAprobado(item.aprobado)).map(limpiarCampos);

        const serviciosData = anunciantesData.filter(item => {
          const segmentos = (item.segmento || '').split(',').map(s => normalizar(s));
          return segmentos.includes('turismo');
        });

        function limpiarValorCategoria(valor) {
          return valor.replace(/^"+|"+$/g, '').trim();
        }

        function obtenerCategoriasUnicas() {
          const todas = serviciosData
            .flatMap(item => (item.categoria || '').split(',').map(cat => cat.trim()))
            .filter(Boolean);
          return [...new Set(todas)].sort();
        }
        function actualizarCategorias() {
          const categoriasUnicas = obtenerCategoriasUnicas();
          selectCategoria.innerHTML = '<option value="">Todas las categorías</option>' +
            categoriasUnicas.map(cat => `<option value="${cat}">${cat}</option>`).join('');
        }

        function obtenerValoresUnicos(campo, filtro={}) {
          return [
            ...new Set(
              serviciosData
                .filter(item => {
                  let ok = true;
                  for (let k in filtro) {
                    if (!filtro[k]) continue;
                    if (!((item[k]||"").split(",").map(t=>t.trim()).includes(filtro[k]))) ok = false;
                  }
                  return ok;
                })
                .flatMap(item =>
                  campo === "categoria"
                    ? [limpiarValorCategoria((item[campo] || "").trim())]
                    : (item[campo] || "")
                        .split(",")
                        .map(r => r.trim())
                        .filter(Boolean)
                )
            )
          ].filter(Boolean).sort();
        }
        function actualizarSegmentos() {
          const segmentosUnicos = obtenerValoresUnicos('segmento');
          selectSegmento.innerHTML = '<option value="">Todos los segmentos</option>' +
            segmentosUnicos.map(seg => `<option value="${seg}">${seg}</option>`).join('');
        }
        selectSegmento.addEventListener('change', () => {
          actualizarCategorias();
          paginaActual = 1;
          render();
        });
        selectCategoria.addEventListener('change', () => {
          paginaActual = 1;
          render();
        });
        actualizarSegmentos();
        actualizarCategorias();

        function renderTermalesLogos(item) {
          const segmentos = (item.segmento || '').split(',').map(r => normalizar(r));
          let logosHtml = '';
          if (segmentos.includes('parque termal')) {
            logosHtml += `<img src="https://raw.githubusercontent.com/liqko/guia-local-dolores/refs/heads/main/img/plataforma/parque-termal.png" alt="Logo Parque Termal" class="termales-logo" />`;
          }
          if (segmentos.includes('termales mall')) {
            logosHtml += `<img src="https://raw.githubusercontent.com/liqko/guia-local-dolores/refs/heads/main/img/plataforma/mall-logo2.png" alt="Logo Termales Mall" class="termales-logo" />`;
          }
          return logosHtml ? `<div class="termales-logo-container">${logosHtml}</div>` : '';
        }

        function extraerUsuarioRedSocial(url) {
          if (!url) return '';
          if (!/^https?:\/\//.test(url)) return url;
          try {
            const u = new URL(url);
            const parts = u.pathname.replace(/^\/+|\/+$/g, '').split('/');
            if(u.hostname.includes('youtube')) {
              if(parts[0].startsWith('@')) return parts[0];
              if(['channel','user','c'].includes(parts[0])) return parts[1]||'';
              return parts[0]||'';
            }
            if(u.hostname.includes('tiktok')) {
              return '@'+parts[0];
            }
            if(u.hostname.includes('linkedin')) {
              return parts.slice(1).join('/');
            }
            return parts[0]||'';
          } catch {
            return url;
          }
        }

        function renderSocialBlockNivel1(item) {
          let redes = [];
          if (item.instagram && item.instagram.trim()) {
            redes.push(`<i class="fab fa-instagram"></i> ${extraerUsuarioRedSocial(item.instagram)}`);
          } else if (item.facebook && item.facebook.trim()) {
            redes.push(`<i class="fab fa-facebook"></i> ${extraerUsuarioRedSocial(item.facebook)}`);
          } else if (item.youtube && item.youtube.trim()) {
            redes.push(`<i class="fab fa-youtube"></i> ${extraerUsuarioRedSocial(item.youtube)}`);
          } else if (item.tiktok && item.tiktok.trim()) {
            redes.push(`<i class="fab fa-tiktok"></i> ${extraerUsuarioRedSocial(item.tiktok)}`);
          } else if (item.linkedin && item.linkedin.trim()) {
            redes.push(`<i class="fab fa-linkedin"></i> ${extraerUsuarioRedSocial(item.linkedin)}`);
          }
          return redes.length ?
            `<div class="sin-direccion-social">${redes[0]}</div>` : '';
        }

        function renderRedesBloque(item, nivelVisual) {
          let redesHtml = '';
          function plainOrLink(icon, url, usuario) {
            if (nivelVisual === 3) {
              return `<div><i class="${icon}" style="margin-right:5px;"></i>${usuario}</div><span class="espaciado"></span>`;
            } else {
              return `<div><i class="${icon}" style="margin-right:5px;"></i><a href="${url}" target="_blank" rel="noopener noreferrer">${usuario}</a></div><span class="espaciado"></span>`;
            }
          }
          if (item.instagram && item.instagram.trim()) {
            const usuario = extraerUsuarioRedSocial(item.instagram);
            redesHtml += plainOrLink('fab fa-instagram', item.instagram, usuario);
          }
          if (item.facebook && item.facebook.trim()) {
            const usuario = extraerUsuarioRedSocial(item.facebook);
            redesHtml += plainOrLink('fab fa-facebook', item.facebook, usuario);
          }
          if (item.youtube && item.youtube.trim()) {
            const usuario = extraerUsuarioRedSocial(item.youtube);
            redesHtml += plainOrLink('fab fa-youtube', item.youtube, usuario);
          }
          if (item.tiktok && item.tiktok.trim()) {
            const usuario = extraerUsuarioRedSocial(item.tiktok);
            redesHtml += plainOrLink('fab fa-tiktok', item.tiktok, usuario);
          }
          if (item.linkedin && item.linkedin.trim()) {
            const usuario = extraerUsuarioRedSocial(item.linkedin);
            redesHtml += plainOrLink('fab fa-linkedin', item.linkedin, usuario);
          }
          return redesHtml ? `<div class="redes-bloque">${redesHtml}</div>` : '';
        }

        function renderCard(item) {
          const nivelVisual = Number(item.nivel);
          const esDestacada = nivelVisual === 5 && Number(item.subnivel) === 1;
          let html = `<div class="card nivel-${nivelVisual}">`;

          html += `<div class="badge-icons">`;
          if((item.verificado||'').toLowerCase()==='x'){
            html += `<img src="https://raw.githubusercontent.com/liqko/guia-local-dolores/refs/heads/main/img/plataforma/VERIFICADO.png" alt="Verificado">`;
          }
          if((item.gold||'').toLowerCase()==='x'){
            html += `<img src="https://raw.githubusercontent.com/liqko/guia-local-dolores/refs/heads/main/img/plataforma/BEST.png" alt="Gold">`;
          }
          html += `</div>`;

          if(item.logo){
            html += `<img class="logo-comercio" src="${item.logo}" alt="Logo">`;
          }

          html += `<div class="nombre">${item.nombre}</div>`;
          if(item.pie){
            html += `<div class="pie">${capitalizarFrase(item.pie)}</div>`;
          }
          html += `<span class="espaciado"></span>`;
          html += renderTermalesLogos(item);

          if(nivelVisual === 2 && item.descripcion){
            html += `<div class="descripcion">${item.descripcion.substring(0,150)}</div>`;
            html += `<span class="segmento-doble"></span>`;
          }
          if(esDestacada && item.descripcion){
            html += `<div class="descripcion">${item.descripcion}</div>`;
            html += `<span class="segmento-doble"></span>`;
          }
          if((nivelVisual === 3 || nivelVisual === 4 || (nivelVisual === 5 && !esDestacada)) && item.descripcion){
            html += `<div class="descripcion">${item.descripcion.substring(0,1000)}</div>`;
            html += `<span class="segmento-doble"></span>`;
          }

          let dirCount = 0;
          let contactoHtml = "";
          for(let i=1;i<=6;i++){
            const dir=item[`direccion${i===1?'':i}`];
            const tel=item[`telefono${i===1?'':i}`];
            if(dir){
              dirCount++;
              contactoHtml += `<div><i class="fas fa-map-marker-alt"></i> ${dir}</div><span class="espaciado"></span>`;
              if(tel) { contactoHtml += `<div><i class="fas fa-phone"></i> ${tel}</div><span class="espaciado"></span>`; }
              const wh=item[`whatsapp${i===1?'':i}`];
              if(wh){
                if(nivelVisual === 3){
                  contactoHtml += `<div><i class="fab fa-whatsapp" style="color:#25D366;"></i> ${wh}</div><span class="espaciado"></span>`;
                }else{
                  contactoHtml += `<div><i class="fab fa-whatsapp" style="color:#25D366;"></i> <a href="https://wa.me/${wh.replace(/[^0-9]/g,'')}" target="_blank" rel="noopener noreferrer">${wh}</a></div><span class="espaciado"></span>`;
                }
              }
              if(dir && item[`maps${i===1?'':i}`]){
                if(nivelVisual === 3){
                  contactoHtml += `<div><i class="fas fa-route" style="margin-right:0.4em;color:#d35400;font-size:1.3em;"></i>${item[`maps${i===1?'':i}`]}</div><span class="espaciado"></span>`;
                }else{
                  contactoHtml += `<div style="margin:0.7em 0;"><a href="${item[`maps${i===1?'':i}`]}" target="_blank" style="display:inline-flex;align-items:center;color:#006699;font-weight:bold;text-decoration:none;font-size:1.02em;"><i class="fas fa-route" style="margin-right:0.4em;color:#d35400;font-size:1.3em;"></i>Cómo llegar</a></div>`;
                  contactoHtml += `<span class="espaciado"></span>`;
                }
              }
            }
          }
          if(dirCount>1 && item.whatsapp){
            if(nivelVisual === 3){
              contactoHtml += `<div><i class="fab fa-whatsapp" style="color:#25D366;"></i> ${item.whatsapp}</div><span class="espaciado"></span>`;
            }else{
              contactoHtml += `<div><i class="fab fa-whatsapp" style="color:#25D366;"></i> <a href="https://wa.me/${item.whatsapp.replace(/[^0-9]/g,'')}" target="_blank" rel="noopener noreferrer">${item.whatsapp}</a></div><span class="espaciado"></span>`;
            }
          }
          html += `<div class="contacto-bloque">${contactoHtml}</div>`;
          html += `<span class="segmento-doble"></span>`;

          html += renderRedesBloque(item, nivelVisual);

          let galeriaHtml = "";
          const imagenes=['img1','img2','img3','img4','img5','img6'].map(k=>item[k]).filter(Boolean);
          if(imagenes.length>1){
            galeriaHtml = `<div class="galeria-carrusel">`+
              imagenes.map((url,idx)=>
              `<img class="thumbnail" src="${url}" alt="Imagen galería" onclick="mostrarModalGaleria(this,${JSON.stringify(imagenes).replace(/"/g,'&quot;')},${idx})">`).join('')+
              `</div><span class="segmento-doble"></span>`;
          }else if(imagenes.length===1){
            galeriaHtml = `<img class="thumbnail solo" src="${imagenes[0]}" alt="Imagen" onclick="mostrarModalGaleria(this,${JSON.stringify(imagenes).replace(/"/g,'&quot;')},0)">`+
            `<span class="segmento-doble"></span>`;
          }
          html += galeriaHtml;

          let webMailHtml = "";
          if(item.link && item.link.trim()){
            if(nivelVisual === 3){
              webMailHtml += `<div><i class="fas fa-globe" style="color:#006699;margin-right:5px;"></i>${item.link}</div><span class="espaciado"></span>`;
            }else{
              webMailHtml += `<div><i class="fas fa-globe" style="color:#006699;margin-right:5px;"></i><a href="${item.link}" target="_blank" rel="noopener noreferrer">Visita nuestra web!</a></div><span class="espaciado"></span>`;
            }
          }
          if(item.mail){
            if(nivelVisual === 3){
              webMailHtml += `<div><i class="fas fa-envelope" style="color:#006699;margin-right:5px;"></i>${item.mail}</div><span class="espaciado"></span>`;
            }else{
              webMailHtml += `<div><i class="fas fa-envelope" style="color:#006699;margin-right:5px;"></i><a href="mailto:${item.mail}">${item.mail}</a></div><span class="espaciado"></span>`;
            }
          }
          if(webMailHtml){
            html += `<div class="web-mail-bloque">${webMailHtml}</div>`;
            html += `<span class="segmento-doble"></span>`;
          }

          if(nivelVisual===1){
            html+=`<div class="leyenda-nivel-4">ESPACIO GRATUITO</div><span class="segmento-doble"></span>`;
          }
          if(nivelVisual===2){
            html+=`<div class="leyenda-nivel-3">ESPACIO GRATUITO/BONIFICADO</div><span class="segmento-doble"></span>`;
          }
          if(nivelVisual===3){
            html+=`<div class="leyenda-nivel-espacio-gratis">ESPACIO GRATUITO</div><span class="segmento-doble"></span>`;
          }
          html+=`</div>`;
          return html;
        }

        function scrollTitulo() {
          const titulo = document.getElementById('titulo-principal');
          if (titulo) {titulo.scrollIntoView({behavior:'smooth',block:'start'});}
          else {window.scrollTo({top:0,behavior:'smooth'});}
        }
        function renderDestacadas(destacadas) {destacadasBar.innerHTML = destacadas.map(renderCard).join('');}
        function renderNormales(normales) {contenedor.innerHTML = normales.map(renderCard).join('');}
        window.irAPagina = function(num){paginaActual=num;render();scrollTitulo();}
        window.cambiarPagina = function(direccion){
          if (direccion === 'prev' && paginaActual > 1) {paginaActual--;}
          else if (direccion === 'next' && paginaActual < totalPaginas) {paginaActual++;}
          else if (direccion === 'primera') {paginaActual=1;}
          render();scrollTitulo();
        };

        let paginaActual = 1;
        const resultadosPorPagina = 10;
        let totalPaginas = 1;

        function getDestacadas(array) {
          return array.filter(item => Number(item.nivel) === 5 && Number(item.subnivel) === 1);
        }

        function buildPaginationBar(targetBar) {
          let html = '';
          const maxBtns = 7;
          let start = Math.max(1, paginaActual - Math.floor(maxBtns / 2));
          let end = start + maxBtns - 1;
          if (end > totalPaginas) {
            end = totalPaginas;
            start = Math.max(1, end - maxBtns + 1);
          }
          if (start > 1) {
            html += `<button onclick="cambiarPagina('primera')">1</button>`;
            if (start > 2) html += `<span class="dots">...</span>`;
          }
          for (let i = start; i <= end; i++) {
            if (i === paginaActual) {
              html += `<span class="active">${i}</span>`;
            } else {
              html += `<button onclick="irAPagina(${i})">${i}</button>`;
            }
          }
          if (end < totalPaginas) {
            if (end < totalPaginas - 1) html += `<span class="dots">...</span>`;
            html += `<button onclick="irAPagina(${totalPaginas})">${totalPaginas}</button>`;
          }
          targetBar.innerHTML = html;
        }

        function render() {
          const qGlobal = normalizar(buscadorGlobal.value.trim());
          const segmentoSeleccionado = selectSegmento.value;
          const categoriaSeleccionada = selectCategoria.value;

          let filtrados = serviciosData.filter(item => {
            let coincideSegmento = true;
            if (segmentoSeleccionado) {
              const segmentos = (item.segmento || "").split(",").map(r => normalizar(r));
              coincideSegmento = segmentos.includes(normalizar(segmentoSeleccionado));
            }
            let coincideCategoria = true;
            if (categoriaSeleccionada) {
              const categorias = (item.categoria || "").split(",").map(r => r.trim());
              coincideCategoria = categorias.includes(categoriaSeleccionada);
            }
            let coincideGlobal = true;
            if (qGlobal) {
              coincideGlobal = [
                'nombre','segmento','categoria','subcategoria','tags','adicionales','pie','descripcion'
              ].some(campo =>
                normalizar(item[campo]||"").includes(qGlobal)
              );
            }
            return coincideSegmento && coincideCategoria && coincideGlobal;
          })
          .sort((a, b) => Number(b.nivel) - Number(a.nivel) || a.subnivel - b.subnivel);

          // DESTACADAS SIEMPRE DE ANUNCIANTESDATA (NO FILTRADAS POR TURISMO)
          const destacadas = getDestacadas(anunciantesData);

          const normales = filtrados.filter(item => !(Number(item.nivel) === 5 && Number(item.subnivel) === 1));

          totalPaginas = Math.max(1, Math.ceil(normales.length / resultadosPorPagina));
          if (paginaActual > totalPaginas) paginaActual = totalPaginas;
          if (paginaActual < 1) paginaActual = 1;

          const inicio = (paginaActual - 1) * resultadosPorPagina;
          const fin = inicio + resultadosPorPagina;
          const normalesPaginadas = normales.slice(inicio, fin);

          btnAnterior.disabled = paginaActual === 1;
          btnSiguiente.disabled = paginaActual === totalPaginas;
          buildPaginationBar(paginationBar);

          renderDestacadas(destacadas);
          renderNormales(normalesPaginadas);
        }

        buscadorGlobal.addEventListener('input', () => {
          paginaActual = 1;
          render();
        });

        render();

        window.addEventListener('scroll', () => {
          const topBtn = document.getElementById('topBtn');
          if (window.scrollY > 200) {topBtn.style.display = 'flex';}
          else {topBtn.style.display = 'none';}
        });

        window.mostrarModalGaleria = function(img, imagenesArr, idx) {
          let actual = idx;
          function renderModalImg() {
            modalImg.innerHTML = `
              <div class="modal-img-bg" onclick="cerrarModalImg(event)">
                <div class="modal-img" onclick="event.stopPropagation();">
                  <button class="cerrar-modal" onclick="cerrarModalImg(event)" title="Cerrar">&times;</button>
                  ${imagenesArr.length>1?`<button class="flecha-modal izq" onclick="cambiarImg(-1,event)">&lt;</button>`:""}
                  <img src="${imagenesArr[actual]}" alt="Imagen ampliada">
                  ${imagenesArr.length>1?`<button class="flecha-modal der" onclick="cambiarImg(1,event)">&gt;</button>`:""}
                  ${imagenesArr.length>1?`<div class="indicador">${actual+1} / ${imagenesArr.length}</div>`:""}
                </div>
              </div>
            `;
            modalImg.style.display = '';
          }
          window.cambiarImg = function(dir,event){
            event.stopPropagation();
            actual += dir;
            if(actual<0) actual=imagenesArr.length-1;
            if(actual>=imagenesArr.length) actual=0;
            renderModalImg();
          }
          window.cerrarModalImg = function(event){
            event.stopPropagation();
            modalImg.style.display='none';
            modalImg.innerHTML='';
          }
          renderModalImg();
        };

      })
      .catch(e => console.error('Error cargando datos:', e));
  </script>
</body>
</html>
