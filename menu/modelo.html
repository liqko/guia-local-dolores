<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Menú</title>
  <style>
    :root{
      --bg:#0b0f14;
      --card:#121a23;
      --text:#e7eef7;
      --muted:#a9b6c6;
      --accent:#3ea6ff;
      --border:rgba(255,255,255,.08);
      --chip:#1b2633;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      background:linear-gradient(180deg,#0b0f14 0%, #0b0f14 30%, #0f1620 100%);
      color:var(--text);
    }
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{max-width:980px; margin:0 auto; padding:18px 14px 60px;}
    .topbar{
      display:flex; gap:14px; align-items:center;
      padding:14px; background:rgba(255,255,255,.03); border:1px solid var(--border);
      border-radius:16px;
    }
    .logo{
      width:72px; height:72px; border-radius:14px; object-fit:cover;
      background:#0a0f15; border:1px solid var(--border);
      flex:0 0 auto;
    }
    .title{flex:1 1 auto; min-width:0}
    .title h1{margin:0; font-size:20px; line-height:1.2}
    .sub{margin-top:6px; color:var(--muted); font-size:13px; line-height:1.35}
    .chips{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px}
    .chip{
      background:var(--chip); border:1px solid var(--border);
      padding:5px 10px; border-radius:999px; font-size:12px; color:var(--text);
    }
    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
      margin-top:14px;
    }
    @media (max-width: 860px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background:rgba(255,255,255,.03);
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
    }
    .card h2{
      margin:0 0 10px 0;
      font-size:16px;
    }
    .contacts .row{
      display:flex; gap:10px; align-items:flex-start;
      padding:8px 0; border-bottom:1px solid rgba(255,255,255,.06);
    }
    .contacts .row:last-child{border-bottom:0}
    .k{color:var(--muted); width:105px; flex:0 0 auto; font-size:13px}
    .v{font-size:13px; line-height:1.35; min-width:0}
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:10px 12px; border-radius:12px;
      border:1px solid var(--border); background:rgba(255,255,255,.04);
      color:var(--text);
      gap:8px;
      width:100%;
      margin-top:10px;
    }
    .btn:hover{background:rgba(255,255,255,.06); text-decoration:none}
    .sectionTitle{
      margin:22px 0 10px;
      font-size:18px;
    }
    .cat{
      margin-top:14px;
      padding:14px;
      border-radius:16px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.02);
    }
    .cat h3{
      margin:0 0 10px 0;
      font-size:16px;
    }
    .item{
      display:flex; gap:10px; justify-content:space-between;
      padding:10px 0;
      border-top:1px dashed rgba(255,255,255,.10);
    }
    .item:first-of-type{border-top:0}
    .item .left{max-width:75%}
    .item .name{font-size:14px; font-weight:600}
    .item .obs{font-size:12px; color:var(--muted); margin-top:4px}
    .item .price{font-size:14px; font-weight:700; white-space:nowrap; margin-left:10px}
    .muted{color:var(--muted)}
    .error{
      margin-top:14px;
      padding:12px 14px;
      border:1px solid rgba(255,80,80,.35);
      background:rgba(255,80,80,.08);
      border-radius:14px;
      font-size:13px;
      white-space:pre-wrap;
    }
    .footerNote{
      margin-top:18px;
      color:var(--muted);
      font-size:12px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <img id="logo" class="logo" alt="Logo" />
      <div class="title">
        <h1 id="nombre">Menú</h1>
        <div id="sub" class="sub"></div>
        <div id="chips" class="chips"></div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Menú</h2>
        <div class="muted" id="loading">Cargando…</div>
        <div id="menu"></div>
        <div class="footerNote">
          Si algún precio está desactualizado, consultá al comercio.
        </div>
      </div>

      <div class="card contacts">
        <h2>Contacto</h2>
        <div id="contactRows"></div>
        <a id="btnMaps" class="btn" href="#" target="_blank" rel="noopener">Abrir en Maps</a>
        <a id="btnWhats" class="btn" href="#" target="_blank" rel="noopener">WhatsApp</a>
        <a id="btnWeb" class="btn" href="#" target="_blank" rel="noopener">Ver ficha</a>
      </div>
    </div>

    <div id="err" class="error" style="display:none"></div>
  </div>

<script>
  const API_BASE = "https://login.liqkoargentina.workers.dev/menu";

  function q(name){
    const url = new URL(window.location.href);
    return url.searchParams.get(name) || "";
  }

  function clean(v){
    if(v === null || v === undefined) return "";
    const s = String(v).trim();
    // En tu import vi que "direccion" a veces viene como fecha (por formato); lo limpiamos si parece ISO
    if(/^\d{4}-\d{2}-\d{2}T/.test(s)) return "";
    return s;
  }

  function truthy(v){
    if(v === true) return true;
    const s = String(v||"").trim().toLowerCase();
    return ["true","1","x","✓","si","sí","ok"].includes(s);
  }

  async function apiGet(params){
    const u = new URL(API_BASE);
    Object.entries(params).forEach(([k,v]) => u.searchParams.set(k, v));
    const r = await fetch(u.toString(), { method:'GET' });
    const text = await r.text();
    let j;
    try{ j = JSON.parse(text); } catch(e){
      throw new Error("Respuesta no JSON desde Worker:\n" + text.slice(0,600));
    }
    return j;
  }

  function setVisible(el, ok){ el.style.display = ok ? "" : "none"; }

  function renderChips(an){
    const chips = document.getElementById('chips');
    chips.innerHTML = "";
    const badges = [];
    if(truthy(an.pet)) badges.push("Pet friendly");
    if(truthy(an.eco)) badges.push("Eco friendly");
    if(truthy(an.gayfriendly)) badges.push("Gay friendly");
    if(truthy(an.gold)) badges.push("Gold");
    if(truthy(an.verificado)) badges.push("Verificado");

    badges.forEach(b => {
      const s = document.createElement('span');
      s.className = "chip";
      s.textContent = b;
      chips.appendChild(s);
    });
  }

  function buildContactRows(an){
    const rows = [];
    const push = (k,v,link) => {
      v = clean(v);
      if(!v) return;
      rows.push({k, v, link});
    };

    // Direcciones 1..6
    for(let i=1;i<=6;i++){
      const d = i===1 ? an.direccion : an["direccion"+i];
      const m = i===1 ? an.maps : an["maps"+i];
      const t = i===1 ? an.telefono : an["telefono"+i];
      const w = i===1 ? an.whatsapp : an["whatsapp"+i];

      if(clean(d)) push("Dirección" + (i===1 ? "" : " " + i), d);
      if(clean(t)) push("Teléfono" + (i===1 ? "" : " " + i), t, "tel:" + encodeURIComponent(clean(t).replace(/\s+/g,'')));
      if(clean(w)) {
        const digits = clean(w).replace(/[^\d]/g,'');
        // WhatsApp necesita país; si ya viene con 54 ok; si no, lo dejamos igual
        const wa = digits.startsWith("54") ? digits : digits;
        push("WhatsApp" + (i===1 ? "" : " " + i), w, "https://wa.me/" + wa);
      }
      if(clean(m)) push("Maps" + (i===1 ? "" : " " + i), "Abrir ubicación", m);
    }

    push("Mail", an.mail, an.mail ? "mailto:" + clean(an.mail) : "");
    push("Instagram", an.instagram, an.instagram);
    push("Facebook", an.facebook, an.facebook);
    push("YouTube", an.youtube, an.youtube);
    push("TikTok", an.tiktok, an.tiktok);
    push("LinkedIn", an.linkedin, an.linkedin);

    const container = document.getElementById('contactRows');
    container.innerHTML = "";

    if(rows.length === 0){
      const div = document.createElement('div');
      div.className = "muted";
      div.textContent = "Sin datos de contacto.";
      container.appendChild(div);
      return;
    }

    rows.forEach(r => {
      const row = document.createElement('div');
      row.className = "row";
      const k = document.createElement('div');
      k.className = "k";
      k.textContent = r.k;

      const v = document.createElement('div');
      v.className = "v";
      if(r.link){
        const a = document.createElement('a');
        a.href = r.link;
        a.target = "_blank";
        a.rel = "noopener";
        a.textContent = r.v;
        v.appendChild(a);
      } else {
        v.textContent = r.v;
      }

      row.appendChild(k);
      row.appendChild(v);
      container.appendChild(row);
    });
  }

  function normalizePrecio(p){
    const s = clean(p);
    if(!s) return "";
    return s;
  }

  function groupMenu(items){
    // items: [{categoria,item,precio,observaciones,orden_item}]
    const byCat = new Map();
    for(const it of items){
      const cat = clean(it.categoria) || "Sin categoría";
      if(!byCat.has(cat)) byCat.set(cat, []);
      byCat.get(cat).push(it);
    }
    // ordenar items por orden_item asc
    for(const [cat, arr] of byCat.entries()){
      arr.sort((a,b) => (Number(a.orden_item||999999)-Number(b.orden_item||999999)) || String(a.item||"").localeCompare(String(b.item||"")));
    }
    return byCat;
  }

  function sortCategories(byCat, categoriasOrdenadas){
    // categoriasOrdenadas: [{categoria, orden_categoria}]
    const orderMap = new Map();
    (categoriasOrdenadas||[]).forEach(c => orderMap.set(clean(c.categoria), Number(c.orden_categoria||999999)));

    const cats = Array.from(byCat.keys());
    cats.sort((a,b) => {
      const oa = orderMap.has(a) ? orderMap.get(a) : 999999;
      const ob = orderMap.has(b) ? orderMap.get(b) : 999999;
      return (oa - ob) || a.localeCompare(b);
    });
    return cats;
  }

  function renderMenu(items, categoriasOrdenadas){
    const menuEl = document.getElementById('menu');
    menuEl.innerHTML = "";

    if(!items || items.length === 0){
      const div = document.createElement('div');
      div.className = "muted";
      div.textContent = "Este comercio todavía no cargó ítems de menú.";
      menuEl.appendChild(div);
      return;
    }

    const byCat = groupMenu(items);
    const cats = sortCategories(byCat, categoriasOrdenadas);

    cats.forEach(cat => {
      const box = document.createElement('div');
      box.className = "cat";
      const h = document.createElement('h3');
      h.textContent = cat;
      box.appendChild(h);

      const arr = byCat.get(cat) || [];
      arr.forEach(it => {
        const row = document.createElement('div');
        row.className = "item";

        const left = document.createElement('div');
        left.className = "left";

        const nm = document.createElement('div');
        nm.className = "name";
        nm.textContent = clean(it.item) || "-";

        const obs = clean(it.observaciones);
        if(obs){
          const o = document.createElement('div');
          o.className = "obs";
          o.textContent = obs;
          left.appendChild(nm);
          left.appendChild(o);
        } else {
          left.appendChild(nm);
        }

        const price = document.createElement('div');
        price.className = "price";
        price.textContent = normalizePrecio(it.precio);

        row.appendChild(left);
        row.appendChild(price);
        box.appendChild(row);
      });

      menuEl.appendChild(box);
    });
  }

  (async function main(){
    const id = q("id");
    if(!id){
      setVisible(document.getElementById('loading'), false);
      const err = document.getElementById('err');
      err.textContent = "Falta parámetro ?id=... en la URL.\nEjemplo: menu.html?id=qjvmsyue";
      setVisible(err, true);
      return;
    }

    try{
      const [an, menu, cats] = await Promise.all([
        apiGet({ action:'getAnunciante', id }),
        apiGet({ action:'getMenu', id }),
        apiGet({ action:'getCategorias', id })
      ]);

      if(!an.success) throw new Error("getAnunciante: " + (an.error || JSON.stringify(an)));
      if(!menu.success) throw new Error("getMenu: " + (menu.error || JSON.stringify(menu)));
      if(!cats.success) throw new Error("getCategorias: " + (cats.error || JSON.stringify(cats)));

      const anunciante = an.anunciante || {};
      document.getElementById('nombre').textContent = clean(anunciante.nombre) || ("Menú (" + id + ")");
      renderChips(anunciante);

      // logo
      const logoUrl = clean(anunciante.logo);
      const logoImg = document.getElementById('logo');
      if(logoUrl){
        logoImg.src = logoUrl;
        logoImg.style.display = "";
      } else {
        logoImg.style.display = "none";
      }

      // subtitle: rating + comentario count (si existen)
      const cal = clean(anunciante.calificaciones);
      const com = clean(anunciante.comentarios);
      const subBits = [];
      if(cal) subBits.push("Calificación: " + cal);
      if(com) subBits.push("Comentarios: " + com);
      document.getElementById('sub').textContent = subBits.join(" • ");

      // contactos
      buildContactRows(anunciante);

      // botones rápidos
      const btnMaps = document.getElementById('btnMaps');
      const btnWhats = document.getElementById('btnWhats');
      const btnWeb = document.getElementById('btnWeb');

      const maps1 = clean(anunciante.maps) || clean(anunciante.maps2) || "";
      btnMaps.href = maps1 || "#";
      setVisible(btnMaps, !!maps1);

      const w1 = clean(anunciante.whatsapp) || clean(anunciante.whatsapp2) || "";
      if(w1){
        const digits = w1.replace(/[^\d]/g,'');
        btnWhats.href = "https://wa.me/" + digits;
        setVisible(btnWhats, true);
      } else {
        setVisible(btnWhats, false);
      }

      const link = clean(anunciante.link);
      btnWeb.href = link || "#";
      setVisible(btnWeb, !!link);

      // menú
      renderMenu(menu.items || [], cats.categorias || []);

      setVisible(document.getElementById('loading'), false);
    } catch(err){
      setVisible(document.getElementById('loading'), false);
      const e = document.getElementById('err');
      e.textContent = String(err && err.message ? err.message : err);
      setVisible(e, true);
    }
  })();
</script>
</body>
</html>
