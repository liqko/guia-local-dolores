<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title id="dynamic-title">Eventos</title>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">
  <style>
    body { background: transparent; font-family: 'Segoe UI', 'Arial', sans-serif; font-style: italic; margin: 0; padding: 0; overflow-x: hidden; }
    .header-flex {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 0;
      margin-top: 28px;
      margin-bottom: 0;
      flex-wrap: wrap;
      width: 100%;
    }
    .main-logo {
      width: 110px;
      height: 110px;
      border-radius: 18px;
      box-shadow: 0 2px 10px rgba(44,60,90,0.10);
      background: #fff;
      object-fit: cover;
      display: block;
      transition: width 0.2s, height 0.2s;
      margin-bottom: 14px;
    }
    .header-title {
      font-size: 2.1em;
      font-weight: 800;
      color: #2b3a55;
      letter-spacing: 1px;
      font-style: italic;
      text-align: center;
      margin: 0;
      display: inline-block;
      width: auto;
      min-width: 64px;
      max-width: 90vw;
      word-break: break-word;
      background: #f3f6fb;
      border-radius: 14px;
      border: 1.5px solid #e2e8f0;
      padding: 14px 22px;
      box-shadow: 0 2px 12px rgba(44,60,90,0.08);
    }
    .search-container { display: flex; justify-content: center; margin-top: 18px; margin-bottom: 0; gap:8px; flex-wrap:wrap; }
    .search-box { width: 320px; padding: 12px 18px; font-size: 1.08em; border: 1.5px solid #d2d7e1; border-radius: 12px; outline: none; margin-bottom: 12px; box-shadow: 0 2px 7px rgba(44,60,90,0.05);}
    .search-box:focus { border-color: #3b7dd8; }
    .category-select { padding: 10px 12px; border-radius: 10px; border: 1.5px solid #d2d7e1; outline: none; font-style: italic; font-weight:600; background:#fff; box-shadow:0 2px 6px rgba(44,60,90,0.03); }
    .suma-evento-banner { width: 100%; max-width: 420px; margin: 0 auto 8px auto; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; }
    .suma-evento-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.40em; background: linear-gradient(90deg, #ffd972 0%, #ff6600 90%); color: #232323; font-family: 'Segoe UI', 'Arial', sans-serif; font-style: italic; font-weight: 800; font-size: 1.22em; border-radius: 1.1em; border: 2.5px solid #ff6600; box-shadow: 0 2px 14px #ff660022; padding: 0.7em 1.2em 0.9em 1.2em; margin-bottom: 3px; margin-top: 5px; text-decoration: none; transition: background 0.18s, color 0.18s, transform 0.18s; cursor: pointer; letter-spacing: 0.5px; outline: none; position: relative; z-index: 1;}
    .suma-evento-btn:hover { background: linear-gradient(90deg, #ff6600 0%, #ffd972 90%); color: #fff; transform: scale(1.045); box-shadow: 0 4px 18px #ff660044; border-color: #e3342f;}
    .suma-evento-btn .suma-evento-emoji { font-size: 1.6em; margin-left: 0.15em; display: inline-block; vertical-align: middle; animation: suma-bounce-right 1.15s infinite; filter: drop-shadow(0 2px 2px #ff660044); }
    @keyframes suma-bounce-right {0%, 100% { transform: translateX(0) rotate(0deg);}50% { transform: translateX(10px) rotate(-11deg);} }
    .suma-evento-btn .suma-evento-desc { background: #fffbe6; color: #0033cc; font-size: 1.05em; font-style: italic; font-weight: 700; margin-top: 8px; margin-bottom: 2px; text-align: center; text-shadow: 0 1px 12px #ffd97266; letter-spacing: 0.02em; border-radius: 0.7em; padding: 0.28em 0.7em; box-shadow: 0 2px 8px #ffd97244; width: 100%; max-width: 290px; display: block;}
    @media (max-width: 600px) {
      .header-flex { gap: 0; }
      .main-logo { width: 80px; height: 80px; margin-bottom: 10px;}
      .header-title { font-size: 1.3em; padding: 10px 8px; max-width: 99vw; }
      .suma-evento-banner { max-width: 99vw; }
      .suma-evento-btn { font-size: 1.05em; padding: 0.65em 0.7em 0.7em 0.7em; }
      .suma-evento-btn .suma-evento-desc { font-size: 0.99em; max-width: 99vw; }
      .search-box { width: calc(100% - 120px); max-width: 320px; }
    }
    .events-container { display: flex; flex-direction: column; align-items: center; gap: 18px; padding: 30px 16px; min-height: 300px; font-style: italic; }
    .event-card { width: 100%; max-width: 720px; margin: 0 auto; background: #fff; border-radius: 14px; box-shadow: 0 4px 16px rgba(60,80,120,0.08); padding: 18px; display: flex; gap: 12px; position: relative; overflow: visible; align-items: flex-start; }
    .event-left { flex: 0 0 110px; display:flex; flex-direction:column; align-items:center; gap:8px; }
    .event-left img { width: 100px; height: 100px; object-fit:cover; border-radius:10px; background:#f6f8fb; box-shadow:0 2px 10px rgba(44,60,90,0.06); }
    .event-right { flex: 1 1 auto; display:flex; flex-direction:column; gap:6px; }
    /* VIP vs FREE styles */
    .event-card.vip {
      border: 2px solid #ffd166;
      background: linear-gradient(180deg,#fffaf0 0%, #fffef8 100%);
      box-shadow: 0 8px 26px rgba(255,161,28,0.12), 0 4px 12px rgba(162,96,0,0.06);
    }
    .event-card.free {
      border: 1px solid #d6e1f3;
      background: linear-gradient(180deg,#ffffff 0%, #fbfdff 100%);
      box-shadow: 0 4px 14px rgba(44,60,90,0.06);
    }
    .event-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 0.9em;
      letter-spacing: 0.03em;
      z-index: 10;
      color: #1b2b3a;
    }
    .event-badge.vip { background: linear-gradient(90deg,#ffd166,#ff9f1c); color:#4a2b00; box-shadow: 0 3px 12px rgba(255,159,28,0.18); }
    .event-badge.free { background: #e8f1ff; color:#0e4f8a; box-shadow: 0 2px 8px rgba(14,79,138,0.06); border: 1px solid #d6e1f3; }
    .event-title { font-size: 1.18em; font-weight: 800; color: #16335a; margin: 0; font-style: italic; }
    .event-category { color: #6d3bd8; font-size: 0.98em; font-weight:700; }
    .event-meta { display:flex; gap:10px; color:#3b7dd8; font-weight:600; font-size:0.98em; align-items:center; flex-wrap:wrap; }
    .event-desc { color:#253245; text-align:justify; margin-top:6px; font-size:0.98em; }
    .event-info-adicional { color:#22529a; font-weight:600; font-style:italic; margin-top:6px; }
    .event-organizer-name { font-size:0.98em; font-weight:700; color:#1b3069; }
    .event-link { background: #3b7dd8 !important; color: #fff !important; border: none !important; box-shadow: 0 2px 7px rgba(44,60,90,0.08); padding: 10px 16px; border-radius: 8px; font-weight:700; cursor:pointer; display:inline-block; margin-top:8px; text-decoration:none; }
    .publicidad-banner { width: 100%; max-width: 720px; margin: 12px auto; display:flex; justify-content:center; align-items:center; border-radius:12px; overflow:hidden; }
    .paginator { background: #f3f6fb; border-radius: 14px; border: 1.5px solid #e2e8f0; padding: 10px 18px; box-shadow: 0 2px 12px rgba(44,60,90,0.08); margin-bottom: 14px; margin-top: 12px; display: flex; align-items: center; justify-content: center; gap: 5px; flex-wrap: wrap; font-size: 1.06em; }
    .paginator button { padding: 7px 14px; font-size: 1em; border: none; background: #3b7dd8; color: #fff; border-radius: 8px; cursor: pointer; font-weight: 600; box-shadow: 0 2px 7px rgba(44,60,90,0.08); margin: 0 1px; min-width: 40px; }
    .paginator button[disabled] { background: #b5c9e4; cursor: not-allowed; }
    #loading-indicator { display:none; text-align:center; font-size:1.2em; color:#22529a; margin-top:20px; }
    #retry-container {display:none; text-align:center; margin-top:20px;}
    #retry-container button { background:#3b7dd8; color:#fff; border:none; border-radius:8px; padding:8px 20px; font-size:1em; font-weight:600;}
    #enlaceModal { display:none; position:fixed; z-index:9999; top:0; left:0; width:100vw; height:100vh; background:#2b3a5580; align-items:center; justify-content:center; }
    #modalContent { position:relative; width:100vw; height:100vh; max-width:100vw; max-height:100vh; margin: 0; background:#fff; border-radius:0; box-shadow:0 4px 32px #2226; display: flex; flex-direction: column; }
    #cerrarModal { position:absolute; top:18px; right:18px; background:#3b7dd8; color:#fff; border:none; border-radius:50%; width:36px; height:36px; font-size:2em; cursor:pointer; z-index:10; display:flex; align-items:center; justify-content:center; }
    #modalIframe { width:100%; height:100%; border:none; flex:1; background: #ebedf5; }
    @media (max-width: 900px) {
      .event-card { max-width: calc(100% - 32px); padding: 14px; flex-direction: column; align-items: stretch; }
      .event-left { flex-direction:row; gap:12px; align-items:center; }
      .event-left img { width:80px; height:80px; }
    }
  </style>
</head>
<body>
  <div class="header-flex">
    <img id="main-logo" src="https://raw.githubusercontent.com/liqko/guia-local-dolores/refs/heads/main/img/plataforma/eventos.png" alt="Logo Principal" class="main-logo" />
    <h1 class="header-title" id="main-title">Pr√≥ximos Eventos</h1>
  </div>

  <div class="search-container">
    <input type="text" id="search" class="search-box" placeholder="Buscar por fecha, categor√≠a u organizador..." list="categories-list">
    <datalist id="categories-list"></datalist>
    <select id="categoryFilter" class="category-select" aria-label="Filtrar por categor√≠a">
      <option value="">Todas las categor√≠as</option>
    </select>
  </div>

  <div class="suma-evento-banner">
    <a class="suma-evento-btn" href="https://www.guialocaldolores.com.ar/suma-tu-evento/" target="_blank" rel="noopener">
      <span>SUM√Å TU EVENTO...GRATIS!!! <span class="suma-evento-emoji" aria-hidden="true">üëâ</span></span>
      <span class="suma-evento-desc">¬°Miles de vecinos y visitantes lo pueden ver!</span>
    </a>
  </div>

  <div id="loading-indicator">
    <span id="loading-spinner">‚è≥</span> Cargando eventos...
  </div>
  <div id="retry-container">
    <button onclick="loadEventos(true)">Reintentar</button>
  </div>

  <div class="events-container" id="events"></div>
  <div class="paginator" id="paginator"></div>

  <div id="enlaceModal">
    <div id="modalContent">
      <button id="cerrarModal">&times;</button>
      <iframe id="modalIframe" src=""></iframe>
    </div>
  </div>

  <script>
    // CONFIG: unified sheet gid and categories gid in the spreadsheet specified by the user
    const SPREADSHEET_ID = "1CCNDvrIFFufiLXmYkm4YcmtZVpk6rG2gJQQYXzA186o";
    const EVENTS_SHEET_GID = "338324539";      // hoja con los eventos unificados
    const CATEGORIES_SHEET_GID = "151081954";  // hoja con categorias en columna A desde fila 2

    const SHEET_GVIZ_BASE = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&gid=`;
    const EVENTS_URL = SHEET_GVIZ_BASE + EVENTS_SHEET_GID;
    const CATEGORIES_URL = SHEET_GVIZ_BASE + CATEGORIES_SHEET_GID;

    // remove footer usage: no footer needed per request

    function aplicarConfig() {
      // update title/logo if desired (keeps previous assets)
      document.getElementById('main-logo').src = "https://raw.githubusercontent.com/liqko/guia-local-dolores/refs/heads/main/img/plataforma/CAPACITACION.png";
      document.getElementById('main-title').textContent = "Listado Unificado de Eventos";
      document.getElementById('dynamic-title').textContent = "Eventos";
      document.getElementById('search').placeholder = "Buscar por fecha, categor√≠a u organizador...";
    }

    // ---------- Adaptador para HOJA UNIFICADA (orden de columnas proporcionado)
    function adaptarFilaUnificada(c) {
      // mapping according to provided structure (zero-based):
      // 0: aprobado
      // 1: nivel
      // 2: evento_id
      // 3: id_anunciante
      // 4: organizador
      // 5: logo_organizador
      // 6: categoria
      // 7: logo_categoria
      // 8: nombre_evento
      // 9: localidad
      // 10: lugar
      // 11: direccion
      // 12: llegar
      // 13: fecha
      // 14: hora
      // 15: hora2
      // 16: descripcion
      // 17: instagram
      // 18: img1
      // 19: img2
      // 20: img3
      // 21: entradas
      // partners etc omitted for brevity, but we can concatenate as auspiciantes
      const get = (idx) => (c[idx] && c[idx].v !== undefined) ? c[idx].v : "";
      const partners = [];
      for (let p = 22; p <= 33; p += 2) {
        const name = get(p);
        if (name) partners.push(name);
      }
      return {
        aprobado:        get(0),
        nivel:           get(1),
        evento_id:       get(2),
        id_anunciante:   get(3),
        organizador_principal: get(4),
        logo_organizador: get(5),
        categoria:       get(6),
        nombre:          get(8),
        localidad:       get(9),
        lugar:           get(10),
        direccion:       get(11),
        llegar:          get(12),
        fecha:           get(13),
        fecha_humana:    fechaHumana(get(13)),
        hora:            get(14),
        hora2:           get(15),
        descripcion:     get(16),
        instagram:       get(17),
        img1:            get(18),
        entradas:        get(21),
        auspiciantes:    partners.join(", "),
        enlace:          "", // not present in mapping; leave empty
        logo:            get(18)
      };
    }

    // ---------- helpers
    function isVerificado(v) {
      if (!v) return false;
      const s = String(v).toLowerCase().trim();
      return ["si","s√≠","true","ok","‚úì","x","check","checked","1"].includes(s);
    }

    function fechaHumana(valor) {
      if (!valor) return "";
      if (/^\d{4}-\d{2}-\d{2}$/.test(valor)) {
        const [anio, mes, dia] = valor.split("-");
        const fecha = new Date(parseInt(anio,10), parseInt(mes,10)-1, parseInt(dia,10));
        const meses = ["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"];
        const dias = ["Domingo","Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado"];
        return `${dias[fecha.getDay()]} ${parseInt(dia,10)} de ${meses[parseInt(mes,10)-1]} de ${anio}`;
      }
      if (/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/.test(valor)) {
        const match = valor.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
        const dia = match[1], mes = match[2], anio = match[3];
        const fecha = new Date(parseInt(anio,10), parseInt(mes,10)-1, parseInt(dia,10));
        const meses = ["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"];
        const dias = ["Domingo","Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado"];
        return `${dias[fecha.getDay()]} ${parseInt(dia,10)} de ${meses[parseInt(mes,10)-1]} de ${anio}`;
      }
      if (/^Date\((\d{4}),\s*(\d+),\s*(\d+)\)$/.test(valor)) {
        const match = valor.match(/^Date\((\d{4}),\s*(\d+),\s*(\d+)\)$/);
        const anio = match[1], mes = match[2], dia = match[3];
        const fecha = new Date(parseInt(anio,10), parseInt(mes,10), parseInt(dia,10));
        const meses = ["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"];
        const dias = ["Domingo","Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado"];
        return `${dias[fecha.getDay()]} ${fecha.getDate()} de ${meses[fecha.getMonth()]} de ${fecha.getFullYear()}`;
      }
      return valor;
    }

    function horaHumana(valor) {
      if (!valor) return "";
      let m = valor.match(/^Date\(\d{4},\d{1,2},\d{1,2},(\d{1,2}),(\d{1,2})/);
      if (m) {
        let h = String(m[1]).padStart(2, "0"), min = String(m[2]).padStart(2, "0");
        return `${h}:${min} hs`;
      }
      m = valor.match(/^(\d{1,2}):(\d{2})(:\d{2})?$/);
      if (m) {
        return `${String(m[1]).padStart(2,"0")}:${m[2]} hs`;
      }
      return valor;
    }

    function detectNivel(cells) {
      // prefer the 'nivel' column if present (index 1)
      if (cells && cells[1] && cells[1].v) {
        const s = String(cells[1].v).toLowerCase().trim();
        if (s.indexOf('vip') !== -1) return 'vip';
        if (s.indexOf('free') !== -1) return 'free';
      }
      // fallback: scan all cells for the words
      for (let i=0;i<cells.length;i++){
        try {
          const raw = cells[i] && (cells[i].v !== undefined ? String(cells[i].v) : String(cells[i])) || "";
          const s = raw.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim();
          if (!s) continue;
          if (s.indexOf('vip') !== -1) return 'vip';
          if (s.indexOf('free') !== -1) return 'free';
        } catch(e){}
      }
      return '';
    }

    // ------------ categories fetching and population into datalist/select
    let categoriesList = [];
    function fetchCategories() {
      return fetch(CATEGORIES_URL)
        .then(res => res.text())
        .then(text => {
          try {
            const json = JSON.parse(text.substr(47).slice(0, -2));
            const rows = json.table.rows || [];
            const cats = [];
            for (let i = 0; i < rows.length; i++) {
              const c = rows[i].c;
              if (!c || !c[0]) continue;
              const val = String(c[0].v || "").trim();
              if (val) cats.push(val);
            }
            // unique and sort
            categoriesList = Array.from(new Set(cats)).sort((a,b)=>a.localeCompare(b,'es',{sensitivity:'base'}));
            // populate datalist
            const dl = document.getElementById('categories-list');
            dl.innerHTML = categoriesList.map(x => `<option value="${x}">`).join('');
            // populate select filter
            const sel = document.getElementById('categoryFilter');
            // keep current selection
            const cur = sel.value || "";
            sel.innerHTML = '<option value="">Todas las categor√≠as</option>' + categoriesList.map(x => `<option value="${x}">${x}</option>`).join('');
            if (cur) sel.value = cur;
          } catch(e) {
            console.warn('fetchCategories parse error', e);
          }
        })
        .catch(err=>{
          console.warn('fetchCategories failed', err);
        });
    }

    // ---------- core: load events from unified sheet
    let eventosData = [], eventosFiltrados = [], currentPage = 1, eventsPerPage = 6;
    let fetchAttempts = 0, maxFetchAttempts = 3;
    function showLoading(show=true) {
      document.getElementById('loading-indicator').style.display = show ? 'block' : 'none';
      if (show) document.getElementById('loading-indicator').querySelector('span').textContent = 'Cargando eventos...';
    }
    function showRetry(show=true) { document.getElementById('retry-container').style.display = show ? 'block' : 'none'; }

    function loadEventos(forceRetry=false) {
      aplicarConfig();
      showLoading(true); showRetry(false);
      document.getElementById('events').innerHTML = "";
      if (!forceRetry) fetchAttempts++;
      else fetchAttempts = 1;
      // load categories in parallel to help search UX
      fetchCategories().finally(() => {
        fetch(EVENTS_URL)
          .then(res => res.text())
          .then(text => {
            showLoading(false); showRetry(false);
            try {
              const json = JSON.parse(text.substr(47).slice(0, -2));
              const rows = json.table.rows || [];
              eventosData = [];
              for (let i = 0; i < rows.length; i++) {
                const c = rows[i].c || [];
                // verification column is column A (index 0)
                if (!c[0] || !isVerificado(c[0].v || "")) continue;
                const ev = adaptarFilaUnificada(c);
                // nivel detection if empty: try detectNivel(c)
                if (!ev.nivel || ev.nivel === "") ev.nivel = detectNivel(c) || "";
                eventosData.push(ev);
              }
              // sort by fecha when available
              if (eventosData.length && eventosData[0].fecha) {
                eventosData.sort(function(a, b) {
                  function toISO(str) {
                    if (!str) return "";
                    if (/^\d{4}-\d{2}-\d{2}$/.test(str)) return str;
                    let m = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
                    if (m) return `${m[3]}-${m[2].padStart(2,"0")}-${m[1].padStart(2,"0")}`;
                    return str;
                  }
                  return toISO(a.fecha || "").localeCompare(toISO(b.fecha || ""));
                });
              }
              eventosFiltrados = eventosData.slice();
              currentPage = 1;
              renderEventos(eventosFiltrados, currentPage);
            } catch(e) {
              console.error('parse events error', e);
              document.getElementById('events').innerHTML = `<p style="color:#b02a2a; font-weight:bold">Error procesando datos. Revise formato de la hoja.</p>`;
            }
          })
          .catch(error => {
            showLoading(false);
            if (fetchAttempts < maxFetchAttempts) setTimeout(() => loadEventos(), 1500);
            else {
              document.getElementById('events').innerHTML = `<p style="color:#b02a2a; font-weight:bold">No se pudieron cargar los datos. Verifica que la hoja est√© publicada y disponible.<br>Error: ${error}</p>`;
              showRetry(true);
            }
          });
      });
    }

    function aplicarFiltro(search, category) {
      const filtro = String(search || "").trim().toLowerCase();
      const cat = String(category || "").trim().toLowerCase();
      eventosFiltrados = eventosData.filter(ev => {
        // skip empty
        if (!ev || (!ev.nombre && !ev.fecha && !ev.organizador_principal)) return false;
        // category filter
        if (cat) {
          if (!ev.categoria || ev.categoria.toLowerCase().indexOf(cat) === -1) return false;
        }
        if (!filtro) return true;
        const buscarEn = [
          ev.fecha_humana, ev.categoria, ev.nombre, ev.organizador_principal, ev.auspiciantes, ev.descripcion, ev.lugar
        ].join(" ").toLowerCase();
        return buscarEn.includes(filtro);
      });
      currentPage = 1;
      renderEventos(eventosFiltrados, currentPage);
    }

    function renderInstagramBlock(instagram) {
      if (!instagram || typeof instagram !== "string" || instagram.trim() === "") return "";
      if (instagram.match(/\.(jpg|jpeg|png)(\?.*)?$/)) {
        return `<div style="margin-top:8px;"><img src="${instagram}" alt="Imagen del evento" style="width:100%;max-width:220px;border-radius:8px;"></div>`;
      }
      if (instagram.includes("instagram.com")) {
        let url = instagram.trim();
        let postMatch = url.match(/instagram\.com\/(p|reel|tv)\/([a-zA-Z0-9_-]+)/);
        if (postMatch) {
          let code = postMatch[2];
          return `<div class="event-instagram-block">
            <div class="event-instagram-iframe-wrapper">
              <iframe src="https://www.instagram.com/${postMatch[1]}/${code}/embed" allowtransparency="true" allowfullscreen></iframe>
              <div class="no-click-overlay"></div>
            </div>
          </div>`;
        }
        return "";
      }
      return "";
    }

    function textoAParrafoJustificado(texto) {
      if (!texto) return '';
      let partes = texto.split(/\n\s*\n/);
      if (partes.length === 1) partes = texto.split(/\n/);
      return partes.map(p => `<p style="text-align:justify;margin:6px 0 6px 0;">${p.trim()}</p>`).join('');
    }

    function eventoEsDestacadoAcp(ev) {
      if (!ev) return false;
      const contains = (t) => t && String(t).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').includes('acp');
      return contains(ev.nombre) || contains(ev.descripcion) || contains(ev.organizador_principal) || contains(ev.categoria);
    }

    function renderEventos(data, page=1) {
      const eventsDiv = document.getElementById('events');
      eventsDiv.innerHTML = "";
      const start = (page-1)*eventsPerPage, end = start + eventsPerPage, pageData = data.slice(start, end);
      let eventosMostrados = 0;
      pageData.forEach((ev, idx) => {
        const levelClass = ev.nivel && String(ev.nivel).toLowerCase().indexOf('vip') !== -1 ? 'vip' :
                           (ev.nivel && String(ev.nivel).toLowerCase().indexOf('free') !== -1 ? 'free' : '');
        const highlighted = eventoEsDestacadoAcp(ev) ? " destacada-acp" : "";
        const card = document.createElement('div');
        card.className = `event-card ${levelClass}${highlighted}`;

        // left block with logo/image
        const left = document.createElement('div');
        left.className = 'event-left';
        const img = document.createElement('img');
        img.alt = ev.nombre || 'imagen evento';
        img.src = ev.logo || ev.img1 || '';
        left.appendChild(img);

        // right block with details
        const right = document.createElement('div');
        right.className = 'event-right';

        // badge
        if (levelClass) {
          const badge = document.createElement('div');
          badge.className = 'event-badge ' + levelClass;
          badge.textContent = levelClass.toUpperCase();
          card.appendChild(badge);
        }

        // title
        const title = document.createElement('div');
        title.className = 'event-title';
        title.textContent = ev.nombre || '';
        right.appendChild(title);

        // category
        if (ev.categoria) {
          const cat = document.createElement('div');
          cat.className = 'event-category';
          cat.textContent = ev.categoria;
          right.appendChild(cat);
        }

        // meta row (date / time / place)
        const meta = document.createElement('div');
        meta.className = 'event-meta';
        if (ev.fecha_humana) {
          const d = document.createElement('div'); d.innerHTML = `<i class="ri-calendar-event-line"></i>&nbsp; ${ev.fecha_humana}`; meta.appendChild(d);
        }
        const horaMostrar = ev.hora && ev.hora.trim() !== "" ? ev.hora : (ev.hora2 && ev.hora2.trim() !== "" ? ev.hora2 : "");
        if (horaMostrar) {
          const t = document.createElement('div'); t.innerHTML = `<i class="ri-time-line"></i>&nbsp; ${horaHumana(horaMostrar)}`; meta.appendChild(t);
        }
        if (ev.lugar) {
          const l = document.createElement('div'); l.innerHTML = `<i class="ri-map-pin-line"></i>&nbsp; ${ev.lugar}`; meta.appendChild(l);
        }
        right.appendChild(meta);

        // description
        if (ev.descripcion) {
          const desc = document.createElement('div');
          desc.className = 'event-desc';
          desc.innerHTML = textoAParrafoJustificado(ev.descripcion);
          right.appendChild(desc);
        }

        // info adicional (direccion/llegar)
        let infoAdd = '';
        if (ev.direccion) infoAdd += `Direcci√≥n: ${ev.direccion}. `;
        if (ev.llegar) infoAdd += `C√≥mo llegar: ${ev.llegar}. `;
        if (infoAdd) {
          const info = document.createElement('div');
          info.className = 'event-info-adicional';
          info.innerHTML = `<i class="ri-information-line"></i>&nbsp; ${infoAdd}`;
          right.appendChild(info);
        }

        // sponsors
        if (ev.auspiciantes) {
          const sponsors = document.createElement('div');
          sponsors.style.marginTop = '8px';
          sponsors.innerHTML = `<strong>Auspicia:</strong> ${ev.auspiciantes}`;
          right.appendChild(sponsors);
        }

        // organizer
        if (ev.organizador_principal) {
          const org = document.createElement('div');
          org.className = 'event-organizer-name';
          org.textContent = `Organiza: ${ev.organizador_principal}`;
          right.appendChild(org);
        }

        // enlace / boton
        if (ev.enlace && ev.enlace.trim() !== "") {
          const btn = document.createElement('a');
          btn.className = 'event-link';
          btn.href = '#';
          btn.setAttribute('data-url', ev.enlace);
          btn.textContent = 'Entradas / M√°s info';
          btn.onclick = function(e){ e.preventDefault(); abrirEnlaceModal(this.getAttribute('data-url')); };
          right.appendChild(btn);
        }

        // instagram / image block
        const ig = renderInstagramBlock(ev.instagram);
        if (ig) {
          const wrapper = document.createElement('div');
          wrapper.innerHTML = ig;
          right.appendChild(wrapper);
        }

        card.appendChild(left);
        card.appendChild(right);
        eventsDiv.appendChild(card);
        eventosMostrados++;

        // banner insertion every 2 cards (optional)
        if ((idx + 1) % 2 === 0 && idx < pageData.length - 1) {
          const bannerDiv = document.createElement('div');
          bannerDiv.className = 'publicidad-banner';
          bannerDiv.innerHTML = `<a href="https://www.guialocaldolores.com.ar/anunciantes/" target="_blank"><img src="https://raw.githubusercontent.com/liqko/guia-local-dolores/refs/heads/main/eventos/banner-eventos.png" alt="Banner"></a>`;
          eventsDiv.appendChild(bannerDiv);
        }
      });

      if (eventosMostrados === 0) {
        eventsDiv.innerHTML = "<p style='color:#b02a2a; font-weight:bold'>No hay eventos para mostrar con ese criterio de b√∫squeda.</p>";
      }
      renderPaginator(data.length, page);
    }

    function renderPaginator(total, page) {
      const paginatorDiv = document.getElementById('paginator');
      const totalPages = Math.ceil(total / eventsPerPage);
      if (totalPages <= 1) { paginatorDiv.innerHTML = ""; return; }
      let buttonsHtml = '';
      buttonsHtml += `<button id="prevPage" ${page <= 1 ? "disabled" : ""}>Anterior</button>`;
      let pagesToShow = [];
      pagesToShow.push(1);
      if (totalPages > 1) pagesToShow.push(totalPages);
      for (let i = 2; i <= Math.min(3, totalPages-1); i++) { pagesToShow.push(i); }
      for (let i = Math.max(totalPages-2, 2); i < totalPages; i++) { if (i !== 1 && i !== totalPages) pagesToShow.push(i); }
      for (let i = page-2; i <= page+2; i++) { if (i > 1 && i < totalPages) pagesToShow.push(i); }
      pagesToShow = Array.from(new Set(pagesToShow)).sort((a, b) => a - b);
      let lastPage = 0;
      for (let i = 0; i < pagesToShow.length; i++) {
        let p = pagesToShow[i];
        if (p - lastPage > 1) {
          buttonsHtml += `<span class="page-ellipsis">...</span>`;
        }
        if (p === page) {
          buttonsHtml += `<span class="page-info" style="font-weight:bold;background:#d8e4f8;color:#22529a;border-radius:5px;padding:2px 8px;">${p}</span>`;
        } else {
          buttonsHtml += `<button class="page-btn" data-page="${p}">${p}</button>`;
        }
        lastPage = p;
      }
      buttonsHtml += `<button id="nextPage" ${page >= totalPages ? "disabled" : ""}>Siguiente</button>`;
      paginatorDiv.innerHTML = buttonsHtml;
      document.getElementById('prevPage').onclick = () => { if (currentPage > 1) { currentPage--; renderEventos(eventosFiltrados, currentPage); scrollToEvents(); }};
      document.getElementById('nextPage').onclick = () => { if (currentPage < totalPages) { currentPage++; renderEventos(eventosFiltrados, currentPage); scrollToEvents(); }};
      document.querySelectorAll('.page-btn').forEach(btn => {
        btn.onclick = function() {
          const goto = parseInt(this.getAttribute('data-page'),10);
          if (!isNaN(goto) && goto !== currentPage) {
            currentPage = goto;
            renderEventos(eventosFiltrados, currentPage);
            scrollToEvents();
          }
        }
      });
    }

    function scrollToEvents() {
      const el = document.getElementById('events');
      if (el) el.scrollIntoView({behavior:"smooth",block:"start"});
    }

    document.getElementById('search').addEventListener('input', function() { aplicarFiltro(this.value, document.getElementById('categoryFilter').value); });
    document.getElementById('categoryFilter').addEventListener('change', function(){ aplicarFiltro(document.getElementById('search').value, this.value); });

    function abrirEnlaceModal(url) {
      if (!url) return;
      var postMatch = url.match(/instagram\.com\/(p|reel|tv)\/([a-zA-Z0-9_-]+)/);
      if (postMatch) {
        var embedUrl = `https://www.instagram.com/${postMatch[1]}/${postMatch[2]}/embed`;
        document.getElementById('modalIframe').src = embedUrl;
        document.getElementById('enlaceModal').style.display = 'flex';
      } else if (/instagram\.com/.test(url)) {
        window.open(url, "_blank");
      } else {
        document.getElementById('modalIframe').src = url;
        document.getElementById('enlaceModal').style.display = 'flex';
      }
    }
    document.getElementById('cerrarModal').onclick = function() {
      document.getElementById('enlaceModal').style.display = 'none';
      document.getElementById('modalIframe').src = '';
    };
    document.getElementById('enlaceModal').onclick = function(e) {
      if (e.target === this) {
        document.getElementById('enlaceModal').style.display = 'none';
        document.getElementById('modalIframe').src = '';
      }
    };

    // init
    aplicarConfig();
    loadEventos();
  </script>
</body>
</html>
