<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Agenda de Eventos</title>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">
  <style>
    :root{
      --accent:#22529a;
      --vip:#ff8c00;
      --muted:#6b7b8f;
      --bg:#f6f9fd;
      --card:#ffffff;
      --radius:10px;
      --shadow: 0 8px 30px rgba(16,30,60,0.06);
    }
    html,body { height:100%; margin:0; padding:0; background:var(--bg); color:#122033; font-family:Inter, Arial, Helvetica, sans-serif; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    .wrap { max-width:1100px; margin:20px auto; padding:20px; box-sizing:border-box; }
    header { display:flex; gap:14px; align-items:center; }
    .logo { width:64px; height:64px; border-radius:12px; background:#fff; padding:6px; box-shadow:0 6px 18px rgba(0,0,0,0.04); object-fit:cover; }
    h1 { margin:0; color:var(--accent); font-size:1.4rem; }
    .subtitle { margin:4px 0 0; color:var(--muted); font-size:0.95rem; }

    .controls { display:flex; gap:12px; align-items:center; margin-top:16px; flex-wrap:wrap; }
    .search { flex:1 1 320px; min-width:220px; padding:10px 12px; border-radius:12px; border:1px solid #e6edf6; background:#fff; }
    .select { padding:9px 10px; border-radius:10px; border:1px solid #e6edf6; background:#fff; min-width:160px; }

    .cards { margin-top:18px; display:flex; flex-direction:column; gap:14px; }
    .card { background:var(--card); border-radius:var(--radius); padding:12px; box-shadow:var(--shadow); display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap; }
    .card.vip { border-left:6px solid var(--vip); }
    .thumb { width:110px; height:80px; object-fit:cover; border-radius:8px; background:#f3f5f8; }
    .info { flex:1 1 420px; }
    .title { margin:0; font-weight:800; color:#122033; font-size:1.06rem; }
    .meta { color:var(--muted); font-size:0.92rem; margin-top:6px; display:flex; gap:8px; flex-wrap:wrap; }
    .desc { margin-top:8px; color:#263448; font-size:0.95rem; max-height:86px; overflow:hidden; }

    .partners { margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .partner-logo { width:48px; height:48px; object-fit:contain; border-radius:6px; background:#fff; border:1px solid #eef2f7; padding:4px; }

    .pager { margin-top:18px; display:flex; gap:12px; justify-content:center; align-items:center; }
    .btn { padding:8px 12px; border-radius:10px; background:var(--accent); color:#fff; border:none; cursor:pointer; font-weight:800; }
    .btn.alt { background:#fff; color:var(--accent); border:1px solid #e6edf6; }

    .empty { color:#b02a2a; font-weight:800; margin-top:16px; }

    @media (max-width:800px) {
      .thumb { width:84px; height:64px; }
      .info { flex-basis:100%; }
      header { flex-direction:column; align-items:flex-start; gap:8px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <img class="logo" id="logo" src="https://raw.githubusercontent.com/liqko/guia-local-dolores/refs/heads/main/img/plataforma/eventos.png" alt="logo">
      <div>
        <h1>Agenda de Eventos</h1>
        <div class="subtitle">Explorá los eventos aprobados — VIPs destacados, gratuitos en lista compacta.</div>
      </div>
    </header>

    <div class="controls" role="region" aria-label="Controles de búsqueda y filtros">
      <input id="search" class="search" placeholder="Buscar por nombre, descripción, lugar..." aria-label="Buscar eventos">
      <select id="selCategory" class="select" aria-label="Filtrar por categoría"><option value="">Todas las categorías</option></select>
      <select id="selOrganizer" class="select" aria-label="Filtrar por organizador"><option value="">Todos los organizadores</option></select>
    </div>

    <div id="cards" class="cards" aria-live="polite"></div>

    <div class="pager" id="pager" aria-hidden="false"></div>
  </div>

  <script>
    // CONFIG
    const DATA_URL = "https://docs.google.com/spreadsheets/d/1CCNDvrIFFufiLXmYkm4YcmtZVpk6rG2gJQQYXzA186o/gviz/tq?tqx=out:json&gid=338324539";

    // Indices fijos (estructura que proporcionaste)
    const IDX = {
      aprobado: 0, nivel: 1, nombre: 8, organizador: 4, logo_organizador: 5, categoria: 6,
      lugar: 10, direccion: 11, fecha: 13, hora: 14, hora2: 15, descripcion: 16,
      instagram: 17, img1: 18, img2: 19, img3: 20, entradas: 21
    };

    // Estado
    let all = [], filtered = [], approvedCount = 0;
    const PER_PAGE = 8;
    let page = 1;

    // UI elems
    const searchEl = document.getElementById('search');
    const selCategory = document.getElementById('selCategory');
    const selOrganizer = document.getElementById('selOrganizer');
    const cardsEl = document.getElementById('cards');
    const pagerEl = document.getElementById('pager');

    // UTILITIES
    const safe = v => v === null || v === undefined ? "" : String(v);
    const esc = s => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    const safeUrl = u => { if(!u) return ""; u = String(u).trim(); if(/^https?:\/\//i.test(u)) return u; if(/^www\./i.test(u)) return 'https://' + u; return u; };

    function isCheckedValue(v){
      if (v === true) return true;
      if (v === false) return false;
      if (typeof v === 'number') return v === 1;
      const s = String(v||'').toLowerCase().trim();
      return ['si','sí','true','1','ok','✓','x'].includes(s);
    }

    function dateISO(valor) {
      if (valor === null || valor === undefined || valor === '') return "";
      valor = String(valor).trim();
      if (/^\d{4}-\d{2}-\d{2}$/.test(valor)) return valor;
      let m = valor.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if (m) return `${m[3]}-${String(m[2]).padStart(2,'0')}-${String(m[1]).padStart(2,'0')}`;
      m = valor.match(/^Date\((\d{4}),\s*(\d+),\s*(\d+)/);
      if (m) return `${m[1]}-${String(Number(m[2])).padStart(2,'0')}-${String(Number(m[3])).padStart(2,'0')}`;
      const parsed = Date.parse(valor);
      if (!isNaN(parsed)) {
        const d = new Date(parsed);
        return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
      }
      return valor;
    }

    function fechaHumana(valor) {
      if (!valor) return "";
      const iso = dateISO(String(valor));
      if (!/^\d{4}-\d{2}-\d{2}$/.test(iso)) return String(valor);
      const [y,m,d] = iso.split('-').map(Number);
      const date = new Date(y,m-1,d);
      const dias = ["domingo","lunes","martes","miércoles","jueves","viernes","sábado"];
      const meses = ["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"];
      return `${dias[date.getDay()]} ${date.getDate()} de ${meses[date.getMonth()]} de ${date.getFullYear()}`;
    }

    function horaHumana(valor) {
      if (!valor) return "";
      const s = String(valor).trim();
      let m = s.match(/^Date\(\d{4},\d{1,2},\d{1,2},(\d{1,2}),(\d{1,2})/);
      if (m) return `${String(m[1]).padStart(2,'0')}:${String(m[2]).padStart(2,'0')} hs`;
      m = s.match(/^(\d{1,2}):(\d{2})/);
      if (m) return `${String(m[1]).padStart(2,'0')}:${m[2]} hs`;
      return s;
    }

    function horaUnificadaObj(ev){
      const h2 = ev && ev.hora2 ? String(ev.hora2||'').trim() : '';
      const h1 = ev && ev.hora ? String(ev.hora||'').trim() : '';
      const chosen = h2 !== '' ? h2 : h1;
      return chosen ? horaHumana(chosen) : '';
    }

    // LOAD
    async function load() {
      // fetch GViz
      try {
        const res = await fetch(DATA_URL, { cache: "no-store" });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const text = await res.text();
        const start = text.indexOf('{'), end = text.lastIndexOf('}');
        if (start === -1 || end === -1) throw new Error('Respuesta inesperada (gviz wrapper no encontrada)');
        const jsonText = text.substring(start, end+1);
        const obj = JSON.parse(jsonText);
        const rows = (obj.table && obj.table.rows) ? obj.table.rows : [];

        all = []; approvedCount = 0;
        const cats = new Set();
        const orgs = new Set();

        for (let i=0;i<rows.length;i++){
          const c = rows[i].c || [];
          const val = idx => {
            if (!c[idx]) return "";
            if (c[idx].v !== undefined) return c[idx].v;
            if (c[idx].f !== undefined) return c[idx].f;
            return "";
          };

          const aproRaw = val(IDX.aprobado);
          const aprobado = isCheckedValue(aproRaw);

          const ev = {
            aprobado,
            nivel: safe(val(IDX.nivel)),
            nombre: safe(val(IDX.nombre)),
            organizador: safe(val(IDX.organizador)),
            logo_organizador: safe(val(IDX.logo_organizador)),
            categoria: safe(val(IDX.categoria)),
            lugar: safe(val(IDX.lugar)),
            direccion: safe(val(IDX.direccion)),
            fecha: safe(val(IDX.fecha)),
            fecha_iso: dateISO(safe(val(IDX.fecha))),
            hora: safe(val(IDX.hora)),
            hora2: safe(val(IDX.hora2)),
            descripcion: safe(val(IDX.descripcion)),
            instagram: safe(val(IDX.instagram)),
            imgs: [safe(val(IDX.img1)), safe(val(IDX.img2)), safe(val(IDX.img3))].filter(Boolean),
            entradas: safe(val(IDX.entradas)),
            partners: []
          };

          for (let p=22; p<=32; p+=2){
            const name = val(p); const logo = val(p+1);
            if (name || logo) ev.partners.push({ name: safe(name), logo: safe(logo) });
          }

          all.push(ev);
          if (ev.categoria) cats.add(ev.categoria);
          if (ev.organizador) orgs.add(ev.organizador);
          if (ev.aprobado) approvedCount++;
        }

        // sort: VIP first, then by date asc
        all.sort((a,b) => {
          const aVip = (a.nivel||'').toLowerCase().includes('vip') ? 0 : 1;
          const bVip = (b.nivel||'').toLowerCase().includes('vip') ? 0 : 1;
          if (aVip !== bVip) return aVip - bVip;
          return String(a.fecha_iso || '').localeCompare(String(b.fecha_iso || ''));
        });

        // populate filters from approved only
        const approvedEvents = all.filter(e => e.aprobado);
        populate(selCategory, new Set(approvedEvents.map(e=>e.categoria).filter(Boolean)));
        populate(selOrganizer, new Set(approvedEvents.map(e=>e.organizador).filter(Boolean)));

        filtered = approvedEvents.slice();
        page = 1;
        renderCards();
        renderPager();

        // keep console diagnostic for debugging (not shown in UI)
        console.log('EVENTS LOADED:', { total: all.length, approved: approvedCount });
      } catch (err) {
        console.error('Carga eventos error', err);
        cardsEl.innerHTML = `<div class="empty">No se pudieron cargar los eventos. Revisa la consola para más detalles.</div>`;
      }
    }

    // FILTER & RENDER (strict approved)
    function applyFilters(){
      const q = (searchEl.value||'').trim().toLowerCase();
      const cat = selCategory.value;
      const org = selOrganizer.value;
      let source = all.filter(e => !!e.aprobado);
      filtered = source.filter(ev => {
        if (cat && (!ev.categoria || String(ev.categoria).toLowerCase() !== String(cat).toLowerCase())) return false;
        if (org && (!ev.organizador || String(ev.organizador).toLowerCase() !== String(org).toLowerCase())) return false;
        if (q) {
          const hay = [ev.nombre, ev.descripcion, ev.lugar, ev.direccion, ev.categoria, ev.organizador, ev.fecha].join(' ').toLowerCase();
          return hay.indexOf(q) !== -1;
        }
        return true;
      });
      page = 1;
      renderCards();
      renderPager();
    }

    function renderCards(){
      cardsEl.innerHTML = '';
      if (!filtered || filtered.length === 0) {
        cardsEl.innerHTML = `<div class="empty">No hay eventos aprobados que coincidan con los filtros.</div>`;
        return;
      }
      const start = (page-1)*PER_PAGE;
      const slice = filtered.slice(start, start+PER_PAGE);
      slice.forEach(ev => {
        const isVip = (ev.nivel||'').toLowerCase().includes('vip');
        const card = document.createElement('div');
        card.className = 'card' + (isVip ? ' vip' : '');
        const imgSrc = safeUrl((ev.imgs && ev.imgs[0]) || ev.logo_organizador || '');
        const imgHtml = imgSrc ? `<img class="thumb" src="${esc(imgSrc)}" alt="">` : `<div class="thumb" aria-hidden="true"></div>`;
        const metaParts = [];
        const fechaDisplay = fechaHumana(ev.fecha_iso || ev.fecha);
        if (fechaDisplay) metaParts.push(fechaDisplay);
        const horaUni = horaUnificadaObj(ev);
        if (horaUni) metaParts.push(horaUni);
        if (ev.lugar) metaParts.push(ev.lugar);
        const meta = metaParts.join(' • ');
        const desc = esc(ev.descripcion || '').slice(0,800);
        const partnersHtml = (ev.partners && ev.partners.length) ? `<div class="partners">${ev.partners.map(p=>`<div style="display:flex;align-items:center;gap:8px"><img class="partner-logo" src="${esc(safeUrl(p.logo))}" onerror="this.style.display='none'"><div class="small">${esc(p.name)}</div></div>`).join('')}</div>` : '';
        const entradasBtn = ev.entradas ? `<a class="btn" href="${esc(safeUrl(ev.entradas))}" target="_blank" rel="noopener">Entradas</a>` : '';
        const instaBtn = ev.instagram ? `<a class="btn alt" href="${esc(safeUrl(ev.instagram))}" target="_blank" rel="noopener">Instagram</a>` : '';

        card.innerHTML = `
          <div>${imgHtml}</div>
          <div class="info">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px;flex-wrap:wrap">
              <div>
                <div class="title">${esc(ev.nombre || '(Sin título)')}</div>
                <div class="meta">${esc(meta)}${ev.categoria ? ' • ' + esc(ev.categoria) : ''}</div>
                <div class="small" style="margin-top:6px">${ev.organizador ? 'Organiza: ' + esc(ev.organizador) : ''}${ev.aprobado ? ' • Aprobado' : ''}</div>
              </div>
              <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
                ${entradasBtn}
                ${instaBtn}
              </div>
            </div>
            <div class="desc">${desc}</div>
            ${partnersHtml}
          </div>
        `;
        cardsEl.appendChild(card);
      });
    }

    function renderPager(){
      pagerEl.innerHTML = '';
      const totalPages = Math.max(1, Math.ceil(filtered.length / PER_PAGE));
      if (totalPages <= 1) return;
      const prev = document.createElement('button'); prev.className='btn alt'; prev.textContent='Anterior'; prev.disabled = page<=1;
      prev.onclick = ()=>{ if(page>1) page--; renderCards(); renderPager(); window.scrollTo({top:0,behavior:'smooth'}); };
      const next = document.createElement('button'); next.className='btn'; next.textContent='Siguiente'; next.disabled = page>=totalPages;
      next.onclick = ()=>{ if(page<totalPages) page++; renderCards(); renderPager(); window.scrollTo({top:0,behavior:'smooth'}); };
      const info = document.createElement('div'); info.className='small'; info.style.fontWeight='800';
      info.textContent = `Página ${page} / ${totalPages} — ${filtered.length} eventos`;
      pagerEl.appendChild(prev); pagerEl.appendChild(info); pagerEl.appendChild(next);
    }

    // UI events
    searchEl.addEventListener('input', () => applyFilters());
    selCategory.addEventListener('change', () => { selOrganizer.value=''; applyFilters(); });
    selOrganizer.addEventListener('change', () => { selCategory.value=''; applyFilters(); });

    function populate(sel, set){
      sel.innerHTML = '<option value="">(todos)</option>';
      Array.from(set).sort().forEach(v => {
        const o = document.createElement('option'); o.value = v; o.textContent = v; sel.appendChild(o);
      });
    }

    // start
    (function start(){
      try { load(); } catch(err) {
        console.error('load error (capturado):', err);
        cardsEl.innerHTML = `<div class="empty">Error cargando eventos. Ver consola para detalles.</div>`;
      }
    })();
  </script>
</body>
</html>
