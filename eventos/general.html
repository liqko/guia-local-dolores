<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title id="dynamic-title">Guía Local Dolores | Eventos</title>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">
  <style>
    :root{
      --bg:#f5f7fb; --panel:#fff; --muted:#6b7a90; --blue:#1f5fb8;
      --vip:#ffb74d; --vip-2:#ff7a2a; --danger:#c62828;
      --card-radius:16px; --shadow:0 10px 30px rgba(28,43,78,0.08);
    }
    *{box-sizing:border-box;}
    html,body{height:100%;margin:0;background:var(--bg);font-family:"Inter","Segoe UI",Arial,sans-serif;color:#122;}
    .wrap{max-width:1100px;margin:24px auto 32px;padding:0 18px;}

    .header{display:flex;gap:16px;align-items:center;margin-bottom:10px;flex-wrap:wrap;}
    .logo{width:84px;height:84px;border-radius:16px;object-fit:cover;background:#fff;box-shadow:0 6px 18px rgba(33,49,86,0.07);padding:8px;}
    .title-block{display:flex;flex-direction:column;gap:8px;}
    .title{font-size:2.05rem;font-weight:950;letter-spacing:-0.02em;color:#0f2e58;margin:0;line-height:1.05;}
    .subtitle{margin:0;color:var(--muted);font-weight:650;font-size:1.02rem;}

    /* oculto por UX */
    .status{display:none !important;}

    .controls{display:flex;gap:10px;flex-wrap:wrap;margin:16px 0 18px;align-items:center;}
    .search{flex:1;min-width:220px;padding:12px 14px;border-radius:14px;border:1.5px solid #d7e1f7;background:#fff;}
    .select{padding:11px 12px;border-radius:14px;border:1.5px solid #d7e1f7;background:#fff;font-weight:800;}
    .cta{padding:11px 16px;border-radius:14px;background:linear-gradient(90deg,#ffd972 0,#ff7a2a 100%);color:#222;font-weight:900;text-decoration:none;border:2px solid #ff7a2a;}

    .events{display:flex;flex-direction:column;gap:16px;}

    .card{
      display:flex;gap:16px;align-items:flex-start;background:var(--panel);
      border-radius:var(--card-radius);box-shadow:var(--shadow);
      padding:16px;position:relative;transition:transform .18s, box-shadow .18s;
      border:1px solid #eaf0ff;
    }
    .card:hover{transform:translateY(-4px);box-shadow:0 18px 44px rgba(28,43,78,0.12);}

    .left{flex:0 0 128px;display:flex;flex-direction:column;gap:10px;align-items:center;}
    .thumb{width:128px;height:128px;border-radius:14px;background:#eee;object-fit:cover;display:block;border:1px solid #f0f4fb;}
    .right{flex:1;display:flex;flex-direction:column;gap:10px;min-width:0;}

    /* FREE */
    .event-card.free{background:linear-gradient(180deg,#ffffff 0,#fbfdff 100%);}

    /* VIP (más destacado) */
    .event-card.vip{
      border:2px solid rgba(255,122,42,0.40);
      background:
        radial-gradient(900px 240px at 15% 0%, rgba(255,183,77,0.34), transparent 60%),
        radial-gradient(700px 240px at 95% 0%, rgba(255,122,42,0.22), transparent 60%),
        linear-gradient(180deg,#fff7ee 0,#ffffff 65%);
      box-shadow:0 18px 46px rgba(255,122,42,0.12), var(--shadow);
    }
    .event-card.vip .thumb{
      border:2px solid rgba(255,122,42,0.22);
      box-shadow:0 10px 24px rgba(255,122,42,0.14);
    }

    .badge{
      position:absolute;top:14px;right:14px;
      padding:8px 14px;border-radius:999px;font-weight:950;
      box-shadow:0 8px 22px rgba(0,0,0,0.08);
      letter-spacing:0.06em;font-size:.82rem;
    }
    .badge.vip{background:linear-gradient(90deg,#ffd166,#ff7a2a);color:#3a2200;}
    .badge.free{background:#e8f1ff;color:#0e4f8a;border:1px solid #d6e1f3;}

    .title-card{font-size:1.22rem;font-weight:950;color:#102f5b;margin:0;line-height:1.15;}
    .event-card.vip .title-card{font-size:1.42rem;}

    .category{
      display:inline-flex;align-items:center;gap:8px;
      background:#f0edff;color:#5a39b9;padding:7px 12px;border-radius:999px;
      font-weight:900;font-size:.95rem;width:fit-content;
    }

    .meta{
      display:flex;gap:14px;flex-wrap:wrap;align-items:center;
      color:#144a94;font-weight:850;font-size:1rem;
    }
    .meta .item{display:inline-flex;gap:8px;align-items:center;white-space:nowrap;}

    .desc{color:#243447;line-height:1.45;text-align:justify;margin:0;font-size:1.03rem;}
    .event-card.vip .desc{font-size:1.06rem;}

    .info{color:#22529a;font-weight:800;font-style:italic;}
    .organizer{font-weight:900;color:#132f6e;font-size:1.02rem;}
    .action{
      margin-top:6px;display:inline-flex;align-items:center;gap:8px;
      background:var(--blue);color:#fff;padding:11px 15px;border-radius:12px;
      text-decoration:none;font-weight:900;width:fit-content;
    }
    .event-card.vip .action{
      background:linear-gradient(90deg,#ff7a2a,#ffb74d);
      color:#2b1900;
      border:1px solid rgba(0,0,0,0.06);
    }

    .paginator{display:flex;gap:8px;justify-content:center;padding:12px;margin-top:14px;flex-wrap:wrap;}
    .paginator button{padding:8px 12px;border-radius:10px;border:none;background:var(--blue);color:#fff;font-weight:900;cursor:pointer;}
    .paginator button[disabled]{background:#c7d7f6;cursor:not-allowed;}
    .error{color:var(--danger);font-weight:900;}

    @media(max-width:820px){
      .card{flex-direction:column}
      .left{flex-direction:row;gap:12px}
      .thumb{width:92px;height:92px}
      .title{font-size:1.75rem}
    }
  </style>
</head>
<body>
  <div class="wrap" role="main">
    <div class="header">
      <img class="logo" src="https://raw.githubusercontent.com/liqko/guia-local-dolores/refs/heads/main/img/plataforma/eventos.png" alt="logo">
      <div class="title-block">
        <h1 class="title" id="main-title">Eventos en Dolores</h1>
        <p class="subtitle" id="subtitle">Elegí un evento y viví la ciudad</p>
        <p class="status" id="status"></p>
      </div>
    </div>

    <div class="controls" role="region" aria-label="filtros">
      <input id="search" class="search" type="search" placeholder="Buscar por fecha, categoría, organizador o lugar...">
      <select id="categoryFilter" class="select" aria-label="Filtrar por categoría">
        <option value="">Todas las categorías</option>
      </select>
      <a class="cta" href="https://www.guialocaldolores.com.ar/suma-tu-evento/" target="_blank" rel="noopener">SUMÁ TU EVENTO</a>
    </div>

    <div id="loading" style="display:none;margin:14px 0;text-align:center;color:var(--blue);font-weight:900">Cargando eventos...</div>
    <div id="error" class="error" style="display:none;margin:10px 0;"></div>
    <div class="events" id="events" aria-live="polite"></div>
    <div class="paginator" id="paginator" aria-label="Paginador"></div>
  </div>

  <div id="enlaceModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(43,58,85,0.6); align-items:center; justify-content:center; z-index:9999;">
    <div style="width:95%; max-width:980px; height:85vh; background:#fff; border-radius:10px; overflow:hidden; position:relative;">
      <button id="cerrarModal" aria-label="Cerrar" style="position:absolute; top:12px; right:12px; z-index:20; background:var(--blue); color:#fff; border-radius:50%; width:40px; height:40px; border:none; font-size:18px; font-weight:900; cursor:pointer;">✕</button>
      <iframe id="modalIframe" src="" style="width:100%; height:100%; border:0; background:#f5f7fb;"></iframe>
    </div>
  </div>

  <script>
    // MANTENIDO IGUAL QUE TU ARCHIVO ORIGINAL
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxTqt5VG9d4mBPYA92t75q1_n1YBMM5nQ1fMz_SsI1_hdEcspBs6EPwXRGR_cWv_HNzkA/exec";
    const EVENTS_ENDPOINT = WEBAPP_URL + "?action=getEventsFormatted";

    const GENERIC_FREE_LOGO = "https://res.cloudinary.com/dw3oovvb1/image/upload/v1761345482/mpeum21vwegc0acgvrfw.png";
    const PLACEHOLDER_SVG = `data:image/svg+xml;utf8,` +
      encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='480' height='320'><rect width='100%' height='100%' fill='#eef4ff'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='#7b8bb3' font-family='Arial' font-size='24'>Sin imagen</text></svg>`);

    let eventosData = [], eventosFiltrados = [], currentPage = 1, eventsPerPage = 6;

    function setStatus(msg, isError=false){
      // oculto por UX, pero lo dejo para debug
      const st = document.getElementById('status');
      const er = document.getElementById('error');
      if (isError){ er.style.display='block'; er.textContent = msg; }
      else { er.style.display='none'; er.textContent=''; }
      if (st) st.textContent = msg;
    }

    /* === SOLO TOQUÉ FORMATO VISUAL DE FECHA (no la carga) === */
    function capFirst(str){
      str = String(str||'').trim();
      if (!str) return '';
      return str.charAt(0).toUpperCase() + str.slice(1);
    }
    function fechaHumanaBonita(fechaHumana){
      // Recibe "domingo 1 de febrero de 2026" y devuelve "Domingo 1 de febrero de 2026"
      return capFirst(fechaHumana || '');
    }

    function isPastISO(iso){
      if (!iso) return false;
      const today = new Date().toISOString().slice(0,10);
      return iso < today;
    }

    function horaHumana(h){
      if (!h) return "";
      h = String(h).trim();
      let m = h.match(/^Date\(\d{4},\d{1,2},\d{1,2},(\d{1,2}),(\d{1,2})/);
      if (m) return `${String(m[1]).padStart(2,'0')}:${String(m[2]).padStart(2,'0')} hs`;
      m = h.match(/^(\d{1,2}):(\d{2})(:\d{2})?$/);
      if (m) return `${String(m[1]).padStart(2,'0')}:${m[2]} hs`;
      return h;
    }

    function textoAParrafoJustificado(texto){
      if (!texto) return "";
      const partes = texto.split(/\n\s*\n/).length>1 ? texto.split(/\n\s*\n/) : texto.split(/\n/);
      return partes.map(p=>`<p style="margin:6px 0 6px 0;text-align:justify">${p.trim()}</p>`).join("");
    }

    async function loadEventos(){
      document.getElementById('events').innerHTML = '';
      document.getElementById('loading').style.display = 'block';
      document.getElementById('error').style.display = 'none';
      try {
        const r = await fetch(EVENTS_ENDPOINT);
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const data = await r.json();
        const arr = (data && data.events) ? data.events : [];

        // MANTENIDO IGUAL (no rompo nada)
        eventosData = arr.filter(ev => !isPastISO(ev.fecha_iso || ev.fecha));
        eventosData.sort((a,b)=> (a.fecha_iso||"").localeCompare(b.fecha_iso||""));
        eventosFiltrados = eventosData.slice();
        currentPage = 1;

        // UX: sin texto de conteo
        setStatus('', false);

        document.getElementById('loading').style.display = 'none';
        renderEventos(eventosFiltrados, currentPage);
      } catch(e){
        document.getElementById('loading').style.display = 'none';
        const msg = 'No se pudieron cargar los datos desde la WebApp.';
        setStatus(msg, true);
        document.getElementById('events').innerHTML = `<p class="error">${msg}</p>`;
      }
    }

    function renderEventos(data,page=1){
      const container = document.getElementById('events'); container.innerHTML = '';
      const start = (page-1)*eventsPerPage, end = start+eventsPerPage, pageData = data.slice(start,end);

      if (!pageData.length){
        container.innerHTML = `<p style="color:#b02a2a;font-weight:900">No hay eventos para mostrar.</p>`;
        document.getElementById('paginator').innerHTML = '';
        return;
      }

      pageData.forEach((ev)=>{
        const card = document.createElement('article');
        const lvl = ev.nivel && String(ev.nivel).toLowerCase().indexOf('vip')!==-1 ? 'vip' : (ev.nivel && String(ev.nivel).toLowerCase().indexOf('free')!==-1 ? 'free' : '');
        card.className = `card event-card ${lvl}`;

        if (lvl){
          const b = document.createElement('div');
          b.className = `badge ${lvl}`;
          b.textContent = lvl.toUpperCase();
          card.appendChild(b);
        }

        const left = document.createElement('div'); left.className = 'left';
        const img = document.createElement('img'); img.className='thumb'; img.alt = ev.nombre_evento || ev.nombre || 'imagen evento';

        let candidate = ev.logo || ev.logo_organizador || ev.img1 || ev.img2 || '';
        if ((!candidate || String(candidate).trim()==='') && lvl === 'free') candidate = GENERIC_FREE_LOGO;
        img.loading = 'lazy';
        img.src = candidate ? candidate : PLACEHOLDER_SVG;
        img.crossOrigin = 'anonymous';
        img.referrerPolicy = 'no-referrer';
        img.onerror = function(){
          if (lvl === 'free' && this.src !== GENERIC_FREE_LOGO) this.src = GENERIC_FREE_LOGO;
          else this.src = PLACEHOLDER_SVG;
          this.onerror = null;
        };
        left.appendChild(img);

        const right = document.createElement('div'); right.className='right';
        const h = document.createElement('h2'); h.className='title-card'; h.textContent = ev.nombre_evento || ev.nombre || ''; right.appendChild(h);

        if (ev.categoria){
          const c = document.createElement('div'); c.className='category'; c.textContent = ev.categoria; right.appendChild(c);
        }

        const meta = document.createElement('div'); meta.className='meta';

        // ✅ FECHA: solo español y con mayúscula inicial
        if (ev.fecha_humana){
          const d = document.createElement('div');
          d.className='item';
          d.innerHTML = `<i class="ri-calendar-event-line"></i><span>${fechaHumanaBonita(ev.fecha_humana)}</span>`;
          meta.appendChild(d);
        }

        // ✅ HORA: NO mostramos valores raros tipo "Sat Dec 30 1899..."
        const rawHr = (ev.hora_unificada && String(ev.hora_unificada).trim())
          ? ev.hora_unificada
          : ((ev.hora && String(ev.hora).trim()) ? ev.hora : (ev.hora2 || ''));

        const hr = horaHumana(rawHr);
        const hrOk = hr && !/^Sat\s+Dec\s+30\s+1899/i.test(String(hr)) ? hr : '';

        if (hrOk){
          const t = document.createElement('div');
          t.className='item';
          t.innerHTML = `<i class="ri-time-line"></i><span>${hrOk}</span>`;
          meta.appendChild(t);
        }

        if (ev.lugar){
          const l = document.createElement('div');
          l.className='item';
          l.innerHTML = `<i class="ri-map-pin-line"></i><span>${ev.lugar}</span>`;
          meta.appendChild(l);
        }

        right.appendChild(meta);

        if (ev.descripcion){
          const desc = document.createElement('div'); desc.className='desc'; desc.innerHTML = textoAParrafoJustificado(ev.descripcion); right.appendChild(desc);
        }

        let infoAdd = '';
        if (ev.direccion) infoAdd += `Dirección: ${ev.direccion}. `;
        if (ev.llegar) infoAdd += `Cómo llegar: ${ev.llegar}. `;
        if (infoAdd){
          const ia = document.createElement('div'); ia.className='info'; ia.innerHTML = `<i class="ri-information-line"></i>&nbsp; ${infoAdd}`; right.appendChild(ia);
        }

        if (ev.organizador){
          const o = document.createElement('div'); o.className='organizer'; o.textContent = `Organiza: ${ev.organizador}`; right.appendChild(o);
        }

        const enlace = ev.entradas && /^https?:\/\//i.test(ev.entradas) ? ev.entradas : '';
        if (enlace){
          const a = document.createElement('a');
          a.className='action';
          a.href='#';
          a.setAttribute('data-url', enlace);
          a.innerHTML = `<i class="ri-external-link-line"></i> Entradas / Más info`;
          a.onclick = function(e){ e.preventDefault(); abrirEnlaceModal(this.getAttribute('data-url')); };
          right.appendChild(a);
        }

        card.appendChild(left); card.appendChild(right); container.appendChild(card);
      });

      renderPaginator(data.length, page);
    }

    function renderPaginator(total,page){
      const cont = document.getElementById('paginator'); const totalPages = Math.ceil(total / eventsPerPage);
      if (totalPages <= 1) { cont.innerHTML = ''; return; }

      let html = `<button id="prev"${page<=1 ? ' disabled':''}>Anterior</button>`;
      const pages = new Set(); pages.add(1); pages.add(totalPages);
      for (let i=Math.max(2,page-2); i<=Math.min(totalPages-1,page+2); i++) pages.add(i);
      const list = Array.from(pages).sort((a,b)=>a-b); let last=0;

      for (const p of list){
        if (p-last>1) html += `<span style="padding:0 8px;color:#667;font-weight:900">...</span>`;
        html += (p===page)
          ? `<span style="font-weight:950;background:#e8f2ff;padding:7px 10px;border-radius:10px;color:#133">${p}</span>`
          : `<button class="page-btn" data-page="${p}" style="background:#2a63bf">${p}</button>`;
        last = p;
      }

      html += `<button id="next"${page>=totalPages ? ' disabled':''}>Siguiente</button>`;
      cont.innerHTML = html;

      const prev = document.getElementById('prev'), next = document.getElementById('next');
      prev && (prev.onclick = ()=>{ if (currentPage>1){ currentPage--; renderEventos(eventosFiltrados,currentPage); scrollToEvents(); }});
      next && (next.onclick = ()=>{ if (currentPage<totalPages){ currentPage++; renderEventos(eventosFiltrados,currentPage); scrollToEvents(); }});

      document.querySelectorAll('.page-btn').forEach(b=>b.onclick = function(){
        const p = parseInt(this.dataset.page,10);
        if (!isNaN(p) && p!==currentPage){ currentPage=p; renderEventos(eventosFiltrados,currentPage); scrollToEvents(); }
      });
    }

    function scrollToEvents(){ const el = document.getElementById('events'); if (el) el.scrollIntoView({behavior:'smooth',block:'start'}); }

    function abrirEnlaceModal(url){
      if (!url) return;
      const m = url.match(/instagram\.com\/(p|reel|tv)\/([a-zA-Z0-9_-]+)/);
      if (m){ document.getElementById('modalIframe').src = `https://www.instagram.com/${m[1]}/${m[2]}/embed`; document.getElementById('enlaceModal').style.display = 'flex'; return; }
      if (/^https?:\/\//i.test(url)){ document.getElementById('modalIframe').src = url; document.getElementById('enlaceModal').style.display = 'flex'; }
      else { window.open(url,'_blank','noopener'); }
    }
    document.getElementById('cerrarModal').onclick = function(){ document.getElementById('modalIframe').src=''; document.getElementById('enlaceModal').style.display='none'; };

    document.getElementById('search').addEventListener('input', function(){ aplicarFiltro(this.value, document.getElementById('categoryFilter').value); });
    document.getElementById('categoryFilter').addEventListener('change', function(){ aplicarFiltro(document.getElementById('search').value, this.value); });

    function aplicarFiltro(search, category){
      const q = String(search||'').trim().toLowerCase();
      const cat = String(category||'').trim().toLowerCase();
      eventosFiltrados = eventosData.filter(ev=>{
        if (!ev) return false;
        if (cat && (!ev.categoria || ev.categoria.toLowerCase().indexOf(cat)===-1)) return false;
        if (!q) return true;
        const hay = [ev.fecha_humana||'',ev.categoria||'',ev.nombre_evento||ev.nombre||'',ev.organizador||ev.organizador_principal||'',ev.entradas||'',ev.descripcion||'',ev.lugar||''].join(' ').toLowerCase();
        return hay.indexOf(q)!==-1;
      });
      currentPage = 1; renderEventos(eventosFiltrados,currentPage);
      setStatus('', false);
    }

    (function init(){ loadEventos(); })();
  </script>
</body>
</html>
