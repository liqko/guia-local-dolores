<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title id="dynamic-title">Eventos</title>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">
  <style>
    :root { --blue:#3b7dd8; --vip-accent:#ffd166; --card-radius:14px; }
    html,body { height:100%; }
    body {
      margin:0;
      font-family: "Segoe UI", "Arial", sans-serif;
      background:transparent;
      color:#223;
      font-style: italic;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .wrap { max-width:980px; margin:0 auto; padding:18px; box-sizing:border-box; }
    .header-flex { display:flex; flex-direction:column; align-items:center; gap:8px; margin-top:18px; margin-bottom:6px; }
    .main-logo { width:110px; height:110px; border-radius:18px; background:#fff; object-fit:cover; box-shadow:0 2px 12px rgba(0,0,0,0.06); }
    .header-title { font-size:1.9rem; font-weight:800; color:#223a55; background:#f3f6fb; padding:12px 20px; border-radius:12px; border:1px solid #e2e8f0; text-align:center; }
    .controls { display:flex; gap:10px; justify-content:center; align-items:center; margin:18px 0 10px; flex-wrap:wrap; }
    .search-box { width:360px; max-width:100%; padding:12px 14px; border-radius:12px; border:1.5px solid #d2d7e1; outline:none; box-shadow:0 2px 7px rgba(44,60,90,0.04); font-size:1rem; }
    .category-select { padding:10px 12px; border-radius:10px; border:1.5px solid #d2d7e1; background:#fff; font-weight:700; font-style:italic; }
    .suma-evento-btn { display:inline-block; background:linear-gradient(90deg,#ffd972 0%,#ff6600 90%); color:#222; padding:10px 14px; border-radius:12px; font-weight:800; text-decoration:none; border:2px solid #ff6600; box-shadow:0 6px 18px rgba(255,102,0,0.08); }
    .events-container { display:flex; flex-direction:column; gap:18px; padding-bottom:40px; min-height:160px; }
    .event-card { display:flex; gap:14px; align-items:flex-start; background:#fff; border-radius:var(--card-radius); box-shadow:0 6px 22px rgba(35,56,90,0.06); padding:14px; position:relative; overflow:visible; max-width:100%; }
    .event-left { flex:0 0 120px; display:flex; flex-direction:column; align-items:center; gap:8px; }
    .event-left img { width:110px; height:110px; border-radius:12px; object-fit:cover; background:#f6f8fb; box-shadow:0 4px 18px rgba(35,56,90,0.06); }
    .event-right { flex:1 1 auto; display:flex; flex-direction:column; gap:8px; }
    .event-card.vip { border:2px solid var(--vip-accent); background:linear-gradient(180deg,#fffaf0 0,#fffef8 100%); }
    .event-card.free { border:1px solid #d6e1f3; background:linear-gradient(180deg,#ffffff 0,#fbfdff 100%); }
    .event-badge { position:absolute; top:10px; right:10px; padding:6px 10px; border-radius:999px; font-weight:900; font-size:.9rem; }
    .event-badge.vip { background:linear-gradient(90deg,#ffd166,#ff9f1c); color:#4a2b00; box-shadow:0 6px 18px rgba(255,159,28,0.12); }
    .event-badge.free { background:#e8f1ff; color:#0e4f8a; border:1px solid #d6e1f3; box-shadow:0 4px 12px rgba(14,79,138,0.04); }
    .event-title { font-size:1.14rem; font-weight:800; color:#16335a; margin:0; }
    .event-category { color:#6d3bd8; font-weight:800; font-size:.95rem; }
    .event-meta { display:flex; gap:12px; align-items:center; color:var(--blue); font-weight:700; font-size:.95rem; flex-wrap:wrap; }
    .event-desc { color:#263240; line-height:1.28; margin-top:6px; font-size:.98rem; text-align:justify; }
    .event-info-adicional { color:#22529a; font-weight:700; font-style:italic; }
    .event-organizer-name { font-weight:800; color:#1b3069; }
    .event-link { display:inline-block; padding:10px 14px; background:var(--blue); color:#fff; border-radius:10px; font-weight:800; text-decoration:none; margin-top:6px; }
    .paginator { display:flex; justify-content:center; gap:8px; padding:10px; border-radius:10px; background:#f4f8ff; border:1px solid #e2e8f0; margin:12px 0; }
    @media (max-width:900px) { .event-card { flex-direction:column; align-items:stretch; } .event-left { flex-direction:row; gap:12px; align-items:center; } .event-left img { width:90px; height:90px; } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header-flex">
      <img id="main-logo" class="main-logo" src="https://raw.githubusercontent.com/liqko/guia-local-dolores/refs/heads/main/img/plataforma/eventos.png" alt="Logo" />
      <h1 id="main-title" class="header-title">Listado Unificado de Eventos</h1>
    </div>

    <div class="controls" role="region" aria-label="Controles de búsqueda">
      <input id="search" class="search-box" type="search" placeholder="Buscar por fecha, categoría, organizador o lugar..." aria-label="Buscar eventos">
      <select id="categoryFilter" class="category-select" aria-label="Filtrar por categoría">
        <option value="">Todas las categorías</option>
      </select>
      <a href="https://www.guialocaldolores.com.ar/suma-tu-evento/" target="_blank" rel="noopener" class="suma-evento-btn" title="Sumá tu evento">SUMÁ TU EVENTO</a>
    </div>

    <div id="loading-indicator" style="display:none; text-align:center; margin:18px 0;">
      <span style="font-size:1.6rem">⏳</span>
      <div id="loading-text" style="color:var(--blue); font-weight:700; margin-top:6px;">Cargando eventos...</div>
    </div>

    <div id="retry-container" style="display:none; text-align:center; margin:18px 0;">
      <button onclick="loadEventos(true)" style="padding:10px 16px; border-radius:10px; background:var(--blue); color:#fff; border:none; font-weight:800;">Reintentar</button>
    </div>

    <div class="events-container" id="events" aria-live="polite"></div>
    <div class="paginator" id="paginator" aria-label="Paginador"></div>
  </div>

  <div id="enlaceModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(43,58,85,0.6); align-items:center; justify-content:center; z-index:9999;">
    <div style="width:95%; max-width:980px; height:85vh; background:#fff; border-radius:10px; overflow:hidden; position:relative;">
      <button id="cerrarModal" aria-label="Cerrar" style="position:absolute; top:12px; right:12px; z-index:20; background:var(--blue); color:#fff; border-radius:50%; width:40px; height:40px; border:none; font-size:1.2rem;">×</button>
      <iframe id="modalIframe" src="" style="width:100%; height:100%; border:0; background:#f5f7fb;"></iframe>
    </div>
  </div>

  <script>
    const SPREADSHEET_ID = "1CCNDvrIFFufiLXmYkm4YcmtZVpk6rG2gJQQYXzA186o";
    const EVENTS_GID = "338324539";
    const CATS_GID = "151081954";
    const GVIZ = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&gid=`;
    const EVENTS_URL = GVIZ + EVENTS_GID;
    const CATS_URL = GVIZ + CATS_GID;

    let eventosData = [], eventosFiltrados = [], currentPage = 1, eventsPerPage = 6;
    let fetchAttempts = 0, maxFetchAttempts = 3;

    function jsonFromGviz(text) {
      try { return JSON.parse(text.substr(47).slice(0,-2)); } catch(e){ throw new Error("GViz parse error: " + (e.message||e)); }
    }

    function isVerificado(v) {
      if (v === undefined || v === null) return false;
      // accept boolean true, numbers 1, and textual affirmative
      if (typeof v === 'boolean') return v === true;
      const s = String(v).toLowerCase().trim();
      return ["si","sí","true","ok","✓","x","check","checked","1","yes"].includes(s);
    }

    function fechaHumana(valor) {
      if (!valor) return "";
      valor = String(valor).trim();
      let m = valor.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (m) { const d=new Date(parseInt(m[1]),parseInt(m[2],10)-1,parseInt(m[3])); return formatoFecha(d); }
      m = valor.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if (m) { const d=new Date(parseInt(m[3]),parseInt(m[2],10)-1,parseInt(m[1])); return formatoFecha(d); }
      m = valor.match(/^Date\((\d{4}),\s*(\d+),\s*(\d+)/);
      if (m) { const d = new Date(parseInt(m[1]), parseInt(m[2]), parseInt(m[3])); return formatoFecha(d); }
      return valor;
    }
    function formatoFecha(dt) {
      const dias = ["domingo","lunes","martes","miércoles","jueves","viernes","sábado"];
      const meses = ["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"];
      return `${dias[dt.getDay()]} ${dt.getDate()} de ${meses[dt.getMonth()]} de ${dt.getFullYear()}`;
    }
    function horaHumana(h) {
      if (!h) return "";
      const s = String(h).trim();
      let m = s.match(/^Date\(\d{4},\d{1,2},\d{1,2},(\d{1,2}),(\d{1,2})/);
      if (m) return `${String(m[1]).padStart(2,'0')}:${String(m[2]).padStart(2,'0')} hs`;
      m = s.match(/^(\d{1,2}):(\d{2})/);
      if (m) return `${String(m[1]).padStart(2,'0')}:${m[2]} hs`;
      return s;
    }

    function adaptarFilaUnificada(cells) {
      const get = i => (cells[i] && cells[i].v !== undefined) ? cells[i].v : "";
      const partners = [];
      for (let p=22; p<=32; p+=2) { const val = get(p); if (val) partners.push(val); }
      const entradas = get(21);
      const enlace = (typeof entradas === "string" && entradas.match(/^https?:\/\//i)) ? entradas : "";
      return {
        aprobado: get(0),
        nivel: get(1),
        evento_id: get(2),
        id_anunciante: get(3),
        organizador_principal: get(4),
        logo_organizador: get(5),
        categoria: get(6),
        nombre: get(8),
        localidad: get(9),
        lugar: get(10),
        direccion: get(11),
        llegar: get(12),
        fecha: get(13),
        fecha_humana: fechaHumana(get(13)),
        hora: get(14),
        hora2: get(15),
        descripcion: get(16),
        instagram: get(17),
        img1: get(18),
        img2: get(19),
        img3: get(20),
        entradas: entradas,
        enlace: enlace,
        auspiciantes: partners.join(", "),
        logo: get(18)
      };
    }

    async function fetchCategories() {
      try {
        const r = await fetch(CATS_URL);
        const t = await r.text();
        const j = jsonFromGviz(t);
        const rows = j.table.rows || [];
        const cats = [];
        for (let i=0;i<rows.length;i++) {
          const c = rows[i].c || [];
          if (!c[0] || c[0].v === undefined) continue;
          const v = String(c[0].v || "").trim();
          if (v) cats.push(v);
        }
        const uniq = Array.from(new Set(cats)).sort((a,b)=>a.localeCompare(b,'es',{sensitivity:'base'}));
        const sel = document.getElementById('categoryFilter');
        const cur = sel.value || "";
        sel.innerHTML = '<option value="">Todas las categorías</option>' + uniq.map(x=>`<option value="${x}">${x}</option>`).join('');
        if (cur) sel.value = cur;
      } catch(e){
        console.warn("fetchCategories failed", e);
      }
    }

    async function loadEventos(force=false) {
      document.getElementById('events').innerHTML = "";
      document.getElementById('retry-container').style.display = 'none';
      document.getElementById('loading-indicator').style.display = 'block';
      document.getElementById('loading-text').textContent = 'Cargando eventos...';
      if (!force) fetchAttempts++; else fetchAttempts = 1;

      await fetchCategories().catch(()=>{ /* categories best-effort */ });

      try {
        const res = await fetch(EVENTS_URL);
        const text = await res.text();
        const json = jsonFromGviz(text);
        document.getElementById('loading-indicator').style.display = 'none';
        const rows = json.table.rows || [];
        eventosData = [];
        for (let i=0;i<rows.length;i++){
          const c = rows[i].c || [];
          const aprobadoCell = c[0] && c[0].v !== undefined ? c[0].v : "";
          if (!isVerificado(aprobadoCell)) continue; // keep aprobado mandatory
          const ev = adaptarFilaUnificada(c);
          // fallback nombre if missing
          if (!ev.nombre || String(ev.nombre).trim() === "") {
            ev.nombre = ev.organizador_principal || ev.lugar || ev.categoria || "";
          }
          // nivel detection if empty
          if (!ev.nivel || String(ev.nivel).trim() === "") {
            for (let j=0;j<c.length;j++){
              try {
                const txt = c[j] && c[j].v !== undefined ? String(c[j].v) : String(c[j] || "");
                const s = txt.toLowerCase();
                if (s.indexOf('vip') !== -1) { ev.nivel = "vip"; break; }
                if (s.indexOf('free') !== -1) { ev.nivel = "free"; break; }
              } catch(e){}
            }
          }
          // accept row if has at least one identifying piece (name or fecha or organizer or lugar)
          if ((!ev.nombre || String(ev.nombre).trim() === "") && (!ev.fecha || String(ev.fecha).trim() === "") && (!ev.organizador_principal || String(ev.organizador_principal).trim() === "") && (!ev.lugar || String(ev.lugar).trim() === "")) {
            continue;
          }
          eventosData.push(ev);
        }

        // sort by fecha when available
        eventosData.sort((a,b) => {
          const toISO = s => {
            if (!s) return "";
            if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
            const m = String(s).match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
            if (m) return `${m[3]}-${m[2].padStart(2,'0')}-${m[1].padStart(2,'0')}`;
            return s;
          };
          return toISO(a.fecha || "").localeCompare(toISO(b.fecha || ""));
        });

        eventosFiltrados = eventosData.slice();
        currentPage = 1;
        renderEventos(eventosFiltrados, currentPage);
      } catch(e){
        document.getElementById('loading-indicator').style.display = 'none';
        if (fetchAttempts < maxFetchAttempts) setTimeout(()=>loadEventos(), 1200);
        else {
          document.getElementById('events').innerHTML = `<p style="color:#b02a2a;font-weight:800">No se pudieron cargar los datos. Verifica permisos o publicación de la hoja.</p>`;
          document.getElementById('retry-container').style.display = 'block';
          console.error("loadEventos failed", e);
        }
      }
    }

    function textoAParrafoJustificado(texto) {
      if (!texto) return "";
      const partes = texto.split(/\n\s*\n/).length>1 ? texto.split(/\n\s*\n/) : texto.split(/\n/);
      return partes.map(p=>`<p style="margin:6px 0 6px 0;text-align:justify">${p.trim()}</p>`).join("");
    }

    function renderInstagramBlock(url) {
      if (!url) return "";
      if (/\.(jpg|jpeg|png|webp)(\?.*)?$/.test(url)) return `<div style="margin-top:8px"><img src="${url}" alt="imagen evento" style="width:100%;max-width:220px;border-radius:8px"></div>`;
      const m = url.match(/instagram\.com\/(p|reel|tv)\/([a-zA-Z0-9_-]+)/);
      if (m) return `<div style="margin-top:8px"><iframe src="https://www.instagram.com/${m[1]}/${m[2]}/embed" style="width:100%;max-width:380px;height:420px;border:none;border-radius:8px"></iframe></div>`;
      return "";
    }

    function eventoEsDestacadoAcp(ev) {
      if (!ev) return false;
      const contains = (t) => t && String(t).toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").includes("acp");
      return contains(ev.nombre) || contains(ev.descripcion) || contains(ev.organizador_principal) || contains(ev.categoria) || contains(ev.auspiciantes);
    }

    function renderEventos(data, page=1) {
      const container = document.getElementById('events');
      container.innerHTML = "";
      const start = (page-1)*eventsPerPage, end = start + eventsPerPage;
      const pageData = data.slice(start, end);
      if (!pageData.length) {
        container.innerHTML = `<p style="color:#b02a2a;font-weight:800">No hay eventos para mostrar con ese criterio.</p>`;
        document.getElementById('paginator').innerHTML = "";
        return;
      }
      pageData.forEach((ev, idx) => {
        const card = document.createElement('article');
        const level = ev.nivel && String(ev.nivel).toLowerCase().indexOf('vip') !== -1 ? 'vip' : (ev.nivel && String(ev.nivel).toLowerCase().indexOf('free') !== -1 ? 'free' : '');
        card.className = `event-card ${level}${eventoEsDestacadoAcp(ev) ? ' destacada-acp':''}`;
        if (level) {
          const badge = document.createElement('div');
          badge.className = 'event-badge ' + level;
          badge.textContent = level.toUpperCase();
          card.appendChild(badge);
        }
        const left = document.createElement('div'); left.className = 'event-left';
        const img = document.createElement('img'); img.alt = ev.nombre || 'imagen evento'; img.src = ev.logo || ev.img1 || 'https://raw.githubusercontent.com/liqko/guia-local-dolores/refs/heads/main/img/plataforma/eventos.png';
        left.appendChild(img);
        const right = document.createElement('div'); right.className = 'event-right';
        const title = document.createElement('h2'); title.className = 'event-title'; title.textContent = ev.nombre || '';
        right.appendChild(title);
        if (ev.categoria) { const cat = document.createElement('div'); cat.className = 'event-category'; cat.textContent = ev.categoria; right.appendChild(cat); }
        const meta = document.createElement('div'); meta.className = 'event-meta';
        if (ev.fecha_humana) { const d = document.createElement('div'); d.innerHTML = `<i class="ri-calendar-event-line"></i>&nbsp; ${ev.fecha_humana}`; meta.appendChild(d); }
        const horaVal = (ev.hora && String(ev.hora).trim() !== "") ? ev.hora : ((ev.hora2 && String(ev.hora2).trim() !== "") ? ev.hora2 : "");
        if (horaVal) { const t = document.createElement('div'); t.innerHTML = `<i class="ri-time-line"></i>&nbsp; ${horaHumana(horaVal)}`; meta.appendChild(t); }
        if (ev.lugar) { const l = document.createElement('div'); l.innerHTML = `<i class="ri-map-pin-line"></i>&nbsp; ${ev.lugar}`; meta.appendChild(l); }
        right.appendChild(meta);
        if (ev.descripcion) { const desc = document.createElement('div'); desc.className = 'event-desc'; desc.innerHTML = textoAParrafoJustificado(ev.descripcion); right.appendChild(desc); }
        let infoAdd = ''; if (ev.direccion) infoAdd += `Dirección: ${ev.direccion}. `; if (ev.llegar) infoAdd += `Cómo llegar: ${ev.llegar}. `;
        if (infoAdd) { const ia = document.createElement('div'); ia.className = 'event-info-adicional'; ia.innerHTML = `<i class="ri-information-line"></i>&nbsp; ${infoAdd}`; right.appendChild(ia); }
        if (ev.auspiciantes) { const s = document.createElement('div'); s.innerHTML = `<strong>Auspicia:</strong> ${ev.auspiciantes}`; s.style.marginTop='6px'; right.appendChild(s); }
        if (ev.organizador_principal) { const o = document.createElement('div'); o.className = 'event-organizer-name'; o.textContent = `Organiza: ${ev.organizador_principal}`; right.appendChild(o); }
        if (ev.enlace) { const a = document.createElement('a'); a.className = 'event-link'; a.href = '#'; a.setAttribute('data-url', ev.enlace); a.textContent = 'Entradas / Más info'; a.onclick = function(e){ e.preventDefault(); abrirEnlaceModal(this.getAttribute('data-url')); }; right.appendChild(a); }
        const igHtml = renderInstagramBlock(ev.instagram); if (igHtml) { const wrap = document.createElement('div'); wrap.innerHTML = igHtml; right.appendChild(wrap); }
        card.appendChild(left); card.appendChild(right); document.getElementById('events').appendChild(card);
      });
      renderPaginator(data.length, page);
    }

    function renderPaginator(total, page) {
      const container = document.getElementById('paginator');
      const totalPages = Math.ceil(total / eventsPerPage);
      if (totalPages <= 1) { container.innerHTML = ""; return; }
      let html = '';
      html += `<button id="prev"${page<=1 ? ' disabled':''}>Anterior</button>`;
      const pages = new Set(); pages.add(1); pages.add(totalPages);
      for (let i=Math.max(2,page-2); i<=Math.min(totalPages-1,page+2); i++) pages.add(i);
      const list = Array.from(pages).sort((a,b)=>a-b);
      let last=0;
      for (const p of list) {
        if (p - last > 1) html += `<span style="padding:0 6px;color:#666">...</span>`;
        if (p===page) html += `<span style="font-weight:900;background:#dfefff;padding:6px 8px;border-radius:6px">${p}</span>`; else html += `<button class="page-btn" data-page="${p}">${p}</button>`;
        last = p;
      }
      html += `<button id="next"${page>=totalPages ? ' disabled':''}>Siguiente</button>`;
      container.innerHTML = html;
      const prev = document.getElementById('prev'), next = document.getElementById('next');
      prev && (prev.onclick = ()=>{ if (currentPage>1){ currentPage--; renderEventos(eventosFiltrados,currentPage); scrollToEvents(); }});
      next && (next.onclick = ()=>{ if (currentPage<totalPages){ currentPage++; renderEventos(eventosFiltrados,currentPage); scrollToEvents(); }});
      document.querySelectorAll('.page-btn').forEach(b => b.onclick = function(){ const p = parseInt(this.dataset.page,10); if (!isNaN(p) && p!==currentPage){ currentPage=p; renderEventos(eventosFiltrados,currentPage); scrollToEvents(); }});
    }

    function scrollToEvents() { const el = document.getElementById('events'); if (el) el.scrollIntoView({behavior:'smooth', block:'start'}); }

    function abrirEnlaceModal(url) {
      if (!url) return;
      const m = url.match(/instagram\.com\/(p|reel|tv)\/([a-zA-Z0-9_-]+)/);
      if (m) { document.getElementById('modalIframe').src = `https://www.instagram.com/${m[1]}/${m[2]}/embed`; document.getElementById('enlaceModal').style.display = 'flex'; return; }
      if (/^https?:\/\//i.test(url)) { document.getElementById('modalIframe').src = url; document.getElementById('enlaceModal').style.display = 'flex'; } else { window.open(url, '_blank', 'noopener'); }
    }
    document.getElementById('cerrarModal').onclick = function(){ document.getElementById('modalIframe').src = ''; document.getElementById('enlaceModal').style.display = 'none'; };
    document.getElementById('enlaceModal').addEventListener('click', function(e){ if (e.target === this) { document.getElementById('modalIframe').src=''; this.style.display='none'; } });

    document.getElementById('search').addEventListener('input', function(){ aplicarFiltro(this.value, document.getElementById('categoryFilter').value); });
    document.getElementById('categoryFilter').addEventListener('change', function(){ aplicarFiltro(document.getElementById('search').value, this.value); });

    function aplicarFiltro(search, category) {
      const q = String(search || "").trim().toLowerCase();
      const cat = String(category || "").trim().toLowerCase();
      eventosFiltrados = eventosData.filter(ev => {
        if (!ev) return false;
        if (cat) { if (!ev.categoria || ev.categoria.toLowerCase().indexOf(cat) === -1) return false; }
        if (!q) return true;
        const hay = [ev.fecha_humana||'', ev.categoria||'', ev.nombre||'', ev.organizador_principal||'', ev.auspiciantes||'', ev.descripcion||'', ev.lugar||''].join(" ").toLowerCase();
        return hay.indexOf(q) !== -1;
      });
      currentPage = 1;
      renderEventos(eventosFiltrados, currentPage);
    }

    (function init(){
      document.getElementById('main-title').textContent = 'Listado Unificado de Eventos';
      loadEventos();
    })();
  </script>
</body>
</html>
