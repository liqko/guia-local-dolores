<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title id="dynamic-title">Guía Local Dolores | Eventos</title>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">
  <style>
    :root{
      --panel:#fff; --muted:#6b7a90; --blue:#1f5fb8;
      --vip:#ffb74d; --vip2:#ff7a2a; --danger:#c62828;
      --card-radius:16px; --shadow:0 10px 30px rgba(28,43,78,0.07);
      --border-free:#d35400;           /* nivel 3: borde naranja */
      --border-vip:#ff7f50;            /* nivel 5: borde coral */
      --bg-free:#ffffff;               /* nivel 3: fondo blanco */
      --bg-vip:#f5e1d4;                /* nivel 5: fondo crema */
    }
    *{box-sizing:border-box;}
    html,body{height:100%;margin:0;background:transparent !important;font-family:"Inter","Segoe UI",Arial,sans-serif;color:#122;}
    .wrap{max-width:1100px;margin:24px auto 32px;padding:0 18px;}

    .header{
      display:flex;gap:16px;align-items:center;margin-bottom:12px;flex-wrap:wrap;
      background:#fff; border:1px solid #e6eefc; border-radius:16px; padding:12px 14px;
      box-shadow:0 8px 22px rgba(33,49,86,0.06);
    }
    .logo{width:84px;height:84px;border-radius:16px;object-fit:cover;background:#fff;box-shadow:0 8px 22px rgba(33,49,86,0.08);padding:8px;}
    .title-block{display:flex;flex-direction:column;gap:6px;}
    .title{
      font-size:2.05rem;font-weight:950;letter-spacing:-0.02em;
      color:#0f2e58;margin:0;line-height:1.06;
      background:none;border:none;padding:0;border-radius:0;
    }
    .subtitle{margin:0;color:var(--muted);font-weight:650;font-size:1.02rem;}
    .status{display:none !important;}

    .controls{display:flex;gap:10px;flex-wrap:wrap;margin:16px 0 18px;align-items:center;}
    .search{flex:1;min-width:220px;padding:12px 14px;border-radius:14px;border:1.5px solid #d7e1f7;background:#fff;}
    .select{padding:11px 12px;border-radius:14px;border:1.5px solid #d7e1f7;background:#fff;font-weight:800;}
    .cta{
      padding:11px 16px;border-radius:14px;background:linear-gradient(90deg,#ffd972 0,#ff7a2a 100%);
      color:#222;font-weight:900;text-decoration:none;border:2px solid #ff7a2a; cursor:pointer;
      display:inline-block;
    }

    .events{display:flex;flex-direction:column;gap:16px;}

    .card{
      display:flex;flex-direction:column;gap:12px;align-items:flex-start;background:var(--panel);
      border-radius:var(--card-radius);box-shadow:var(--shadow);
      padding:0;position:relative;transition:transform .18s, box-shadow .18s;
      border:2px solid #eaf0ff;
      overflow:hidden;
    }
    .card:hover{transform:translateY(-4px);box-shadow:0 18px 44px rgba(28,43,78,0.12);}

    /* Cabecera superior: Organiza + Badge (+ logo VIP) */
    .card-head{
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;padding:10px 14px;background:#f6f9ff;border-bottom:1px solid #e6eefc;
    }
    .head-left{display:flex;align-items:center;gap:10px;min-width:0;}
    .logo-organizador-head{
      width:48px;height:48px;border-radius:12px;background:#eef4ff;object-fit:cover;display:block;border:2px solid #ffb74d;box-shadow:0 4px 18px #ffb74d30;
    }
    .organizer-inline{
      display:flex;align-items:center;gap:8px;min-width:0;
      font-size:1rem;
    }
    .organizer-inline .label{
      color:#fc781b;font-weight:900;letter-spacing:.01em;
    }
    .organizer-inline .name{
      color:#132f6e;font-weight:900;font-size:1.08rem;line-height:1;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width:72vw;
    }

    .badge{
      padding:8px 14px;border-radius:999px;font-weight:950;
      box-shadow:0 8px 22px rgba(0,0,0,0.08);
      letter-spacing:0.10em;font-size:.78rem;flex:0 0 auto;
      border:1px solid rgba(0,0,0,0.06);
    }
    .badge.vip{background:linear-gradient(90deg,#ffd166,#ff7a2a);color:#3a2200;}
    .badge.free{background:#e8f1ff;color:#0e4f8a;border-color:#d6e1f3;}

    .card-body{padding:14px 16px;}

    /* Free y VIP: fondos y bordes según colores pedidos (nivel 3 y nivel 5) */
    .event-card.free{
      background: var(--bg-free);
      border-color: var(--border-free);
    }
    .event-card.vip{
      background: var(--bg-vip);
      border-color: var(--border-vip);
      box-shadow: 0 10px 30px rgba(28,43,78,0.06);
    }

    .title-card{font-size:1.22rem;font-weight:950;color:#102f5b;margin:0;line-height:1.12;}
    .event-card.vip .title-card{font-size:1.55rem;}

    /* Bloque categoría con iconos de columna logo_categoria */
    .category-group{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-top:6px;}
    .category-text{
      display:inline-flex;align-items:center;gap:8px;background:#f0edff;color:#5a39b9;
      padding:7px 12px;border-radius:999px;font-weight:900;font-size:.95rem;
    }
    .category-icons{display:flex;align-items:center;gap:6px;flex-wrap:wrap;}
    .category-icon{
      width:28px;height:28px;object-fit:contain;border-radius:6px;background:#fff;
      border:1px solid #e6eefc;padding:2px;
    }

    .info-block{display:flex;flex-direction:column;gap:6px;margin-top:8px;}
    .line{display:flex;gap:10px;align-items:flex-start;color:#123;}
    .line i{color:var(--blue);margin-top:1px;flex:0 0 auto;}
    .line .text{font-weight:850;color:var(--blue);line-height:1.35;}
    .line .muted{color:#22529a;font-weight:800;}

    .desc{color:#243447;line-height:1.45;text-align:justify;margin:6px 0 0 0;font-size:1.03rem;}
    .event-card.vip .desc{font-size:1.06rem;}

    .gallery-bar{
      display:flex;gap:12px;flex-wrap:wrap;margin:14px 0 0 0;align-items:center;justify-content:flex-start;
    }
    .gallery-thumb{
      width:90px;height:90px;object-fit:cover;border-radius:8px;cursor:pointer;
      border:2px solid #f7c288;box-shadow:0 2px 8px #1113 ;background:#f5f5f7;
      transition: box-shadow .18s, border .15s;
    }
    .gallery-thumb:hover,.gallery-thumb:focus{
      box-shadow:0 8px 20px #ffb74d55; border-color:#ff7a2a;
      outline:none;
    }

    .sponsors{margin-top:8px;}
    .sponsors-title{font-weight:950;color:#132f6e;margin-bottom:8px;display:flex;gap:8px;align-items:center;}
    .sponsors-grid{display:flex;gap:10px;flex-wrap:wrap;}
    .sponsor-item{
      width:96px; padding:10px 10px;
      border-radius:12px;
      background:#fff;
      border:1px solid #e6eefc;
      box-shadow:0 10px 26px rgba(28,43,78,0.06);
      text-align:center;
    }
    .sponsor-logo{
      width:52px;height:52px;border-radius:12px;object-fit:contain;
      background:#fff;
      border:1px solid #edf2ff;
      padding:6px;
      margin:0 auto 6px auto;
      display:block;
    }
    .sponsor-name{font-size:.74rem;font-weight:900;color:#233;line-height:1.15;}

    .embed-wrap{
      margin-top:10px;
      border:1px solid #d7e1f7;
      border-radius:14px;
      overflow:hidden;
      background:#fff;
      box-shadow:0 10px 26px rgba(28,43,78,0.06);
    }
    .embed-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      background:#f6f9ff;
      border-bottom:1px solid #e6eefc;
      font-weight:900;
      color:#132f6e;
    }
    .embed-close{
      border:0;
      background:#fff;
      border-radius:10px;
      padding:6px 10px;
      font-weight:900;
      cursor:pointer;
      border:1px solid #d7e1f7;
    }
    .embed-iframe{
      width:100%;
      height:clamp(380px, 70vh, 620px);
      border:0;
      background:#fff;
    }

    /* Ads: imagen o video YouTube en tamaño reel vertical (9/16) */
    .ad-card{
      background:#fff;
      border-radius:16px;
      border:1px solid #e6eefc;
      box-shadow:0 10px 26px rgba(28,43,78,0.06);
      padding:14px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      align-items:center;
    }
    .ad-img{
      width:min(100%, 420px);
      border-radius:14px;
      border:1px solid #eef3ff;
      object-fit:cover;
      aspect-ratio:9/16;
      max-height:85vh;
      display:block;
      background:#eee;
      margin: 0 auto;
    }
    .ad-video{
      width:min(100%, 420px);
      border-radius:14px;
      border:1px solid #eef3ff;
      background:#000;
      aspect-ratio:9/16; /* forzar formato reel vertical */
      overflow:hidden;
      margin: 0 auto;
      position:relative;
    }
    .ad-video iframe{
      width:100%;
      height:100%;
      border:0;
      background:#000;
    }
    @media(max-width: 600px){
      .ad-img{
        width:100%;
        max-height:88vh;
        aspect-ratio:9/16;
      }
      .ad-card{ padding:10px; }
      .ad-video{ width:100%; aspect-ratio:9/16; }
    }
    .ad-cta{
      margin-top:10px;
      width:min(100%, 420px);
      border:0;
      padding:12px 14px;
      border-radius:14px;
      font-weight:950;
      cursor:pointer;
      background:linear-gradient(90deg,#1f5fb8,#2fd0d6);
      color:#fff;
      border:1px solid rgba(0,0,0,0.06);
    }
    .ad-play{
      margin-top:8px;
      width:min(100%, 420px);
      border:0;
      padding:10px 12px;
      border-radius:14px;
      font-weight:900;
      cursor:pointer;
      background:#ff7a2a;
      color:#222;
      border:1px solid rgba(0,0,0,0.06);
    }

    .paginator{display:flex;gap:8px;justify-content:center;padding:12px;margin-top:14px;flex-wrap:wrap;}
    .paginator button{padding:8px 12px;border-radius:10px;border:none;background:#1f5fb8;color:#fff;font-weight:900;cursor:pointer;}
    .paginator button[disabled]{background:#c7d7f6;cursor:not-allowed;}
    .error{color:var(--danger);font-weight:900;}

    @media(max-width:820px){
      .title{font-size:1.8rem}
      .sponsor-item{width:92px}
      .embed-iframe{height:clamp(360px, 68vh, 520px);}
    }

    .modal-img-viewer{
      display:none;position:fixed;z-index:9999;top:0;left:0;width:100vw;height:100vh;
      background:rgba(36,44,46,0.95);
      justify-content:center;align-items:center;
      transition:opacity .15s;
      flex-direction:column;
      padding:0;
    }
    .modal-img-viewer.open{ display:flex; }
    .modal-img-viewer img{
      max-width:94vw;
      max-height:85vh;
      box-shadow:0 8px 44px 0 rgba(0,0,0,0.28);
      border-radius:16px;
      background:#fff;
    }
    .modal-img-viewer .close-btn{
      position:absolute;top:18px;right:24px;
      font-size:2.3rem;
      background:none;border:none;color:#fff;cursor:pointer;font-weight:900;
      z-index:9002;
    }
    .modal-img-viewer .thumblist{
      display:flex;gap:9px;margin:20px 0 0 0;
      flex-wrap:wrap;justify-content:center;
    }
    .modal-img-viewer .thumblist img{
      width:58px;height:58px;object-fit:cover;cursor:pointer;border-radius:8px;
      border:2px solid #eee;background:#eee;transition:box-shadow .16s;
      box-shadow:0 2px 8px rgba(21,22,29,0.12);
      margin-bottom:6px;
    }
    .modal-img-viewer .thumblist img.selected{
      border:3px solid #ff7a2a;box-shadow:0 4px 18px #ffb74d55;
    }
    @media(max-width:630px){
      .modal-img-viewer img{
        max-width:100vw;
        max-height:63vh;
      }
      .modal-img-viewer .close-btn{top:10px;right:14px;}
    }

    .map-link{
      color:#2074bb;
      font-weight:900;
      text-decoration: underline dotted;
      display: inline-block;
      margin-top:4px;
      letter-spacing:.01em;
    }
    .map-link i{margin-right:6px;}
  </style>
</head>
<body>
  <div class="wrap" role="main">
    <div class="header">
      <img class="logo" src="https://res.cloudinary.com/dw3oovvb1/image/upload/v1761321331/dq3bwgffteoqkeesxsuy.png" alt="logo">
      <div class="title-block">
        <h1 class="title" id="main-title">Planes para hoy en Dolores</h1>
        <p class="subtitle" id="subtitle">Elegí un evento y viví la ciudad</p>
        <p class="status" id="status"></p>
      </div>
    </div>

    <div class="controls" role="region" aria-label="filtros">
      <input id="search" class="search" type="search" placeholder="Buscar por fecha, categoría, organizador o lugar...">
      <select id="categoryFilter" class="select" aria-label="Filtrar por categoría">
        <option value="">Todas las categorías</option>
      </select>
      <button id="btnSumaEvento" class="cta" type="button">SUMÁ TU EVENTO</button>
    </div>

    <div class="events" id="events" aria-live="polite"></div>
    <div class="paginator" id="paginator" aria-label="Paginador"></div>
  </div>

  <div class="modal-img-viewer" id="modalImgViewer" tabindex="-1" aria-modal="true" role="dialog" aria-label="Galería de imágenes">
    <button class="close-btn" id="modalImgClose" type="button" aria-label="Cerrar">&times;</button>
    <img src="" alt="Vista ampliada" id="modalImgMain">
    <div class="thumblist" id="modalImgThumbs"></div>
  </div>

  <script>
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxTqt5VG9d4mBPYA92t75q1_n1YBMM5nQ1fMz_SsI1_hdEcspBs6EPwXRGR_cWv_HNzkA/exec";
    const SERVER_SECRET = "PzbqSEw9xNrwvWruJN7njiW905uwMiBS";
    const EVENTS_ENDPOINT = WEBAPP_URL + "?action=getEventsFormatted&serverSecret=" + encodeURIComponent(SERVER_SECRET);

    const SUMA_EVENTO_URL = "https://www.guialocaldolores.com.ar/suma-tu-evento/";

    const GENERIC_FREE_LOGO = "https://res.cloudinary.com/dw3oovvb1/image/upload/v1761345482/mpeum21vwegc0acgvrfw.png";
    const PLACEHOLDER_SVG = `data:image/svg+xml;utf8,` +
      encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='480' height='320'><rect width='100%' height='100%' fill='#eef4ff'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='22' fill='#889'>Auspicia</text></svg>`);

    /* Banners: imagen o YouTube (incluye Shorts), NO se repiten por página */
    const AD_BANNERS = [
      { type: "image", img: "https://res.cloudinary.com/dw3oovvb1/image/upload/v1761317400/wmxljnky7smtuxmecf4i.png", url: "https://www.guialocaldolores.com.ar" },
      { type: "image", img: "https://res.cloudinary.com/dw3oovvb1/image/upload/v1761317400/uh6x3jd0dvhin7jqtzwt.png", url: "https://www.guialocaldolores.com.ar" },
      { type: "image", img: "https://res.cloudinary.com/dw3oovvb1/image/upload/v1761317400/sz50zhc2ki0zgk9s6j0o.png", url: "https://www.guialocaldolores.com.ar" },
      { type: "youtube", videoUrl: "https://youtube.com/shorts/XBJOogweSiE?feature=share", url: "https://www.guialocaldolores.com.ar" }
    ];
    function shuffleArray(arr){
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a;
    }
    function normalizeYouTubeId(input){
      if (!input) return "";
      const s = String(input).trim();
      let m = s.match(/youtu\.be\/([A-Za-z0-9_-]+)/i);
      if (m) return m[1];
      m = s.match(/[?&]v=([A-Za-z0-9_-]+)/i);
      if (m) return m[1];
      m = s.match(/\/shorts\/([A-Za-z0-9_-]+)/i);
      if (m) return m[1];
      m = s.match(/^[A-Za-z0-9_-]{6,}$/);
      if (m) return s;
      return "";
    }

    let eventosData = [], eventosFiltrados = [], currentPage = 1, eventsPerPage = 6;

    function getFechaDesdeRaw(ev){
      return (ev && (ev.fecha_desde ?? ev.fechaDesde ?? ev.fecha_desde_iso)) ? (ev.fecha_desde ?? ev.fechaDesde ?? ev.fecha_desde_iso) : '';
    }
    function getFechaHastaRaw(ev){
      return (ev && (ev.fecha_hasta ?? ev.fechaHasta ?? ev.fecha_hasta_iso)) ? (ev.fecha_hasta ?? ev.fechaHasta ?? ev.fecha_hasta_iso) : '';
    }

    function parseToDate(value){
      if (value === null || value === undefined || value === '') return null;
      if (Object.prototype.toString.call(value) === '[object Date]') {
        const d = new Date(value);
        return isNaN(d.getTime()) ? null : d;
      }
      const s = String(value).trim();
      let m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (m) return new Date(parseInt(m[1],10), parseInt(m[2],10)-1, parseInt(m[3],10));
      m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if (m) return new Date(parseInt(m[3],10), parseInt(m[2],10)-1, parseInt(m[1],10));
      m = s.match(/^Date\((\d{4}),\s*(\d+),\s*(\d+)(?:,\s*(\d+),\s*(\d+))?/);
      if (m) return new Date(parseInt(m[1],10), parseInt(m[2],10), parseInt(m[3],10));
      const d = new Date(s);
      return isNaN(d.getTime()) ? null : d;
    }

    function isPastDate(desdeValue, hastaValue){
      const dDesde = parseToDate(desdeValue);
      const dHasta = parseToDate(hastaValue);
      const d = dHasta || dDesde;
      if (!d) return false;
      const today = new Date();
      today.setHours(0,0,0,0);
      const onlyDate = new Date(d.getFullYear(), d.getMonth(), d.getDate());
      return onlyDate.getTime() < today.getTime();
    }

    function horaHumana(h){
      if (!h) return "";
      h = String(h).trim();
      let m = h.match(/^Date\(\d{4},\d{1,2},\d{1,2},(\d{1,2}),(\d{1,2})/);
      if (m) return `${String(m[1]).padStart(2,'0')}:${String(m[2]).padStart(2,'0')} hs`;
      m = h.match(/^(\d{1,2}):(\d{2})(:\d{2})?$/);
      if (m) return `${String(m[1]).padStart(2,'0')}:${m[2]} hs`;
      return h;
    }

    function textoAParrafoJustificado(texto){
      if (!texto) return "";
      const partes = texto.split(/\n\s*\n/).length>1 ? texto.split(/\n\s*\n/) : texto.split(/\n/);
      return partes.map(p=>`<p style="margin:6px 0 6px 0;text-align:justify">${p.trim()}</p>`).join("");
    }

    function capitalizarPrimeraLetra(txt){
      txt = String(txt || '').trim();
      if (!txt) return '';
      return txt.charAt(0).toUpperCase() + txt.slice(1);
    }

    function formatRangoFechasHumano(ev){
      const rawDesde = getFechaDesdeRaw(ev);
      const rawHasta = getFechaHastaRaw(ev);

      const dDesde = parseToDate(rawDesde);
      const dHasta = parseToDate(rawHasta);

      if (ev && ev.fecha_humana) return capitalizarPrimeraLetra(ev.fecha_humana);

      const fmt = (d) => capitalizarPrimeraLetra(
        d.toLocaleDateString('es-AR', { weekday:'long', year:'numeric', month:'long', day:'numeric' })
      );

      if (dDesde && dHasta){
        const sameDay =
          dDesde.getFullYear() === dHasta.getFullYear() &&
          dDesde.getMonth() === dHasta.getMonth() &&
          dDesde.getDate() === dHasta.getDate();
        if (sameDay) return fmt(dDesde);
        return `${fmt(dDesde)} — ${fmt(dHasta)}`;
      }
      if (dDesde) return fmt(dDesde);
      if (dHasta) return fmt(dHasta);
      return '';
    }

    function hydrateCategoryFilterFromEvents(events){
      const select = document.getElementById('categoryFilter');
      if (!select) return;
      const current = select.value || '';
      const cats = new Set();
      (events || []).forEach(ev=>{
        const c = ev && ev.categoria ? String(ev.categoria).trim() : '';
        if (c) cats.add(c);
      });
      const arr = Array.from(cats).sort((a,b)=>a.localeCompare(b,'es',{sensitivity:'base'}));
      select.innerHTML = '';
      const opt0 = document.createElement('option');
      opt0.value = '';
      opt0.textContent = 'Todas las categorías';
      select.appendChild(opt0);
      arr.forEach(c=>{
        const o = document.createElement('option');
        o.value = c;
        o.textContent = c;
        select.appendChild(o);
      });
      if (current && arr.includes(current)) select.value = current;
    }

    function safeUrl(u){
      const s = String(u || '').trim();
      if (!s) return '';
      if (!/^https?:\/\//i.test(s)) return '';
      return s;
    }

    function getPartners(ev){
      const names = [ev.partner, ev.partner2, ev.partner3, ev.partner4, ev.partner5, ev.partner6]
        .map(x=>String(x||'').trim())
        .filter(Boolean);

      const logos = [ev.logo_partner, ev.logo_partner2, ev.logo_partner3, ev.logo_partner4, ev.logo_partner5, ev.logo_partner6]
        .map(x=>String(x||'').trim());

      const items = [];
      for (let i=0;i<names.length;i++){
        items.push({ name: names[i], logo: safeUrl(logos[i]) || '' });
      }
      return items;
    }

    function mountEmbedBlock(rightEl, title, url){
      const wrap = document.createElement('div');
      wrap.className = 'embed-wrap';

      const head = document.createElement('div');
      head.className = 'embed-head';

      const label = document.createElement('span');
      label.textContent = title;

      const close = document.createElement('button');
      close.className = 'embed-close';
      close.type = 'button';
      close.textContent = 'Ocultar';
      close.onclick = ()=> wrap.remove();

      head.appendChild(label);
      head.appendChild(close);

      const ifr = document.createElement('iframe');
      ifr.className = 'embed-iframe';
      ifr.src = url;
      ifr.loading = 'lazy';
      ifr.setAttribute('sandbox', 'allow-scripts allow-same-origin allow-forms allow-presentation allow-popups');

      wrap.appendChild(head);
      wrap.appendChild(ifr);

      rightEl.appendChild(wrap);
      return wrap;
    }

    /* Banner: CTA nueva pestaña; YouTube reproducible (como en V2), tamaño reel 9/16 */
    function createBannerAdElement(ad){
      const el = document.createElement('div');
      el.className = 'ad-card';
      let mediaShown = false;

      if (ad.type === 'youtube' && (ad.videoId || ad.videoUrl)){
        const vidId = ad.videoId || normalizeYouTubeId(ad.videoUrl);

        const thumb = document.createElement('img');
        thumb.className = 'ad-img';
        thumb.alt = 'Publicidad';
        thumb.loading = 'lazy';
        thumb.src = `https://img.youtube.com/vi/${vidId}/hqdefault.jpg`;
        el.appendChild(thumb);

        const play = document.createElement('button');
        play.className = 'ad-play';
        play.type = 'button';
        play.textContent = 'Reproducir video';
        play.onclick = function(){
          if (mediaShown) return;
          mediaShown = true;
          thumb.remove();

          const origin = encodeURIComponent(location.origin);

          const vid = document.createElement('div');
          vid.className = 'ad-video'; // tamaño reel (9/16) controlado por CSS

          const iframe = document.createElement('iframe');
          iframe.src = `https://www.youtube.com/embed/${vidId}?enablejsapi=1&autoplay=1&mute=1&rel=0&modestbranding=1&playsinline=1&origin=${origin}`;
          iframe.loading = 'lazy';
          iframe.setAttribute('allow','accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share');
          iframe.setAttribute('allowfullscreen','true');
          iframe.setAttribute('sandbox','allow-scripts allow-same-origin allow-presentation');

          vid.appendChild(iframe);
          el.insertBefore(vid, play);

          play.textContent = 'Reproduciendo';
          play.disabled = true;
        };
        el.appendChild(play);
      } else if (ad.type === 'image' && ad.img){
        const img = document.createElement('img');
        img.className = 'ad-img';
        img.alt = 'Publicidad';
        img.loading = 'lazy';
        img.referrerPolicy = 'no-referrer';
        img.src = ad.img;
        el.appendChild(img);
      }

      const btn = document.createElement('button');
      btn.className = 'ad-cta';
      btn.type = 'button';
      btn.textContent = 'Visitar anunciante';
      btn.onclick = function(){
        const u = safeUrl(ad.url);
        if (!u) return;
        window.open(u, '_blank', 'noopener');
      };

      el.appendChild(btn);
      return el;
    }

    function showImgModal(imgArr, index) {
      const modal = document.getElementById('modalImgViewer');
      const modalImg = document.getElementById('modalImgMain');
      const thumbs = document.getElementById('modalImgThumbs');
      if (!imgArr.length) return;
      let curIdx = (typeof index === 'number' && index<imgArr.length) ? index : 0;
      function setImg(idx){
        modalImg.src = imgArr[idx];
        Array.from(thumbs.children).forEach((img,i)=>img.classList.toggle('selected',i===idx));
      }
      thumbs.innerHTML = '';
      imgArr.forEach((url,i)=>{
        const im = document.createElement('img');
        im.src=url; im.alt="Miniatura"; im.tabIndex=0;
        if(i===curIdx) im.classList.add('selected');
        im.onclick=()=>{ curIdx=i; setImg(i);}
        im.onkeyup=(e)=>{ if(e.key==='Enter') { curIdx=i; setImg(i);} }
        thumbs.appendChild(im);
      });
      setImg(curIdx);
      modal.classList.add('open');
      document.body.style.overflow='hidden';
      modalImg.focus && modalImg.focus();
      function handleKey(e){
        if (e.key==='Escape') { closeModal(); }
        else if ((e.key==='ArrowLeft'||e.key==='a') && curIdx>0){ curIdx--; setImg(curIdx);}
        else if ((e.key==='ArrowRight'||e.key==='d') && curIdx<imgArr.length-1){ curIdx++; setImg(curIdx); }
      }
      function closeModal(){
        modal.classList.remove('open');
        modalImg.src='';
        document.body.style.overflow='';
        document.removeEventListener('keydown', handleKey);
      }
      document.getElementById('modalImgClose').onclick=closeModal;
      modal.onclick = (evt)=>{
        if(evt.target===modal) closeModal();
      }
      document.addEventListener('keydown', handleKey);
    }

    function renderCategoryBlock(ev){
      const group = document.createElement('div');
      group.className = 'category-group';

      const raw = String(ev && ev.logo_categoria ? ev.logo_categoria : '').trim();
      const iconUrls = raw ? raw.split(',').map(s=>safeUrl(s.trim())).filter(Boolean) : [];

      // Ícono ADELANTE de la etiqueta de categoría
      if (iconUrls.length){
        const firstIcon = document.createElement('img');
        firstIcon.className = 'category-icon';
        firstIcon.src = iconUrls[0];
        firstIcon.alt = 'Icono categoría';
        firstIcon.loading = 'lazy';
        firstIcon.referrerPolicy = 'no-referrer';
        group.appendChild(firstIcon);
      }

      const catText = String(ev && ev.categoria ? ev.categoria : '').trim();
      if (catText){
        const chip = document.createElement('div');
        chip.className = 'category-text';
        chip.textContent = catText;
        group.appendChild(chip);
      }

      // Resto de iconos (si hay más), DESPUÉS de la etiqueta
      if (iconUrls.length > 1){
        const iconsWrap = document.createElement('div');
        iconsWrap.className = 'category-icons';
        iconUrls.slice(1).forEach(url=>{
          const img = document.createElement('img');
          img.className = 'category-icon';
          img.src = url;
          img.alt = 'Icono categoría';
          img.loading = 'lazy';
          img.referrerPolicy = 'no-referrer';
          iconsWrap.appendChild(img);
        });
        group.appendChild(iconsWrap);
      }

      return group;
    }

    function renderEventos(data,page=1){
      const container = document.getElementById('events');
      container.innerHTML = '';
      const start = (page-1)*eventsPerPage;
      const end = start+eventsPerPage;
      const pageData = data.slice(start,end);
      if (!pageData.length){
        container.innerHTML = `<p style="color:#b02a2a;font-weight:800">No hay eventos para mostrar con ese criterio.</p>`;
        document.getElementById('paginator').innerHTML = '';
        document.getElementById('main-title').textContent = `Planes para hoy en Dolores`;
        return;
      }

      const adPool = shuffleArray(AD_BANNERS);
      let adPtr = 0;

      pageData.forEach((ev, idxOnPage)=>{
        const card = document.createElement('article');
        const nivelStr = (ev && ev.nivel) ? String(ev.nivel).toLowerCase() : '';
        const lvl = nivelStr.includes('vip') ? 'vip' : (nivelStr.includes('free') ? 'free' : '');
        card.className = `card event-card ${lvl}`;

        const head = document.createElement('div');
        head.className = 'card-head';
        const left = document.createElement('div');
        left.className = 'head-left';

        const lo = safeUrl(ev && ev.logo_organizador ? ev.logo_organizador : '');
        if (lvl==='vip' && lo){
          const logoimg = document.createElement('img');
          logoimg.className = 'logo-organizador-head';
          logoimg.src = lo;
          logoimg.alt = "Logo del organizador";
          logoimg.referrerPolicy = "no-referrer";
          logoimg.loading = "lazy";
          left.appendChild(logoimg);
        }

        const orgInline = document.createElement('div');
        orgInline.className = 'organizer-inline';
        const lbl = document.createElement('span');
        lbl.className = 'label';
        lbl.textContent = 'Organiza:';
        const nm = document.createElement('span');
        nm.className = 'name';
        nm.textContent = ev.organizador || ev.organizador_principal || "-";
        orgInline.appendChild(lbl);
        orgInline.appendChild(nm);
        left.appendChild(orgInline);

        head.appendChild(left);
        if (lvl){
          const b = document.createElement('div');
          b.className = `badge ${lvl}`;
          b.textContent = lvl.toUpperCase();
          head.appendChild(b);
        }
        card.appendChild(head);

        const body = document.createElement('div');
        body.className = 'card-body';

        // Título simple (SIN icono delante)
        const h = document.createElement('h2');
        h.className='title-card';
        h.textContent = (ev && (ev.nombre_evento || ev.nombre)) ? (ev.nombre_evento || ev.nombre) : '';
        body.appendChild(h);

        // Bloque categoría con icono ANTES del texto (ya ajustado)
        body.appendChild(renderCategoryBlock(ev));

        const infoBlock = document.createElement('div');
        infoBlock.className = 'info-block';
        const fechaHum = formatRangoFechasHumano(ev);

        const hrRaw = (ev && ev.hora_unificada && String(ev.hora_unificada).trim()) ? ev.hora_unificada :
                      ((ev && ev.hora && String(ev.hora).trim()) ? ev.hora : (ev ? (ev.hora2 || '') : ''));
        let hrShown = horaHumana(hrRaw);
        if (/^Sat\s+Dec\s+30\s+1899/i.test(String(hrShown || ''))) hrShown = '';
        if (fechaHum || hrShown){
          const line = document.createElement('div');
          line.className = 'line';
          line.innerHTML = `<i class="ri-calendar-event-line"></i><div class="text">${fechaHum ? fechaHum : ''}${(fechaHum && hrShown) ? ' • ' : ''}${hrShown ? hrShown : ''}</div>`;
          infoBlock.appendChild(line);
        }
        if (ev && ev.lugar){
          const line = document.createElement('div');
          line.className = 'line';
          line.innerHTML = `<i class="ri-map-pin-line"></i><div class="text">${ev.lugar}</div>`;
          infoBlock.appendChild(line);
        }
        if (ev && ev.direccion){
          const line = document.createElement('div');
          line.className = 'line';
          line.innerHTML = `<i class="ri-road-map-line"></i><div class="muted"><strong>Dirección:</strong> ${ev.direccion}</div>`;
          infoBlock.appendChild(line);

          const llegarUrl = safeUrl(ev && ev.llegar ? ev.llegar : '');
          if (llegarUrl){
            const mapA = document.createElement('a');
            mapA.href=llegarUrl;
            mapA.className = 'map-link';
            mapA.target="_blank";
            mapA.rel="noopener noreferrer";
            mapA.innerHTML = `<i class="ri-map-pin-2-line"></i> ¿Cómo llegar?`;
            infoBlock.appendChild(mapA);
          }
        }
        body.appendChild(infoBlock);

        if (ev && ev.descripcion){
          const desc = document.createElement('div');
          desc.className='desc';
          desc.innerHTML = textoAParrafoJustificado(ev.descripcion);
          body.appendChild(desc);
        }

        if (lvl==='vip') {
          const gal = [];
          ['img1','img2','img3'].forEach(k=>{
            let u = safeUrl(ev && ev[k] ? ev[k] : '');
            if(u) gal.push(u);
          });
          if (gal.length > 0) {
            const gallery = document.createElement('div');
            gallery.className = 'gallery-bar';
            gal.forEach((url,i)=>{
              const gimg = document.createElement('img');
              gimg.className = 'gallery-thumb';
              gimg.style.aspectRatio = "1/1";
              gimg.src = url;
              gimg.loading = 'lazy';
              gimg.alt = `Foto ${i+1}`;
              gimg.tabIndex=0;
              gimg.onclick = ()=>showImgModal(gal,i);
              gimg.onkeyup = (e)=>{if(e.key==="Enter"||e.key===" "){showImgModal(gal,i);}};
              gallery.appendChild(gimg);
            });
            body.appendChild(gallery);
          }
        }

        const enlace = safeUrl(ev && ev.entradas ? ev.entradas : '');
        if (enlace){
          mountEmbedBlock(body, 'Entradas / Inscripción', enlace);
        }

        const partners = getPartners(ev);
        if (partners.length){
          const sponsors = document.createElement('div');
          sponsors.className = 'sponsors';
          const st = document.createElement('div');
          st.className = 'sponsors-title';
          st.innerHTML = `<i class="ri-hand-heart-line"></i> <span>Auspicia</span>`;
          sponsors.appendChild(st);
          const grid = document.createElement('div');
          grid.className = 'sponsors-grid';
          partners.forEach(p=>{
            const item = document.createElement('div');
            item.className = 'sponsor-item';
            const img = document.createElement('img');
            img.className = 'sponsor-logo';
            img.alt = p.name || 'Auspicia';
            img.loading = 'lazy';
            img.referrerPolicy = 'no-referrer';
            img.src = p.logo ? p.logo : PLACEHOLDER_SVG;
            img.onerror = function(){
              this.src = PLACEHOLDER_SVG;
              this.onerror = null;
            };
            const name = document.createElement('div');
            name.className = 'sponsor-name';
            name.textContent = p.name;
            item.appendChild(img);
            item.appendChild(name);
            grid.appendChild(item);
          });
          sponsors.appendChild(grid);
          body.appendChild(sponsors);
        }

        card.appendChild(body);
        container.appendChild(card);

        const isSecond = ((idxOnPage + 1) % 2 === 0);
        const notLast = (idxOnPage !== pageData.length - 1);
        if (isSecond && notLast && adPtr < adPool.length){
          container.appendChild(createBannerAdElement(adPool[adPtr++]));
        }
      });
      renderPaginator(data.length, page);
      document.getElementById('main-title').textContent = `Planes para hoy en Dolores`;
    }

    function renderPaginator(total,page){
      const cont = document.getElementById('paginator');
      const totalPages = Math.ceil(total / eventsPerPage);
      if (totalPages <= 1) { cont.innerHTML = ''; return; }
      let html = `<button id="prev"${page<=1 ? ' disabled':''}>Anterior</button>`;
      const pages = new Set(); pages.add(1); pages.add(totalPages);
      for (let i=Math.max(2,page-2); i<=Math.min(totalPages-1,page+2); i++) pages.add(i);
      const list = Array.from(pages).sort((a,b)=>a-b);
      let last=0;
      for (const p of list){
        if (p-last>1) html += `<span style="padding:0 8px;color:#667">...</span>`;
        html += (p===page)
          ? `<span style="font-weight:900;background:#e8f2ff;padding:6px 8px;border-radius:8px;color:#133">${p}</span>`
          : `<button class="page-btn" data-page="${p}" style="background:#2a63bf">${p}</button>`;
        last = p;
      }
      html += `<button id="next"${page>=totalPages ? ' disabled':''}>Siguiente</button>`;
      cont.innerHTML = html;
      const prev = document.getElementById('prev');
      const next = document.getElementById('next');
      prev && (prev.onclick = ()=>{ if (currentPage>1){ currentPage--; renderEventos(eventosFiltrados,currentPage); scrollToEvents(); }});
      next && (next.onclick = ()=>{ if (currentPage<totalPages){ currentPage++; renderEventos(eventosFiltrados,currentPage); scrollToEvents(); }});
      document.querySelectorAll('.page-btn').forEach(b=>b.onclick = function(){
        const p = parseInt(this.dataset.page,10);
        if (!isNaN(p) && p!==currentPage){
          currentPage=p;
          renderEventos(eventosFiltrados,currentPage);
          scrollToEvents();
        }
      });
    }
    function scrollToEvents(){
      const el = document.getElementById('events');
      if (el) el.scrollIntoView({behavior:'smooth',block:'start'});
    }
    document.getElementById('search').addEventListener('input', function(){
      aplicarFiltro(this.value, document.getElementById('categoryFilter').value);
    });
    document.getElementById('categoryFilter').addEventListener('change', function(){
      aplicarFiltro(document.getElementById('search').value, this.value);
    });
    function aplicarFiltro(search, category){
      const q = String(search||'').trim().toLowerCase();
      const cat = String(category||'').trim().toLowerCase();
      eventosFiltrados = eventosData.filter(ev=>{
        if (!ev) return false;
        if (cat && (!ev.categoria || String(ev.categoria).toLowerCase().indexOf(cat)===-1)) return false;
        if (!q) return true;
        const hay = [
          ev.fecha_humana || '',
          getFechaDesdeRaw(ev) || '',
          getFechaHastaRaw(ev) || '',
          ev.categoria || '',
          ev.nombre_evento || ev.nombre || '',
          ev.organizador || ev.organizador_principal || '',
          ev.entradas || '',
          ev.descripcion || '',
          ev.lugar || '',
          ev.direccion || ''
        ].join(' ').toLowerCase();
        return hay.indexOf(q)!==-1;
      });
      currentPage = 1;
      renderEventos(eventosFiltrados,currentPage);
    }

    (function setupSumaTuEvento(){
      const btn = document.getElementById('btnSumaEvento');
      btn && (btn.onclick = ()=> window.open(SUMA_EVENTO_URL, '_blank', 'noopener'));
    })();

    async function init(){
      try{
        const r = await fetch(EVENTS_ENDPOINT, { cache: "no-store" });
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const data = await r.json();
        const arr = (data && data.events) ? data.events : [];

        eventosData = arr.filter(ev => {
          const desde = getFechaDesdeRaw(ev);
          const hasta = getFechaHastaRaw(ev);
          return !isPastDate(desde, hasta);
        });

        eventosData.sort((a,b)=>{
          const da = parseToDate(getFechaDesdeRaw(a)) || new Date(8640000000000000);
          const db = parseToDate(getFechaDesdeRaw(b)) || new Date(8640000000000000);
          return da.getTime() - db.getTime();
        });

        eventosFiltrados = eventosData.slice();
        hydrateCategoryFilterFromEvents(eventosData);
        renderEventos(eventosFiltrados, 1);
      } catch(e){
        document.getElementById('events').innerHTML = `<p class="error">No se pudieron cargar los datos de eventos.</p>`;
      }
    }
    init();
  </script>
</body>
</html>
