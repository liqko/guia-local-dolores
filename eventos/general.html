<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title id="dynamic-title">Eventos</title>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">
  <style>
    :root{
      --bg: #f6f8fb;
      --panel: #ffffff;
      --muted: #6b7a90;
      --blue: #275fb8;
      --vip: #ffb74d;
      --card-radius: 14px;
      --shadow: 0 10px 30px rgba(28,43,78,0.06);
    }
    html,body{height:100%;margin:0;background:var(--bg);font-family:"Segoe UI", Arial, sans-serif;color:#122;}
    .wrap{max-width:1000px;margin:20px auto;padding:18px;box-sizing:border-box;}
    .header{display:flex;gap:14px;align-items:center;margin-bottom:12px}
    .logo{width:88px;height:88px;border-radius:14px;object-fit:cover;background:#fff;box-shadow:0 6px 20px rgba(33,49,86,0.06);padding:8px}
    .title{font-size:1.55rem;font-weight:800;color:#16335a;background:#f3f6fb;padding:10px 14px;border-radius:10px;border:1px solid #e6eefb}
    .controls{display:flex;gap:10px;flex-wrap:wrap;margin:14px 0 18px;align-items:center}
    .search{flex:1;min-width:220px;padding:12px 14px;border-radius:12px;border:1.5px solid #d7e1f7;background:#fff;box-shadow:inset 0 1px 0 #fff}
    .select{padding:10px 12px;border-radius:10px;border:1px solid #d7e1f7;background:#fff;font-weight:700}
    .cta{padding:10px 14px;border-radius:10px;background:linear-gradient(90deg,#ffd972 0,#ff7a2a 100%);color:#222;font-weight:800;text-decoration:none;border:2px solid #ff7a2a}
    .events{display:flex;flex-direction:column;gap:16px}
    .card{display:flex;gap:16px;align-items:flex-start;background:var(--panel);border-radius:var(--card-radius);box-shadow:var(--shadow);padding:14px;position:relative;transition:transform .18s,box-shadow .18s}
    .card:hover{transform:translateY(-6px);box-shadow:0 18px 40px rgba(28,43,78,0.12)}
    .left{flex:0 0 120px;display:flex;flex-direction:column;gap:10px;align-items:center}
    .thumb{width:120px;height:120px;border-radius:12px;background:#eee;object-fit:cover;display:block;border:1px solid #f0f4fb}
    .right{flex:1;display:flex;flex-direction:column;gap:8px}
    .event-card.vip { border:2px solid var(--vip); background:linear-gradient(180deg,#fffaf0 0,#fffef8 100%); }
    .event-card.free { border:1px solid #d6e1f3; background:linear-gradient(180deg,#ffffff 0,#fbfdff 100%); }
    .event-badge { position:absolute; top:12px; right:12px; padding:7px 12px; border-radius:999px; font-weight:900; box-shadow:0 6px 18px rgba(0,0,0,0.06) }
    .badge.vip{background:linear-gradient(90deg,#ffd166,#ff9f1c);color:#4a2b00}
    .badge.free{background:#e8f1ff;color:#0e4f8a;border:1px solid #d6e1f3}
    .title-card{font-size:1.14rem;font-weight:900;color:#16335a;margin:0}
    .category{display:inline-block;background:#f0edff;color:#5a39b9;padding:6px 10px;border-radius:999px;font-weight:800;font-size:.92rem}
    .meta{display:flex;gap:12px;flex-wrap:wrap;align-items:center;color:var(--blue);font-weight:700;font-size:.95rem}
    .desc{color:#243447;line-height:1.35;text-align:justify;margin:0}
    .info{color:#22529a;font-weight:700;font-style:italic}
    .organizer{font-weight:800;color:#1b3069}
    .action{margin-top:8px;display:inline-block;background:var(--blue);color:#fff;padding:10px 14px;border-radius:10px;text-decoration:none;font-weight:800}
    .partners{margin-top:8px;font-size:.95rem;color:#445}
    .placeholder{display:flex;align-items:center;justify-content:center;width:100%;height:100%;background:linear-gradient(90deg,#f0f4ff,#fff);border-radius:8px;color:#99a3b7}
    .paginator{display:flex;gap:8px;justify-content:center;padding:12px;margin-top:14px}
    .paginator button{padding:8px 12px;border-radius:8px;border:none;background:var(--blue);color:#fff;font-weight:800;cursor:pointer}
    .paginator button[disabled]{background:#c7d7f6;cursor:not-allowed}
    @media(max-width:820px){ .card{flex-direction:column} .left{flex-direction:row;gap:12px} .thumb{width:90px;height:90px} }
  </style>
</head>
<body>
  <div class="wrap" role="main">
    <div class="header">
      <img class="logo" src="https://raw.githubusercontent.com/liqko/guia-local-dolores/refs/heads/main/img/plataforma/eventos.png" alt="logo">
      <div class="title" id="main-title">Listado Unificado de Eventos</div>
    </div>

    <div class="controls" role="region" aria-label="filtros">
      <input id="search" class="search" type="search" placeholder="Buscar por fecha, categoría, organizador o lugar...">
      <select id="categoryFilter" class="select" aria-label="Filtrar por categoría">
        <option value="">Todas las categorías</option>
      </select>
      <a class="cta" href="https://www.guialocaldolores.com.ar/suma-tu-evento/" target="_blank" rel="noopener">SUMÁ TU EVENTO</a>
    </div>

    <div id="loading" style="display:none;margin:14px 0;text-align:center;color:var(--blue);font-weight:800">Cargando eventos...</div>
    <div class="events" id="events" aria-live="polite"></div>
    <div class="paginator" id="paginator" aria-label="Paginador"></div>
  </div>

  <div id="enlaceModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(43,58,85,0.6); align-items:center; justify-content:center; z-index:9999;">
    <div style="width:95%; max-width:980px; height:85vh; background:#fff; border-radius:10px; overflow:hidden; position:relative;">
      <button id="cerrarModal" aria-label="Cerrar" style="position:absolute; top:12px; right:12px; z-index:20; background:var(--blue); color:#fff; border-radius:50%; width:40px; height:40px; border:none; font-size:1.2rem;">×</button>
      <iframe id="modalIframe" src="" style="width:100%; height:100%; border:0; background:#f5f7fb;"></iframe>
    </div>
  </div>

  <script>
    const SPREADSHEET_ID = "1CCNDvrIFFufiLXmYkm4YcmtZVpk6rG2gJQQYXzA186o";
    const EVENTS_GID = "338324539";
    const CATS_GID = "151081954";
    const GVIZ = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&gid=`;
    const EVENTS_URL = GVIZ + EVENTS_GID;
    const CATS_URL = GVIZ + CATS_GID;

    // Generic organizer logo for free events (user-provided)
    const GENERIC_FREE_LOGO = "https://res.cloudinary.com/dw3oovvb1/image/upload/v1761345482/mpeum21vwegc0acgvrfw.png";

    // inline SVG placeholder (data URI)
    const PLACEHOLDER_SVG = `data:image/svg+xml;utf8,` +
      encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='480' height='320'><rect width='100%' height='100%' fill='#eef4ff'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='#9fb0d8' font-family='Arial' font-size='18'>Imagen no disponible</text></svg>`);

    let eventosData = [], eventosFiltrados = [], currentPage = 1, eventsPerPage = 6;
    let fetchAttempts = 0, maxFetchAttempts = 3;

    function jsonFromGviz(text){
      try { return JSON.parse(text.substr(47).slice(0,-2)); }
      catch(e){ throw new Error('GViz parse error: ' + (e.message||e)); }
    }
    function isVerificado(v){
      if (v === undefined || v === null) return false;
      if (typeof v === 'boolean') return v === true;
      const s = String(v).toLowerCase().trim();
      return ["si","sí","true","ok","✓","x","check","checked","1","yes"].includes(s);
    }

    function fechaHumana(valor){
      if (!valor) return "";
      valor = String(valor).trim();
      let m = valor.match(/^Date\((\d{4}),\s*(\d+),\s*(\d+)/);
      if (m) { const y=parseInt(m[1]), mo=parseInt(m[2]), d=parseInt(m[3]); return new Date(y,mo,d).toLocaleDateString('es-AR',{weekday:'long',day:'numeric',month:'long',year:'numeric'}); }
      if (/^\d{4}-\d{2}-\d{2}$/.test(valor)) { const [y,mo,d]=valor.split('-'); return new Date(parseInt(y),parseInt(mo,10)-1,parseInt(d)).toLocaleDateString('es-AR',{weekday:'long',day:'numeric',month:'long',year:'numeric'}); }
      if (/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/.test(valor)){ const mm=valor.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/); return new Date(parseInt(mm[3]),parseInt(mm[2],10)-1,parseInt(mm[1])).toLocaleDateString('es-AR',{weekday:'long',day:'numeric',month:'long',year:'numeric'}); }
      return valor;
    }

    function adaptarFilaUnificada(cells){
      const get = i => (cells[i] && cells[i].v !== undefined) ? cells[i].v : "";
      const partners = []; for (let p=22;p<=32;p+=2){ const v=get(p); if (v) partners.push(v); }
      const entradas = get(21);
      const enlace = (typeof entradas === 'string' && entradas.match(/^https?:\/\//i)) ? entradas : "";
      return {
        aprobado: get(0),
        nivel: get(1),
        evento_id: get(2),
        id_anunciante: get(3),
        organizador_principal: get(4),
        logo_organizador: get(5),
        categoria: get(6),
        nombre: get(8),
        localidad: get(9),
        lugar: get(10),
        direccion: get(11),
        llegar: get(12),
        fecha: get(13),
        fecha_humana: fechaHumana(get(13)),
        hora: get(14),
        hora2: get(15),
        descripcion: get(16),
        instagram: get(17),
        img1: get(18),
        entradas: entradas,
        enlace: enlace,
        auspiciantes: partners.join(", "),
        logo: get(18)
      };
    }

    async function fetchCategories(){
      try {
        const r = await fetch(CATS_URL);
        const t = await r.text();
        const j = jsonFromGviz(t);
        const rows = j.table.rows || [];
        const cats = [];
        for (let i=0;i<rows.length;i++){
          const c = rows[i].c || [];
          if (!c[0] || c[0].v === undefined) continue;
          const v = String(c[0].v || "").trim(); if (v) cats.push(v);
        }
        const uniq = Array.from(new Set(cats)).sort((a,b)=>a.localeCompare(b,'es',{sensitivity:'base'}));
        const sel = document.getElementById('categoryFilter');
        const cur = sel.value || "";
        sel.innerHTML = '<option value="">Todas las categorías</option>' + uniq.map(x=>`<option value="${x}">${x}</option>`).join('');
        if (cur) sel.value = cur;
      } catch(e){ console.warn('fetchCategories failed', e); }
    }

    async function loadEventos(force=false){
      document.getElementById('events').innerHTML = '';
      document.getElementById('loading').style.display = 'block';
      if (!force) fetchAttempts++; else fetchAttempts = 1;
      await fetchCategories().catch(()=>{});
      try {
        const r = await fetch(EVENTS_URL);
        const t = await r.text();
        const j = jsonFromGviz(t);
        document.getElementById('loading').style.display = 'none';
        const rows = j.table.rows || [];
        eventosData = [];
        for (let i=0;i<rows.length;i++){
          const c = rows[i].c || [];
          const aprobadoCell = c[0] && c[0].v !== undefined ? c[0].v : "";
          if (!isVerificado(aprobadoCell)) continue;
          const ev = adaptarFilaUnificada(c);
          if (!ev.nombre || String(ev.nombre).trim()==="") ev.nombre = ev.organizador_principal || ev.lugar || ev.categoria || '';
          if (!ev.nivel || String(ev.nivel).trim()===""){
            for (let j=0;j<c.length;j++){
              try { const txt = c[j] && c[j].v !== undefined ? String(c[j].v) : String(c[j]||''); const s = txt.toLowerCase(); if (s.indexOf('vip')!==-1){ev.nivel='vip';break;} if (s.indexOf('free')!==-1){ev.nivel='free';break;} } catch(e){}
            }
          }
          if ((!ev.nombre || String(ev.nombre).trim()==="") && (!ev.fecha || String(ev.fecha).trim()==="") && (!ev.organizador_principal || String(ev.organizador_principal).trim()==="") && (!ev.lugar || String(ev.lugar).trim()==="")) continue;
          eventosData.push(ev);
        }
        eventosData.sort((a,b)=>{
          const toISO = s => { if (!s) return ""; if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s; const m = String(s).match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/); if (m) return `${m[3]}-${m[2].padStart(2,'0')}-${m[1].padStart(2,'0')}`; return s; };
          return toISO(a.fecha||"").localeCompare(toISO(b.fecha||""));
        });
        eventosFiltrados = eventosData.slice();
        currentPage = 1;
        renderEventos(eventosFiltrados, currentPage);
      } catch(e){
        document.getElementById('loading').style.display = 'none';
        if (fetchAttempts < maxFetchAttempts) setTimeout(()=>loadEventos(),1200);
        else {
          document.getElementById('events').innerHTML = `<p style="color:#b02a2a;font-weight:800">No se pudieron cargar los datos. Revisa permisos o publicación de la hoja.</p>`;
        }
      }
    }

    function textoAParrafoJustificado(texto){ if (!texto) return ""; const partes = texto.split(/\n\s*\n/).length>1 ? texto.split(/\n\s*\n/) : texto.split(/\n/); return partes.map(p=>`<p style="margin:6px 0 6px 0;text-align:justify">${p.trim()}</p>`).join(""); }

    function renderEventos(data,page=1){
      const container = document.getElementById('events'); container.innerHTML = '';
      const start = (page-1)*eventsPerPage, end = start+eventsPerPage, pageData = data.slice(start,end);
      if (!pageData.length){ container.innerHTML = `<p style="color:#b02a2a;font-weight:800">No hay eventos para mostrar con ese criterio.</p>`; document.getElementById('paginator').innerHTML = ''; return; }
      pageData.forEach((ev,idx)=>{
        const card = document.createElement('article');
        const lvl = ev.nivel && String(ev.nivel).toLowerCase().indexOf('vip')!==-1 ? 'vip' : (ev.nivel && String(ev.nivel).toLowerCase().indexOf('free')!==-1 ? 'free' : '');
        card.className = `card event-card ${lvl}`;
        if (lvl){
          const b = document.createElement('div'); b.className = `badge ${lvl}`; b.textContent = lvl.toUpperCase(); card.appendChild(b);
        }
        const left = document.createElement('div'); left.className = 'left';
        const img = document.createElement('img'); img.className='thumb'; img.alt = ev.nombre || 'imagen evento';
        // Candidate image selection and robust fallback for FREE
        let candidate = (ev.logo && ev.logo !== 'null') ? ev.logo : (ev.img1 && ev.img1 !== 'null' ? ev.img1 : '');
        // If event is free and there's no organizer logo, use provided generic
        if ((!candidate || String(candidate).trim()==='') && lvl === 'free') candidate = GENERIC_FREE_LOGO;
        // final fallback to placeholder
        img.loading = 'lazy';
        if (candidate && candidate !== 'null') {
          try { img.src = encodeURI(String(candidate)); }
          catch(e){ img.src = PLACEHOLDER_SVG; }
        } else {
          img.src = PLACEHOLDER_SVG;
        }
        // additional safety: CORS/referrer policy + error handler -> placeholder or generic
        img.crossOrigin = 'anonymous';
        img.referrerPolicy = 'no-referrer';
        img.onerror = function(){
          // if free event, try generic; else placeholder
          if (lvl === 'free' && this.src !== GENERIC_FREE_LOGO) this.src = GENERIC_FREE_LOGO;
          else this.src = PLACEHOLDER_SVG;
          this.onerror = null;
        };
        left.appendChild(img);
        const right = document.createElement('div'); right.className='right';
        const h = document.createElement('h2'); h.className='title-card'; h.textContent = ev.nombre || ''; right.appendChild(h);
        if (ev.categoria){ const c = document.createElement('div'); c.className='category'; c.textContent = ev.categoria; right.appendChild(c); }
        const meta = document.createElement('div'); meta.className='meta';
        if (ev.fecha_humana){ const d = document.createElement('div'); d.innerHTML = `<i class="ri-calendar-event-line"></i>&nbsp; ${ev.fecha_humana}`; meta.appendChild(d); }
        const hr = (ev.hora && String(ev.hora).trim()!=='') ? ev.hora : ((ev.hora2 && String(ev.hora2).trim()!=='')? ev.hora2 : '');
        if (hr){ const t = document.createElement('div'); t.innerHTML = `<i class="ri-time-line"></i>&nbsp; ${horaHumana(hr)}`; meta.appendChild(t); }
        if (ev.lugar){ const l = document.createElement('div'); l.innerHTML = `<i class="ri-map-pin-line"></i>&nbsp; ${ev.lugar}`; meta.appendChild(l); }
        right.appendChild(meta);
        if (ev.descripcion){ const desc = document.createElement('div'); desc.className='desc'; desc.innerHTML = textoAParrafoJustificado(ev.descripcion); right.appendChild(desc); }
        let infoAdd = ''; if (ev.direccion) infoAdd += `Dirección: ${ev.direccion}. `; if (ev.llegar) infoAdd += `Cómo llegar: ${ev.llegar}. `;
        if (infoAdd){ const ia = document.createElement('div'); ia.className='info'; ia.innerHTML = `<i class="ri-information-line"></i>&nbsp; ${infoAdd}`; right.appendChild(ia); }
        if (ev.auspiciantes){ const s = document.createElement('div'); s.className='partners'; s.innerHTML = `<strong>Auspicia:</strong> ${ev.auspiciantes}`; right.appendChild(s); }
        if (ev.organizador_principal){ const o = document.createElement('div'); o.className='organizer'; o.textContent = `Organiza: ${ev.organizador_principal}`; right.appendChild(o); }
        if (ev.enlace){ const a = document.createElement('a'); a.className='action'; a.href='#'; a.setAttribute('data-url', ev.enlace); a.textContent='Entradas / Más info'; a.onclick = function(e){ e.preventDefault(); abrirEnlaceModal(this.getAttribute('data-url')); }; right.appendChild(a); }
        const igHtml = ev.instagram ? (ev.instagram.indexOf('instagram.com')!==-1 ? `<div style="margin-top:8px"><iframe src="${ev.instagram.replace('/p/','/p/').replace('/reel/','/reel/')}" style="width:100%;max-width:380px;height:420px;border:none;border-radius:8px"></iframe></div>` : '') : '';
        if (igHtml){ const wrap = document.createElement('div'); wrap.innerHTML = igHtml; right.appendChild(wrap); }
        card.appendChild(left); card.appendChild(right); document.getElementById('events').appendChild(card);
      });
      renderPaginator(data.length, page);
    }

    function renderPaginator(total,page){
      const cont = document.getElementById('paginator'); const totalPages = Math.ceil(total / eventsPerPage);
      if (totalPages <= 1) { cont.innerHTML = ''; return; }
      let html = `<button id="prev"${page<=1 ? ' disabled':''}>Anterior</button>`;
      const pages = new Set(); pages.add(1); pages.add(totalPages);
      for (let i=Math.max(2,page-2); i<=Math.min(totalPages-1,page+2); i++) pages.add(i);
      const list = Array.from(pages).sort((a,b)=>a-b); let last=0;
      for (const p of list){ if (p-last>1) html += `<span style="padding:0 8px;color:#667">...</span>`; html += (p===page) ? `<span style="font-weight:900;background:#e8f2ff;padding:6px 8px;border-radius:6px">${p}</span>` : `<button class="page-btn" data-page="${p}">${p}</button>`; last=p; }
      html += `<button id="next"${page>=totalPages ? ' disabled':''}>Siguiente</button>`; cont.innerHTML = html;
      const prev = document.getElementById('prev'), next = document.getElementById('next');
      prev && (prev.onclick = ()=>{ if (currentPage>1){ currentPage--; renderEventos(eventosFiltrados,currentPage); scrollToEvents(); }});
      next && (next.onclick = ()=>{ if (currentPage<totalPages){ currentPage++; renderEventos(eventosFiltrados,currentPage); scrollToEvents(); }});
      document.querySelectorAll('.page-btn').forEach(b=>b.onclick = function(){ const p = parseInt(this.dataset.page,10); if (!isNaN(p) && p!==currentPage){ currentPage=p; renderEventos(eventosFiltrados,currentPage); scrollToEvents(); }});
    }

    function scrollToEvents(){ const el = document.getElementById('events'); if (el) el.scrollIntoView({behavior:'smooth',block:'start'}); }

    function abrirEnlaceModal(url){
      if (!url) return;
      const m = url.match(/instagram\.com\/(p|reel|tv)\/([a-zA-Z0-9_-]+)/);
      if (m){ document.getElementById('modalIframe').src = `https://www.instagram.com/${m[1]}/${m[2]}/embed`; document.getElementById('enlaceModal').style.display = 'flex'; return; }
      if (/^https?:\/\//i.test(url)){ document.getElementById('modalIframe').src = url; document.getElementById('enlaceModal').style.display = 'flex'; } else { window.open(url,'_blank','noopener'); }
    }
    document.getElementById('cerrarModal').onclick = function(){ document.getElementById('modalIframe').src=''; document.getElementById('enlaceModal').style.display='none'; };
    document.getElementById('search').addEventListener('input', function(){ aplicarFiltro(this.value, document.getElementById('categoryFilter').value); });
    document.getElementById('categoryFilter').addEventListener('change', function(){ aplicarFiltro(document.getElementById('search').value, this.value); });

    function aplicarFiltro(search, category){
      const q = String(search||'').trim().toLowerCase(); const cat = String(category||'').trim().toLowerCase();
      eventosFiltrados = eventosData.filter(ev=>{
        if (!ev) return false;
        if (cat && (!ev.categoria || ev.categoria.toLowerCase().indexOf(cat)===-1)) return false;
        if (!q) return true;
        const hay = [ev.fecha_humana||'',ev.categoria||'',ev.nombre||'',ev.organizador_principal||'',ev.auspiciantes||'',ev.descripcion||'',ev.lugar||''].join(' ').toLowerCase();
        return hay.indexOf(q)!==-1;
      });
      currentPage = 1; renderEventos(eventosFiltrados,currentPage);
    }

    (function init(){ loadEventos(); })();
  </script>
</body>
</html>
