<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Eventos</title>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">
  <style>
    /* ... Todo el CSS igual ... */
    body { background: transparent; font-family: 'Segoe UI', 'Arial', sans-serif; font-style: italic; margin: 0; padding: 0; overflow-x: hidden; }
    /* ... resto igual ... */
    .event-instagram-block { margin-top: 10px; text-align: center; }
    /* ... resto igual ... */
  </style>
</head>
<body>
  <div class="header-flex">
    <img src="https://raw.githubusercontent.com/liqko/guia-local-dolores/refs/heads/main/img/plataforma/eventos.png" alt="Logo Principal" class="main-logo" />
    <h1 class="header-title">Próximos Eventos</h1>
  </div>
  <div class="search-container">
    <input type="text" id="search" class="search-box" placeholder="Buscar por fecha, categoría u organizador...">
  </div>
  <div id="loading-indicator">
    <span id="loading-spinner">⏳</span> Cargando eventos...
  </div>
  <div id="retry-container">
    <button onclick="loadEventos(true)">Reintentar</button>
  </div>
  <div class="events-container" id="events"></div>
  <div class="paginator" id="paginator"></div>
  <div class="footer-zocalo">
    <div class="footer-zocalo-item">
      <a href="https://www.guialocaldolores.com.ar/actividades" target="_blank" title="Actividades">
        <img src="https://raw.githubusercontent.com/liqko/guia-local-dolores/refs/heads/main/img/plataforma/ACTIVIDADES.png" alt="Actividades"/>
      </a>
      <div class="footer-zocalo-label">Actividades</div>
    </div>
    <div class="footer-zocalo-item">
      <a href="https://www.guialocaldolores.com.ar/agenda-deportiva" target="_blank" title="Agenda Deportiva">
        <img src="https://raw.githubusercontent.com/liqko/guia-local-dolores/refs/heads/main/img/plataforma/DEPORTIVA.png" alt="Agenda Deportiva"/>
      </a>
      <div class="footer-zocalo-label">Agenda Deportiva</div>
    </div>
    <div class="footer-zocalo-item">
      <a href="https://www.guialocaldolores.com.ar/capacitaciones" target="_blank" title="Capacitaciones">
        <img src="https://raw.githubusercontent.com/liqko/guia-local-dolores/refs/heads/main/img/plataforma/CAPACITACIONES.png" alt="Capacitaciones"/>
      </a>
      <div class="footer-zocalo-label">Capacitaciones</div>
    </div>
  </div>
  <div id="enlaceModal">
    <div id="modalContent">
      <button id="cerrarModal">&times;</button>
      <iframe id="modalIframe" src=""></iframe>
    </div>
  </div>
  <script>
    function isVerificado(v) {
      if (!v) return false;
      const s = String(v).toLowerCase().trim();
      return ["si","sí","true","ok","✓","x","check","checked","1"].includes(s);
    }
    function normalizar(str) { return (str || "").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim(); }
    function fechaHumana(valor) {
      // ... igual ...
      if (!valor) return "";
      if (/^\d{4}-\d{2}-\d{2}$/.test(valor)) {
        const [anio, mes, dia] = valor.split("-");
        const fecha = new Date(parseInt(anio,10), parseInt(mes,10)-1, parseInt(dia,10));
        const meses = ["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"];
        const dias = ["Domingo","Lunes","Martes","Miércoles","Jueves","Viernes","Sábado"];
        return `${dias[fecha.getDay()]} ${parseInt(dia,10)} de ${meses[parseInt(mes,10)-1]} de ${anio}`;
      }
      // ... resto igual ...
      if (/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/.test(valor)) {
        const match = valor.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
        const dia = match[1], mes = match[2], anio = match[3];
        const fecha = new Date(parseInt(anio,10), parseInt(mes,10)-1, parseInt(dia,10));
        const meses = ["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"];
        const dias = ["Domingo","Lunes","Martes","Miércoles","Jueves","Viernes","Sábado"];
        return `${dias[fecha.getDay()]} ${parseInt(dia,10)} de ${meses[parseInt(mes,10)-1]} de ${anio}`;
      }
      if (/^Date\((\d{4}),\s*(\d+),\s*(\d+)\)$/.test(valor)) {
        const match = valor.match(/^Date\((\d{4}),\s*(\d+),\s*(\d+)\)$/);
        const anio = match[1], mes = match[2], dia = match[3];
        const fecha = new Date(parseInt(anio,10), parseInt(mes,10), parseInt(dia,10));
        const meses = ["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"];
        const dias = ["Domingo","Lunes","Martes","Miércoles","Jueves","Viernes","Sábado"];
        return `${dias[fecha.getDay()]} ${fecha.getDate()} de ${meses[fecha.getMonth()]} de ${fecha.getFullYear()}`;
      }
      return valor;
    }
    function horaHumana(valor) {
      // ... igual ...
      if (!valor) return "";
      let m = valor.match(/^Date\(\d{4},\d{1,2},\d{1,2},(\d{1,2}),(\d{1,2})/);
      if (m) {
        let h = m[1].padStart(2, "0"), min = m[2].padStart(2, "0");
        return `${h}:${min} hs`;
      }
      m = valor.match(/^(\d{1,2}):(\d{2})(:\d{2})?$/);
      if (m) {
        return `${m[1].padStart(2,"0")}:${m[2]} hs`;
      }
      return valor;
    }
    function eventoVacio(ev) {
      return !ev.nombre && !ev.fecha_humana && !ev.organizador_principal;
    }
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/17H2xueOlfBdsWDLspy8PWRMRFqbuEpQhA0VkUjSczxc/gviz/tq?tqx=out:json&sheet=ig_grl";
    let eventosData = [], eventosFiltrados = [], currentPage = 1, eventsPerPage = 6;
    let fetchAttempts = 0, maxFetchAttempts = 3;
    function showLoading(show=true) { document.getElementById('loading-indicator').style.display = show ? 'block' : 'none'; }
    function showRetry(show=true) { document.getElementById('retry-container').style.display = show ? 'block' : 'none'; }
    function loadEventos(forceRetry=false) {
      showLoading(true); showRetry(false);
      document.getElementById('events').innerHTML = "";
      fetchAttempts = forceRetry ? 1 : fetchAttempts + 1;
      fetch(SHEET_URL)
        .then(res => res.text())
        .then(text => {
          showLoading(false); showRetry(false);
          const json = JSON.parse(text.substr(47).slice(0, -2)), rows = json.table.rows;
          eventosData = [];
          for (let i = 0; i < rows.length; i++) {
            const c = rows[i].c;
            if (!c[0] || !isVerificado(c[0].v || "")) continue;
            const ubicacion = c[7] ? c[7].v || "" : "";
            if (ubicacion.toLowerCase().includes("fuera de la ciudad de dolores")) continue;
            const nombre = c[2] ? c[2].v || "" : "";
            const fecha = c[1] ? c[1].v || "" : "";
            const organizador_principal = c[9] ? c[9].v || "" : "";
            if (!nombre && !fecha && !organizador_principal) continue;
            eventosData.push({
              fecha:         c[1] ? c[1].v || "" : "",
              fecha_humana:  fechaHumana(c[1] ? c[1].v : ""),
              nombre:        c[2] ? c[2].v || "" : "",
              hora:          c[3] ? c[3].v || "" : "",
              hora2:         c[4] ? c[4].v || "" : "",
              categoria:     c[5] ? c[5].v || "" : "",
              descripcion:   c[6] ? c[6].v || "" : "",
              ubicacion:     ubicacion,
              lugar:         c[8] ? c[8].v || "" : "",
              organizador_principal: c[9] ? c[9].v || "" : "",
              co_organizadores: c[10] ? c[10].v || "" : "",
              info_adicional: c[11] ? c[11].v || "" : "",
              valor_entrada: c[12] ? c[12].v || "" : "",
              auspiciantes:  c[13] ? c[13].v || "" : "",
              enlace:        c[14] ? c[14].v || "" : "",
              instagram:     c[15] ? c[15].v || "" : "",
              logo:          c[16] ? c[16].v || "" : ""
            });
          }
          eventosFiltrados = eventosData;
          renderEventos(eventosFiltrados, currentPage);
        })
        .catch(error => {
          showLoading(false);
          if (fetchAttempts < maxFetchAttempts) setTimeout(() => loadEventos(), 1500);
          else {
            document.getElementById('events').innerHTML = `<p style="color:#b02a2a; font-weight:bold">No se pudieron cargar los eventos. Verifica que la hoja esté publicada y disponible.<br>Error: ${error}</p>`;
            showRetry(true);
          }
        });
    }
    function aplicarFiltro(search) {
      const filtro = search.trim().toLowerCase(), anteriorPage = currentPage;
      eventosFiltrados = eventosData.filter(ev => {
        if (eventoVacio(ev)) return false;
        if (ev.ubicacion && ev.ubicacion.toLowerCase().includes("fuera de la ciudad de dolores")) return false;
        if (!filtro) return true;
        const buscarEn = [
          ev.fecha_humana, ev.categoria, ev.organizador_principal, ev.co_organizadores, ev.auspiciantes
        ].join(" ").toLowerCase();
        return buscarEn.includes(filtro);
      });
      const totalPages = Math.max(1, Math.ceil(eventosFiltrados.length / eventsPerPage));
      currentPage = anteriorPage > totalPages ? totalPages : anteriorPage;
      renderEventos(eventosFiltrados, currentPage); scrollToEvents();
    }
    function renderInstagramBlock(instagram) {
      if (!instagram || typeof instagram !== "string" || instagram.trim() === "") return "";
      if (instagram.match(/\.(jpg|jpeg|png)(\?.*)?$/)) {
        return `<div class="event-image-block"><img src="${instagram}" alt="Imagen Instagram del evento"></div>`;
      }
      if (instagram.includes("instagram.com")) {
        let url = instagram.trim();
        let postMatch = url.match(/instagram\.com\/(p|reel|tv)\/([a-zA-Z0-9_-]+)/);
        if (postMatch) {
          let code = postMatch[2];
          // Botón que abre el modal con el iframe
          return `<div class="event-instagram-block">
            <button class="event-link" type="button" onclick="abrirInstagramEnModal('${postMatch[1]}','${code}','${encodeURIComponent(url)}')">Ver publicación en Instagram</button>
          </div>`;
        }
        // Si no es una publicación embebida, solo botón al enlace
        return `<div class="event-instagram-block">
          <button class="event-link" type="button" onclick="abrirInstagramEnModal('','','${encodeURIComponent(url)}')">Ver en Instagram</button>
        </div>`;
      }
      return "";
    }
    function textoAParrafoJustificado(texto) {
      if (!texto) return '';
      let partes = texto.split(/\n\s*\n/);
      if (partes.length === 1) partes = texto.split(/\n/);
      return partes.map(p => `<p style="text-align:justify;">${p.trim()}</p>`).join('');
    }
    function renderEventos(data, page=1) {
      const eventsDiv = document.getElementById('events');
      eventsDiv.innerHTML = "";
      let eventosMostrados = 0;
      const start = (page-1)*eventsPerPage, end = start + eventsPerPage, pageData = data.slice(start, end);
      pageData.forEach((ev, idx) => {
        const card = document.createElement('div'); card.className = "event-card";
        let orgNameHtml = ev.organizador_principal ? `<div class="event-organizer-name">${ev.organizador_principal}</div>` : "";
        let logoHtml = (ev.logo && ev.logo.trim() !== "") ? `<img class="event-logo-main" src="${ev.logo}" alt="Logo ${ev.organizador_principal || 'organizador'}">` : "";
        let coOrganizadoresHtml = "";
        if (ev.co_organizadores && ev.co_organizadores.trim() !== "") {
          coOrganizadoresHtml = `
            <div class="event-co-organizers-block">
              <div class="event-co-organizers-label">Co Organizado por:</div>
              <div class="event-co-organizers">${ev.co_organizadores}</div>
            </div>`;
        }
        let infoRows = '';
        if (ev.nombre) infoRows += `<div class="event-title">${ev.nombre}</div>`;
        if (ev.categoria) infoRows += `<div class="event-category-under-title">${ev.categoria}</div>`;
        if (ev.descripcion) infoRows += `<div class="event-description">${textoAParrafoJustificado(ev.descripcion)}</div>`;
        if (ev.fecha_humana) infoRows += `<div class="event-info-row event-date"><span class="icon"><i class="ri-calendar-event-line"></i></span><span>${ev.fecha_humana}</span></div>`;
        let horaMostrar = ev.hora && ev.hora.trim() !== "" ? ev.hora : (ev.hora2 && ev.hora2.trim() !== "" ? ev.hora2 : "");
        if (horaMostrar) infoRows += `<div class="event-info-row event-time"><span class="icon"><i class="ri-time-line"></i></span><span>${horaHumana(horaMostrar)}</span></div>`;
        if (ev.lugar) infoRows += `<div class="event-info-row event-location"><span class="icon"><i class="ri-map-pin-line"></i></span><span>${ev.lugar}</span></div>`;
        if (ev.valor_entrada) infoRows += `<div class="event-info-row event-value"><span class="icon"><i class="ri-money-dollar-circle-line"></i></span><span>${ev.valor_entrada}</span></div>`;
        if (ev.info_adicional) infoRows += `<div class="event-info-adicional"><span class="icon"><i class="ri-information-line"></i></span><span>${ev.info_adicional}</span></div>`;
        let sponsorsHtml = "";
        if (ev.auspiciantes && ev.auspiciantes.trim() !== "") {
          sponsorsHtml = `
            <div class="event-sponsors-block">
              <div class="event-sponsors-label">Agradecemos a:</div>
              <div class="event-sponsors">${ev.auspiciantes}</div>
            </div>`;
        }
        let enlaceHtml = (ev.enlace && typeof ev.enlace === "string" && ev.enlace.trim() !== "")
          ? `<button class="event-link" type="button" onclick="abrirEnlaceModal(this.getAttribute('data-url'))" data-url="${ev.enlace.replace(/"/g, '&quot;')}">Entradas / Más info / Inscribirse</button>` : "";
        let instagramHtml = renderInstagramBlock(ev.instagram);
        card.innerHTML = `
          ${orgNameHtml}
          ${logoHtml}
          ${coOrganizadoresHtml}
          ${infoRows}
          ${sponsorsHtml}
          ${enlaceHtml}
          ${instagramHtml}
        `;
        eventsDiv.appendChild(card);
        eventosMostrados++;
      });
      if (eventosMostrados === 0) {
        eventsDiv.innerHTML = "<p style='color:#b02a2a; font-weight:bold'>No hay eventos para mostrar con ese criterio de búsqueda.</p>";
      }
      renderPaginator(data.length, page);
    }
    function renderPaginator(total, page) {
      const paginatorDiv = document.getElementById('paginator');
      const totalPages = Math.ceil(total / eventsPerPage);
      if (totalPages <= 1) { paginatorDiv.innerHTML = ""; return; }
      paginatorDiv.innerHTML =
        `<button id="prevPage" ${page <= 1 ? "disabled" : ""}>Anterior</button>
         <span class="page-info">Página ${page} / ${totalPages}</span>
         <button id="nextPage" ${page >= totalPages ? "disabled" : ""}>Siguiente</button>`;
      document.getElementById('prevPage').onclick = () => { if (currentPage > 1) { currentPage--; renderEventos(eventosFiltrados, currentPage); scrollToEvents(); }};
      document.getElementById('nextPage').onclick = () => { if (currentPage < totalPages) { currentPage++; renderEventos(eventosFiltrados, currentPage); scrollToEvents(); }};
    }
    function scrollToEvents() {
      const el = document.getElementById('events');
      if (el) el.scrollIntoView({behavior:"smooth",block:"start"});
    }
    loadEventos();
    document.getElementById('search').addEventListener('input', function() { aplicarFiltro(this.value); });
    function abrirEnlaceModal(url) {
      document.getElementById('modalIframe').src = url;
      document.getElementById('enlaceModal').style.display = 'flex';
    }
    // NUEVA FUNCION PARA EL MODAL DE INSTAGRAM
    function abrirInstagramEnModal(tipo, code, rawurl) {
      let url = decodeURIComponent(rawurl || '');
      let src = '';
      if (tipo && code) {
        src = `https://www.instagram.com/${tipo}/${code}/embed`;
      } else if (url && url.includes('instagram.com')) {
        // Si es solo el enlace a instagram, lo mostramos en el iframe
        src = url;
      } else {
        src = url;
      }
      document.getElementById('modalIframe').src = src;
      document.getElementById('enlaceModal').style.display = 'flex';
    }
    document.getElementById('cerrarModal').onclick = function() {
      document.getElementById('enlaceModal').style.display = 'none';
      document.getElementById('modalIframe').src = '';
    };
    document.getElementById('enlaceModal').onclick = function(e) {
      if (e.target === this) {
        document.getElementById('enlaceModal').style.display = 'none';
        document.getElementById('modalIframe').src = '';
      }
    };
  </script>
</body>
</html>
